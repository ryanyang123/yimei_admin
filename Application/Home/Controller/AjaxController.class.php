<?php
namespace Home\Controller;
use PhpMyAdmin\Config\Forms\Page\ImportForm;
use Think\Controller;
class AjaxController extends Controller {
    public function _initialize(){
        vendor('Rong.rongcloud');
    }
    public function index(){
        /*$rong_user2[] = '2';
        $tis = '我们已经是好友，现在我们可以开始聊天了';
        $res = SendRongUserMessage('4523',$rong_user2,$tis);
        dump($res);die;*/
    }




    /**
     * 登录发送验证码
     */
    public function SendCodeLogin(){
        DeleteOldCode();
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        if(!$phone){
            $arr = array(
                'code'=> 0,
                'res'=> '请输入手机号'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if(strlen($phone)!=11){
            $arr = array(
                'code'=> 0,
                'res'=> '手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //实例化数据表
        $user = M('user');
        $verify = M('verify');
        $phone_code = M('phone_code');

      /*  $phone_arr = array(
            '13066817617',
            '18927486814',
            '18998944916',
            '13823666429',
            '18038076688',
            '13828733352',
            '18124527436',
            '15899753337',
            '15012824797',
            '13828936636',
            '13631259933',
            '18933974998',
            '13660495333'
        );*/
        $rand = rand(100000,999999);

        //$rand =123456;
        $is_have = $phone_code->where(array('phone'=>$phone))->find();

        //$isin = in_array($phone,$phone_arr);
        if($is_have){
            //$rand =8866888;
            $rand =$is_have['password'];
        }
/*
        if($phone=='13066817617'){
            $rand =123456;
        }*/

        //$uid = "2255";
        //$passwd = "7fdf6096659ff66beaba43046368a020";
        $content = "您的验证码为：".$rand."，为了保护您的账户安全，验证码请勿转发他人，有效时间15分钟。【伊美小天鹅】";
        //$url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=".$phone."&content=".$content;


        $params = array();
        $params['account'] = 'N4419285';
        $params['password'] = 'js8S0k5BD';
        $params['msg'] = $content;
        $params['phone'] = $phone;
        $params['sendtime'] = (String)date('YmdHi');
        $params['report'] ='true';
        $params['extend'] ='243322';
        $params['uid'] = (String)time();

        $params = json_encode($params);
        //dump($params);die;
        $url = 'http://smssh1.253.com/msg/send/json';
        if($is_have){
            $result['code'] = 0;
        }else{
            $con = SendPost($url,$params);
            $result = json_decode($con,true);
            if($result['code'] == 0){
                //M('set')->where(array('set_type'=>'sms_code_num'))->setDec('set_value',1);
            }
        }

     /*   if($is_have){
            $result['code'] = 0;
        }else{
            $html = file_get_contents($url);
            $result = json_decode($html,true);
            if($result['code'] == 0){
                M('set')->where(array('set_type'=>'sms_code_num'))->setDec('set_value',1);
            }

        }*/
        //$result['code'] = 0;

        //$html = file_get_contents($url);
        //$result = json_decode($html,true);
        //$con= substr( file_get_contents($url), 0, 1 );  //获取信息发送后的状态
        //$result['code'] = 0;
        if($result['code'] == 0){
            $where['phone'] = $phone;
            $where['type'] = 4;
            $is_code = $verify->where($where)->find();
            if($is_code){
                $save['code'] = $rand;
                $save['create_time'] = time();
                $verify->where(array('id'=>$is_code['id']))->save($save);
            }else{
                $add['code'] = $rand;
                $add['phone'] = $phone;
                $add['type'] = 4;//注册，2修改密码
                $add['create_time'] = time();
                $verify->add($add);
            }
            $arr = array(
                'code'=> 1,
                'res'=>'发送成功',
                'phone'=>$phone
            );

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'发送失败',
                'phone'=>$phone
            );

        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }





    /**
     * 注册发送验证码
     */
    public function SendCode(){
        DeleteOldCode();
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        if(!$phone){
            $arr = array(
                'code'=> 0,
                'res'=> '请输入手机号'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if(strlen($phone)!=11){
            $arr = array(
                'code'=> 0,
                'res'=> '手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //实例化数据表
        $user = M('user');
        $verify = M('verify');


        $is_reg = $user->where(array('phone'=>$phone))->find();
        if($is_reg){
            $arr = array(
                'code'=> 0,
                'res'=>'该手机号已注册'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{

            $rand = rand(100000,999999);
            //$rand =123456;




            //$uid = "2255";
            $passwd = "7fdf6096659ff66beaba43046368a020";
            $content = "您的验证码为：".$rand."，为了保护您的账户安全，验证码请勿转发他人，有效时间15分钟。【伊美小天鹅】";
           // $url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=".$phone."&content=".$content;
            //$html = file_get_contents($url);
            //$result = json_decode($html,true);
            //$con= substr( file_get_contents($url), 0, 1 );  //获取信息发送后的状态
           // $result['code'] = 0;

            $params = array();
            $params['account'] = 'N4419285';
            $params['password'] = 'js8S0k5BD';
            $params['msg'] = $content;
            $params['phone'] = $phone;
            $params['sendtime'] = (String)date('YmdHi');
            $params['report'] ='true';
            $params['extend'] ='243322';
            $params['uid'] = (String)time();

            $params = json_encode($params);
            //dump($params);die;
            $url = 'http://smssh1.253.com/msg/send/json';

            //$con = SendPost('http://api.1cloudsp.com/api/v2/send',$params);
            $con = SendPost($url,$params);

            //$url = "http://api.1cloudsp.com/api/v2/send?".$params; //提交的url地址
            //$con= file_get_contents($url);
            $result = json_decode($con,true);


            if($result['code'] == 0){
                M('set')->where(array('set_type'=>'sms_code_num'))->setDec('set_value',1);
                $where['phone'] = $phone;
                $where['type'] = 1;
                $is_code = $verify->where($where)->find();
                if($is_code){
                    $save['code'] = $rand;
                    $save['create_time'] = time();
                    $verify->where(array('id'=>$is_code['id']))->save($save);
                }else{
                    $add['code'] = $rand;
                    $add['phone'] = $phone;
                    $add['type'] = 1;//注册，2修改密码
                    $add['create_time'] = time();
                    $verify->add($add);
                }


                $arr = array(
                    'code'=> 1,
                    'res'=>'发送成功',
                    'phone'=>$phone
                );

            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'发送失败',
                    'phone'=>$phone
                );

            }

            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");

        }

    }

    function sendtest(){
        die;
        $rand = '123456';
        $phone = '14718171817';
        $uid = "2255";
        $passwd = "7fdf6096659ff66beaba43046368a020";
        $content = "您的验证码为：".$rand."，为了保护您的账户安全，验证码请勿转发他人，有效时间15分钟。【伊美小天鹅】";
        $url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=".$phone."&content=".$content;
        $html = file_get_contents($url);
        $result = json_decode($html,true);
        dump($result);die;
    }


    /**
     * 注册验证手机验证码
     */
    function CheckCode(){
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        $code = decrypt1(trim(I('post.code')));

        //实例化数据表
        $user = M('user');
        $verify = M('verify');

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$code)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(!is_numeric($phone) || strlen($phone)<8){
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $is_reg = $user->where(array('phone'=>$phone))->find();
        if($is_reg){
            $arr = array(
                'code'=> 0,
                'res'=>'该手机号码已注册'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_code['code'] = $code;
        $where_code['phone'] = $phone;
        $where_code['type'] = 1;
        $is_code = $verify->where($where_code)->order('create_time desc')->find();
        if(!$is_code){
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            $arr = array(
                'code'=> 1,
                'res'=>'验证码正确'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

    }



    /**
    * 用户注册
    */
    function UserRegister(){
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        $code = decrypt1(trim(I('post.code')));
        $password = decrypt1(trim(I('post.password')));
        $push_id = decrypt1(trim(I('post.push_id')));
        $invitation_code = decrypt1(trim(I('post.invitation_code')));

        //实例化数据表
        $user = M('user');
        $verify = M('verify');
        $set = M('set');
        $code_db = M('code');

        //删除15分钟前验证码
        $min15 = time()-900;
        $verify->where(array('create_time'=>array('ELT',$min15)))->delete();

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$code)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(strlen($password)>16 || strlen($password)<6){
            $arr = array(
                'code'=> 0,
                'res'=>'密码长度为6-16'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$password)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'密码由字母、数字、下划线或@、#组成'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(!is_numeric($phone) || strlen($phone)<8){
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $is_reg = $user->where(array('phone'=>$phone))->find();
        if($is_reg){
            $arr = array(
                'code'=> 0,
                'res'=>'该手机号码已注册'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }



        $where_code['code'] = $code;
        $where_code['phone'] = $phone;
        $where_code['type'] = 1;
        $is_code = $verify->where($where_code)->order('create_time desc')->find();
        if(!$is_code){
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $is_open_register = $set->where(array('set_type'=>'is_register_code'))->find();

        if($is_open_register['set_value']==0){
            if(!$invitation_code){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请输入邀请码'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

            $code_info = $code_db->where(array('number'=>$invitation_code,'is_open'=>'1'))->find();
            if(!$code_info){
                $arr = array(
                    'code'=> 0,
                    'res'=>'邀请码无效'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        $month_code_num = $set->where(array('set_type'=>'month_code_num'))->find();
        //添加新用户
        $add['phone'] = $phone;
        $add['school_id'] = 1;
        if($push_id){
            $add['push_id'] = $push_id;
        }

        $user_name = '用户';

        $add['token'] = md5('xuan_yixiang_User'.$phone.time());
        $add['password'] = md5($password);
        $add['create_time'] = time();
        $add['head'] = XUANIMG.'/Public/image/usermo.png';
        $add['imid'] = GetImId();
        //$add['phone_at'] = '1';
        $add['signature'] = '听说有个签名，今年会有桃花运';

        $add['send_code_num'] = $month_code_num['set_value'];
        if($is_open_register['set_value']==0){
            $add['parent'] = $code_info['user_id'];
            $add['code_id'] = $code_info['id'];

        }

        $query = $user->add($add);

        if($query){
            if($is_open_register['set_value']==0){
                //自动添加为好友
                if($code_info['is_friend']=='1'){
                    $user_friend = M('user_friend');
                    $add_friend1['user_id'] = $code_info['user_id'];
                    $add_friend1['friend_user_id'] = $query;
                    $add_friend1['create_time'] = time();
                    $user_friend->add($add_friend1);

                    $add_friend2['user_id'] = $query;
                    $add_friend2['friend_user_id'] = $code_info['user_id'];
                    $add_friend2['create_time'] = time();
                    $user_friend->add($add_friend2);
                }

                //自动加入群
                if($code_info['is_group']!=0) {
                    $group_user = M('group_user');
                    $group = M('group');
                    $group_info = $group->where(array('id'=>$code_info['is_group']))->find();
                    if ($group_info['max']=='1'){$max = 500;}
                    if ($group_info['max']=='2'){$max = 1000;}
                    if ($group_info['max']=='3'){$max = 2000;}
                    if ($group_info['max']=='4'){$max = 3000;}
                    $count_num = $group_user->where(array('group_id'=>$group_info['id']))->count();

                    if ($count_num>$max){
                       //
                    }else{
                        $add_group_user['user_id'] = $query;
                        $add_group_user['group_id'] =$code_info['is_group'];
                        $add_group_user['type'] = 3;
                        $add_group_user['create_time'] = time();
                        $query_group = $group_user->add($add_group_user);
                        if($query_group){
                            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                            $result = $RongCloud->group()->join($query,$code_info['is_group'],$group_info['group_name']);
                        }
                    }
                }
            }

            $save['name'] = $user_name.'_'.$query;
            $user->where(array('id'=>$query))->save($save);
            //融云token
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->getToken($query, $save['name'],$add['head']);
            $rongres =  json_decode($result,true);
            if($result){
                $user->where(array('id'=>$query))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
            }

            $rong_user[] = $query;
            $tis = 'Welcome！';
           // SendRongSystem($rong_user,$tis);

            $arr = array(
                'code'=> 1,
                'res'=>'注册成功',
                'token'=>$add['token'],
                'user_id'=>$query,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'注册失败',
                'token'=>'',
                'user_id'=>'',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 完善个人资料
     */
    function RegUserInfo(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $head = decrypt1(trim(I('post.head')));
        $name = decrypt1(trim(I('post.name')));
        $sex = decrypt1(trim(I('post.sex')));
        $birthday = decrypt1(trim(I('post.birthday')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //if(!$head){$arr = array('code'=> 0, 'res'=>'请上传头像');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$name){$arr = array('code'=> 0, 'res'=>'请输入昵称');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(strlen($name)>24){$arr = array('code'=> 0, 'res'=>'昵称长度过长');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if(!$birthday){$arr = array('code'=> 0, 'res'=>'请选择您的生日');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if(strtotime($birthday)>strtotime(date('Y-m-d'))){$arr = array('code'=> 0, 'res'=>'生日时间不能大于当前时间');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($name) {
            $where_id_name['name'] = $name;
            $where_id_name['id'] = array('NEQ', $user_info['id']);
            $is_name = $user->where($where_id_name)->find();
            if ($is_name) {
                $arr = array('code' => 0, 'res' => '昵称已存在');
                $data = json_encode($arr);
                $return['encryption'] = encrypt1($data);
                $this->ajaxReturn($return, "JSON");
            }
        }

        if($head){
            $save['head'] = $head;
        }else{
            $head = $user_info['head'];
        }

        if($name){
            $save['name'] = $name;
        }else{
            $name = $user_info['name'];
        }

        if($sex){
            $save['sex'] = $sex;
        }
        $age = birthday($birthday);
        $save['birthday'] = strtotime($birthday);
        $save['age'] = $age;
        $save['is_info'] = '1';
        $save['update_time'] = time();
        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        if($query){

            //融云token
           $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->refresh($user_info['id'], $name,$head);
            $arr = array(
                'code'=> 1,
                'res'=>'修改成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'修改失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 用户手机号登陆
     */
    function UserLogin(){
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        $code = decrypt1(trim(I('post.code')));
        $push_id = decrypt1(trim(I('post.push_id')));
        $share_user_id = decrypt1(trim(I('post.share_user_id')));
        $user = M('user');
        $verify = M('verify');

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$code)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_code['code'] = $code;
        $where_code['phone'] = $phone;
        $where_code['type'] = 4;
        $is_code = $verify->where($where_code)->order('create_time desc')->find();
        if(!$is_code){
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //实例化数据表


        $where['phone'] = $phone;
        $user_info = $user->where($where)->find();
        if($user_info){
            if($user_info['is_freeze']=='0'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

            //融云token
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->getToken($user_info['id'], $user_info['name'],$user_info['head']);
            $rongres =  json_decode($result,true);
            if($result){
                //$user->where(array('id'=>$user_info['id']))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                $save_user['rong_token']  = $rongres['token'];
            }


            if($push_id){
                //$user->where(array('id'=>$user_info['id']))->save(array('push_id'=>$push_id,'update_time'=>time()));
                $save_user['push_id'] = $push_id;
            }
            $save_user['update_time'] = time();
            $save_user['login_time'] = time();
            $user->where(array('id'=>$user_info['id']))->save($save_user);

            $rong_user[] = $user_info['id'];
            if ($user_info['login_time']>0){
                $tis = '欢迎回来！';
            }else{
                $tis = 'Welcome！';
            }
            SendRongSystem($rong_user,$tis);


            if(!$user_info['code_user']){
                if($share_user_id){
                    //绑定邀请人
                    $bind_status = BindCodeUser($share_user_id,$user_info['id']);
                }
            }


            if($user_info['code_user']){
                $is_need_code = '1';
            }else{
                $is_need_code = '0';
            }
            if($user_info['head']=='http://api.ymxte.com/Public/image/usermo.png'){
                $is_need_info = '0';
            }else{
                $is_need_info = '1';
            }
            $arr = array(
                'code'=> 1,
                'res'=>'登录成功',
                'token'=>$user_info['token'],
                'user_id'=>$user_info['id'],
                'name'=>$user_info['name'],
                'head'=>$user_info['head'],
                'is_code'=>$is_need_code,
                'is_info'=>$user_info['is_info'],
            );
        }else{
            //添加新用户
            $add['phone'] = $phone;
            if($push_id){
                $add['push_id'] = $push_id;
            }


            $user_name = '用户';

            $add['token'] = md5('xuan_yimei_User'.$phone.time());
            $add['create_time'] = time();
            $add['login_time'] = time();
            $add['head'] = XUANIMG.'/Public/image/usermo.png';
            //$add['phone_at'] = '1';
            $add['signature'] = '听说有个签名，今年会有桃花运';
            $query = $user->add($add);
            if ($query){
                $save['name'] = $user_name.'_'.$query;
                $user->where(array('id'=>$query))->save($save);
                //融云token
                $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                $result = $RongCloud->user()->getToken($query, $save['name'],$add['head']);
                $rongres =  json_decode($result,true);
                if($result){
                    $user->where(array('id'=>$query))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                }

                if($share_user_id){
                    //绑定邀请人
                    $bind_status = BindCodeUser($share_user_id,$query);
                }

                $rong_user[] = $query;
                $tis = 'Welcome！';
                SendRongSystem($rong_user,$tis);
                //注册增加积分
                //$add_status = AddScore($query,0,0,'5',$query);

                //注册获得东西
                $add_status = RegGetTask($query);

                //发送注册公告
                SendNoticeUser($query);
                $arr = array(
                    'code'=> 1,
                    'res'=>'登录成功',
                    'token'=>$add['token'],
                    'user_id'=>$query,
                    'name'=>$save['name'],
                    'head'=>$add['head'],
                    'is_code'=>'0',
                    'is_info'=>'0',
                );
            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'注册失败',
                );
            }
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /**
     * 用户微信登陆
     */
    function UserLoginWx(){
        //接收数据
        $unionid = decrypt1(trim(I('post.unionid')));
        $name = decrypt1(trim(I('post.name')));
        $head = decrypt1(trim(I('post.head')));
        $sex = decrypt1(trim(I('post.sex')));
        $country = decrypt1(trim(I('post.country')));
        $province = decrypt1(trim(I('post.province')));
        $city = decrypt1(trim(I('post.city')));
        $user = M('user');
        $wx = M('wx');

        if(!$unionid){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $is_wx = $wx->where(array('unionid'=>$unionid))->find();
        if($is_wx){
            if($is_wx['user_id']){
                $user_info = $user->where(array('id'=>$is_wx['user_id']))->find();
                //融云token
                $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                $result = $RongCloud->user()->getToken($user_info['id'], $user_info['name'],$user_info['head']);
                $rongres =  json_decode($result,true);
                if($result){
                    //$user->where(array('id'=>$user_info['id']))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                    $save_user['rong_token']  = $rongres['token'];
                }

                $save_user['update_time'] = time();
                $save_user['login_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save_user);

                $rong_user[] = $user_info['id'];
                if ($user_info['login_time']>0){
                    $tis = '欢迎回来！';
                }else{
                    $tis = 'Welcome！';
                }
                SendRongSystem($rong_user,$tis);

                $arr = array(
                    'code'=> 1,
                    'res'=>'登录成功',
                    'token'=>$user_info['token'],
                    'user_id'=>$user_info['id'],
                    'name'=>$user_info['name'],
                    'head'=>$user_info['head'],
                    'is_phone'=>'1',
                    'is_code'=>$user_info['is_code'],
                    'is_info'=>$user_info['is_info'],
                    'unionid'=>$unionid,
                );
            }else{
                $arr = array(
                    'code'=> 1,
                    'res'=>'登录成功',
                    'token'=>'',
                    'user_id'=>'',
                    'name'=>'',
                    'head'=>'',
                    'is_phone'=>'0',
                    'is_code'=>'0',
                    'is_info'=>'0',
                    'unionid'=>$unionid,
                );
            }

        }else{
            $add_wx['unionid'] = $unionid;
            $add_wx['name'] = $name;
            $add_wx['head'] = $head;
            $add_wx['sex'] = $sex;
            $add_wx['country'] = $country;
            $add_wx['province'] = $province;
            $add_wx['city'] = $city;
            $add_wx['create_time'] = time();
            $wx->add($add_wx);
            $arr = array(
                'code'=> 1,
                'res'=>'登录成功',
                'token'=>'',
                'user_id'=>'',
                'name'=>'',
                'head'=>'',
                'is_phone'=>'0',
                'is_code'=>'0',
                'is_info'=>'0',
                'unionid'=>$unionid,
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 用户小程序登录
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function LoginXCX()
    {
        $phone = decrypt1(trim(I('post.phone')));
        $name = decrypt1(trim(I('post.name')));
        $head = decrypt1(trim(I('post.head')));
        $share_user_id = decrypt1(trim(I('post.share_user_id')));


        $user = M('user');

        if($phone){
            $where['phone'] = $phone;
            $user_info = $user->where($where)->find();
            if($user_info){
                if($user_info['is_freeze']=='0'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                $save_user['update_time'] = time();
                $save_user['login_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save_user);

                if(!$user_info['code_user']){
                    if($share_user_id){
                        //绑定邀请人
                        $bind_status = BindCodeUser($share_user_id,$user_info['id']);
                    }
                }
                $arr = array(
                    'code'=> 1,
                    'res'=>'登录成功',
                    'token'=>$user_info['token'],
                    'head'=>$user_info['head'],
                    'name'=>$user_info['name'],
                    'id'=>$user_info['id'],
                );
            }else{
                //添加新用户
                $add['phone'] = $phone;

                $user_name = '用户';

                $add['token'] = md5('xuan_yimei_User'.$phone.time());
                $add['create_time'] = time();
                $add['login_time'] = time();
                $add['head'] = $head;
                $add['name'] = $name;
                //$add['phone_at'] = '1';
                $add['signature'] = '听说有个签名，今年会有桃花运';
                $query = $user->add($add);
                if ($query){
                    //$save['name'] = $user_name.'_'.$query;
                    //$user->where(array('id'=>$query))->save($save);
                    //融云token
                    $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                    $result = $RongCloud->user()->getToken($query, $add['name'],$add['head']);
                    $rongres =  json_decode($result,true);
                    if($result){
                        $user->where(array('id'=>$query))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                    }

                    if($share_user_id){
                        //绑定邀请人
                        $bind_status = BindCodeUser($share_user_id,$query);
                    }

                    $rong_user[] = $query;
                    $tis = 'Welcome！';
                    SendRongSystem($rong_user,$tis);
                    //注册增加积分
                    //$add_status = AddScore($query,0,0,'5',$query);

                    //注册获得东西
                    $add_status = RegGetTask($query);

                    //发送注册公告
                    SendNoticeUser($query);
                    $arr = array(
                        'code'=> 1,
                        'res'=>'登录成功',
                        'token'=>$add['token'],
                        'head'=>$add['head'],
                        'name'=>$save['name'],
                        'id'=>$query,
                    );
                }else{
                    $arr = array(
                        'code'=> 0,
                        'res'=>'注册失败',
                    );
                }
            }

            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");


        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 小程序返回信息
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    public function checkXcx()
    {
        $code = decrypt1(trim(I('post.code')));
        $iv = decrypt1(trim(I('post.iv')));
        $encryptedData = decrypt1(trim(I('post.encryptedData')));
        //$share_user_id = decrypt1(trim(I('post.share_user_id')));

        //$code = '033DYuIx1AVP7c0f5qIx1AdsIx1DYuIe';
        //$iv = '9MnwKe41rTS5hOicDEK9fQ==';
        //$encryptedData = 'FqLQu2d5Lw2Dep5RGeMnVOUXh+EuJhEKTL+fBI2844cq+9r/CWHX6z1waUQGj73EWkapjeUJp3wDMeVu2rl2bfa6EE1L84LwwMKwN2yPvpkBno/lzCEw1rKGICpKtQ3IIPpZuR9vnm3d1OSHHkVSjoL3uL86cvuqzyhBw0+4YfQQVsiRBl/n4VdwC8dE2BTM0A8hyjDPASUeM1jDBCinkQ==';

        $user = M('user');
        $wx = M('wx');

        //if(!$unionid){$arr = array('code'=> 0, 'res'=>'缺少参数1004');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$iv){$arr = array('code'=> 0, 'res'=>'缺少参数1003');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$encryptedData){$arr = array('code'=> 0, 'res'=>'缺少参数1002');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$code){$arr = array('code'=> 0, 'res'=>'缺少参数1001');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $appid = 'wx29e047dc98f52006';
        $secret = 'b99cf71cdd3bd8b3b5c800afafb4e8c3';
        $url = 'https://api.weixin.qq.com/sns/jscode2session?appid='.$appid.'&secret='.$secret.'&js_code='.$code.'&grant_type=authorization_code';
        $a = geturl($url);
        $sessionKey = $a['session_key'];
        $open_id = $a['openid'];
        vendor('XcxAes.wxBizDataCrypt');
        $pc = new \Wxbizdatacrypt($appid, $sessionKey);
        $errCode = $pc->decryptData($encryptedData, $iv, $data2 );
        if($errCode==0){
            //$xcx_info = json_decode($data2,true);
            $arr = array(
                'code'=> 1,
                'res'=>$data2,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'获取信息失败，请重新进入小程序',
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 用户支付宝登陆
     */
    function UserLoginAli(){
        //接收数据
        $auth_code = decrypt1(trim(I('post.auth_code')));
        $alipay_open_id = decrypt1(trim(I('post.alipay_open_id')));
        //$auth_code = 'a90b232a7a1840d69b3e3ae11942TB02';
        //$alipay_open_id = '20881037580637758739795690210002';
        $user = M('user');
        $ali = M('ali');

        if(!$auth_code || !$alipay_open_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        vendor('appalipay.AopSdk');// 加载类库

        $aop = new \AopClient ();
        $aop->gatewayUrl = 'https://openapi.alipay.com/gateway.do';
        $aop->appId = C('alipay_config.appid');
        $aop->rsaPrivateKey = C('alipay_config.rsaPrivateKey');
        $aop->alipayrsaPublicKey=C('alipay_config.alipayrsaPublicKey');
        $aop->apiVersion = '1.0';
        $aop->signType = 'RSA2';
        $aop->postCharset='utf-8';
        $aop->format='json';
        $request = new \AlipaySystemOauthTokenRequest ();
        $request->setGrantType("authorization_code");
        $request->setCode($auth_code);
        $request->setRefreshToken($alipay_open_id);
        $result = $aop->execute ( $request);

        $responseNode = str_replace(".", "_", $request->getApiMethodName()) . "_response";
        $user_id_start = $result->$responseNode->user_id;
        $access_token = $result->$responseNode->access_token;


        if(!empty($user_id_start) && $access_token){
            $aop2 = new \AopClient ();
            $aop2->gatewayUrl = 'https://openapi.alipay.com/gateway.do';
            $aop2->appId =  C('alipay_config.appid');
            $aop2->rsaPrivateKey =  C('alipay_config.rsaPrivateKey');
            $aop2->alipayrsaPublicKey= C('alipay_config.alipayrsaPublicKey');
            $aop2->apiVersion = '1.0';
            $aop2->signType = 'RSA2';
            $aop2->postCharset='utf-8';
            $aop2->format='json';
            $request2 = new \AlipayUserInfoShareRequest ();
            $result2 = $aop2->execute ( $request2 , $access_token);

            $responseNode2 = str_replace(".", "_", $request2->getApiMethodName()) . "_response";
            $resultCode2 = $result2->$responseNode2->code;
            if(!empty($resultCode2)&&$resultCode2 == 10000){
                $ali_user_id = $result2->$responseNode2->user_id;
                $gender = $result2->$responseNode2->gender;
                $sex = '1';
                if($gender=='f'){
                    $sex = '2';
                }
                $head = $result2->$responseNode2->avatar;
                $city = $result2->$responseNode2->city;
                $province = $result2->$responseNode2->province;
                $name = $result2->$responseNode2->nick_name;


                $is_wx = $ali->where(array('ali_user_id'=>$ali_user_id))->find();
                if($is_wx){
                    if($is_wx['user_id']){
                        $user_info = $user->where(array('id'=>$is_wx['user_id']))->find();
                        //融云token
                        $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                        $result = $RongCloud->user()->getToken($user_info['id'], $user_info['name'],$user_info['head']);
                        $rongres =  json_decode($result,true);
                        if($result){
                            //$user->where(array('id'=>$user_info['id']))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                            $save_user['rong_token']  = $rongres['token'];
                        }

                        $save_user['update_time'] = time();
                        $save_user['login_time'] = time();
                        $user->where(array('id'=>$user_info['id']))->save($save_user);

                        $rong_user[] = $user_info['id'];
                        if ($user_info['login_time']>0){
                            $tis = '欢迎回来！';
                        }else{
                            $tis = 'Welcome！';
                        }
                        SendRongSystem($rong_user,$tis);

                        $arr = array(
                            'code'=> 1,
                            'res'=>'登录成功',
                            'token'=>$user_info['token'],
                            'user_id'=>$user_info['id'],
                            'name'=>$user_info['name'],
                            'head'=>$user_info['head'],
                            'is_phone'=>'1',
                            'is_code'=>$user_info['is_code'],
                            'is_info'=>$user_info['is_info'],
                            'ali_user_id'=>$ali_user_id,
                        );
                    }else{
                        $arr = array(
                            'code'=> 1,
                            'res'=>'登录成功',
                            'token'=>'',
                            'user_id'=>'',
                            'name'=>'',
                            'head'=>'',
                            'is_phone'=>'0',
                            'is_code'=>'0',
                            'is_info'=>'0',
                            'ali_user_id'=>$ali_user_id,
                        );
                    }

                }else{
                    $add_wx['ali_user_id'] = $ali_user_id;
                    $add_wx['name'] = $name;
                    $add_wx['head'] = $head;
                    $add_wx['sex'] = $sex;
                    $add_wx['province'] = $province;
                    $add_wx['city'] = $city;
                    $add_wx['create_time'] = time();
                    $ali->add($add_wx);
                    $arr = array(
                        'code'=> 1,
                        'res'=>'登录成功',
                        'token'=>'',
                        'user_id'=>'',
                        'name'=>'',
                        'head'=>'',
                        'is_phone'=>'0',
                        'is_code'=>'0',
                        'is_info'=>'0',
                        'ali_user_id'=>$ali_user_id,
                    );
                }

                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");

            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'参数错误1002'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

        } else {
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误1001'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }





    }

    /**
     * 绑定手机发送验证码
     */
    public function SendCodeBind(){
        DeleteOldCode();
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        $type = decrypt1(trim(I('post.type')));//类型：1微信，2支付宝

        if(!$phone){
            $arr = array(
                'code'=> 0,
                'res'=> '请输入手机号'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if(strlen($phone)!=11){
            $arr = array(
                'code'=> 0,
                'res'=> '手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //实例化数据表
        $user = M('user');
        $wx = M('wx');
        $ali = M('ali');
        $verify = M('verify');

        $user_id = $user->where(array('phone'=>$phone))->field('id')->find();
        if($type=='2'){
            $is_bind = $ali->where(array('user_id'=>$user_id['id']))->find();
        }else{
            $is_bind = $wx->where(array('user_id'=>$user_id['id']))->find();
        }

        if($is_bind){
            $arr = array(
                'code'=> 0,
                'res'=>'该手机号已经被绑定，请更换'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $rand = rand(100000,999999);
        //$rand =123456;


        //$uid = "2255";
        //$passwd = "7fdf6096659ff66beaba43046368a020";
        $content = "您的验证码为：".$rand."，为了保护您的账户安全，验证码请勿转发他人，有效时间15分钟。【伊美小天鹅】";
        //$url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=".$phone."&content=".$content;
        //$html = file_get_contents($url);
        //$result = json_decode($html,true);




        $params = array();
        $params['account'] = 'N4419285';
        $params['password'] = 'js8S0k5BD';
        $params['msg'] = $content;
        $params['phone'] = $phone;
        $params['sendtime'] = (String)date('YmdHi');
        $params['report'] ='true';
        $params['extend'] ='243322';
        $params['uid'] = (String)time();

        $params = json_encode($params);
        //dump($params);die;
        $url = 'http://smssh1.253.com/msg/send/json';

        //$con = SendPost('http://api.1cloudsp.com/api/v2/send',$params);
        $con = SendPost($url,$params);

        //$url = "http://api.1cloudsp.com/api/v2/send?".$params; //提交的url地址
        //$con= file_get_contents($url);
        $result = json_decode($con,true);


        //$con= substr( file_get_contents($url), 0, 1 );  //获取信息发送后的状态
        //$result['code'] = 0;
        if($result['code'] == 0){
            M('set')->where(array('set_type'=>'sms_code_num'))->setDec('set_value',1);
            $where['phone'] = $phone;
            $where['type'] = 5;
            $is_code = $verify->where($where)->find();
            if($is_code){
                $save['code'] = $rand;
                $save['create_time'] = time();
                $verify->where(array('id'=>$is_code['id']))->save($save);
            }else{
                $add['code'] = $rand;
                $add['phone'] = $phone;
                $add['type'] = 5;//注册，2修改密码
                $add['create_time'] = time();
                $verify->add($add);
            }
            $arr = array(
                'code'=> 1,
                'res'=>'发送成功',
                'phone'=>$phone
            );

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'发送失败',
                'phone'=>$phone
            );

        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 绑定手机号
     */
    function BindPhone(){
        //接收数据
        $unionid = decrypt1(trim(I('post.unionid')));
        $ali_user_id = decrypt1(trim(I('post.ali_user_id')));
        $phone = decrypt1(trim(I('post.phone')));
        $code = decrypt1(trim(I('post.code')));
        $push_id = decrypt1(trim(I('post.push_id')));
        $share_user_id = decrypt1(trim(I('post.share_user_id')));
        $type = decrypt1(trim(I('post.type')));//1微信绑定，2支付宝绑定

     /*   $ali_user_id = '2088712435371023';
        $phone = '15074851050';
        $code = '629356';
        $type = '2';*/

        if(!$type){$type='1';}
        $user = M('user');
        $verify = M('verify');
        $wx = M('wx');
        $ali = M('ali');


        if($type=='1'){
            if(!$unionid){
                $arr = array(
                    'code'=> 0,
                    'res'=>'缺少参数'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }



        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$code)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_code['code'] = $code;
        $where_code['phone'] = $phone;
        $where_code['type'] = 5;
        $is_code = $verify->where($where_code)->order('create_time desc')->find();
        if(!$is_code){
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if($type=='2'){
            $wx_info = $ali->where(array('ali_user_id'=>$ali_user_id))->find();
        }else{
            $wx_info = $wx->where(array('unionid'=>$unionid))->find();
        }

        if($wx_info){
            if($wx_info['user_id']){
                $arr = array(
                    'code'=> 0,
                    'res'=>'已绑定'
                );
            }else{
                $user_info = $user->where(array('phone'=>$phone))->find();
                if($user_info){
                    if($type=='2'){
                        $is_bind = $ali->where(array('user_id'=>$user_info['id']))->find();
                    }else{
                        $is_bind = $wx->where(array('user_id'=>$user_info['id']))->find();
                    }

                    if ($is_bind){
                        $arr = array(
                            'code'=> 0,
                            'res'=>'该手机号已经被绑定，请更换'
                        );
                    }else{
                        if($type=='2'){
                            $ali->where(array('id'=>$wx_info['id']))->save(array('user_id'=>$user_info['id'],'update_time'=>time()));
                            $save_user['sex'] = $wx_info['sex'];
                            $save_user['ali_user_id'] = $wx_info['ali_user_id'];
                            if($user_info['code_user'] && $wx_info['sex'] == '2'){
                                TaskSex($wx_info['id'],$user_info['code_user']);
                            }
                        }else{
                            $wx->where(array('id'=>$wx_info['id']))->save(array('user_id'=>$user_info['id'],'update_time'=>time()));
                        }
                        //融云token
                        $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                        $result = $RongCloud->user()->getToken($user_info['id'], $user_info['name'],$user_info['head']);
                        $rongres =  json_decode($result,true);
                        if($result){
                            //$user->where(array('id'=>$user_info['id']))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                            $save_user['rong_token']  = $rongres['token'];
                        }

                        $save_user['update_time'] = time();
                        $save_user['login_time'] = time();
                        $user->where(array('id'=>$user_info['id']))->save($save_user);

                        $rong_user[] = $user_info['id'];
                        if ($user_info['login_time']>0){
                            $tis = '欢迎回来！';
                        }else{
                            $tis = 'Welcome！';
                        }
                        SendRongSystem($rong_user,$tis);

                        if(!$user_info['code_user']){
                            if($share_user_id){
                                //绑定邀请人
                                $bind_status = BindCodeUser($share_user_id,$user_info['id']);
                            }
                        }


                        //注册增加积分
                        //$add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'5',$user_info['id']);
                        //注册获得东西
                        $add_status = RegGetTask($user_info['id']);
                        SendNoticeUser($user_info['id']);
                        $arr = array(
                            'code'=> 1,
                            'res'=>'绑定成功',
                            'token'=>$user_info['token'],
                            'user_id'=>$user_info['id'],
                            'name'=>$user_info['name'],
                            'head'=>$user_info['head'],
                            'is_code'=>$user_info['is_code'],
                            'is_info'=>$user_info['is_info'],
                        );
                    }
                }else{
                    $add['name'] = $wx_info['name'];
                    $add['head'] = $wx_info['head'];
                    $add['sex'] = $wx_info['sex'];
                    $add['country'] = $wx_info['country'];
                    $add['province'] = $wx_info['province'];
                    $add['city'] = $wx_info['city'];
                    $add['phone'] = $phone;
                    $add['ali_user_id'] = $wx_info['ali_user_id'];
                    if ($push_id){
                        $add['push_id'] = $push_id;
                    }
                    $add['token'] = md5('xuan_yimei_User'.$phone.time());
                    $add['create_time'] = time();
                    //$add['phone_at'] = '1';
                    $add['signature'] = '听说有个签名，今年会有桃花运';
                    $query = $user->add($add);
                    if ($query){
                        if(!$wx_info['name']){
                            $save_rong['name'] = '用户_'.$query;
                        }
                        //融云token
                        $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                        $result = $RongCloud->user()->getToken($query, $add['name'],$add['head']);
                        $rongres =  json_decode($result,true);
                        if($result){
                            $save_rong['rong_token'] = $rongres['token'];
                            $save_rong['update_time'] = time();
                            $user->where(array('id'=>$query))->save($save_rong);
                        }

                        if($share_user_id){
                            //绑定邀请人
                            $bind_status = BindCodeUser($share_user_id,$query);
                        }

                        $rong_user[] = $query;
                        $tis = 'Welcome！';
                        // SendRongSystem($rong_user,$tis);

                        if($type=='2'){
                            $ali->where(array('id'=>$wx_info['id']))->save(array('user_id'=>$query,'update_time'=>time()));
                        }else{
                            $wx->where(array('id'=>$wx_info['id']))->save(array('user_id'=>$query,'update_time'=>time()));
                        }
                        //赠送优惠券
                       /* $give_list =  M('ticket')->where(array('type'=>'2','is_give'=>'1'))->select();
                        if($give_list){
                            $add_ticket['user_id'] = $query;
                            $add_ticket['buy_money'] = 0;
                            $add_ticket['rebate_money'] = 0;
                            $add_ticket['create_time'] = time();
                            foreach ($give_list as $item){
                                $add_ticket['parent'] = $item['id'];
                                $add_ticket['discount'] = $item['discount'];
                                M('ticket_user')->add($add_ticket);
                            }
                        }*/


                        //注册增加积分
                        //$add_status = AddScore($query,0,0,'5',$query);

                        //注册获得东西
                        $add_status = RegGetTask($query);

                        $rong_user[] = $query;
                        $tis = 'Welcome！';
                        SendRongSystem($rong_user,$tis);
                        SendNoticeUser($query);
                        $arr = array(
                            'code'=> 1,
                            'res'=>'绑定成功',
                            'token'=>$add['token'],
                            'user_id'=>$query,
                            'name'=>$add['name'],
                            'head'=>$add['head'],
                            'is_code'=>'0',
                            'is_info'=>'0',
                        );
                    }else{
                        $arr = array(
                            'code'=> 0,
                            'res'=>'绑定失败'
                        );
                    }


                }

            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'unionid错误'
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 填写邀请码（不填写也需访问）
     */
    function Bindcode(){
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $code = decrypt1(trim(I('post.code')));


        $user = M('user');


        //$token = '294b2427f12500c5d2069518d9a7e723';
        //$code = '14718171817';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($user_info['code']){
            $arr = array(
                'code'=> 0,
                'res'=>'已填写邀请码',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if ($code){

            $is_code = $user->where(array('phone'=>$code))->field('id,score,level,parent,team_id')->find();
            if ($is_code){
                if ($is_code['id']==$user_info['id']){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'不能绑定自己',
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }else{
                    $save['code'] = $code;
                    if (!$user_info['code_user']){
                        $save['code_user'] = $is_code['id'];
                    }
                    $save['is_code'] = '1';
                    $save['update_time'] = time();
                    $query = $user->where(array('id'=>$user_info['id']))->save($save);
                    if ($query){
                        //邀请好友增加积分
                        $add_status = AddScore($is_code['id'],$is_code['score'],$is_code['level'],'6',$user_info['id']);

                        $arr = array(
                            'code'=> 1,
                            'res'=>'操作成功',
                            'is_info'=>$user_info['is_info'],
                        );
                    }else{
                        $arr = array(
                            'code'=> 0,
                            'res'=>'绑定失败',
                        );
                    }
                }
            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'邀请码错误',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

        }else{
            $user->where(array('id'=>$user_info['id']))->save(array('is_code'=>'1','update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>'操作成功',
                'is_info'=>$user_info['is_info'],
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }




    /**
     * 修改密码发送验证码
     */
    public function SendEditCode(){
        DeleteOldCode();
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));

        if(!$phone){
            $arr = array(
                'code'=> 0,
                'res'=> '请输入手机号'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if(strlen($phone)!=11){
            $arr = array(
                'code'=> 0,
                'res'=> '手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        //实例化数据表
        $user = M('user');
        $verify = M('verify');


        $is_reg = $user->where(array('phone'=>$phone))->find();


        if(!$is_reg){
            $arr = array(
                'code'=> 0,
                'res'=>'该手机号未注册'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            if($is_reg['is_freeze']=='0'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $rand = rand(100000,999999);
            //$rand =123456;

            //$uid = "2255";
            //$passwd = "7fdf6096659ff66beaba43046368a020";
            $content = "您的验证码为：".$rand."，为了保护您的账户安全，验证码请勿转发他人，有效时间15分钟。【伊美小天鹅】";
            //$url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=".$phone."&content=".$content;
            //$html = file_get_contents($url);
            //$result = json_decode($html,true);

            $params = array();
            $params['account'] = 'N4419285';
            $params['password'] = 'js8S0k5BD';
            $params['msg'] = $content;
            $params['phone'] = $phone;
            $params['sendtime'] = (String)date('YmdHi');
            $params['report'] ='true';
            $params['extend'] ='243322';
            $params['uid'] = (String)time();

            $params = json_encode($params);
            //dump($params);die;
            $url = 'http://smssh1.253.com/msg/send/json';

            //$con = SendPost('http://api.1cloudsp.com/api/v2/send',$params);
            $con = SendPost($url,$params);

            //$url = "http://api.1cloudsp.com/api/v2/send?".$params; //提交的url地址
            //$con= file_get_contents($url);
            $result = json_decode($con,true);

            if($result['code'] == 0){
                M('set')->where(array('set_type'=>'sms_code_num'))->setDec('set_value',1);
                $where['phone'] = $phone;
                $where['type'] = 2;
                $is_code = $verify->where($where)->find();
                if($is_code){
                    $save['code'] = $rand;
                    $save['create_time'] = time();
                    $verify->where(array('id'=>$is_code['id']))->save($save);
                }else{
                    $add['code'] = $rand;
                    $add['phone'] = $phone;
                    $add['type'] = 2;//注册，2修改密码
                    $add['create_time'] = time();
                    $verify->add($add);
                }

                $arr = array(
                    'code'=> 1,
                    'res'=>'发送成功',
                    'phone'=>$phone
                );

            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'发送失败',
                    'phone'=>$phone
                );

            }

            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

    }








    /**
     * 修改密码验证手机验证码
     */
    function EditPassCheckCode(){
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        $code = decrypt1(trim(I('post.code')));

        //实例化数据表
        $user = M('user');
        $verify = M('verify');

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$code)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(!is_numeric($phone) || strlen($phone)<8){
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $is_reg = $user->where(array('phone'=>$phone))->find();
        if(!$is_reg){
            $arr = array(
                'code'=> 0,
                'res'=>'该手机号码未注册'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_code['code'] = $code;
        $where_code['phone'] = $phone;
        $where_code['type'] = 2;
        $is_code = $verify->where($where_code)->order('create_time desc')->find();
        if(!$is_code){
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            $arr = array(
                'code'=> 1,
                'res'=>'验证码正确'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

    }


    /**
     * 修改登陆密码/忘记登陆密码
     */
    function UserEditPassword(){
        //接收数据
        $phone = decrypt1(trim(I('post.phone')));
        $code = decrypt1(trim(I('post.code')));
        $password = decrypt1(trim(I('post.password')));

        //实例化数据表
        $user = M('user');
        $verify = M('verify');

        //删除15分钟前验证码
        $min15 = time()-900;
        $verify->where(array('create_time'=>array('ELT',$min15)))->delete();


        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$code)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(strlen($password)>16 || strlen($password)<6){
            $arr = array(
                'code'=> 0,
                'res'=>'密码长度为6-16'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$password)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'密码由字母、数字、下划线或@、#组成'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(!is_numeric($phone) || strlen($phone)<8){
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $is_reg = $user->where(array('phone'=>$phone))->find();
        if(!$is_reg){
            $arr = array(
                'code'=> 0,
                'res'=>'没有该手机号'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($is_reg['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $where_code['code'] = $code;
        $where_code['phone'] = $phone;
        $where_code['type'] = 2;
        $is_code = $verify->where($where_code)->order('create_time desc')->find();
        if(!$is_code){
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //添加新用户
        //$save['phone'] = $phone;
        $save['token'] = md5('xuan_yixiang_User'.$phone.time());
        $save['password'] = md5($password);
        $save['update_time'] = time();
        $query = $user->where(array('id'=>$is_reg['id']))->save($save);

        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'修改成功',
                'token'=>$save['token'],
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'修改失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    function aestest(){
        $test = decrypt1(trim(I('post.test')));
        $test2 = I('post.test');
        $list['data'] = $_REQUEST;
        $list['post'] = $_POST;
        $list['test2'] = $test2;

        $add['content'] = json_encode($list);
        M('test')->add($add);
        if($test){
            $arr = array(
                'code'=> 1,
                'res'=>'解析成功',
                'content'=>$test,
                'content2'=>$test2,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'解析失败',
                'content'=>$test,
                'content2'=>$test2,
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    function aes2(){
        $a = "我是测试加解密的明文";
        $my = encrypt1($a);
        $hai = "OZcrLiPRKkQJ1rFIOrtxp+ECi97oRwkjaNV213OajX0=";
        dump($my);
        dump($hai);
    }


    /**
     *首页
     */
    function HomeData(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $check_type = decrypt1(trim(I('post.check_type')));//分类:1附近医院，2附近医生
       /* $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 10;//分页数
        $start = ($page-1)*$num;*/
        if(!$check_type){$check_type='1';}
        //if(!$scope){$scope = 2500;}
        $scope = 25000;

        $splendid = M('splendid');
        $hospital = M('hospital');
        $user = M('user');
        $set = M('set');
        $banner = M('banner');
        $user_blogs = M('user_blogs');
        $shop_goods = M('shop_goods');
        $leave = M('leave');
        $leave_num = 0;
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                if(!$user_info['rebate_city']){
                    $lng_lat = $lng.','.$lat;
                    $city_id = getaddress($lng_lat);
                    $save['rebate_city'] = $city_id;
                }
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
            $leave_num += $leave->where(array('user_id'=>$user_info['id'],'is_read'=>'0','type'=>'2'))->count();

        }
        if($leave_num>99){$leave_num=99;}
        $leave_num = (String)$leave_num;

        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x
        $Dao = M();


        if($check_type=='1'){
            $where2 = "WHERE `is_show` = 1 AND `status`= 1 AND `classify`!= 13";
            // 加入排序，从最近到最近排序。
            $sql2 = "select id,lat,lng,name,hospital_id,logo, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop ".$where2." having dis <".$scope." ORDER BY sort desc,dis asc limit 0,6";

            $hospital_list = $Dao->query($sql2);
            foreach($hospital_list as $key=>$item){
                $hospital_list[$key]['dis'] = MiZhuanhuan($item['dis']);

                if ($item['hospital_id']){
                    $hospital_info = $hospital->where(array('id'=>$item['hospital_id']))->field('id,logo,classify')->find();
                    $hospital_list[$key]['logo'] = $hospital_info['logo'];
                }else{
                    if (!$item['logo']){
                        $hospital_list[$key]['logo'] = XUANIP.'/shop_logo.jpg';
                    }
                }
            }
            $doctor_list = array();
        }else{
            $where2 = "WHERE `is_show` = 1";

            // 加入排序，从最近到最近排序。
            $sql2 = "select id,lat,lng,name,head, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_doctor ".$where2." having dis <".$scope." ORDER BY dis asc limit 0,6";

            $doctor_list = $Dao->query($sql2);
            foreach($doctor_list as $key=>$item){
                $doctor_list[$key]['dis'] = MiZhuanhuan($item['dis']);
            }
            $hospital_list = array();
        }

        $banner_list = $banner->where(array('is_show'=>'1','show_type'=>'1'))->order('sort,create_time desc')->field('id,img_url,type,to_url')->select();
        foreach($banner_list as $key=>$item){
            if(!$item['to_url']){
                $banner_list[$key]['to_url'] = '';
            }
        }
        $verb_list = M('home_verb')->where(array('is_show'=>'1'))->limit(3)->order('sort,create_time desc')->field('id,img_url,type,to_url')->select();
        foreach($verb_list as $key=>$item){
//            if($user_info['id'] ==4 || $user_info['id']==5|| $user_info['id']==1){
//                if($key==0){
//                    $verb_list[$key]['type'] = '8';
//                }
//                if($key==1){
//                    $verb_list[$key]['type'] = '8';
//                }
//                if($key==2){
//                    $verb_list[$key]['type'] = '9';
//                }
//            }

            if(!$item['to_url']){
                $verb_list[$key]['to_url'] = '';
            }
        }
        $user_blogs_photo = M('user_blogs_photo');
        //精彩推荐
        $splendid_list = $splendid->where(array('is_show'=>'1'))->order('rand()')->field('id,type,type_id')->select();
        foreach ($splendid_list as $key=>$item){
            if($item['type']=='1'){
                $type_info = $user_blogs->where(array('id'=>$item['type_id']))->field('content,type,video_thumb')->find();
                if ($type_info['type']=='1'){
                    $img_val = $user_blogs_photo->where(array('blogs_id'=>$item['type_id']))->order('id')->find();
                    $splendid_list[$key]['cover'] = $img_val['img_url'];
                }else{
                    $splendid_list[$key]['cover'] = $type_info['video_thumb'];
                }

                $splendid_list[$key]['price'] = '';
                $splendid_list[$key]['name'] = $type_info['content'];
                $splendid_list[$key]['blogs_type'] = $type_info['type'];
            }else{
                $type_info = $shop_goods->where(array('id'=>$item['type_id']))->field('cover,price,name')->find();
                $splendid_list[$key]['cover'] = $type_info['cover'];
                $splendid_list[$key]['price'] = $type_info['price'];
                $splendid_list[$key]['name'] = $type_info['name'];
                $splendid_list[$key]['blogs_type'] = '';
            }
        }


        $set_icon = $set->where(array('set_type'=>'home_icon'))->find();
  /*
        $show_ad['is_show'] = '0';
        $show_ad['show_time'] = '0';
        $show_ad['type'] = '0';
        $show_ad['url'] = '0';

        $set_show = $set->where(array('set_type'=>'home_show_ad'))->find();
        if($set_show['set_value']=='1'){
            $is_add = true;
            if($token){
               $is_have_read = M('home_read')->where(array('user_id'=>$user_info['id']))->find();
                if($is_have_read){
                    $is_add = false;
                }
            }
            if($is_add){
                $show_info = json_decode($set_show['remark'],true);
                $show_ad['is_show'] = '1';
                $show_ad['show_time'] = $show_info['show_time'];
                $show_ad['type'] = $show_info['type'];
                $show_ad['url'] = $show_info['url'];
            }
        }*/

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'leave_num'=>$leave_num,
            'made_icon'=>$set_icon['set_value'],
            'banner_list'=>$banner_list,
            'verb_list'=>$verb_list,
            'doctor_list'=> $doctor_list,
            'hospital_list'=> $hospital_list,
            'splendid_list'=> $splendid_list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     *付款给店铺-基础信息
     */
    function ShopPayInfo(){
        $user = M('user');
        $hospital_order = M('hospital_order');
        $pay_ad = M('pay_ad');
        $shop = M('shop');
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        //$token = 'bf8739cb479fa5d17c98dfbb7beb1452';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('id'=>$shop_id))->find();
//        if(!$shop_info['hospital_id']){
//            $arr = array(
//                'code'=> 0,
//                'res'=>'机构未绑定医院，无法直接使用此功能'
//            );
//            $data = json_encode($arr);
//            $return['encryption'] =  encrypt1($data);
//            $this->ajaxReturn($return,"JSON");
//        }

        $where_order['parent'] = $shop_info['hospital_id'];
        $where_order['user_id'] = $user_info['id'];
        $where_order['create_type'] = 2;
        $where_order['status'] = 1;
        $is_order = $hospital_order->where($where_order)->count();
        if($is_order>0){
            $is_have = '1';
        }else{
            $is_have = '0';
        }

        $ad_info['is_show'] = '0';
        $ad_info['type'] = '0';
        $ad_info['img_url'] = '';
        $ad_info['to_url'] = '';
        $is_banner = $pay_ad->where(array('is_show'=>'1'))->order('rand()')->find();
        if($is_banner){

            $ad_info['is_show'] = '1';
            $ad_info['type'] = $is_banner['type'];
            $ad_info['img_url'] = $is_banner['img_url'];
            if($is_banner['to_url']){
                $ad_info['to_url'] = $is_banner['to_url'];;
            }
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'is_have'=>$is_have,
            'shop_name'=>$shop_info['name'],
            'ad_info'=>$ad_info,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 订单-购买保险地址
     */
    function NounUrlList(){
        $user = M('user');

        $noun = M('noun');
        $order_bx = M('order_bx');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$shop_id = '4';
        //$order_id = '75';
        //$type = '3';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$type) {$arr = array('code' => 0, 'res' => '参数错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($type!='3'){
            if (!$order_id) {$arr = array('code' => 0, 'res' => '请传入订单ID');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $list = $noun->where(array('is_show'=>'1'))->order('sort')->field('id as noun_id,name,title,cover,info,money')->select();
            $where_buy['type'] = $type;
            $where_buy['order_id'] = $order_id;
        }else{
            $order_id = 0;
            $list = $noun->where(array('type'=>'2','is_show'=>'1'))->order('sort')->field('id as noun_id,name,title,cover,info,money')->select();
            //$list = $noun->field('id as noun_id,name,cover,info,money')->select();

        }
        $where_buy['user_id'] = $user_info['id'];
        $buy_list= $order_bx->where($where_buy)->field('id,parent')->limit(3)->select();
        if($buy_list){
            foreach ($buy_list as $key=>$item){
                $noun_info = $noun->where(array('id'=>$item['parent']))->find();
                $buy_list[$key]['title'] = $noun_info['title'];
                $buy_list[$key]['name'] = $noun_info['name'];
                $buy_list[$key]['info'] = $noun_info['info'];
                $buy_list[$key]['cover'] = $noun_info['cover'];
                $buy_list[$key]['money'] = $noun_info['money'];
                $buy_list[$key]['url'] = XUANIP.'/home/shopshow/pingan/type/4/token/'.$user_info['token'].'/check_id/'.$item['id'];
            }
        }else{
            $buy_list = array();
        }

        foreach ($list as $key=>$item){
            $list[$key]['url'] =  XUANIP.'/home/shopshow/pingan/noun_id/'.$item['noun_id'].'/type/'.$type.'/token/'.$user_info['token'].'/order_id/'.$order_id;
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'buy_list'=>$buy_list,
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 订单-查看已购买保险
     */
    function OrderNounList(){
        $user = M('user');

        $order_bx = M('order_bx');
        $noun_name = M('noun_name');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$shop_id = '4';
        //$order_id = '1';
        //$type = '1';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if (!$order_id) {$arr = array('code' => 0, 'res' => '请传入订单ID');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$type) {$arr = array('code' => 0, 'res' => '参数错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $name_list = $noun_name->select();
        foreach ($name_list as $item){
            $new_name[$item['key']] = $item['name'];
        }


        $where['type'] = $type;
        $where['order_id'] = $order_id;
        $where['user_id'] = $user_info['id'];
        $list = $order_bx->where($where)->field('id,key,create_time,type,order_id')->select();

        foreach ($list as $key=>$item){
            $list[$key]['date'] = date('Y-m-d',$item['create_time']);
            $list[$key]['time'] = date('H:i:s',$item['create_time']);

            if($new_name[$item['key']]){
                $list[$key]['name'] = $new_name[$item['key']];
            }else{
                $list[$key]['name'] = '平安医疗美容意外保险';
            }
            $list[$key]['url'] =  XUANIP.'/home/shopshow/pingan/show_type/3/type/'.$item['type'].'/order_id/'.$item['order_id'].'/token/'.$token.'/check_id/'.$item['id'];

        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 付款给店铺-定金或全额基础信息
     */
    function ShopPayAllORrepay(){
        $user = M('user');

        $shop = M('shop');
        $hospital = M('hospital');
        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$order_id = decrypt1(trim(I('post.qr_val')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1全额或定金，2尾款
        $order_id = decrypt1(trim(I('post.order_id')));

        //$page = decrypt1(trim(I('post.page')));
        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$shop_id = '4';
        //$order_id = '75';
        //$type = '2';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('id'=>$shop_id))->find();
//        if(!$shop_info['hospital_id']){
//            $arr = array(
//                'code'=> 0,
//                'res'=>'机构未绑定医院，无法直接使用此功能'
//            );
//            $data = json_encode($arr);
//            $return['encryption'] =  encrypt1($data);
//            $this->ajaxReturn($return,"JSON");
//        }
        $list['shop_name'] = $shop_info['name'];
        $list['classify'] = $shop_info['classify'];
        $list['logo'] = $shop_info['logo'];

        $list['usable_score'] = $user_info['score'];
        $list['pay_money'] = '0';
        $list['max_score'] = '0';
        if($shop_info['classify']=='11'){
            $list['is_noun'] = '1';
        }else{
            $list['is_noun'] = '0';
        }
        $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
        $list['noun_money'] = $noun_money['set_value'];
        if($type=='2'){
            $order_info = $hospital_order->where(array('id'=>$order_id))->find();


            if(!$order_info){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请传入要查看的订单'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $list['pay_money'] = $order_info['need_money'];
            $where_bx['order_id'] = $order_info['id'];
            $where_bx['type'] = 2;
            $is_bx = M('order_bx')->where($where_bx)->count();
            if($order_info['total_money']>=$noun_money['set_value']){
                if($is_bx>0){
                    $list['is_noun'] = '2';
                }
            }else{
                $list['is_noun'] = '0';
            }
            $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
            $socre_max = $set->where(array('set_type'=>'score_use_max'))->find();
            $max_money1 = $order_info['total_money'] *($socre_max['set_value']/100);
            $max_money = floor($max_money1);
            $max = ($max_money/$socre_num['remark'])*$socre_num['set_value'];
            /*if ($user_info['score']>$max) {
                $list['usable_score'] = $max;
            }*/
            $list['max_score'] = (String)$max;
        }
        $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
        $score_use_max = $set->where(array('set_type'=>'score_use_max'))->find();

        $list['rule_score']  = $socre_num['set_value'];
        $list['rule_money']  = $socre_num['remark'];
        $usable_list = array();
        $ticket_num = 0;
        $t_list = $ticket_hospital
            ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
            ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price')
            ->where(array('lyx_ticket_hospital.hospital_id'=>$shop_info['id'],'lyx_ticket.type'=>array('IN','1,3'),'lyx_ticket.use_type'=>array('IN','1,3'),'lyx_ticket.ticket_type'=>1))
            ->select();
        if($t_list){
            foreach ($t_list as $item){
                $t_arr[] = $item['ticket_id'];
            }
            $t_val = implode(',',$t_arr);
            $where_t['lyx_ticket_user.user_id']= $user_info['id'];
            $where_t['lyx_ticket_user.status']= 0;
            $where_t['lyx_ticket.type']= array('IN','1,3');
            $where_t['lyx_ticket_user.parent']= array('IN',$t_val);
            if($type==2){
                $where_t['lyx_ticket.use_type']= 1;
            }
            $usable_list = $ticket_user
                ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                ->field('lyx_ticket_user.id as have_id,lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket_user.discount')
                ->where($where_t)
                ->select();
            if($type=='2'){
                foreach ($usable_list as $key=>$item){
                    $usable_list[$key]['discount'] = (String)($item['discount']/10);
                    $js_dis = $item['discount']/100;
                    $jian = ($order_info['total_money'] - $order_info['cost'])*$js_dis;
                    $usable_list[$key]['ticket_money'] = (String)($jian-$order_info['loans']+$order_info['cost']);
                    if ($usable_list[$key]['ticket_money']<=0){
                        unset($usable_list[$key]);
                    }
                }
            }
            $ticket_num += count($usable_list);
        }
        $list['usable_ticket'] = (String)$ticket_num;

        if(!$list['pay_money']){
            $list['pay_money'] = '0';
        }
        $list['score_use_max'] = $score_use_max['set_value'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
            'is_agent'=>$user_info['is_agent'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 支付金额为0的订单
     */
    function PayNoMoneyOrder(){
        $shop = M('shop');
        $user = M('user');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

    }

    /**
     * 付款给店铺-选择优惠券
     */
    function ShopPayOrderTicket(){
        $user = M('user');
        $shop = M('shop');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $hospital_order = M('hospital_order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $money = decrypt1(trim(I('post.money')));
        $cost = decrypt1(trim(I('post.cost')));
        $loans = decrypt1(trim(I('post.loans')));
        $type = decrypt1(trim(I('post.type')));//查看类型： 1支付全额，2使用项目券，3支付尾款
        $order_id = decrypt1(trim(I('post.order_id')));//查看类型： 1支付全额，2使用项目券，3支付尾款

        //$token = "38e59920c3837c2f1e7606c78551c12c";
         //$type = '2';
        //$shop_id = '4';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $shop_info = $shop->where(array('id'=>$shop_id))->find();
//        if(!$shop_info['hospital_id']){
//            $arr = array(
//                'code'=> 0,
//                'res'=>'机构未绑定医院，无法直接使用此功能'
//            );
//            $data = json_encode($arr);
//            $return['encryption'] =  encrypt1($data);
//            $this->ajaxReturn($return,"JSON");
//        }


        $usable_list = array();


        if($type=='2'){
            $t_list = $ticket_hospital
                ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
                ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                ->where(array('lyx_ticket_hospital.hospital_id'=>$shop_info['id'],'lyx_ticket.use_type'=>2,'lyx_ticket.ticket_type'=>1))
                ->select();
        }else{
            $t_list = $ticket_hospital
                ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
                ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                ->where(array('lyx_ticket_hospital.hospital_id'=>$shop_info['id'],'lyx_ticket.type'=>array('IN','1,3'),'lyx_ticket.use_type'=>array('IN','1,3'),'lyx_ticket.ticket_type'=>1))
                ->select();
        }
        if($type=='1'){
            if($t_list){
                foreach ($t_list as $item){
                    $t_arr[] = $item['ticket_id'];
                }
                $t_val = implode(',',$t_arr);
                $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
                $where_t['lyx_ticket.type']= array('IN','1,3');
                $where_t['lyx_ticket.use_type']= array('IN','1,3');
                $where_t['lyx_ticket.ticket_type']= 1;
                $where_t['lyx_ticket_user.parent']= array('IN',$t_val);
                $usable_list = $ticket_user
                    ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                    ->where($where_t)
                    ->field('lyx_ticket_user.id as have_id,lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket_user.discount,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                    ->select();

                foreach ($usable_list as $key=>$item){
                    $usable_list[$key]['is_use'] = '1';
                    if($item['use_type']==1){
                        $usable_list[$key]['discount'] = (String)($item['discount']/10);
                        $js_dis = $item['discount']/100;
                        $jian = ($money - $cost)*$js_dis;
                        $usable_list[$key]['ticket_money'] = (String)($jian-$loans+$cost);
                    }else{
                        $usable_list[$key]['use_type'] = '2';
                        $usable_list[$key]['ticket_money'] = (String)($money-$loans-$item['discount']);
                    }

                       if ($usable_list[$key]['ticket_money']<0){
                           $usable_list[$key]['ticket_money']  = '0';
                        }

                }
            }
        }else{
            if($t_list){
                foreach ($t_list as $item){
                    $t_arr[] = $item['ticket_id'];
                }
                $t_val = implode(',',$t_arr);
                $where_t['lyx_ticket_user.parent']= array('IN',$t_val);
                if ($type=='2'){
                    $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                    $where_t['lyx_ticket_user.status']= 0;
                    $where_t['lyx_ticket.use_type']= 2;
                    $where_t['lyx_ticket.ticket_type']= 1;
                }else{
                    $order_info = $hospital_order->where(array('id'=>$order_id))->find();
                    $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                    $where_t['lyx_ticket_user.status']= 0;
                    $where_t['lyx_ticket.type']= array('NEQ','2');
                    $where_t['lyx_ticket.use_type']= array('IN','1,3');
                    $where_t['lyx_ticket.ticket_type']= 1;
                }
                $usable_list = $ticket_user
                    ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                    ->where($where_t)
                    ->field('lyx_ticket_user.id as have_id,lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket_user.discount,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                    ->select();

                foreach ($usable_list as $key=>$item){
                    $usable_list[$key]['is_use'] = '1';
                    $usable_list[$key]['discount'] = '0';
                    $usable_list[$key]['ticket_money'] = '0';
                    if($type=='3'){
                        if($item['use_type']==1){
                            $usable_list[$key]['discount'] = (String)($item['discount']/10);
                            $js_dis = $item['discount']/100;
                            $jian = ($order_info['total_money'] - $cost)* $js_dis;
                            $usable_list[$key]['ticket_money'] = (String)($jian-$loans+$cost);

                        }else{
                            $usable_list[$key]['ticket_money'] = (String)($order_info['need_money']-$item['discount']);

                        }
                        if ($usable_list[$key]['ticket_money']<=0){
                           unset($usable_list[$key]);
                        }
                    }
                }
            }
        }



        foreach ($t_list as $key=>$item){
            $t_list[$key]['discount'] = (String)($item['discount']/10);
            if($item['is_show']==0){
                unset($t_list[$key]);
            }

        }
        $usable_list = array_merge($usable_list);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'usable_list'=>$usable_list,
            'ticket_list'=>$t_list
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 付款给店铺-支付负金额订单
     */
    function PayHospitalFu(){
        $user = M('user');
        $shop = M('shop');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $set = M('set');
        $hospital_order = M('hospital_order');
        $ticket = M('ticket');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $money = decrypt1(trim(I('post.money')));
        $cost = decrypt1(trim(I('post.cost')));
        $loans = decrypt1(trim(I('post.loans')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $have_id = decrypt1(trim(I('post.have_id')));
        $score = decrypt1(trim(I('post.score')));

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$order_id = '2';
        //$loans = '99.9';
        //$cost = '10';
        //$money = '99.9';
        //$shop_id = '4';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $shop_info = $shop->where(array('id'=>$shop_id))->find();
//        if(!$shop_info['hospital_id']){
//            $arr = array(
//                'code'=> 0,
//                'res'=>'机构未绑定医院，无法直接使用此功能'
//            );
//            $data = json_encode($arr);
//            $return['encryption'] =  encrypt1($data);
//            $this->ajaxReturn($arr,"JSON");
//        }

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();

        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

       // if ($order_info['use_type']!='1') {$arr = array('code' => 0, 'res' => '订单信息错误10021');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($order_info['status']>1) {$arr = array('code' => 0, 'res' => '订单信息错误1003');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($order_info['create_type']!='2') {$arr = array('code' => 0, 'res' => '订单信息错误10041');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if($order_info['status']=='1'){
            $money = $order_info['total_money'];
        }else{
            if ($money<=0) {$arr = array('code' => 0, 'res' => '订单总金额不能为0');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        if ($have_id){
            $is_have = $ticket_user->where(array('id'=>$have_id))->find();

            if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $where_use['lyx_ticket.price'] = 0;
            $where_use['lyx_ticket_user.user_id'] = $user_info['id'];
            $where_use['lyx_ticket_user.status'] = array('IN','1,2');
            $is_have_use = $ticket_user
                ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                ->where($where_use)
                ->field('lyx_ticket_user.id')->find();
            if ($is_have_use) {$arr = array('code' => 0, 'res' => '已使用过同类型免费优惠券，无法重复使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $where_check['hospital_id'] = $order_info['shop_id'];
            $where_check['ticket_id'] = $is_have['parent'];
            $where_check['ticket_type'] = 1;
            $is_use = $ticket_hospital->where($where_check)->find();
            if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前医院使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


            if($is_have['use_type']==1){
                $odds = $is_have['discount']/100;
                $pay_money1 = (bcsub($money,$cost,2)) * $odds;
            }else{
                $pay_money1 = $money - $is_have['discount'];
            }
            $pay_money = $pay_money1 - $loans + $cost;
            $ticket_info = $ticket->where(array('id'=>$is_have['parent']))->find();
            if ($ticket_info['use_type']=='2') {$arr = array('code' => 0, 'res' => '参数错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $save['ticket_id'] = $have_id;
            $save['ticket_money'] = bcsub($money , $pay_money,2);
        }else{
            $pay_money = bcsub($money , $loans,2);
        }

        if ($score){
            $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
            $socre_max = $set->where(array('set_type'=>'score_use_max'))->find();
            if ($score < $socre_num['set_value']) {$arr = array('code' => 0, 'res' => '最低使用'.$socre_num['set_value'].'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($score%$socre_num['set_value']!=0) {$arr = array('code' => 0, 'res' => '积分只能输入'.$socre_num['set_value'].'或其倍数');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $max_money1 = $money *($socre_max['set_value']/100);
            $max_money = floor($max_money1);
            $max = ($max_money/$socre_num['remark'])*$socre_num['set_value'];


            if ($score>$max) {$arr = array('code' => 0, 'res' => '此订单最大使用'.$max.'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $bei = $score/$socre_num['set_value'];
            $score_money = $bei*$socre_num['remark'];

            $pay_money -= $score_money;

            $save['score'] = $score;
            $save['score_money'] = $score_money;
        }
        if($order_info['status']==1){
            $pay_money -= $order_info['money'];
        }
        if ($pay_money>0) {$arr = array('code' => 0,'res' => '订单参数错误10031');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $save['total_money'] = $money;
        $save['loans'] = $loans;
        $save['cost'] = $cost;
        $save['pay_money'] = $pay_money;
        $save['status'] = 2;
        $save['status'] = 2;
        $save['money_type'] = 2;
        $save['fan_status'] = 1;
        $save['is_loans'] = 1;
        $save['update_time'] = time();
        $query = $hospital_order->where(array('id'=>$order_id))->save($save);
        if($query){
            M('hospital')->where(array('id'=>$order_info['parent']))->setInc('subscribe',1);
            M('doctor')->where(array('id'=>$order_info['doctor_id']))->setInc('subscribe',1);

            if($score){
                $user->where(array('id'=>$order_info['user_id']))->setDec('score',$score);
                //减去积分
                $add_log['user_id'] = $order_info['user_id'];
                $add_log['add_or_del'] = 2;
                $add_log['type'] = 2;
                $add_log['num'] = $score;
                $add_log['order_id'] = $order_info['id'];
                $add_log['create_time'] = time();
                M('shop_score_log')->add($add_log);
            }
            if($have_id){
                M('ticket_user')->where(array('id'=>$have_id))->save(array('status'=>'1','update_time'=>time()));
            }
            $arr = array(
                'code'=> 1,
                'res'=>'支付成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'支付失败',
            );
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 付款给店铺-尾款订单
     */
    function ShopPayNoPayList(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $doctor = M('doctor');
        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));

        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$order_id = '1';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('id'=>$shop_id))->find();
        if(!$shop_info['hospital_id']){
            $shop_info['hospital_id'] = 0;
        }
        $where['lyx_hospital_order.parent'] = $shop_info['hospital_id'];
        $where['lyx_hospital_order.user_id'] = $user_info['id'];
        $where['lyx_hospital_order.status'] = 1;
        $where['lyx_hospital_order.create_type'] = 2;
        $list= $hospital_order
            ->join('lyx_hospital ON lyx_hospital_order.parent = lyx_hospital.id')
            ->field('lyx_hospital_order.id as order_id,lyx_hospital_order.order_number,lyx_hospital_order.parent,lyx_hospital_order.doctor_id,
            lyx_hospital.name,lyx_hospital.classify,lyx_hospital.logo,lyx_hospital_order.money,lyx_hospital_order.status,lyx_hospital_order.total_money,
            lyx_hospital_order.refund_status,lyx_hospital_order.refund_money')
            ->where($where)->limit($start,$num)->order('lyx_hospital_order.create_time desc')->select();

        foreach($list as $key=>$item){
            $doc_name = $doctor->where(array('id'=>$item['doctor_id']))->field('name')->find();
            $list[$key]['doctor_name'] =$doc_name['name']?$doc_name['name']:"";
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    //更新医院订单的机构ID
    function UpdateHosOrderShopId(){
        $hospital_order = M('hospital_order');
        $shop = M('shop');
        $list = $hospital_order->select();
        $i = 0;
        foreach ($list as $key=>$item){
            if($item['shop_id']==0){
                $shop_info = $shop->where(array('hospital_id'=>$item['parent']))->find();
                if($shop_info){
                    $i++;
                    $save['shop_id'] = $shop_info['id'];
                    $save['update_time'] = time();
                    $hospital_order->where(array('id'=>$item['id']))->save($save);
                }

            }

        }
        dump($i);die;
    }


    /**
     * 付款给店铺-生成缓存订单
     */
    function CreateShopPayCacheOrder(){
        $user = M('user');
        $shop = M('shop');
        $set = M('set');
        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $ticket = M('ticket');
        $doctor = M('doctor');
        $hospital = M('hospital');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $money = decrypt1(trim(I('post.money')));
        $cost = decrypt1(trim(I('post.cost')));
        $loans = decrypt1(trim(I('post.loans')));
        $score = decrypt1(trim(I('post.score')));
        $have_id = decrypt1(trim(I('post.have_id')));
        $prepay = decrypt1(trim(I('post.prepay')));
        $type = decrypt1(trim(I('post.type')));//类型：1支付全额，2支付定金，3使用项目券，4支付尾款
        $order_id = decrypt1(trim(I('post.order_id')));
        $project_apply_id = decrypt1(trim(I('post.project_apply_id')));

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$money = '1000';
        //$shop_id = '4';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('id'=>$shop_id))->find();
//        if(!$shop_info['hospital_id']){
//            $arr = array(
//                'code'=> 0,
//                'res'=>'机构未绑定医院，无法直接使用此功能'
//            );
//            $data = json_encode($arr);
//            $return['encryption'] =  encrypt1($data);
//            $this->ajaxReturn($return,"JSON");
//        }

        $add['type'] = '1';
        $add['use_type'] = '1';
        $to_type = '1';
        if($type=='1'){
            if($money<1){
                $arr = array(
                    'code'=> 0,
                    'res'=>'订单总金额不能小于1元'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

            if($cost>$money){
                $arr = array('code' => 0, 'res' => '不打折金额不能大于订单总金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            if($loans>$money){
                $arr = array('code' => 0, 'res' => '贷款金额不能大于订单总金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            $hos_order_cost = M('set')->where(array('set_type'=>'hos_order_cost'))->find();
            $cost_bai = ($cost/$money)*100;
            if($cost_bai>$hos_order_cost['set_value']){$arr = array('code' => 0, 'res' => '不打折金额不能大于总金额的 '.$hos_order_cost['set_value'].' %');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $add['pay_money'] = $money-$loans;
            if($add['pay_money']<=0){
                $to_type = '4';
            }
            if  ($have_id){
                $is_have = $ticket_user->where(array('id'=>$have_id))->find();
                if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                $where_use['lyx_ticket.price'] = 0;
                $where_use['lyx_ticket_user.user_id'] = $user_info['id'];
                $where_use['lyx_ticket_user.status'] = array('IN','1,2');
                $is_have_use = $ticket_user
                    ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                    ->where($where_use)
                    ->field('lyx_ticket_user.id')->find();
                if ($is_have_use) {$arr = array('code' => 0, 'res' => '已使用过同类型免费优惠券，无法重复使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $where_check['hospital_id'] = $shop_info['id'];
                $where_check['ticket_id'] = $is_have['parent'];
                $where_check['ticket_type'] = 1;
                $is_use = $ticket_hospital->where($where_check)->find();
                if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前医院使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                $ticket_info = $ticket->where(array('id'=>$is_have['parent']))->find();
                $add['ticket_list'] = $is_have['parent'];

                    if ($ticket_info['use_type']=='3') {
                        $to_type = '2';
                        $add['use_type'] = '2';
                        $pay_money1 = $money -$is_have['discount'];
                        $pay_money = $pay_money1 - $loans + $cost;
                        if($pay_money<=0){
                            $to_type = '4';
                        }
                    }else{
                        $odds = $is_have['discount']/100;
                        $pay_money1 = ($money-$cost) * $odds;
                        $pay_money = $pay_money1 - $loans + $cost;
                        if($pay_money<=0){
                            $to_type = '4';
                        }
                        //if ($pay_money<=0) {$arr = array('code' => 0, 'res' => '此优惠券无法使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                    }
            }
            if ($score){
                $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
                $socre_max = $set->where(array('set_type'=>'score_use_max'))->find();
                if ($score < $socre_num['set_value']) {$arr = array('code' => 0, 'res' => '最低使用'.$socre_num['set_value'].'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                if ($score%$socre_num['set_value']!=0) {$arr = array('code' => 0, 'res' => '积分只能输入'.$socre_num['set_value'].'或其倍数');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $max_money1 = $money *($socre_max['set_value']/100);
                $max_money = floor($max_money1);
                $max = ($max_money/$socre_num['remark'])*$socre_num['set_value'];
                if ($score>$max) {$arr = array('code' => 0, 'res' => '此订单最大使用'.$max.'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            }
        }

        if($type=='2'){
            if($money<1){
                $arr = array(
                    'code'=> 0,
                    'res'=>'订单总金额不能小于1元'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            if ($prepay<0) {$arr = array('code' => 0, 'res' => '请输入定金');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($prepay>=$money) {$arr = array('code' => 0, 'res' => '定金金额不能大于订单总金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $add['pay_money'] = $money;
            $add['prepay_money'] = $prepay;
            if($prepay>0){
                $add['is_prepay'] = 1;
            }else{
                $add['is_prepay'] = 0;
            }
        }

        if($type=='3'){
            $add['type'] = '2';
            $add['use_type'] = '2';
            $to_type = '3';
            $money = 0;
            $cost = 0;
            $loans = 0;
            if  ($have_id){
                $is_have = $ticket_user->where(array('id'=>$have_id))->find();
                if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $ticket_info = $ticket->where(array('id'=>$is_have['parent']))->find();
                if($ticket_info['ticket_type']==3){
                    $apply = M('project_apply')->where(['id'=>$project_apply_id])->find();
                    if($apply['is_show']==0 || $apply['is_open']==0){$arr = array('code' => 0, 'res' => '项目已下架');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                    if($apply['project_id']!=$ticket_info['project_id']) {$arr = array('code' => 0, 'res' => '活动已下架');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                    $add['project_apply_id'] = $project_apply_id;
                }else{
                    $where_check['hospital_id'] = $shop_info['id'];
                    $where_check['ticket_id'] = $is_have['parent'];
                    $where_check['ticket_type'] = 1;
                    $is_use = $ticket_hospital->where($where_check)->find();
                    if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前机构使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                }
                $add['ticket_list'] = $is_have['parent'];
                if($ticket_info['use_type']!=2){
                    $arr = array('code' => 0, 'res' => '此优惠券当前订单无法使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
                }
            }else{
                $arr = array('code' => 0, 'res' => '请选择使用的优惠券');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
        }

        if($type=='4'){

            $jian_money = 0;
            $order_info  = $hospital_order->where(array('id'=>$order_id))->find();
            $save['cost'] = $cost;

            if($cost>$order_info['total_money']){
                $arr = array('code' => 0, 'res' => '不打折金额不能大于订单总金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            if($loans>$order_info['total_money']){
                $arr = array('code' => 0, 'res' => '贷款金额不能大于订单总金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }

            $hos_order_cost = M('set')->where(array('set_type'=>'hos_order_cost'))->find();
            $cost_bai = ($cost/$money)*100;
            if($cost_bai>$hos_order_cost['set_value']){$arr = array('code'=> 0, 'res'=>'不打折金额不能大于总金额的 '.$hos_order_cost['set_value'].' %');$this->ajaxReturn($arr,"JSON");}

            $save['loans'] = $loans;
            if  ($have_id){
                $is_have = $ticket_user->where(array('id'=>$have_id))->find();
                if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                $where_use['lyx_ticket.price'] = 0;
                $where_use['lyx_ticket_user.user_id'] = $user_info['id'];
                $where_use['lyx_ticket_user.status'] = array('IN','1,2');
                $is_have_use = $ticket_user
                    ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                    ->where($where_use)
                    ->field('lyx_ticket_user.id')->find();
                if ($is_have_use) {$arr = array('code' => 0, 'res' => '已使用过同类型免费优惠券，无法重复使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $where_check['hospital_id'] = $order_info['id'];
                $where_check['ticket_id'] = $is_have['parent'];
                $where_check['ticket_type'] = 1;
                $is_use = $ticket_hospital->where($where_check)->find();
                if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前医院使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
              if($is_have['use_type']==1){
                  $odds = $is_have['discount']/100;
                  $pay_money1 = ($order_info['total_money']-$cost) * $odds;
              }else{
                  $pay_money1 = $order_info['need_money']-$is_have['discount'];
              }


                $pay_money = $pay_money1 - $loans + $cost;
                //if ($pay_money<=0) {$arr = array('code' => 0, 'res' => '此优惠券无法使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $ticket_info = $ticket->where(array('id'=>$is_have['parent']))->find();
                if ($ticket_info['use_type']=='2') {$arr = array('code' => 0, 'res' => '参数错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                //$save['ticket_id'] = $have_id;
                //$save['ticket_money'] = $order_info['pay_money']  - $pay_money;
                $jian_money += $pay_money;
            }else{
                $pay_money = $order_info['pay_money'];
            }
            if ($score){
                $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
                $socre_max = $set->where(array('set_type'=>'score_use_max'))->find();
                if ($score < $socre_num['set_value']) {$arr = array('code' => 0, 'res' => '最低使用'.$socre_num['set_value'].'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                if ($score%$socre_num['set_value']!=0) {$arr = array('code' => 0, 'res' => '积分只能输入'.$socre_num['set_value'].'或其倍数');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $max_money1 = $order_info['pay_money'] *($socre_max['set_value']/100);
                $max_money = floor($max_money1);
                $max = ($max_money/$socre_num['remark'])*$socre_num['set_value'];


                if ($score>$max) {$arr = array('code' => 0, 'res' => '此订单最大使用'.$max.'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

                $bei = $score/$socre_num['set_value'];
                $score_money = $bei*$socre_num['remark'];

                $pay_money -= $score_money;
                //$save['score'] = $score;
                //$save['score_money'] = $score_money;
            }

            if($loans>=$order_info['need_money']){
                $to_type='4';
            }
            if($pay_money<=0){
                $to_type='4';
            }
            //$save['need_money'] = $order_info['need_money'] - $jian_money;
            //$save['pay_money'] = $order_info['total_money'] - $jian_money;
            $save['update_time'] = time();
        }

        $add['total_money'] = $money;
        $add['cost'] = $cost;
        $add['loans'] = $loans;
        if($loans>0){
            $add['is_loans'] = 1;
        }else{
            $add['is_loans'] = 0;
        }
        $add['status'] = 0;
        //$doctor_info = $doctor->where(array('hospital_id'=>$shop_info['hospital_id']))->order('rand()')->field('id')->find();
        $add['doctor_id'] = 0;
        $add['order_number'] = time().rand(100000,9999999);
        $add['user_id'] = $user_info['id'];
        $add['create_type'] = 2;
        $add['parent'] = $shop_info['hospital_id'];
        $add['shop_id'] = $shop_info['id'];
        $add['create_time'] = time();
        if($type!='4'){
            $query = $hospital_order->add($add);
        }else{
            $query = $hospital_order->where(array('id'=>$order_id))->save($save);
            if($query){
                $query = $order_id;
            }
        }

        if($query){
            /*if($type=='4'){
                M('ticket_user')->where(array('id'=>$have_id))->save(array('status'=>'1','update_time'=>time()));
            }*/
//            $hos_info = $hospital->where(array('id'=>$shop_info['hospital_id']))->find();
//            $qr_arr['type'] = '1';
//            $qr_arr['type_id'] = $query;
//            $qr_val = json_encode($qr_arr);
//            $content = encrypt1($qr_val);
//            $qr_url = makecode($content,$hos_info['logo']);
            //$hospital_order->where(array('id'=>$query))->save(array('qr_url'=>$qr_url));
            $arr = array(
                'code'=> 1,
                'res'=>'创建成功',
                'order_id'=>$query,
                'to_type'=>$to_type
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'创建失败',
                'order_id'=>'0',
                'to_type'=>'0',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     *首页弹出视频或图片广告弹窗后调用
     */
    function HomeShowAd(){
        $user = M('user');
        $home_read = M('home_read');
        $token = decrypt1(trim(I('post.token')));
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $where['user_id'] = $user_info['id'];
        $is_have = $home_read->where($where)->find();

        if(!$is_have){
            $add['user_id'] = $user_info['id'];
            $add['create_time'] = time();
            $home_read->add($add);
        }
        $arr = array(
            'code'=> 1,
            'res'=>'调用成功'
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     *美容日志列表
     */
    function DiaryList(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $check_type = decrypt1(trim(I('post.check_type')));//日志类型:0推荐，1其他对应分类ID，2根据日志内容搜索,3机构日志
        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $class_id = decrypt1(trim(I('post.class_id')));

        if(!$page){$page = 1;}
        //$page = 1;
        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$check_type){$check_type='0';}
        //if(!$scope){$scope = 2500;}
        $scope = 25000;
        $diary_classify = M('diary_classify');

        $class_list = $diary_classify->where(array('is_show'=>'1'))->order('sort,create_time desc')->field('id,name,logo')->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }
        if($check_type==1){
            if($class_id==0){
                $class_id = $class_list[0]['id'];
            }
        }
        $user = M('user');
        $user_blogs = M('user_blogs');

        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();



        if($check_type=='0'){

            $where_top['is_top'] = '1';
            $where_top['is_show'] = '1';
            $where_top['type'] = array('IN','1,2');
            $top_list = $user_blogs->where($where_top)->field('id,user_id,lng,lat,content,zan,browse,comment_count,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type,class_type')->find();
            if($top_list){
                $where3 = "WHERE `is_show` = 1 AND `type` IN ( 1,2 ) AND `id` !=".$top_list['id'];
            }else{
                $where3 = "WHERE `is_show` = 1 AND `type` IN ( 1,2 )";
            }




            //$desc_asc = 'ORDER BY create_time desc,dis asc';
            $desc_asc = 'ORDER BY rand(),dis asc';
            //$desc_asc = 'ORDER BY dis asc';


        }else if($check_type=='2'){
            $where3 = "WHERE `is_show` = 1 AND `type` IN ( 1,2 ) AND `content` LIKE '%".$search."%' ";
            //$desc_asc = 'ORDER BY sales desc,dis asc';
            $desc_asc = 'ORDER BY rand(),dis asc';
        }else if($check_type=='3'){
            $where3 = "WHERE `is_show` = 1 AND `type` IN ( 1,2 ) AND `shop_id` = ".$shop_id;
            //$desc_asc = 'ORDER BY sales desc,dis asc';
            $desc_asc = 'ORDER BY create_time desc,dis asc';
        }else{
            $where3 = "WHERE `is_show` = 1 AND `type` IN ( 1,2 ) AND `class_type` = ".$class_id;
            //$desc_asc = 'ORDER BY sales desc,dis asc';
            $desc_asc = 'ORDER BY rand(),dis asc';
        }

        // 加入排序，从最近到最近排序。
        $sql2 = "select id,user_id,lng,lat,content,zan,browse,comment_count,class_type,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_user_blogs ".$where3."  having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;
        $list = $Dao->query($sql2);
        if  ($page=='1' && $top_list){
            array_unshift($list,$top_list);
        }



        foreach($list as $key=>$item){
            if(!$item['video_url']){
                $list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $list[$key]['video_thumb'] = "";
            }
            if(!$item['ad_url']){
                $list[$key]['ad_url'] = "";
            }
            if(!$item['lng']){
                $list[$key]['lng'] = "";
            }

            $list[$key]['class_name'] = $new_class[$item['class_type']];

            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
            $list[$key]['name'] = $user_info2['name'];
            $list[$key]['head'] = $user_info2['head'];
            $list[$key]['sex'] = $user_info2['sex'];
            $list[$key]['age'] = $user_info2['age'];
            $list[$key]['level'] = $user_info2['level'];

            $list[$key]['create_time'] = mdate($item['create_time']);
            //点赞数
            $list[$key]['zan'] = WanChu($item['zan']);
            //评论数
            $list[$key]['comment_count'] = WanChu($item['comment_count']);
            //浏览人数
            $list[$key]['browse'] = WanChu($item['browse']);
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);
            $list[$key]['img_width'] = '0';
            $list[$key]['img_height'] = '0';
            $new_img_list = array();
            $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $key2=>$val) {
                    if ($key2==0){
                        $list[$key]['img_width'] = $val['width'];
                        $list[$key]['img_height'] = $val['height'];
                    }
                    $new_img_list[] = $val['img_url'];
                }
            }
            $list[$key]['img_list'] = $new_img_list;


            //自己是否有点赞
            $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
            if ($is_zan) {
                $list[$key]['is_zan'] = '1';
            } else {
                $list[$key]['is_zan'] = '0';
            }

            unset($list[$key]['video_icon']);

        }







        $arr = array(
            'code'=> 1,
            'res'=>$check_type.'---'.$class_id,
            'class_id'=>$class_id,
            'class_list'=>$class_list,
            'list'=> $list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     *医院列表-优惠券适用医院（共用）
     */
    function HospitalList(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//查看类型：1正常医院列表，2优惠券适用医院,3根据医院名称搜索

        $ticket_id = decrypt1(trim(I('post.ticket_id')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $check_type = decrypt1(trim(I('post.check_type')));//类型:0全部，1距离有限，2预约优先
        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));

        if(!$type){$type = '1';}
        //$search = "深圳";
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$check_type){$check_type='0';}
        if(!$scope){$scope = 2500;}

        $user = M('user');

        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();

        if($check_type=='1'){
            //$desc_asc = 'ORDER BY create_time desc,dis asc';
            $desc_asc = 'ORDER BY dis asc';
        }else if($check_type=='2'){
            $desc_asc = 'ORDER BY subscribe desc,dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }else{
            $desc_asc = 'ORDER BY sort desc,dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }

        if ($type=='2'){
            $hos_list = M('ticket_hospital')->where(array('ticket_id'=>$ticket_id,'ticket_type'=>1))->select();
            if ($hos_list){
                foreach ($hos_list as $item){
                    $id_list[] = $item['hospital_id'];
                }
                $id_val = implode(',',$id_list);
                if($search){
                    $where3 = "WHERE `is_show` = 1 AND `ticket_type` = 1 AND `id` IN ( ".$id_val.") AND `name` LIKE '%".$search."%' ";
                }else{
                    $where3 = "WHERE `is_show` = 1 AND `ticket_type` = 1 AND `id` IN ( ".$id_val.") ";
                }

            }else{
                $where3 = "WHERE `id` = 0  ";
            }

        }else if($type=='1'){
            $where3 = "WHERE `is_show` = 1 AND `ticket_type` = 1";
        }else{
            $where3 = "WHERE `is_show` = 1  AND `ticket_type` = 1 AND  `name` LIKE '%".$search."%' ";
        }



        // 加入排序，从最近到最近排序。
        $sql2 = "select id,name,lng,lat,logo,classify,subscribe,location,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_hospital ".$where3."  having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;
        $list = $Dao->query($sql2);



        foreach($list as $key=>$item){

            $list[$key]['dis'] = MiZhuanhuan($item['dis']);

        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=> $list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     *检查是否要弹出新用户/会员视频
     */
    function CheckVideoModal(){
        $user = M('user');
        $home_ad = M('home_ad');
        $home_ad_user = M('home_ad_user');
        $token = decrypt1(trim(I('post.token')));
        //$token = 'bf8739cb479fa5d17c98dfbb7beb1452';
        $type = decrypt1(trim(I('post.type')));//1新用户注册，2成为会员
        if(!$type){$type='1';}
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list['is_have'] = '1';
        $list['ad_info'] = array();

        $where_ad['status'] = $type;
        $where_ad['is_show'] = 1;
        $ad_info = $home_ad->field('img_url,ad_type,type,to_url,width,height,thumb,show_time')->where($where_ad)->find();

        if($ad_info){
            $list['ad_info'] = $ad_info;
            if($type=='1'){
                $where_ad_have['user_id'] = $user_info['id'];
                $where_ad_have['type'] = $type;
                $is_show = $home_ad_user->where($where_ad_have)->find();
                if($is_show){
                    $list['is_have'] = '0';
                }else{
                    $list['is_have'] = '1';
                }
            }else{
                if($user_info['is_agent'] == '1'){
                    $where_ad_have['user_id'] = $user_info['id'];
                    $where_ad_have['type'] = $type;
                    $is_show = $home_ad_user->where($where_ad_have)->find();
                    if($is_show){
                        $list['is_have'] = '0';
                    }else{
                        $list['is_have'] = '1';
                    }
                }else{
                    $list['is_have'] = '0';
                }
            }
        }else{
            $list['is_have'] = '0';
            $list['ad_info'] = array();
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=> $list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     *弹出新用户/会员视频后访问
     */
    function SetVideoModal(){
        $user = M('user');
        $home_ad = M('home_ad');
        $home_ad_user = M('home_ad_user');
        $token = decrypt1(trim(I('post.token')));
        //$token = 'bf8739cb479fa5d17c98dfbb7beb1452';
        $type = decrypt1(trim(I('post.type')));//1新用户注册，2成为会员
        if(!$type){$type='1';}
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $add['user_id'] = $user_info['id'];
        $add['type'] = $type;
        $add['create_time'] = time();
        $query = $home_ad_user->add($add);
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'操作成功',
            );
        }else{
            $arr = array(
                'code'=> 1,
                'res'=>'操作失败',
            );
        }



        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     *综合搜索
     */
    function TotalTypeSearch(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度


        if(!$lng){
            $lng = '114.085947';
        }
        if(!$lat){
            $lat = '22.547503';
        }



        $token = decrypt1(trim(I('post.token')));

        $type = decrypt1(trim(I('post.type')));//查看类型：0全部，1商品，2日志，3机构，4医生
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里

        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));

        if(!$type){$type = '0';}
        //$search = "医";
        if(!$page){$page = 1;}

        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$scope){$scope = 2500;}

        $user = M('user');
        $store_classify =M('store_classify');
        $hospital =M('hospital');
        $shop =M('shop');
        //$user_blogs = M('user_blogs');
        //$diary_classify = M('diary_classify');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }




        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();
        $goods_list = array();
        $shop_list = array();
        $doctor_list = array();
        $list = array();

        // 商品
        //$desc_asc = 'ORDER BY is_home desc,dis asc';
        $desc_asc_goods = 'ORDER BY dis asc';
        $where_goods = "WHERE `is_show` = 1  AND `is_del` = 0  AND `is_freeze` = 1 AND `name` LIKE '%".$search."%' ";
        // 加入排序，从最近到最近排序。

        if($type=='0'){
            if($page==1){
                $sql_goods = "select id,lat,lng,shop_id,name,cover,price,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where_goods." having dis <".$scope." ".$desc_asc_goods." limit 0,3";
                $goods_list = $Dao->query($sql_goods);
            }

        }else{
            if($type=='1'){
                $sql_goods = "select id,lat,lng,shop_id,name,cover,price,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where_goods." having dis <".$scope." ".$desc_asc_goods." limit ".$start.",".$num;
                $goods_list = $Dao->query($sql_goods);
            }

        }



        if($goods_list){
            foreach ($goods_list as $key=>$item){
                $goods_list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $shop_name = $shop->where(array('id'=>$item['shop_id']))->field('name')->find();
                $goods_list[$key]['shop_name'] = $shop_name['name'];
                $goods_list[$key]['sales'] = '销量 '.$item['sales'];
                $goods_list[$key]['price'] = (String)floatval($item['price']);

            }
        }else{
            $goods_list = array();
        }
        //机构

        $where_shop = "WHERE `is_show` = 1 AND `status` = 1 AND `name` LIKE '%".$search."%' ";
        $desc_asc_shop = 'ORDER BY dis asc';

        if($type=='0'){
            if($page==1){
                // 加入排序，从最近到最近排序。
                $sql_shop = "select id,name,lng,lat,logo,classify,grade,location,sort,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop ".$where_shop."  having dis <".$scope." ".$desc_asc_shop." limit 0,3";
                $shop_list = $Dao->query($sql_shop);
            }
       }else{
            if($type=='3'){
                // 加入排序，从最近到最近排序。
                $sql_shop = "select id,name,lng,lat,logo,classify,grade,location,sort,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop ".$where_shop."  having dis <".$scope." ".$desc_asc_shop." limit ".$start.",".$num;
                $shop_list = $Dao->query($sql_shop);
            }
        }



        if($shop_list){
            $arrSort = array();
            foreach($shop_list AS $key => $value){
                foreach($value AS $k=>$v){
                    $arrSort[$k][$key] = $v;
                }
            }
            array_multisort($arrSort['sort'], SORT_DESC, $shop_list);
            $class_list = $store_classify->select();
            foreach ($class_list as $item){
                $new_class[$item['id']] = $item['name'];
            }
            foreach($shop_list as $key=>$item){
                $shop_list[$key]['dis'] = MiZhuanhuan($item['dis']);

                    $shop_list[$key]['classify'] = $new_class[$item['classify']];
                    if (!$item['logo']){
                        $shop_list[$key]['logo'] = XUANIP.'/shop_logo.jpg';
                    }


                $shop_list[$key]['grade'] = round($item['grade'],1);
            }
        }else{
            $shop_list = array();
        }

        //医生
        $where_doctor = "WHERE `is_show` = 1 AND `name` LIKE '%".$search."%' ";
        $desc_asc_doctor = 'ORDER BY dis asc';
        if($type=='0'){
            if($page==1){
                // 加入排序，从最近到最近排序。
                $sql_doctor = "select id,name,lng,lat,head,job,subscribe,location,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_doctor ".$where_doctor."  having dis <".$scope." ".$desc_asc_doctor." limit 0,3";
// 加入排序，从最近到最近排序。
                $doctor_list = $Dao->query($sql_doctor);
            }
        }else{
            if($type=='4'){
                // 加入排序，从最近到最近排序。
                $sql_doctor = "select id,name,lng,lat,head,job,subscribe,location,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_doctor ".$where_doctor."  having dis <".$scope." ".$desc_asc_doctor." limit ".$start.",".$num;
                // 加入排序，从最近到最近排序。
                $doctor_list = $Dao->query($sql_doctor);
            }
        }

        if($doctor_list){
            foreach($doctor_list as $key=>$item){
                $hos_name = $hospital->where(array('id'=>$item['hospital_id']))->field('name')->find();
                $doctor_list[$key]['hos_name'] = $hos_name['name'];
                $doctor_list[$key]['dis'] = MiZhuanhuan($item['dis']);
            }
        }else{
            $doctor_list = array();
        }


        //案例
        $where_blogs = "WHERE `is_show` = 1 AND `type` IN ( 1,2 ) AND `content` LIKE '%".$search."%' ";
        $desc_asc_blogs = 'ORDER BY dis asc';
        if($type=='0' || $type=='2'){
            // 加入排序，从最近到最近排序。
            $sql_blogs = "select id,user_id,lng,lat,content,zan,browse,comment_count,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_user_blogs ".$where_blogs."  having dis <".$scope." ".$desc_asc_blogs." limit ".$start.",".$num;
            $list = $Dao->query($sql_blogs);
        }

        if($list){
            foreach($list as $key=>$item){
                if(!$item['video_url']){
                    $list[$key]['video_url'] = "";
                }
                if(!$item['video_height']){
                    $list[$key]['video_height'] = "0";
                }
                if(!$item['video_width']){
                    $list[$key]['video_width'] = "0";
                }
                if(!$item['video_thumb']){
                    $list[$key]['video_thumb'] = "";
                }
                if(!$item['ad_url']){
                    $list[$key]['ad_url'] = "";
                }
                if(!$item['lng']){
                    $list[$key]['lng'] = "";
                }

                //用户信息
                $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
                $list[$key]['name'] = $user_info2['name'];
                $list[$key]['head'] = $user_info2['head'];
                $list[$key]['sex'] = $user_info2['sex'];
                $list[$key]['age'] = $user_info2['age'];
                $list[$key]['level'] = $user_info2['level'];

                $list[$key]['create_time'] = mdate($item['create_time']);
                //点赞数
                $list[$key]['zan'] = WanChu($item['zan']);
                //评论数
                $list[$key]['comment_count'] = WanChu($item['comment_count']);
                //浏览人数
                $list[$key]['browse'] = WanChu($item['browse']);
                $list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $list[$key]['img_width'] = '0';
                $list[$key]['img_height'] = '0';
                $new_img_list = array();
                $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
                if ($img_list) {
                    foreach ($img_list as $key2=>$val) {
                        if ($key2==0){
                            $list[$key]['img_width'] = $val['width'];
                            $list[$key]['img_height'] = $val['height'];
                        }
                        $new_img_list[] = $val['img_url'];
                    }
                }
                $list[$key]['img_list'] = $new_img_list;


                //自己是否有点赞
                $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
                if ($is_zan) {
                    $list[$key]['is_zan'] = '1';
                } else {
                    $list[$key]['is_zan'] = '0';
                }

                unset($list[$key]['video_icon']);

            }

        }else{
            $list = array();
        }
        $sort_list = array();
        $sort_list[] = array('name'=>'shop_list','num'=>count($goods_list));
        $sort_list[] = array('name'=>'goods_list','num'=>count($goods_list));
        $sort_list[] = array('name'=>'doctor_list','num'=>count($doctor_list));


        $arrSort = array();
        foreach($sort_list AS $key => $value){
            foreach($value AS $k=>$v){
                $arrSort[$k][$key] = $v;
            }
        }
        array_multisort($arrSort['num'], SORT_DESC, $sort_list);

        $sort_arr = array();
        foreach ($sort_list as $item){
            $sort_arr[]  = $item['name'];
        }
        $sort_arr[]  = 'blogs_list';

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'sort_list'=> $sort_arr,
            'goods_list'=> $goods_list,
            'shop_list'=> $shop_list,
            'doctor_list'=> $doctor_list,
            'blogs_list'=> $list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     *机构列表
     */
    function ShopList(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度



        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//查看类型：1正常机构列表,2使用医院优惠券，3根据机构名称搜索

        $ticket_id = decrypt1(trim(I('post.ticket_id')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $check_type = decrypt1(trim(I('post.check_type')));//类型:0全部，1距离有限，2好评优先，3整形医院，4美容店，5化妆护肤品店

        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));

        if(!$type){$type = '1';}
        //$search = "深圳";
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$check_type){$check_type='0';}
        if(!$scope){$scope = 2500;}

        $user = M('user');
        $store_classify =M('store_classify');
        $hospital =M('hospital');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();

        if($check_type=='1'){
            //$desc_asc = 'ORDER BY create_time desc,dis asc';
            $desc_asc = 'ORDER BY dis asc';
        }else if($check_type=='2'){
            $desc_asc = 'ORDER BY grade desc,dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }else{
            $desc_asc = 'ORDER BY dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }

        if ($type=='2'){
            $hos_list = M('ticket_hospital')->where(array('ticket_id'=>$ticket_id))->select();
            if ($hos_list){
                foreach ($hos_list as $item){
                    $id_list[] = $item['hospital_id'];
                }
                $id_val = implode(',',$id_list);
                $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `id` IN ( ".$id_val.") ";
            }else{
                $where3 = "WHERE `id` = 0 AND `status` = 1";
            }

        }else if($type=='1'){
            if($check_type=='3'){
                $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `classify` = 11";
            }else if($check_type=='4'){
                $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `classify` = 12";
            }else if($check_type=='5'){
                $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `classify` = 13";
            }else{
                $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `classify` != 13";
            }
        }else{
            $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `name` LIKE '%".$search."%' ";
        }



        // 加入排序，从最近到最近排序。
        $sql2 = "select id,name,lng,lat,logo,classify,grade,location,sort,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop ".$where3."  having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;
        $list = $Dao->query($sql2);

        if($page=='1'){
            if($check_type!='1' && $check_type!='2'){
                $arrSort = array();
                foreach($list AS $key => $value){
                    foreach($value AS $k=>$v){
                        $arrSort[$k][$key] = $v;
                    }
                }
                array_multisort($arrSort['sort'], SORT_DESC, $list);
            }

        }


        $class_list = $store_classify->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }
        foreach($list as $key=>$item){
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);

                $list[$key]['classify'] = $new_class[$item['classify']];
                if (!$item['logo']){
                    $list[$key]['logo'] = XUANIP.'/shop_logo.jpg';
                }


            $list[$key]['grade'] = round($item['grade'],1);
        }



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=> $list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     *机构列表
     */
    function ShopList2(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度


        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//查看类型：1正常机构列表,2使用医院优惠券，3根据机构名称搜索

        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $check_type = decrypt1(trim(I('post.check_type')));//类型:0全部，1距离有限，2好评优先，3整形医院，4美容店，5化妆护肤品店
        $class2 = decrypt1(trim(I('post.class2')));

        $page = decrypt1(trim(I('post.page')));
        $classify = decrypt1(trim(I('post.classify')));
        $classify  = $classify==0?11:12;
        if(!$type){$type = '1';}
        //$search = "深圳";
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$check_type){$check_type='0';}
        if(!$scope){$scope = 2500;}

        $user = M('user');
        $store_classify =M('store_classify');
        $shop_goods =M('shop_goods');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();
        if($check_type=='1'){
            //$desc_asc = 'ORDER BY create_time desc,dis asc';
            $desc_asc = 'ORDER BY dis asc';
        }else if($check_type=='2'){
            $desc_asc = 'ORDER BY grade desc,dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }else{
            $desc_asc = 'ORDER BY dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }

        $where3 = "WHERE `is_show` = 1 AND `status` = 1 AND `classify` =".$classify;
        $where3 .= ' AND `classify2` = '.$class2;

        // 加入排序，从最近到最近排序。
        $sql2 = "select id,name,lng,lat,logo,classify,grade,location,sort,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop ".$where3."  having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;
        $list = $Dao->query($sql2);

        if($page=='1'){
            if($check_type!='1' && $check_type!='2'){
                $arrSort = array();
                foreach($list AS $key => $value){
                    foreach($value AS $k=>$v){
                        $arrSort[$k][$key] = $v;
                    }
                }
                array_multisort($arrSort['sort'], SORT_DESC, $list);
            }

        }


        $class_list = $store_classify->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }
        foreach($list as $key=>$item){
            $project_list = $shop_goods->where(['shop_id'=>$item['id'],'is_project'=>1])->field('id,name,price as money,sales')->select();

            $list[$key]['project_list'] = $project_list?$project_list:false;
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);

            $list[$key]['classify'] = $new_class[$item['classify']];
            if (!$item['logo']){
                $list[$key]['logo'] = XUANIP.'/shop_logo.jpg';
            }
            $list[$key]['grade'] = round($item['grade'],1);
        }



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=> $list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     *医生列表
     */
    function DoctorList(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $check_type = decrypt1(trim(I('post.check_type')));//类型:0全部，1距离有限，2预约优先，3根据医院ID展示旗下医生，4根据医生名字搜索
        $page = decrypt1(trim(I('post.page')));
        $hospital_id = decrypt1(trim(I('post.hospital_id')));
        $search = decrypt1(trim(I('post.search')));

        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$check_type){$check_type='0';}
        if(!$scope){$scope = 2500;}

        $user = M('user');
        $hospital = M('hospital');

        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();

        if($check_type=='1'){
            //$desc_asc = 'ORDER BY create_time desc,dis asc';
            $desc_asc = 'ORDER BY dis asc';
        }else if($check_type=='2'){
            $desc_asc = 'ORDER BY subscribe desc,dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }else{
            $desc_asc = 'ORDER BY sort desc,dis asc';
            //$desc_asc = 'ORDER BY dis asc';
        }

        if ($check_type=='3'){
            $where3 = "WHERE `is_show` = 1  AND `hospital_id` = ".$hospital_id;
        }else if ($check_type=='4'){
            if ($hospital_id){
                $where3 = "WHERE `is_show` = 1 AND `name` LIKE '%".$search."%' AND `hospital_id` = ".$hospital_id;
            }else{
                $where3 = "WHERE `is_show` = 1 AND `name` LIKE '%".$search."%' ";
            }

        }else{
            $where3 = "WHERE `is_show` = 1 ";
        }




        // 加入排序，从最近到最近排序。
        $sql2 = "select id,name,lng,lat,head,job,subscribe,location,hospital_id,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_doctor ".$where3."  having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;
        $list = $Dao->query($sql2);

        foreach($list as $key=>$item){
            $hos_name = $hospital->where(array('id'=>$item['hospital_id']))->field('name')->find();
            $list[$key]['hos_name'] = $hos_name['name'];
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=> $list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 个性定制分类
     */
    function MadeClassifyList(){
        $user = M('user');

        $made_classify = M('made_classify');
        $leave = M('leave');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$page = decrypt1(trim(I('post.page')));

       /* if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $leave_num = 0;
        $leave_num += $leave->where(array('user_id'=>$user_info['id'],'is_read'=>'0','type'=>'2'))->count();

        if($leave_num>99){$leave_num=99;}
        $leave_num = (String)$leave_num;
        $where['is_show'] = 1;

        $game_list = $made_classify->where($where)->order('sort')
            ->field('id,name,logo')->select();


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'leave_num' => $leave_num,
            'list' => $game_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }











    /**
     * 留言板-提交留言
     */
    function LeaveSubmit(){
        $user = M('user');

        $leave = M('leave');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $content = decrypt1(trim(I('post.content')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$content) {$arr = array('code' => 0, 'res' => '留言内容不能为空');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (strlen($content)>4000) {$arr = array('code' => 0, 'res' => '留言内容过长');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $add['user_id'] = $user_info['id'];
        $add['content'] = $content;
        $add['type'] = 1;
        $add['is_read'] = 0;
        $add['create_time'] = time();
        $query = $leave->add($add);

        $res = '留言';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 留言板-列表
     */
    function LeaveList(){
        $user = M('user');

        $leave = M('leave');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $type = decrypt1(trim(I('post.type')));

         if(!$page){$page = 1;}
         if(!$type){$type = '2';}
         $num = 20;//分页数
         $start = ($page-1)*$num;

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $list = $leave->where(array('user_id'=>$user_info['id']))
            ->limit($start,$num)
            ->field('id,content,type,create_time')
            ->order('create_time desc')
            ->select();

        if($list){
            $leave->where(array('user_id'=>$user_info['id'],'type'=>'2','is_read'=>'0'))->save(array('is_read'=>'1','update_time'=>time()));
        }

        if($type=='2'){
            $list = array_reverse($list);
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 申请开店预备数据-分类和协议
     */
    function OpenShopData(){
        $user = M('user');

        $shop_classify = M('store_classify');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $where['is_show'] = 1;
        $where['type'] = 1;
        $list = $shop_classify->where($where)->order('sort')
            ->field('id,name')->select();

        $xy_list = $set->where(array('set_type'=>'shop_user_xy'))->field('set_value,remark')->find();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
            'xy_list' => $xy_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    function testshop(){
        die;
        $shop = M('shop');
        $list = $shop->select();
        $i = 0;
        foreach ($list as $item){
            if(!$item['pay_qr']){
                $qr_arr['type'] = '2';
                $qr_arr['type_id'] = $item['id'];
                $qr_val = json_encode($qr_arr);
                $content = encrypt1($qr_val);
                $qr_url = makecode($content,$item['logo']);
                $save['pay_qr'] = $qr_url;
                $save['update_time'] = time();
                $shop->where(array('id'=>$item['id']))->save($save);
                $i++;
            }

        }
        dump($i);die;

    }
    /**
     * 申请开店-提交
     */
    function SubmitShopDataData(){
        $user = M('user');

        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $explain = decrypt1(trim(I('post.explain')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $classify = decrypt1(trim(I('post.classify')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $location = decrypt1(trim(I('post.location')));
        $postage_id = decrypt1(trim(I('post.postage_id')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$user_info['ali_user_id']) {$arr = array('code' => 3001, 'res' => '请先绑定支付宝');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $is_open = $shop->where(array('user_id'=>$user_info['id']))->find();
        if ($is_open){
            if ($is_open['status'] == '0') {$arr = array('code' => 0, 'res' => '您已申请过开店，请耐心等待审核结果');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($is_open['status'] == '1') {$arr = array('code' => 0, 'res' => '您已开通店铺，请勿重复申请');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $is_edit = $is_open['id'];

        }else{
            $is_edit = false;
        }
        if (!$name) {$arr = array('code' => 0, 'res' => '请输入店铺名称');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$classify) {$arr = array('code' => 0, 'res' => '请选择店铺分类');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$explain) {$arr = array('code' => 0, 'res' => '请输入店铺说明');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$img_url) {$arr = array('code' => 0, 'res' => '请上传店铺资质图片');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
       /* if (!$lng || !$lat){
            $arr = array(
                'code'=> 0,
                'res'=>'请先开启GPS定位',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/
        $where['name'] = $name;
        $where['status'] = '1';
        $is_have = $shop->where($where)->find();
        if ($is_have) {$arr = array('code' => 0, 'res' => '店铺名称已被占用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $add['user_id'] = $user_info['id'];
        $add['name'] = $name;
        $add['lng'] = $lng;
        $add['lat'] = $lat;
        $add['logo'] = XUANIP.'/shop_logo.jpg';
        $add['bg'] = XUANIP.'/shop_bg.jpg';
        $add['location'] = $location;
        $add['explain'] = $explain;
        $add['classify'] = $classify;
        $add['postage_id'] = $postage_id;
        $add['img_url'] = $img_url;
        $add['status'] = 0;
        $add['create_time'] = time();
        if ($is_edit){
            $query = $shop->where(array('id'=>$is_edit))->save($add);
        }else{
            $query = $shop->add($add);
        }

        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>'申请成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'申请失败',
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 我的店铺审核状态
     */
    function MyShopStatus(){
        $user = M('user');

        $shop = M('shop');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $shop->where(array('user_id'=>$user_info['id']))->field('status,remark')->find();
        if ($list){
            if (!$list['remark']){$list['remark']='';}
        }else{
            $list['status'] = '3';
            $list['remark'] = '';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    //星级会员规则说明
    function agentSendInfo(){
        $user = M('user');
        $set = M('set');
        $team_qr = M('team_qr');
        $token = decrypt1(trim(I('post.token')));
        $qr_id = decrypt1(trim(I('post.qr_id')));
        $share_user_id =  decrypt1(trim(I('post.share_user_id')));
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if(!$user_info['code_user']){
            if($share_user_id){
                //绑定邀请人
                $bind_status = BindCodeUser($share_user_id,$user_info['id']);
            }
        }


        //if ($user_info['is_agent']==1) {$arr = array('code' => 0, 'res' => '已经是星级会员，请勿重复开通');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($qr_id){
            $qr_info = $team_qr->where(array('id'=>$qr_id))->find();
            if($qr_info){
                if($qr_info['is_use']==0){
                    $qr_info = array();
                }
                //验证是否过期
                if($qr_info['type']==2){
                    if($qr_info['use_num']==$qr_info['num']){
                        $qr_info = array();
                    }
                }
                if($qr_info['type']==1){
                    if($qr_info['end_time']<time()){
                        $qr_info = array();
                    }
                }
            }
        }


        $set_info = $set->where(array('set_type'=>'agent_send'))->find();
        $set_info2 = $set->where(array('set_type'=>'team_open_money'))->find();
        $list = json_decode($set_info['remark'],true);
        if($qr_info){
            $list['qr_id'] = $qr_info['id'];
            $list['now_money'] = $qr_info['price'];
        }else{
            $list['qr_id'] = 0;
            $list['now_money'] = $set_info2['set_value'];
        }
        $list['open_money'] = $set_info2['set_value'];

        $list['ticket_info'] = array();
        if($list['ticket_id']){
            $ticket_info = M('ticket')->where(array('id'=>$list['ticket_id']))->field('id,ticket_type,project_id')->find();
            $list['ticket_info'] = $ticket_info;
        }


        $list['is_agent'] = $user_info['is_agent'];

        $have_info = [];
        if($user_info['is_agent']==1){
            $is_have =M('ticket_user')->where(['user_id'=>$user_info['id'],'parent'=>$ticket_info['id']])->find();
            if($is_have){
              $have_info['is_have'] = 1;
              if($is_have['status']==0){
                  $have_info['is_use'] = 0;
              }else{
                  $have_info['is_use'] = 1;
              }
          }else{
              $have_info['is_have'] = 0;
          }
        }

        $img_list = [
            'https://api.ymxte.com/Public/new_ui/0.jpeg',
            'https://api.ymxte.com/Public/new_ui/1.jpeg',
            'https://api.ymxte.com/Public/new_ui/2.jpeg',
            'https://api.ymxte.com/Public/new_ui/3.jpeg',
        ];

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'img_list' => $img_list,
            'list' => $list,
            'have_info' => $have_info,
        );




        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的团队审核状态
     */
    function MyTeamStatus(){
        $user = M('user');

        $team = M('team');
        $set = M('set');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if($user_info['is_agent']=='1'){
            $list['status'] = '1';
            $list['remark'] = '';
        }else{
            $list = $team->where(array('user_id'=>$user_info['id']))->field('status,remark')->find();
            if ($list){
                if (!$list['remark']){$list['remark']='';}
            }else{
                $list['status'] = '4';
                $list['remark'] = '';
            }
        }
        $set_info = $set->where(array('set_type'=>'team_open_money'))->find();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
            'team_open_money' => $set_info['set_value'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    //更新已有医院图片
    function updateHospitalShopImg(){
        $hospital = M('hospital');
        $shop = M('shop');
        $list = $hospital->select();
        $i = 0;
        foreach ($list as $item){
            $is_have = $shop->where(array('hospital_id'=>$item['id']))->find();
            if($is_have){
                if($item['logo']){
                    $save['logo'] = $item['logo'];
                }
                if($item['bg']){
                    $save['bg'] = $item['bg'];
                }
                $save['update_time'] = time();
                $query = $shop->where(array('id'=>$is_have['id']))->save($save);
                $i++;
            }

        }
        dump($i);
        die;
    }


    /**
     * 我的团队-开通申请
     */
    function SubmitTeamData(){
        $user = M('user');

        $team = M('team');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $phone = decrypt1(trim(I('post.phone')));
        $sex = decrypt1(trim(I('post.sex')));
        $age = decrypt1(trim(I('post.age')));
        $job = decrypt1(trim(I('post.job')));
        $job_age = decrypt1(trim(I('post.job_age')));
        $explain = decrypt1(trim(I('post.explain')));
        //$page = decrypt1(trim(I('post.page')));
        $arr = array('code' => 3001, 'res' => '此功能已暂停使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($user_info['is_agent']=='1') {$arr = array('code' => 0, 'res' => '您已开通团队，请勿重复提交');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$user_info['ali_user_id']) {$arr = array('code' => 3001, 'res' => '请先绑定支付宝');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $is_open = $team->where(array('user_id'=>$user_info['id']))->find();

        if ($is_open){
            if ($is_open['status'] == '0') {$arr = array('code' => 0, 'res' => '您已申请，请耐心等待审核结果');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($is_open['status'] == '1') {$arr = array('code' => 0, 'res' => '您已开通团队，请勿重复申请');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($is_open['status'] == '2') {$arr = array('code' => 0, 'res' => '您已通过审核，支付金额即可开通团队');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $is_edit = $is_open['id'];

        }else{
            $is_edit = false;
        }

        if (!$name) {$arr = array('code' => 0, 'res' => '请输入您的真实姓名');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$phone) {$arr = array('code' => 0, 'res' => '请输入您的手机号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$age) {$arr = array('code' => 0, 'res' => '请输入您的年龄');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$job) {$arr = array('code' => 0, 'res' => '请输入您的职业');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$job_age) {$arr = array('code' => 0, 'res' => '请输入您的从业年限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$explain) {$arr = array('code' => 0, 'res' => '请输入申请理由');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


     /*   if($user_info['parent']){
            $parent_info = $user->where(array('id'=>$user_info['parent']))->field('is_agent,team_id')->find();
            if($parent_info['is_agent']=='1'){
                $add['type'] = 2;
                $add['parent'] = $parent_info['team_id'];
            }else{
                $add['type'] = 1;
            }
        }else{
            $add['type'] = 1;
        }*/

        $add['type'] = 1;

        $add['user_id'] = $user_info['id'];
        $add['name'] = $name;
        $add['explain'] = $explain;
        $add['phone'] = $phone;
        $add['sex'] = $sex;
        $add['age'] = $age;
        $add['job'] = $job;
        $add['job_age'] = $job_age;
        $add['status'] = 0;
        $add['create_time'] = time();
        if ($is_edit){
            $query = $team->where(array('id'=>$is_edit))->save($add);
        }else{
            $query = $team->add($add);
        }


        if ($query){

            $user->where(array('id'=>$user_info['id']))->find(array('is_team_pay'=>'1','update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>'申请成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'申请失败',
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /**
     * 我的团队-取消申请开通
     */
    function CancelTeamApply(){
        $user = M('user');

        $team = M('team');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_agent'] == '1') {$arr = array('code' => 0, 'res' => '已经开通团队');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $team_info = $team->where(array('user_id'=>$user_info['id']))->find();

        if (!$team_info) {$arr = array('code' => 0, 'res' => '您还未申请开通团队');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($team_info['status'] != '2') {$arr = array('code' => 0, 'res' => '状态错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $save['status'] = 3;
        $save['remark'] = '用户自行取消';
        $save['update_time'] = time();

        $query = $team->where(array('id'=>$team_info['id']))->save($save);


        if ($query){
            $user->where(array('id'=>$user_info['id']))->find(array('is_team_pay'=>'0','update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>'取消成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'取消失败',
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的团队-模拟支付团队费用
     */
    function PayTeamApply(){
        die;
        $user = M('user');
        $team = M('team');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_agent'] == '1') {$arr = array('code' => 0, 'res' => '已经开通团队');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $team_info = $team->where(array('user_id'=>$user_info['id']))->find();

        if (!$team_info) {$arr = array('code' => 0, 'res' => '您还未申请开通团队');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($team_info['status'] != '2') {$arr = array('code' => 0, 'res' => '状态错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $save['status'] = 1;
        $save['update_time'] = time();

        $query = $team->where(array('id'=>$team_info['id']))->save($save);


        if ($query){

            //赠送优惠券
            $give_list =  M('ticket')->where(array('type'=>'2','is_give'=>'1'))->select();
            if($give_list){
                $add_ticket['user_id'] = $user_info['id'];
                $add_ticket['buy_money'] = 0;
                $add_ticket['rebate_money'] = 0;
                $add_ticket['create_time'] = time();
                foreach ($give_list as $item){
                    $is_have = M('ticket_user')->where(array('user_id'=>$user_info['id'],'parent'=>$item['id']))->find();
                    if (!$is_have){
                        $add_ticket['parent'] = $item['id'];
                        $add_ticket['discount'] = $item['discount'];
                        M('ticket_user')->add($add_ticket);
                    }

                }
            }


            $user->where(array('id'=>$user_info['id']))->find(array('is_agent'=>'1','team_id'=>$team_info['id'],'update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>'支付成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'支付失败',
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    //城市合伙人-页面
    function cityH5Info(){
        $list = M('set')->where(['set_type'=>'gudong_h5'])->find();
        $arr = array(
            'code'=> 1,
            'list'=>$list,
            'res'=>'查询成功',
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 城市合伙人-申请开通
     */
    function SubmitGudData(){
        $user = M('user');

        $gudong = M('gudong');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $phone = decrypt1(trim(I('post.phone')));
        $company_img = decrypt1(trim(I('post.company_img')));
        $img_list = decrypt1(trim(I('post.img_list')));
        $type = decrypt1(trim(I('post.type')));//1企业，2个人
        $explain = decrypt1(trim(I('post.explain')));


        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if ($user_info['is_gudong']=='1') {$arr = array('code' => 0, 'res' => '您已是城市合伙人，请勿重复提交');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$user_info['ali_user_id']) {$arr = array('code' => 3001, 'res' => '请先绑定支付宝');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $is_open = $gudong->where(array('user_id'=>$user_info['id']))->find();

        if ($is_open){
            if ($is_open['status'] == '0') {$arr = array('code' => 0, 'res' => '您已申请，请耐心等待审核结果');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($is_open['status'] == '1') {$arr = array('code' => 0, 'res' => '您已经是城市合伙人，请勿重复申请');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($is_open['status'] == '2') {$arr = array('code' => 0, 'res' => '您已通过审核，支付金额即可成为城市合伙人');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $is_edit = $is_open['id'];

        }else{
            $is_edit = false;
        }
        if (!$name) {$arr = array('code' => 0, 'res' => '请输入您的真实姓名');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$phone) {$arr = array('code' => 0, 'res' => '请输入您的手机号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$explain) {$arr = array('code' => 0, 'res' => '请输入申请理由');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$phone)){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $add['type'] = $type;
        $add['user_id'] = $user_info['id'];
        $add['name'] = $name;
        $add['explain'] = $explain;
        $add['phone'] = $phone;
        $add['company_img'] = $company_img;
        $add['img_list'] = $img_list;
        $add['status'] = 0;
        $add['create_time'] = time();
        if ($is_edit){
            $query = $gudong->where(array('id'=>$is_edit))->save($add);
        }else{
            $query = $gudong->add($add);
        }
        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>'申请成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'申请失败',
            );
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 城市合伙人-取消申请
     */
    function CancelGudApply(){
        $user = M('user');

        $gudong = M('gudong');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_gudong'] == '1') {$arr = array('code' => 0, 'res' => '已经是城市合伙人，无法取消');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $gudong_info = $gudong->where(array('user_id'=>$user_info['id']))->find();

        if (!$gudong_info) {$arr = array('code' => 0, 'res' => '您还未申请开通成为城市合伙人');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($gudong_info['status'] != '2') {$arr = array('code' => 0, 'res' => '状态错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $save['status'] = 3;
        $save['remark'] = '用户自行取消';
        $save['update_time'] = time();
        $query = $gudong->where(array('id'=>$gudong_info['id']))->save($save);
        if ($query){
            $user->where(array('id'=>$user_info['id']))->find(array('is_team_pay'=>'0','update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>'取消成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'取消失败',
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 城市合伙人-申请状态查询
     */
    function MyGudStatus(){
        $user = M('user');

        $gudong = M('gudong');
        $set = M('set');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if($user_info['is_gudong']=='1'){
            $list['status'] = '1';
            $list['remark'] = '';
        }else{
            $list = $gudong->where(array('user_id'=>$user_info['id']))->field('status,remark')->find();
            if ($list){
                if (!$list['remark']){$list['remark']='';}
            }else{
                $list['status'] = '4';
                $list['remark'] = '';
            }
        }
        $set_info = $set->where(array('set_type'=>'gudong_money'))->find();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
            'open_money' => $set_info['set_value'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-邀请好友
     */
    function MyCodeFriend(){
        $user = M('user');

        $set = M('set');
        $team_money = M('team_money');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $set_info = $set->where(array('set_type'=>'app_url'))->find();
        $head_info['code'] = $user_info['phone'];
        $head_info['app_url'] = $set_info['set_value'];

        $where['code_user'] = $user_info['id'];
        if ($user_info['team_id']=='0'){
            $user_info['team_id'] = -1;
        }
        $where['team_id'] = array('NEQ',$user_info['team_id']);
        $where['is_agent'] = 0;
        $code_num= 0;
        $code_num += $user->where($where)->count();
        $head_info['invite_num'] = (String)$code_num;

        $where_fl['user_id'] = $user_info['id'];
        $list = $user->where($where)->field('id,head,phone')->order('create_time desc')->limit($start,$num)->select();
        foreach ($list as $key=>$item){
            $list[$key]['phone'] = substr($item['phone'], 0, 3).'****'.substr($item['phone'], 7);
            //返利
            $where_fl['buy_user_id'] = $item['id'];
            $list[$key]['rebate'] = 0;
            $list[$key]['rebate'] += $team_money->where($where_fl)->sum('money');
            $list[$key]['rebate'] = (String)$list[$key]['rebate'];
        }




        if ($user_info['code_qr']){
            $code_url = $user_info['code_qr'];
        }else{
            $content = 'https://wx.ymxte.com/home/home/index/to/upload/code_id/'.$user_info['phone'];
            $code_url = makecode($content,'http://api.ymxte.com/logo.jpg');
            if ($code_url){
                $user->where(array('id'=>$user_info['id']))->save(array('code_qr'=>$code_url,'update_time'=>time()));
            }
        }
        //$code_url = $set->where(array('set_type'=>'code_url'))->find();
        $head_info['code_url'] = $code_url;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'code_url'=>$code_url,
            'head_info'=>$head_info,
            'list'=>$list,
        );


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

// 返回执行日期所在周的第一天(周一)日期
    function firstOfWeek($date)
    {
        $now = strtotime($date);    //当时的时间戳
        $number = date("w",$now);  //当时是周几
        $number = $number == 0 ? 7 : $number; //如遇周末,将0换成7
        $diff_day = $number - 1; //求到周一差几天
        return date("Y-m-d",$now - ($diff_day * 60 * 60 * 24));
    }

    /**
     * 我的团队
     */
    function MyTeam(){
        $user = M('user');

        $team = M('team');
        $team_money = M('team_money');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $show_type = $set->where(['set_type'=>'show_team_pai_type'])->find();

//        if($show_type['set_value']==4){
//            $team_ranking = $user
//                ->field('id as user_id,rebate_money as total_money,head,name')
//                ->order('rebate_money desc')->limit(5)->select();
//        }else{
//            if($show_type['set_value']==1){
//                $start_time = date("Y-m-d");
//            }else if($show_type['set_value']==2){
//                $now_date = date("Y-m-d");
//                $start_time = $this->firstOfWeek($now_date);
//            }else {
//                $start_time = date("Y-m-01");
//
//            }
//            $newtime = strtotime($start_time);
//            $where['create_time'] = array('EGT',$newtime);
//            $list = $team_money->where($where)->group('user_id')->select();
//            dump($list);die;
//        }

        $start_time = date("Y-m-01");
        $newtime = strtotime($start_time);
        $where['create_time'] = array('EGT',$newtime);
        $user_list = $team_money->where($where)->group('user_id')->select();
        $now_num = count($user_list);
        if($now_num>0){
            foreach ($user_list as $key=>$item){
                $where['user_id'] = $item['user_id'];
                $user_list[$key]['total_money'] = $team_money->where($where)->sum('money');

            }
            $user_list = array_column($data,'total_money');
            array_multisort($last_names,SORT_DESC,$user_list);
        }
        $user_arr = [];
        $user_id_arr = [];
        if($now_num>0){
            foreach ($user_list as $key=>$item){
                if($key<5){
                    $user_data = $user->where(['id'=>$item['user_id']])->field('id,name,head')->find();
                    $user_arr[] = $user_data;
                    $user_id_arr[] = $item['user_id'];
                }
            }
        }
        $need_num = 5 - count($user_id_arr);

        if($need_num>0){
            $where_check['is_agent'] = 1;
            if(count($user_id_arr)>0){
                $val_id = implode(',',$user_id_arr);
                $where_check['id'] = array('not in',$val_id);
            }
            $new_user = $user->where($where_check)->order('rand()')->limit($need_num)->field('id,name,head')
                ->select();
            foreach ($new_user as $item){
                $user_arr[] = $item;
            }
        }

        $team_ranking = $user_arr;
//            $team_ranking = $user
//                ->field('id as user_id,rebate_money as total_money,head,name')
//                ->order('rebate_money desc')->limit(5)->select();



        $rebate_list = $team_money
            ->limit(20)
            ->where(['lyx_team_money.money'=>['GT',0]])
            ->order('rand()')
            ->field('lyx_user.id,lyx_user.name,lyx_user.head,lyx_team_money.money')
            ->join('lyx_user ON lyx_team_money.user_id = lyx_user.id')
            ->select();


        $set_info = $set->where(array('set_type'=>'app_url'))->find();

        $a_user_num = 0;


        $b_user_num = 0;
        //$b_user_num += $user->where($where_b)->count();
        $total_user_id = array();

        //下属用户数量
        $xia_user = 0;
        $total_xia_user = 0;
        $agnet_xia_user = 0;
        $xia_list = $user->where(array('code_user'=>$user_info['id']))->field('id')->select();
        $xia_user+= count($xia_list);
        foreach ($xia_list as $item){
            $total_user_id[] = $item['id'];
        }

        $where_a1['team_id']  = $user_info['team_id'];
        $where_a1['parent']  = $user_info['id'];
        $where_a1['id']  = array('NEQ',$user_info['id']);
        $a_list =  $user->where($where_a1)->field('id,head,name')->select();


        if($a_list){
            $a_user_num = count($a_list);
            foreach ($a_list as $key=>$item){
                $total_user_id[] =$item['id'];
                $b_list = array();
                $a_user_list = array();
                $a_id_list = array();

                //下级代理的用户
                $a_user_list =  $user->where(array('code_user'=>$item['id']))->field('id')->select();
                $agnet_xia_user+=count($a_user_list);

                $a_id_list[] = $item['id'];
                foreach ($a_user_list as $val_a){
                    $a_id_list[] = $val_a['id'];
                    $total_user_id[] = $val_a['id'];

                }
                $a_id_where = implode(',',$a_id_list);
                $where_a_team['user_id'] = $user_info['id'];
                $where_a_team['buy_user_id'] = array('IN',$a_id_where);
                $a_rebate = 0;
                $a_rebate += $team_money->where($where_a_team)->sum('money');
                $a_list[$key]['rebate'] =(String)$a_rebate;

                $where_b1['team_id']  = $user_info['team_id'];
                $where_b1['parent']  = $item['id'];
                $where_b1['id']  = array('NEQ',$user_info['id']);
                $where_b1['is_agent']  = 1;

                $b_list =  $user->where($where_b1)->field('id,head,name')->select();
                if($b_list){
                    $b_user_num += count($b_list);
                    foreach ($b_list as $key1=>$val){
                        $total_user_id[] = $val['id'];
                        $b_user_list = array();
                        $b_id_list = array();
                        $b_user_list =  $user->where(array('parent'=>$val['id'],'id'=>array('NEQ',$user_info['id'])))->field('id')->select();
                        $agnet_xia_user+=count($b_user_list);
                        $b_id_list[] = $val['id'];
                        foreach ($b_user_list as $val_b){

                            $b_id_list[] = $val_b['id'];
                            $total_user_id[] = $val_b['id'];
                        }
                        $b_id_where = implode(',',$b_id_list);


                        $where_b_team['user_id'] = $user_info['id'];
                        $where_b_team['buy_user_id'] = array('IN',$b_id_where);
                        $b_rebate = 0;
                        $b_rebate += $team_money->where($where_b_team)->sum('money');
                        $b_list[$key1]['rebate'] =(String)$b_rebate;
                    }
                    $a_list[$key]['b_list'] = $b_list;
                    $a_list[$key]['b_num'] = (String)count($b_list);
                }else{
                    $a_list[$key]['b_num'] = '0';
                    $a_list[$key]['b_list'] = array();
                }
            }
        }else{
            $a_list = array();
        }




        $total_revenue = 0;
        $total_revenue += $team_money->where(array('user_id'=>$user_info['id']))->sum('money');

        $head_info['total_revenue'] = (String)$total_revenue;

        $revenue_no = 0;
        $revenue_no += $team_money->where(array('user_id'=>$user_info['id'],'is_get'=>'0'))->sum('money');
        $head_info['revenue_no'] = (String)$revenue_no;

        $revenue_yes = 0;
        $revenue_yes += $team_money->where(array('user_id'=>$user_info['id'],'is_get'=>'1'))->sum('money');
        $head_info['revenue_yes'] = (String)$revenue_yes;



        $head_info['code'] = $user_info['phone'];
        $head_info['app_url'] = $set_info['set_value'];


        //男性用户数量
        $total_id_val = implode(',',$total_user_id);
        $man_num = $user->where(array('id'=>array('IN',$total_id_val),'sex'=>array('NEQ',2)))->count();
        //女性用户数量
        $woman_num = $user->where(array('id'=>array('IN',$total_id_val),'sex'=>2))->count();

        //0-20岁
        $where_age1['age'] = array(array('EGT',0),array('LT',20),'AND');
        $where_age1['id'] = array('IN',$total_id_val);
        $new_list['age_20'] = $user->where($where_age1)->count();

        //20-30岁
        $where_age2['age'] = array(array('EGT',20),array('LT',30),'AND');
        $where_age2['id'] = array('IN',$total_id_val);
        $new_list['age_30'] = $user->where($where_age2)->count();

        //30-40岁
        $where_age3['age'] = array(array('EGT',30),array('LT',40),'AND');
        $where_age3['id'] = array('IN',$total_id_val);
        $new_list['age_40'] = $user->where($where_age3)->count();

        //大于40
        $where_age4['age'] = array(array('EGT',40),array('LT',100),'AND');
        $where_age4['id'] = array('IN',$total_id_val);
        $new_list['age_50'] = $user->where($where_age4)->count();



        $total_xia_user+= $xia_user;
        $total_xia_user+= $agnet_xia_user;
        $new_list['a_num'] =$a_user_num;
        $new_list['b_num'] =$b_user_num;
        $new_list['xia_user'] =$xia_user;
        $new_list['agent_user'] =$agnet_xia_user;
        $new_list['total_user'] =$total_xia_user;
        $new_list['man_num'] =$man_num;
        $new_list['woman_num'] =$woman_num;




        $list['a_user_num'] = (String)$a_user_num;
        $list['b_user_num'] = (String)$b_user_num;
        $list['a_list'] = $a_list;


        if ($user_info['code_qr']){
            $code_url = $user_info['code_qr'];
        }else{
            $content = 'https://wx.ymxte.com/home/home/index/to/upload/code_id/'.$user_info['phone'];
            $code_url = makecode($content,'http://api.ymxte.com/logo.jpg');
            if ($code_url){
                $user->where(array('id'=>$user_info['id']))->save(array('code_qr'=>$code_url,'update_time'=>time()));
            }
        }
        
        //$code_url =$set->where(array('set_type'=>'code_url'))->find();
        $head_info['code_url'] = $code_url;


        $set_info = M('set')->where(array('set_type'=>'agent_send'))->find();
        $song = json_decode($set_info['remark'],true);

        $song['ticket_info'] = array();
        if($song['ticket_id']){
            $ticket_info = M('ticket')->where(array('id'=>$song['ticket_id']))->field('id,ticket_type,project_id')->find();
            $song = $ticket_info;
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'code_url'=>$code_url,
            'head_info'=>$head_info,
            'rebate_list'=>$rebate_list,
            'song'=>$song,
            'team_ranking'=>$team_ranking,
            'list'=>$list,
            'new_list'=>$new_list,
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 我的团队-下级与用户
     */
    function MyTeam2(){
        $user = M('user');

        $team = M('team');
        $team_money = M('team_money');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        if($token=='bf8739cb479fa5d17c98dfbb7beb1452'){
            $user_info = $user->where(array('id' => 11581))->find();
        }else{
            $user_info = $user->where(array('token' => $token))->find();
        }

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $a_user_num = 0;
        $b_user_num = 0;


        //下属用户数量
        $xia_user = 0;
        $xia_list = $user->where(array('code_user'=>$user_info['id']))->field('id,name,head')->select();
        foreach ($xia_list as $key=>$item){
            $where_user_money['user_id'] = $user_info['id'];
            $where_user_money['buy_user_id'] = $item['id'];
            $user_rebate = 0;
            $user_rebate += $team_money->where($where_user_money)->sum('money');
            $xia_list[$key]['rebate'] =$user_rebate;
        }
        $xia_user+= count($xia_list);

        $where_a1['team_id']  = $user_info['team_id'];
        $where_a1['parent']  = $user_info['id'];
        $where_a1['id']  = array('NEQ',$user_info['id']);
        $a_list =  $user->where($where_a1)->field('id,head,name')->select();
        if($a_list){
            $a_user_num = count($a_list);
            foreach ($a_list as $key=>$item){
                $total_user_id[] =$item['id'];
                $b_list = array();
                $a_user_list = array();
                $a_id_list = array();
                //下级代理的用户
                $a_user_list =  $user->where(array('code_user'=>$item['id']))->field('id')->select();

                $a_list[$key]['user_num'] = count($a_user_list);
                $a_id_list[] = $item['id'];
                foreach ($a_user_list as $val_a){
                    $a_id_list[] = $val_a['id'];
                }
                $a_id_where = implode(',',$a_id_list);
                $where_a_team['user_id'] = $user_info['id'];
                $where_a_team['buy_user_id'] = array('IN',$a_id_where);
                $a_rebate = 0;
                $a_rebate += $team_money->where($where_a_team)->sum('money');
                $a_list[$key]['rebate'] =(String)$a_rebate;

                $where_b1['team_id']  = $user_info['team_id'];
                $where_b1['parent']  = $item['id'];
                $where_b1['id']  = array('NEQ',$user_info['id']);
                $where_b1['is_agent']  = 1;
                $b_list =  $user->where($where_b1)->field('id,head,name')->select();
                if($b_list){
                    $b_user_num += count($b_list);
//                    foreach ($b_list as $key1=>$val){
//                        $total_user_id[] = $val['id'];
//                        $b_user_list = array();
//                        $b_id_list = array();
//                        $b_user_list =  $user->where(array('parent'=>$val['id'],'id'=>array('NEQ',$user_info['id'])))->field('id')->select();
//                        $b_id_list[] = $val['id'];
//                        foreach ($b_user_list as $val_b){
//
//                            $b_id_list[] = $val_b['id'];
//                        }
//                        $b_id_where = implode(',',$b_id_list);
//
//
//                        $where_b_team['user_id'] = $user_info['id'];
//                        $where_b_team['buy_user_id'] = array('IN',$b_id_where);
//                        $b_rebate = 0;
//                        $b_rebate += $team_money->where($where_b_team)->sum('money');
//                        $b_list[$key1]['rebate'] =(String)$b_rebate;
//                    }
                    $a_list[$key]['b_list'] = $b_list;
                    $a_list[$key]['b_num'] = (String)count($b_list);
                }else{
                    $a_list[$key]['b_num'] = '0';
                    $a_list[$key]['b_list'] = array();
                }
            }
        }else{
            $a_list = array();
        }

        $list['a_user_num'] = (String)$a_user_num;
        $list['b_user_num'] = (String)$b_user_num;
        $list['a_list'] = $a_list;
        $list['xia_user'] = $xia_user;
        $list['xia_list'] = $xia_list;





        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的团队-详细信息
     */
    function MyTeamInfo(){
        $user = M('user');

        $team = M('team');
        $shop_order = M('shop_order');
        $team_money = M('team_money');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));


        if($token=='bf8739cb479fa5d17c98dfbb7beb1452'){
            $user_info = $user->where(array('id' => 11581))->find();
        }else{
            $user_info = $user->where(array('token' => $token))->find();
        }

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        //查看的用户信息
        $check_user = $user->where(array('id'=>$user_id))->field('id,name,head,birthday,age,province,city,sex,parent,one,code_user,phone')->find();
        $check_user['birthday'] = $check_user['birthday']?date('Y-m-d',$check_user['birthday']):'-';
        if($check_user['parent']==$user_info['id']){
            $check_user['type']= 1;
        }else if($check_user['one']==$user_info['id']){
            $check_user['type']= 2;
        }else{
            $check_user['type']= 3;
        }

        $a_user_num = 0;
        $b_user_num = 0;

        if($check_user['type']!=3){
            //下属用户数量
            $xia_user = 0;
            $xia_list = $user->where(array('code_user'=>$check_user['id']))->field('id,name,head')->select();
            foreach ($xia_list as $key=>$item){
                $where_user_money['user_id'] = $user_info['id'];
                $where_user_money['buy_user_id'] = $item['id'];
                $user_rebate = 0;
                $user_rebate += $team_money->where($where_user_money)->sum('money');
                $xia_list[$key]['rebate'] =$user_rebate;
            }
            $xia_user+= count($xia_list);

            if($check_user['type']==1){
                $where_a1['team_id']  = $user_info['team_id'];
                $where_a1['parent']  = $check_user['id'];
                $where_a1['id']  = array('NEQ',$user_info['id']);
                $a_list =  $user->where($where_a1)->field('id,head,name')->select();
                if($a_list){
                    $a_user_num = count($a_list);
                    foreach ($a_list as $key=>$item){
                        $total_user_id[] =$item['id'];
                        $b_list = array();
                        $a_user_list = array();
                        $a_id_list = array();
                        //下级代理的用户
                        $a_user_list =  $user->where(array('code_user'=>$item['id']))
                            ->field('id,name,head')->select();


                        $a_id_list[] = $item['id'];
                        foreach ($a_user_list as $key3=>$val_a){
                            $a_id_list[] = $val_a['id'];
                            $where_a_team33['user_id'] = $user_info['id'];
                            $where_a_team33['buy_user_id'] = $val_a['id'];
                            $a_rebate33 = 0;
                            $a_rebate33 += $team_money->where($where_a_team33)->sum('money');
                            $a_user_list[$key3]['rebate'] =$a_rebate33;
                        }

                        $a_list[$key]['user_num'] = count($a_user_list);
                        $a_list[$key]['user_list'] = $a_user_list;


                        $a_id_where = implode(',',$a_id_list);
                        $where_a_team['user_id'] = $user_info['id'];
                        $where_a_team['buy_user_id'] = array('IN',$a_id_where);
                        $a_rebate = 0;
                        $a_rebate += $team_money->where($where_a_team)->sum('money');
                        $a_list[$key]['rebate'] =(String)$a_rebate;
                    }
                }else{
                    $a_list = array();
                }
            }
        }


        //最常购买店铺
        $where_order1['status']= array('NOT IN','0,3');
        $where_order1['user_id']= $check_user['id'];
        $shop_list = $shop_order->where($where_order1)->field('shop_id')->group('shop_id')->select();
        $max_shop_id = 0;
        $max_shop_num = 0;
        foreach ($shop_list as $key=>$item){

            $where_order2 = $where_order1;
            $where_order2['shop_id'] = $item['shop_id'];
            $num =  $shop_order->where($where_order2)->field('shop_id')->count();
            if($num>$max_shop_num){
                $max_shop_num = $num;
                $max_shop_id = $item['shop_id'];
            }
        }
        $shop_info = M('shop')->where(array('id'=>$max_shop_id))->field('id,name,logo')->find();
        $list['shop_info'] = $shop_info;


        //最常购买商品
        $goods_list = $shop_order->where($where_order1)->field('goods_id')->group('goods_id')->select();
        $max_goods_id = 0;
        $max_goods_num = 0;
        foreach ($goods_list as $key=>$item){
            $where_order3 = $where_order1;
            $where_order3['goods_id'] = $item['goods_id'];
            $num =  $shop_order->where($where_order3)->field('goods_id')->count();
            if($num>$max_goods_num){
                $max_goods_num = $num;
                $max_goods_id = $item['goods_id'];
            }
        }
        $goods_info = M('shop_goods')->where(array('id'=>$max_goods_id))->field('id,name,cover')->find();
        $list['goods_info'] = $goods_info;



        //最近购买商品
        $buy_goods1 = $shop_order->where($where_order1)->order('create_time desc')->find();
        $buy_goods = M('shop_goods')->where(array('id'=>$buy_goods1['goods_id']))->field('id,name,cover')->find();
        $list['buy_goods'] = $buy_goods;

        //总消费
        $total_money = 0;
        $total_money += $shop_order->where($where_order1)->sum('money');
        $list['total_money'] = $total_money;

        //最高
        $max_money = $shop_order->where($where_order1)->order('money desc')->find();
        $list['max_money'] = $max_money['money']?$max_money['money']:0;

        //最低
        $min_money = $shop_order->where($where_order1)->order('money')->find();
        $list['min_money'] = $min_money['money']?$min_money['money']:0;


        $list['a_user_num'] = (String)$a_user_num;
        $list['b_user_num'] = (String)$b_user_num;
        $list['a_list'] = $a_list;

        $list['xia_user'] = $xia_user;
        $list['xia_list'] = $xia_list;





        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
            'check_user'=>$check_user,
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }










    /**
     * 我的团队-设置星级会员展示信息
     */
    function TeamSetVipList(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $where['code_user'] = $user_info['id'];
        $where['is_agent'] = 0;
        $where['is_team_pay'] = 0;
        $list =  $user->where($where)->limit($start,$num)->order('create_time desc')->field('id,head,name')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的团队-设置用户成为代理提交
     */
    function SetUserJoinTeam(){
        $user = M('user');

        $agent_share = M('agent_share');
        $team = M('team');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $set_user_id = decrypt1(trim(I('post.set_user_id')));
        $from = decrypt1(trim(I('post.from')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';
        if($from!='xcx'){
            $arr = array('code' => 0, 'res' => '此功能已暂停使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $set_user = $user->where(array('id'=>$set_user_id))->field('is_agent,is_team_pay,code_user,phone,name,sex,age,ali_user_id')->find();
        if($set_user['id']==$user_info['id']){$arr = array('code' => 0, 'res' => '不能邀请自己');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['id']!=$set_user['code_user']) {$arr = array('code' => 0, 'res' => '没有设置权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_agent']!='1') {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($set_user['is_agent']=='1') {$arr = array('code' => 0, 'res' => '此用户已经是代理');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $is_have = $agent_share->where(['user_id'=>$set_user_id])->find();
       if($is_have){
           $arr = array(
               'code'=> 1,
               'res'=>'邀请成功',
           );

           $data = json_encode($arr);
           $return['encryption'] =  encrypt1($data);
           $this->ajaxReturn($return,"JSON");
       }else{
           $add['send_user_id'] = $user_info['id'];
           $add['user_id'] = $set_user_id;
           $add['create_time'] = time();
           $query = $agent_share->add($add);
       }




        if ($query){
             $arr = array(
                'code'=> 1,
                'res'=>'邀请成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'邀请失败',
            );
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 扫码支付-确认订单
     */
    function HospitalOrderInfo(){
        $user = M('user');

        $hospital = M('hospital');
        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$order_id = decrypt1(trim(I('post.qr_val')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $arr = array('code' => 0, 'res' => '此功能已下架，请前往对应机构买单支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        //$page = decrypt1(trim(I('post.page')));
        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "6f8d7f3353587fb88380aabdf4357743";
        //$order_id = '110';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($order_info['user_id']){
            if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '二维码已失效');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            //if ($order_info['status']!='1') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }else{
            if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $hos_info = $hospital->where(array('id'=>$order_info['parent']))->field('name,logo,classify,location')->find();
        $order_info['hospital_info'] = $hos_info;
        $ticket_num = 0;
        if ($order_info['type']=='1' && $order_info['use_type']=='1'){
            $t_list = $ticket_hospital
                ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
                ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price')
                ->where(array('lyx_ticket_hospital.hospital_id'=>$order_info['parent'],'lyx_ticket.type'=>array('IN','1,3')))
                ->select();
            if($t_list){
                foreach ($t_list as $item){
                    $t_arr[] = $item['ticket_id'];
                }


                $t_val = implode(',',$t_arr);
                $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
                $where_t['lyx_ticket.type']= array('IN','1,3');
                $where_t['lyx_ticket_user.parent']= array('IN',$t_val);
                $usable_list = $ticket_user
                    ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                    ->field('lyx_ticket_user.id as have_id,lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket_user.discount')
                    ->where($where_t)
                    ->select();

                foreach ($usable_list as $key=>$item){
                    $js_dis = $item['discount']/100;
                    $jian = ($order_info['total_money'] - $order_info['cost'])*$js_dis;
                    $usable_list[$key]['ticket_money'] = (String)($jian-$order_info['loans']+$order_info['cost']);
                    if ($usable_list[$key]['ticket_money']<=0){
                        unset($usable_list[$key]);
                    }
                }
                $ticket_num += count($usable_list);

            }
        }else{
            if  ($order_info['type']=='1'){
                $where_t['type']= 2;
                $where_t['user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
            }else{
                $where_t['type']= array('NEQ','2');
                $where_t['use_type']= 2;
                $where_t['user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
            }

            $where_t['parent']= array('IN',$order_info['ticket_list']);
            $ticket_num += $ticket_user->where($where_t)->count();
        }


        $order_info['usable_ticket']  = (String)$ticket_num;



        $order_info['usable_score'] = '0';

        if ($order_info['type']=='1'){
            $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
            $socre_max = $set->where(array('set_type'=>'score_use_max'))->find();
            if  ($user_info['score']>=$socre_num['set_value']){
                $max_money1 = $order_info['pay_money'] *($socre_max['set_value']/100);
                $max_money = floor($max_money1);
                $max = ($max_money/$socre_num['remark'])*$socre_num['set_value'];

                if  ( $user_info['score']>$max){
                    $order_info['usable_score'] = (String)$max;
                }else{
                    $order_info['usable_score'] =  (String)$user_info['score'];
                }
            }
        }
        $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
        if($order_info['total_money']>=$noun_money['set_value']){
            $order_info['is_noun'] = '1';
        }else{
            $order_info['is_noun'] = '0';
        }



        unset($order_info['ticket_money']);
        unset($order_info['score']);
        unset($order_info['money']);
        unset($order_info['score_money']);
        unset($order_info['ticket_id']);
        unset($order_info['user_id']);
        unset($order_info['create_time']);
        unset($order_info['update_time']);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$order_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 扫码支付-使用优惠券
     */
    function HospitalOrderTicket(){
        $user = M('user');

        $hospital = M('hospital');
        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "38e59920c3837c2f1e7606c78551c12c";
        //$order_id = '118';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($order_info['user_id']){
            if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '二维码已失效');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $hos_info = $hospital->where(array('id'=>$order_info['parent']))->field('name,logo,classify,location')->find();
        $order_info['hospital_info'] = $hos_info;
        $usable_list = array();

        $t_list = $ticket_hospital
            ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
            ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
            ->where(array('lyx_ticket_hospital.hospital_id'=>$order_info['parent'],'lyx_ticket.type'=>array('IN','1,3'),'lyx_ticket.ticket_type'=>1))
            ->select();
        if($order_info['type']=='1' && $order_info['use_type']=='1'){
            if($t_list){
                foreach ($t_list as $item){
                    $t_arr[] = $item['ticket_id'];
                }
                $t_val = implode(',',$t_arr);
                $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
                $where_t['lyx_ticket.type']= array('IN','1,3');
                $where_t['lyx_ticket.ticket_type']= 1;
                $where_t['lyx_ticket_user.parent']= array('IN',$t_val);
                $usable_list = $ticket_user
                    ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                    ->where($where_t)
                    ->field('lyx_ticket_user.id as have_id,lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket_user.discount,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                    ->select();

                foreach ($usable_list as $key=>$item){
                    $usable_list[$key]['discount'] = (String)($item['discount']/10);
                    $js_dis = $item['discount']/100;

                    $jian = ($order_info['total_money'] - $order_info['cost'])*$js_dis;
                    $usable_list[$key]['ticket_money'] = (String)($jian-$order_info['loans']+$order_info['cost']);
                    if ($usable_list[$key]['ticket_money']<=0){
                        unset($usable_list[$key]);
                    }
                }

            }
        }else{
            if ($order_info['type']=='2'){
                $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
                $where_t['lyx_ticket.type']= 2;
                $where_t['lyx_ticket.ticket_type']= 1;
                $where_t['lyx_ticket_user.parent']= array('IN',$order_info['ticket_list']);
            }else{
                $where_t['lyx_ticket_user.user_id']= $user_info['id'];
                $where_t['lyx_ticket_user.status']= 0;
                $where_t['lyx_ticket.type']= array('NEQ','2');
                $where_t['lyx_ticket.use_type']= 2;
                $where_t['lyx_ticket.ticket_type']= 1;
                $where_t['lyx_ticket_user.parent']= array('IN',$order_info['ticket_list']);
            }

            $usable_list = $ticket_user
                ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                ->where($where_t)
                ->field('lyx_ticket_user.id as have_id,lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket_user.discount,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                ->select();



            foreach ($usable_list as $key=>$item){
                $usable_list[$key]['discount'] = '0';
                $usable_list[$key]['ticket_money'] = '0';
            }
        }

        foreach ($t_list as $key=>$item){
            $t_list[$key]['discount'] = (String)($item['discount']/10);
        }


        $usable_list = array_merge($usable_list);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'usable_list'=>$usable_list,
            'ticket_list'=>$t_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 扫码支付-使用积分
     */
    function HospitalOrderScore(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$order_id = '1';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($order_info['user_id']){
            if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '二维码已失效');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['type']=='2') {$arr = array('code' => 0, 'res' => '此订单无法使用积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $socre_num = $set->where(array('set_type'=>'score_pay'))->find();

        $list['user_score']  = $user_info['score'];
        $list['rule_score']  = $socre_num['set_value'];
        $list['rule_money']  = $socre_num['remark'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 扫码支付-支付体验券订单（使用体验券）
     */
    function HospitalOrderUse(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $have_id = decrypt1(trim(I('post.have_id')));

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($order_info['user_id']){
            if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '二维码已失效');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['type']!='2') {$arr = array('code' => 0, 'res' => '此订单类型不是体验订单');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$have_id) {$arr = array('code' => 0, 'res' => '请选择要使用的优惠券');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $is_have = $ticket_user->where(array('id'=>$have_id))->find();
        if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $ticket_info = M('ticket')->where(['id'=>$is_have['parent']])->find();
        if($ticket_info['ticket_type']==3){
            if($order_info['ticket_list']!=$ticket_info['id']){
                {$arr = array('code' => 0, 'res' => '此优惠券无法在此项目使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            }
        }else{
            $where_check['hospital_id'] = $order_info['shop_id'];
            $where_check['ticket_id'] = $is_have['parent'];
            $where_check['ticket_type'] = 1;
            $is_use = $ticket_hospital->where($where_check)->find();
            if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前医院使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }

        $save['ticket_id'] = $have_id;
        $save['ticket_money'] = 0;

        $save['user_id'] = $user_info['id'];
        $save['status'] = 4;
        $save['update_time'] = time();
        $save['pay_time'] = time();
        //平台抽水
   /*     $chou_odds = M('set')->where(array('set_type'=>'hos_order_chou'))->find();
        if($chou_odds['set_value']!='0'){
            $chou_money = $order_info['total_money'] - $order_info['cost'] - $order_info['loans'];
            $odds = $chou_odds['set_value']/100;
            $chou = $chou_money * $odds;
            $save['chou'] = $chou;
            $save['odds'] = $chou_odds['set_value'];
        }*/

        $query = $hospital_order->where(array('id'=>$order_id))->save($save);
        if($query){
            $a = SendSocket($order_info['parent'],$order_info['id']);
            //代理抽水
            //HosOrderAgentChou($order_id);
            $ticket_user->where(array('id'=>$have_id))->save(array('status'=>'1','update_time'=>time()));

            if($ticket_info['ticket_type']==3){
                TicketUseGetMoneyProject($order_id);
                //增加销量
                M('project_apply')->where(['id'=>$order_info['project_apply_id']])->setInc('sales',1);
                M('shop_goods')->where(['project_id'=>$order_info['project_apply_id']])->setInc('sales',1);
            }else{
                //返利给医院
                if($is_use['money']>0){
                    TicketUseGetMoney($is_use['id'],$order_id);
                }
            }

            $arr = array(
                'code'=> 1,
                'res'=>'支付成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'支付成功',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 扫码支付-支付抵消券（使用非体验券外的抵消券）
     */
    function HospitalOrderDi(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $have_id = decrypt1(trim(I('post.have_id')));

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($order_info['user_id']){
            if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '二维码已失效');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['type']=='2') {$arr = array('code' => 0, 'res' => '订单错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['use_type']!='2') {$arr = array('code' => 0, 'res' => '订单类型错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$have_id) {$arr = array('code' => 0, 'res' => '请选择要使用的优惠券');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $is_have = $ticket_user->where(array('id'=>$have_id))->find();
        if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $where_check['hospital_id'] = $order_info['shop_id'];
        $where_check['ticket_id'] = $is_have['parent'];
        $where_check['ticket_type'] = 1;
        $is_use = $ticket_hospital->where($where_check)->find();
        if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前机构使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $save['ticket_id'] = $have_id;
        $save['ticket_money'] = 0;

        $save['user_id'] = $user_info['id'];
        $save['status'] = 4;
        $save['update_time'] = time();
        $save['pay_time'] = time();
        //平台抽水
        /*     $chou_odds = M('set')->where(array('set_type'=>'hos_order_chou'))->find();
             if($chou_odds['set_value']!='0'){
                 $chou_money = $order_info['total_money'] - $order_info['cost'] - $order_info['loans'];
                 $odds = $chou_odds['set_value']/100;
                 $chou = $chou_money * $odds;
                 $save['chou'] = $chou;
                 $save['odds'] = $chou_odds['set_value'];
             }*/

        $query = $hospital_order->where(array('id'=>$order_id))->save($save);
        if($query){

            $a = SendSocket($order_info['parent'],$order_info['id']);
            //代理抽水
            //HosOrderAgentChou($order_id);
            $ticket_user->where(array('id'=>$have_id))->save(array('status'=>'1','update_time'=>time()));
            //返利给医院
            if($is_use['money']>0){
                TicketUseGetMoney($is_use['id'],$order_id);
            }
            $arr = array(
                'code'=> 1,
                'res'=>'支付成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'支付成功',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }
    /**
     * 扫码支付-模拟支付宝支付
     */
    function HospitalOrderPay(){
        die;
        $user = M('user');

        $hospital_order = M('hospital_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $have_id = decrypt1(trim(I('post.have_id')));
        $score = decrypt1(trim(I('post.score')));


        //$page = decrypt1(trim(I('post.page')));
        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$order_id = '1';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($order_info['user_id']){
            if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '二维码已失效');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $pay_money = $order_info['pay_money'];
        if  ($have_id){
            $is_have = $ticket_user->where(array('id'=>$have_id))->find();
            if (!$is_have || $is_have['status']!='0') {$arr = array('code' => 0, 'res' => '未拥有此优惠券或已使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $where_check['hospital_id'] = $order_info['parent'];
            $where_check['ticket_id'] = $is_have['parent'];
            $is_use = $ticket_hospital->where($where_check)->find();
            if (!$is_use) {$arr = array('code' => 0, 'res' => '此优惠券无法在当前医院使用');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $odds = $is_have['discount']/100;
            $pay_money1 = ($order_info['total_money']-$order_info['cost']) * $odds;
            $pay_money = $pay_money1 - $order_info['loans']+$order_info['cost'];
            $save['ticket_id'] = $have_id;
            $save['ticket_money'] = $order_info['pay_money']  - $pay_money;
        }


        if ($score){
            $socre_num = $set->where(array('set_type'=>'score_pay'))->find();
            $socre_max = $set->where(array('set_type'=>'score_use_max'))->find();
            if ($score < $socre_num['set_value']) {$arr = array('code' => 0, 'res' => '最低使用'.$socre_num['set_value'].'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($score%$socre_num['set_value']!=0) {$arr = array('code' => 0, 'res' => '积分只能输入'.$socre_num['set_value'].'或其倍数');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $max_money1 = $order_info['pay_money'] *($socre_max['set_value']/100);
            $max_money = floor($max_money1);
            $max = ($max_money/$socre_num['remark'])*$socre_num['set_value'];


            if ($score>$max) {$arr = array('code' => 0, 'res' => '此订单最大使用'.$max.'积分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $bei = $score/$socre_num['set_value'];
            $score_money = $bei*$socre_num['remark'];

            $pay_money -= $score_money;

            $save['score'] = $score;
            $save['score_money'] = $score_money;
        }


        $save['user_id'] = $user_info['id'];
        $save['money'] = $pay_money;
        $save['status'] = 1;
        $save['update_time'] = time();
        $save['pay_time'] = time();
        //平台抽水
        $chou_odds = M('set')->where(array('set_type'=>'hos_order_chou'))->find();
        if($chou_odds['set_value']!='0'){
            $chou_money = $order_info['total_money'] - $order_info['cost'] - $order_info['loans'];
            $odds = $chou_odds['set_value']/100;
            $chou = $chou_money * $odds;
            $save['chou'] = $chou;
            $save['odds'] = $chou_odds['set_value'];
        }


        $query = $hospital_order->where(array('id'=>$order_id))->save($save);
        if($query){




            if($score){
                $user->where(array('id'=>$user_info['id']))->setDec('score',$score);
                //减去积分
                $add_log['user_id'] = $user_info['id'];
                $add_log['add_or_del'] = 2;
                $add_log['type'] = 2;
                $add_log['num'] = $score;
                $add_log['order_id'] = $order_id;
                $add_log['create_time'] = time();
                M('shop_score_log')->add($add_log);
            }

            //代理抽水
            HosOrderAgentChou($order_id);

            if  ($have_id){
                $ticket_user->where(array('id'=>$have_id))->save(array('status'=>'1','update_time'=>time()));
            }

            $arr = array(
                'code'=> 1,
                'res'=>'支付成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'支付成功',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-医院订单
     */
    function MyHospitqalList(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $doctor = M('doctor');
        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        $page = decrypt1(trim(I('post.page')));
         if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$order_id = '1';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $where['lyx_hospital_order.user_id'] = $user_info['id'];
        $where['lyx_hospital_order.status'] = array('NEQ','0');
        $list= $hospital_order
            ->join('lyx_shop ON lyx_hospital_order.shop_id = lyx_shop.id')
            ->field('lyx_hospital_order.id as order_id,lyx_hospital_order.total_money,lyx_hospital_order.order_number,lyx_hospital_order.parent,lyx_hospital_order.doctor_id,
            lyx_shop.name,lyx_shop.classify,lyx_shop.logo,lyx_hospital_order.money,lyx_hospital_order.status,
            lyx_hospital_order.refund_status,lyx_hospital_order.refund_money,lyx_hospital_order.project_apply_id')
            ->where($where)->limit($start,$num)->order('lyx_hospital_order.create_time desc')->select();
        $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();

        $class_list = M('store_classify')->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }

        foreach($list as $key=>$item){
            $list[$key]['classify'] = $new_class[$item['classify']];
//            $doc_name = $doctor->where(array('id'=>$item['doctor_id']))->field('name')->find();
//            $list[$key]['doctor_name'] =$doc_name['name']?$doc_name['name']:"";

            if($item['total_money']>=$noun_money['set_value']){
                $list[$key]['is_noun'] = '1';
                $where_bx['order_id'] = $item['order_id'];
                $where_bx['type'] = 2;
                $is_have_noun = M('order_bx')->where($where_bx)->count();
                if($is_have_noun>0){
                    $list[$key]['is_noun'] = '2';
                }
            }else{
                $list[$key]['is_noun'] = '0';
            }

        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-医院订单-评价信息
     */
    function SubmitHospitalOrderData(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $doctor = M('doctor');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$order_id = '1';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}




        $where['lyx_hospital_order.id'] = $order_id;
        $list= $hospital_order
            ->join('lyx_hospital ON lyx_hospital_order.parent = lyx_hospital.id')
            ->field('lyx_hospital_order.id as order_id,lyx_hospital_order.order_number,lyx_hospital_order.parent,lyx_hospital_order.doctor_id,
            lyx_hospital.name,lyx_hospital.classify,lyx_hospital.logo,lyx_hospital_order.money,lyx_hospital_order.status')
            ->where($where)->find();

        $doc_name = $doctor->where(array('id'=>$list['doctor_id']))->field('name')->find();
        $list['doctor_name'] =$doc_name['name']?$doc_name['name']:"";




        if ($list){
            $arr = array(
                'code'=> 1,
                'res'=>'查询成功',
                'list'=>$list,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'查询失败',
                'list'=>array(),
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-医院订单-提交评价
     */
    function SubmitHospitalOrder(){
        $user = M('user');

        $hospital_order = M('hospital_order');
        $hospital_comment = M('order_comment');
        $hospital_comment_photo = M('order_comment_photo');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $content = decrypt1(trim(I('post.content')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $grade = decrypt1(trim(I('post.grade')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}




        if (!$grade) {$arr = array('code' => 0, 'res' => '请选择评价星级');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$content) {$arr = array('code' => 0, 'res' => '请输入评价内容');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['status']!='4') {$arr = array('code' => 0, 'res' => '订单状态错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($img_url){
            $add['type'] = '1';
        }else{
            $add['type'] = '3';
        }

        $add['order_type'] = 2;
        $add['content'] = $content;
        $add['grade'] = $grade;
        $add['order_id'] = $order_id;
        $add['parent'] = $order_info['parent'];
        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();

        $query = $hospital_comment->where(array('id'=>$order_id))->add($add);

        if ($query){
            //星级评分
            gradeset($order_info['parent'],'1');
            $hospital_order->where(array('id'=>$order_id))->save(array('status'=>'5','update_time'=>time()));
            if ($img_url){
                $img_arr = explode(',',$img_url);
                $add_img['blogs_id'] = $query;
                $add_img['create_time'] = time();
                foreach ($img_arr as $item){
                    $add_img['img_url'] = $item;
                    $hospital_comment_photo->add($add_img);
                }
            }
            $arr = array(
                'code'=> 1,
                'res'=>'评论成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 个人中心-商城订单-提交评价
     */
    function SubmitShopOrder(){
        $user = M('user');

        $hospital_order = M('shop_order');
        $hospital_comment = M('order_comment');
        $hospital_comment_photo = M('order_comment_photo');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $content = decrypt1(trim(I('post.content')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $grade = decrypt1(trim(I('post.grade')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}




        if (!$grade) {$arr = array('code' => 0, 'res' => '请选择评价星级');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$content) {$arr = array('code' => 0, 'res' => '请输入评价内容');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['status']!='5') {$arr = array('code' => 0, 'res' => '订单状态错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($img_url){
            $add['type'] = '1';
        }else{
            $add['type'] = '3';
        }

        $add['order_type'] = 1;
        $add['content'] = $content;
        $add['grade'] = $grade;
        $add['order_id'] = $order_id;
        $add['parent'] = $order_info['shop_id'];
        $add['goods_id'] = $order_info['goods_id'];
        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();

        $query = $hospital_comment->where(array('id'=>$order_id))->add($add);

        if ($query){
            //星级评分
            gradeset($order_info['shop_id'],'2');
            $hospital_order->where(array('id'=>$order_id))->save(array('status'=>'6','update_time'=>time()));
            if ($img_url){
                $img_arr = explode(',',$img_url);
                $add_img['blogs_id'] = $query;
                $add_img['create_time'] = time();
                foreach ($img_arr as $item){
                    $add_img['img_url'] = $item;
                    $hospital_comment_photo->add($add_img);
                }
            }
            $arr = array(
                'code'=> 1,
                'res'=>'评论成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的优惠券-赠送
     */
    function GiveTicket(){
        $user = M('user');

        $ticket_user = M('ticket_user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $phone = decrypt1(trim(I('post.phone')));
        $have_id = decrypt1(trim(I('post.have_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $have_info = $ticket_user->where(array('id'=>$have_id))->find();

        if ($user_info['id'] != $have_info['user_id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($have_info['status']!='0') {$arr = array('code' => 0, 'res' => '无法赠送');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $give_user = $user->where(array('phone'=>$phone))->field('id')->find();
        if (!$give_user) {$arr = array('code' => 0, 'res' => '赠送用户不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($give_user['id']==$user_info['id']) {$arr = array('code' => 0, 'res' => '不能送给自己');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $save['user_id'] = $give_user['id'];
        $save['is_zhuan'] = 1;
        $save['update_time'] = time();

        $query = $ticket_user->where(array('id'=>$have_id))->save($save);


        if ($query){
            $ticket_give = M('ticket_give');
            $add['parent'] = $have_id;
            $add['user_id'] = $user_info['id'];
            $add['get_user_id'] = $give_user['id'];
            $add['create_time'] = time();
            $ticket_give->add($add);

            $arr = array(
                'code'=> 1,
                'res'=>'赠送成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'赠送失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的优惠券-退款
     */
    function GiveRefund(){
        $user = M('user');

        $ticket = M('ticket');
        $ticket_user = M('ticket_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $have_id = decrypt1(trim(I('post.have_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        //if (!$user_info['ali_number'] || !$user_info['ali_name']) {$arr = array('code' => 0, 'res' => '请先绑定支付宝账号再进行退款操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$user_info['ali_user_id']) {$arr = array('code' => 3001, 'res' => '请先绑定支付宝账号再进行退款操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $have_info = $ticket_user->where(array('id'=>$have_id))->find();

        if ($user_info['id'] != $have_info['user_id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($have_info['status']!='0') {$arr = array('code' => 0, 'res' => '已使用或已退款');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($have_info['is_zhuan']=='1') {$arr = array('code' => 0, 'res' => '转送优惠券无法退款');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $ticket_info = $ticket->where(array('id'=>$have_info['parent']))->find();
        if ($ticket_info['type']=='2') {$arr = array('code' => 0, 'res' => '体验券无法退款');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($have_info['buy_money']<=0) {$arr = array('code' => 0, 'res' => '免费优惠券无法退款');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $save['status'] = 3;
        $save['update_time'] = time();

        $query = $ticket_user->where(array('id'=>$have_id))->save($save);

        if ($query){

            $add_tui['user_id'] = $user_info['id'];
            $add_tui['type'] = 2;
            $add_tui['type_id'] = $have_info['id'];
            $add_tui['money'] = $have_info['buy_money'];
            $add_tui['create_time'] = time();
            M('tui')->add($add_tui);

            $arr = array(
                'code'=> 1,
                'res'=>'退款成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'退款失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 我的店铺- 发布/修改 商品
     */
    function SubmitShopData(){
        $user = M('user');

        $shop = M('shop');
        $shop_select = M('shop_select');
        $shop_goods = M('shop_goods');
        $shop_goods_banner = M('shop_goods_banner');
        $shop_goods_photo = M('shop_goods_photo');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $name = decrypt1(trim(I('post.name')));
        $stock = decrypt1(trim(I('post.stock')));
        $select_list = decrypt1(trim(I('post.select_list')));
        $is_prepay = decrypt1(trim(I('post.is_prepay')));
        $prepay = decrypt1(trim(I('post.prepay')));
        $content = decrypt1(trim(I('post.content')));
        $goods_id = decrypt1(trim(I('post.goods_id')));
        $classify = decrypt1(trim(I('post.classify')));
        $max = decrypt1(trim(I('post.max')));
        $postage_id = decrypt1(trim(I('post.postage_id')));

        //$page = decrypt1(trim(I('post.page')));
        if(!$max){$max = 0;}
        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还没有开通店铺，无法发布商品');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($shop_info['is_show']!='1') {$arr = array('code' => 0, 'res' => '您的店铺已被后台封禁，请联系客服');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($goods_id){
            $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
            if (!$goods_info) {$arr = array('code' => 0, 'res' => '商品不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($goods_info['shop_id']!=$shop_info['id']) {$arr = array('code' => 0, 'res' => '没有权限修改');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        if (!$img_url) {$arr = array('code' => 0, 'res' => '请上传至少一张商品图片');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$name) {$arr = array('code' => 0, 'res' => '请输入商品名称');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$stock) {$arr = array('code' => 0, 'res' => '请输入商品库存');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($stock<0) {$arr = array('code' => 0, 'res' => '库存数量不能小于1');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$select_list) {$arr = array('code' => 0, 'res' => '请输入颜色/规格分类信息');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$content) {$arr = array('code' => 0, 'res' => '请输入商品详情');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($is_prepay=='1') {

            if (!$prepay) {$arr = array('code' => 0, 'res' => '请输入预约金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($prepay<0) {$arr = array('code' => 0, 'res' => '预约金额不能小于等于0');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $select_list1 = json_decode($select_list,true);
        foreach ($select_list1 as $key=>$item){
            if (!$item['select_name']){
                $select_list1[$key]['select_name'] = "颜色/规格分类";
            }
            if (!$item['value']){
                $arr = array('code' => 0, 'res' => '请输入规格名称');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            if (!$item['add_price']){
                $arr = array('code' => 0, 'res' => '请输入价格');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            if ($item['add_price']<0){
                $arr = array('code' => 0, 'res' => '价格不能小于等于0');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }

            if ($is_prepay=='1') {
                if ($prepay>=$item['add_price']) {$arr = array('code' => 0, 'res' => '预约金额不能大于商品价格');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            }
        }

        $last_names = array_column($select_list1,'add_price');
        array_multisort($last_names,SORT_ASC,$select_list1);

        $img_list = explode(',',$img_url);



        $add['max'] = $max;
        $add['classify'] = $classify;
        $add['name'] = $name;
        $add['cover'] = $img_list[0];
        $add['price'] = $select_list1[0]['add_price'];
        $add['prepay'] = $prepay;
        $add['is_prepay'] = $is_prepay;
        $add['stock'] = $stock;
        $add['lng'] = $shop_info['lng'];
        $add['lat'] = $shop_info['lat'];
        $add['postage_id'] = $postage_id;

        if ($goods_id){
            $add['update_time'] = time();
            $query = $shop_goods->where(array('id'=>$goods_id))->save($add);
            if  ($query){
                $query = $goods_id;
            }
            $res = '修改';
        }else{

            $add['shop_id'] = $shop_info['id'];
           /* $add['classify'] = $shop_info['classify'];*/
            $add['create_time'] = time();
            $add['is_show'] = 1;
            $query = $shop_goods->add($add);
            $res = '发布';
        }


        if ($query){
            //商品图片
            $shop_goods_banner->where(array('goods_id'=>$query))->delete();
            if (count($img_list)>1){
                $add_img['goods_id'] = $query;
                $add_img['create_time'] = time();
                foreach ($img_list as $key=>$item){
                    if ($key!=0){
                        $add_img['img_url'] = $item;
                        $shop_goods_banner->add($add_img);
                    }

                }
            }

            //商品内容
            $is_have = $shop_goods_photo->where(array('goods_id'=>$query))->field('id')->find();
            if ($is_have){
                $shop_goods_photo->where(array('id'=>$is_have['id']))->save(array('content'=>$content,'goods_id'=>$query,'create_time'=>time()));
            }else{
                $shop_goods_photo->add(array('content'=>$content,'goods_id'=>$query,'create_time'=>time()));
            }

            //商品规格
            $shop_select->where(array('goods_id'=>$query))->delete();
            $add_sel['goods_id'] = $query;
            $add_sel['create_time'] = time();
            foreach ($select_list1 as $item){
                $add_sel['select_name'] = $item['select_name'];
                $add_sel['value'] = $item['value'];
                $add_sel['add_price'] = $item['add_price'];
                $shop_select->add($add_sel);
            }

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的店铺-删除商品
     */
    function DeleteMyGoods(){
        $user = M('user');

        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还没有开通店铺，无法发布商品');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($shop_info['is_show']!='1') {$arr = array('code' => 0, 'res' => '您的店铺已被后台封禁，请联系客服');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
        if (!$goods_info) {$arr = array('code' => 0, 'res' => '商品不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($goods_info['shop_id']!=$shop_info['id']) {$arr = array('code' => 0, 'res' => '没有权限删除');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $save['is_del'] = 1;
        $save['is_show'] = 0;
        $save['update_time'] = time();

        $query = $shop_goods->where(array('id'=>$goods_id))->save($save);

        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>'删除成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'删除失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /**
     * 我的店铺-上/下架商品
     */
    function EditGoodsShowStatus(){
        $user = M('user');

        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));
        $goods_id = decrypt1(trim(I('post.goods_id')));
        if(!$type){$type='0';}
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还没有开通店铺，无法发布商品');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($shop_info['is_show']!='1') {$arr = array('code' => 0, 'res' => '您的店铺已被后台封禁，请联系客服');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
        if (!$goods_info) {$arr = array('code' => 0, 'res' => '商品不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($goods_info['shop_id']!=$shop_info['id']) {$arr = array('code' => 0, 'res' => '没有权限删除');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $save['is_show'] = $type;
        $save['update_time'] = time();

        $query = $shop_goods->where(array('id'=>$goods_id))->save($save);

        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>'修改成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'修改失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 新消息中心查询是否有消息
     */
    function newChatNum(){
        $ticket_user = M('ticket_user');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $list['total_num'] = 0;
        $ticket_num = $ticket_user
            ->where(['lyx_ticket_user.status'=>0,
                'lyx_ticket_user.user_id'=>$user_info['id'],
                'lyx_ticket.ticket_type'=>3
                ])
            ->join('lyx_ticket ON lyx_ticket_user.parent=lyx_ticket.id')
            ->count();
        $list['ticket_num'] = $ticket_num;

        $list['total_num'] += $ticket_num;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 新消息中心查询是否有消息（优惠券列表）
     */
    function newChatList(){
        $ticket_user = M('ticket_user');
        $project = M('project');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $ticket_list = $ticket_user
            ->where(['lyx_ticket_user.status'=>0,
                'lyx_ticket_user.user_id'=>$user_info['id'],
                'lyx_ticket.ticket_type'=>3
            ])
            ->field('lyx_ticket_user.id,lyx_ticket.project_id')
            ->join('lyx_ticket ON lyx_ticket_user.parent=lyx_ticket.id')
            ->select();
        foreach ($ticket_list as $key=>$item){
            $pro = $project->where(['id'=>$item['project_id']])->field('id,name')->find();
            $ticket_list[$key]['project'] = $pro;
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$ticket_list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 新消息中心查询是否有消息（邀请函）
     */
    function newChatListInfo(){
        $agent_share = M('agent_share');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $agent_share->where(['user_id'=>$user_info['id']])->order('create_time','desc')->select();
        $agent_share->where(['user_id'=>$user_info['id'],'is_read'=>0])->save(['is_read'=>1,'update_time'=>time()]);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 活动项目
     */
    function projectList(){
        $project = M('project');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $project->field('id,name')->where(array('is_show'=>1))->select();
        $new_list[] = array('id'=>0, 'name'=>'请选择');
        $new_arr[] = '请选择';
        foreach ($list as $item){
            $new_list[] = $item;
            $new_arr[] = $item['name'];
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$new_list,
            'arr' =>$new_arr,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 活动分类
     */
    function projectClassList(){
        $project_class = M('project_class');
        $user = M('user');
        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $project_class->field('id,name')
            ->where(array('is_show'=>1,'parent'=>$id))->select();
        $new_list[] = array('id'=>0, 'name'=>'请选择');
        $new_arr[] = '请选择';
        foreach ($list as $item){
            $new_list[] = $item;
            $new_arr[] = $item['name'];
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$new_list,
            'arr' =>$new_arr,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 活动列表
     */
    function projectJoinList(){
        $project_class = M('project_class');
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $project = M('project');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $pro_list = $project->select();
        foreach ($pro_list as $item){
            $new_pro[$item['id']] = $item['name'];
        }
        $class_list = $project_class->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }

        $shop_info = M('shop')->where(array('user_id'=>$user_info['id']))->find();
        $list = $project_apply
            ->where(array('shop_id'=>$shop_info['id']))->select();
        foreach ($list as $key=>$item){
            $list[$key]['project'] = $new_pro[$item['project_id']];
            $list[$key]['class'] = $new_class[$item['parent']];
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


      /**
     * 活动详细
     */
    function projectDetail(){
        $project_class = M('project_class');
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $project = M('project');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $project->where(array('id'=>$id))->find();
        if ($list['is_show']==0) {$arr = array('code' => 0, 'res' => '活动已下架');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $list['class_list'] = $project_class
            ->order('sort desc')
            ->where(array('parent'=>$list['id'],'is_show'=>1))->select();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 活动分类详细
     */
    function projectClassDetail(){
        $project_class = M('project_class');
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $project = M('project');
        $hospital_order = M('hospital_order');
        $user = M('user');
        $shop = M('shop');

        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $search = decrypt1(trim(I('post.search')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $project_class->where(array('id'=>$id))->find();
        if ($list['is_show']==0) {$arr = array('code' => 0, 'res' => '活动已下架');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $pro_info = $project->where(array('id'=>$list['parent']))->find();
        $list['pro_info']  = $pro_info;

        $where['is_show'] = 1;
        $where['is_open'] = 1;
        $where['parent'] = $list['id'];
        if($search){
            $where['name'] =  array("like","%".$search."%");;
        }

        $shop_list = $project_apply->where($where)->select();
        foreach ($shop_list as $key=>$item){
            $order_num = $hospital_order->where(array('project_apply_id'=>$item['id']))->count();
            $shop_info = $shop->where(['id'=>$item['shop_id']])->field('id,name,logo,location,lng,lat')->find();
            $shop_list[$key]['dis'] = getDistance($lat,$lng,$shop_info['lat'],$shop_info['lng']);
            $shop_list[$key]['shop'] = $shop_info;
            $shop_list[$key]['order_num'] = $order_num;
        }
        $last_names = array_column($shop_list,'dis');
        array_multisort($last_names,SORT_ASC,$shop_list);
        $list['shop_num'] = count($shop_list);
        $list['shop_list'] = $shop_list;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 活动项目详细
     */
    function projectShopDetail(){
        $project_class = M('project_class');
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $project = M('project');
        $hospital_order = M('hospital_order');
        $user = M('user');
        $ticket = M('ticket');
        $ticket_user = M('ticket_user');
        $shop = M('shop');

        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));
        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $project_apply->where(['id'=>$id])->find();
        $shop_info = $shop->where(['id'=>$list['shop_id']])->field('id,name,logo,user_id,location,lng,lat')->find();
        $is_self = $shop_info['user_id']==$user_info['id']?1:0;
        if($user_info['id']==1){
            $is_self=0;
        }
        $list['is_self'] = $is_self;
        $list['shop'] = $shop_info;

        $class_info  = $project_class->where(['id'=>$list['parent']])->field('name,info,parent')->find();
        $list['class'] = $class_info;

        $list['project'] = $project->where(['id'=>$class_info['parent']])->field('id,name')->find();

        $list['img_list'] = $project_img->where(['parent'=>$list['id']])->select();
        $list['order_num'] = $hospital_order->where(['project_apply_id'=>$list['id']])->count();


        $ticket_info = $ticket->where(['ticket_type'=>3,'project_id'=>$class_info['parent']])->find();
        $is_have = $ticket_user
            ->where(['user_id'=>$user_info['id'],'parent'=>$ticket_info['id'],'status'=>0])
            ->find();
        $list['is_have'] = 0;
        if($is_have){
            $list['is_have'] = $is_have['id'];
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 删除项目活动
     */
    function delProject(){
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));


        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $shop_info = M('shop')->where(array('user_id'=>$user_info['id']))->find();
        $apply = $project_apply->where(array('id'=>$id))->find();
        if ($shop_info['id']!=$apply['shop_id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($apply['status']==1) {$arr = array('code' => 0, 'res' => '此申请已通过，无法删除');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $query = $project_apply->where(array('id'=>$id))->delete();
        if($query){

            $arr = array(
                'code'=> 1,
                'res'=>'删除成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'删除失败',
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 修改项目活动
     */
    function editProject(){
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));


        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $shop_info = M('shop')->where(array('user_id'=>$user_info['id']))->find();
        $apply = $project_apply->where(array('id'=>$id))->find();
        if ($shop_info['id']!=$apply['shop_id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($apply['status']!=1) {$arr = array('code' => 0, 'res' => '此申请未通过，无法修改');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $is_open = $apply['is_open']==1?0:1;
        $save['is_open'] = $is_open;
        $save['update_time'] = time();

        $query = $project_apply->where(array('id'=>$id))->save($save);
        if($query){

            $arr = array(
                'code'=> 1,
                'res'=>'修改成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'修改失败',
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 参加活动提交
     */
    function submmitProject(){
        $project_class = M('project_class');
        $project_img = M('project_img');
        $project_apply = M('project_apply');
        $user = M('user');
        $shop = M('shop');

        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $content = decrypt1(trim(I('post.content')));
        $img = decrypt1(trim(I('post.img')));
        $price = decrypt1(trim(I('post.price')));
        $parent = decrypt1(trim(I('post.parent')));
        $project_id = decrypt1(trim(I('post.project_id')));
        if (!$project_id) {$arr = array('code' => 0, 'res' => '请选择活动');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$parent) {$arr = array('code' => 0, 'res' => '请选择活动分类');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$name) {$arr = array('code' => 0, 'res' => '请输入活动名称');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$price) {$arr = array('code' => 0, 'res' => '请输入活动价值');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!is_numeric($price)) {$arr = array('code' => 0, 'res' => '价格只能输入数字');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($price<0) {$arr = array('code' => 0, 'res' => '请输入价格');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$content) {$arr = array('code' => 0, 'res' => '请输入活动内容');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $user_info = $user->where(array('token' => $token))->find();


        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $shop_info = M('shop')->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info) {$arr = array('code' => 0, 'res' => '您还没有开通店铺，无法参与活动');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $img_list = explode(',',$img);
        $add['shop_id'] = $shop_info['id'];
        $add['name'] = $name;
        $add['price'] = $price;
        $add['content'] = $content;
        $add['parent'] = $parent;
        $add['project_id'] = $project_id;
        $add['create_time'] = time();
        $query = $project_apply->add($add);
        if($query){
            foreach ($img_list as $item){
                $add_img['parent'] = $query;
                $add_img['img_url'] = $item;
                $add_img['create_time'] = time();
                $project_img->add($add_img);
            }
            $arr = array(
                'code'=> 1,
                'res'=>'提交成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'提交失败',
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 我的店铺
     */
    function MyShop(){
        $shop_goods = M('shop_goods');
        $user = M('user');
        $shop = M('shop');
        $shop_order = M('shop_order');
        $shop_order_goods = M('shop_order_goods');
        $shop_goods = M('shop_goods');

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$search = '洗发';

        $user_info = $user->where(array('token' => $token))->find();
//        if($user_info['id']==1){
//            $user_info = $user->where(array('id' => 8007))->find();
//        }
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还未开店');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($shop_info['is_show']!='1') {$arr = array('code' => 0, 'res' => '您的店铺已被后台封禁，请联系客服');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list['shop_id'] = $shop_info['id'];
        $list['pay_qr'] = $shop_info['pay_qr'];
        $list['name'] = $shop_info['name'];
        $where_total['shop_id'] = $shop_info['id'];
        $where_total['status'] = array('NOT IN','0,3');
        $total_income = 0;
        $total_income += $shop_order->where($where_total)->sum('total_money');
        $list['total_income'] = (String)$total_income;

        $where_total['is_get'] = 0;
        $total_no = 0;
        $total_no += $shop_order->where($where_total)->sum('total_money');
        $list['total_no'] = (String)$total_no;

        $where_total['is_get'] = 1;
        $total_yes = 0;
        $total_yes += $shop_order->where($where_total)->sum('total_money');
        $list['total_yes'] = (String)$total_yes;

        $goods_num = 0;
        $goods_num += $shop_goods->where(array('shop_id'=>$shop_info['id'],'is_del'=>'0','is_freeze'=>'1'))->count();
        $list['goods_num'] = (String)$goods_num;


        $where_order['type'] = 2;
        $where_order['shop_id'] = $shop_info['id'];
        //$where_order['status'] = array('NEQ','0');
        $where_order['is_confirm'] =1;
        $order_list = $shop_order->where($where_order)->limit($start,$num)->order('status,create_time desc')
            ->field('id,order_number,total_money,status,refund_status,user_id')
            ->select();

        foreach ($order_list as $key1=>$val){
            $goods_list = array();
            $goods_list = $shop_order_goods
                ->join('lyx_shop_goods ON lyx_shop_order_goods.goods_id = lyx_shop_goods.id')
                ->where(array('lyx_shop_order_goods.order_id'=>$val['id']))
                ->field('lyx_shop_order_goods.goods_id,lyx_shop_order_goods.select_id,lyx_shop_order_goods.num,lyx_shop_order_goods.money,
            lyx_shop_goods.name,lyx_shop_goods.cover,lyx_shop_order_goods.select_val')
                ->select();
            $order_list[$key1]['goods_list'] = $goods_list;
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'shop_info' =>$list,
            'order_list' =>$order_list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 我的店铺-信息
     */
    function MyShopInfo(){
        $shop_goods = M('shop_goods');
        $user = M('user');
        $shop = M('shop');
        $shop_order = M('shop_order');
        $shop_order_goods = M('shop_order_goods');
        $shop_goods = M('shop_goods');

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$search = '洗发';

        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))
            ->field('id,logo,name,bg,phone')->find();
        $shop_info['phone'] = $shop_info['phone']?$shop_info['phone']:$user_info['phone'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$shop_info,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 我的店铺-修改店铺信息
     */
    function editMyShopInfo(){

        $user = M('user');
        $shop = M('shop');


        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//1logo，2背景，3店铺电话
        $val = decrypt1(trim(I('post.val')));



        $user_info = $user->where(array('token' => $token))->find();

        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$val) {$arr = array('code' => 0, 'res' => '修改失败');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))
            ->field('id,logo,name,bg,phone')->find();
        if (!$shop_info) {$arr = array('code' => 0, 'res' => '店铺状态错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if($type==1){$save['logo'] = $val;}
        if($type==2){$save['bg'] = $val;}
        if($type==3){$save['phone'] = $val;}
        $save['update_time'] = time();
        $query = $shop->where(array('id'=>$shop_info['id']))->save($save);
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'修改成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'修改失败',
            );
        }



        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }





    /**
     * 我的店铺-我的商品
     */
    function MyShopGoods(){
        $shop_goods = M('shop_goods');
        $user = M('user');
        $shop = M('shop');

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$search = '洗发';

        $user_info = $user->where(array('token' => $token))->find();
        if($user_info['id']==1){
            $user_info = $user->where(array('id' => 8007))->find();
        }
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还未开店');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $asc_desc = 'is_show desc,sales desc,create_time desc';
        $where['is_del'] =   0;
        $where['is_freeze'] =   1;
        $where['shop_id'] =   $shop_info['id'];
        //商品信息
        $goods_list = $shop_goods->where($where)->limit($start,$num)->order($asc_desc)->field('id,shop_id,name,cover,price,sales,is_show')->select();

        if($goods_list){
            foreach ($goods_list as $key=>$item){
                //$goods_list[$key]['shop_name'] = $shop_info['name'];
                $goods_list[$key]['sales'] = '销量 '.$item['sales'];
                $goods_list[$key]['price'] = (String)floatval($item['price']);
            }
        }else{
            $goods_list = array();
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$goods_list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }







    /**
     * 我的店铺-订单操作
     */
    function ShopOrderEdit(){
        $user = M('user');

        $shop = M('shop');
        $shop_order = M('shop_order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//操作类型：1发货，2同意退款，3拒绝退款
        $order_id = decrypt1(trim(I('post.order_id')));
        $express_type = decrypt1(trim(I('post.express_type')));//类型：0不需要快递，1需要
        $express_code = decrypt1(trim(I('post.express_code')));//快递公司代码
        $express_number = decrypt1(trim(I('post.express_number')));//快递单号
        $express_phone = decrypt1(trim(I('post.express_phone')));//收件人手机号后四位

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还没有开通店铺');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($shop_info['is_show']!='1') {$arr = array('code' => 0, 'res' => '您的店铺已被后台封禁，请联系客服');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $shop_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['shop_id']!=$shop_info['id']) {$arr = array('code' => 0, 'res' => '没有权限操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($order_info['status']=='0') {$arr = array('code' => 0, 'res' => '请先支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$type) {$arr = array('code' => 0, 'res' => '请传入要操作的类型');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if($type=='1'){
            if ($order_info['status']!='2') {$arr = array('code' => 0, 'res' => '订单状态错误：1001');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $save_order['status'] = '4';

            if($express_type=='1'){
                if (!$express_number) {$arr = array('code' => 0, 'res' => '请输入快递单号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                if (!$express_phone) {$arr = array('code' => 0, 'res' => '请输入收件人手机号后四位');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                $save_order['express_type'] = 1;
                $save_order['express_code'] = $express_code;
                $save_order['express_number'] = $express_number;
                $save_order['express_phone'] = $express_phone;
            }
        }

        if($type=='2' || $type=='3'){
            if($order_info['status']!='3'){
                $arr = array('code' => 0, 'res' => '订单状态错误：1002');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }else{
                if ($order_info['refund_status']!='1' && $order_info['refund_status']!='3') {$arr = array('code' => 0, 'res' => '订单状态错误：1003');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
                //if ($order_info['refund_status']!='3') {$arr = array('code' => 0, 'res' => '订单状态错误：1004');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            }

            if  ($type=='2'){
                $save_order['refund_status'] = '5';
            }

            if  ($type=='3'){
                $save_order['refund_status'] = '2';
            }

        }

        $save_order['update_time'] = time();




        $query = $shop_order->where(array('id'=>$order_id))->save($save_order);

        if ($query){
            if ($type=='1'){
                $add_system['type'] = 1;//1已发货，2交易成功，3退款成功，4退款失败
                $tis = '已发货';
            }
            if ($type=='2'){
                $add_system['type'] = 3;//1已发货，2交易成功，3退款成功，4退款失败
                $tis = '退款中';

                M('shop_goods')->where(array('id'=>$order_info['goods_id']))->setDec('sales',$order_info['total_num']);
                M('shop_goods')->where(array('id'=>$order_info['goods_id']))->setInc('stock',$order_info['total_num']);

                $add_tui['user_id'] = $order_info['user_id'];
                $add_tui['type'] = 1;
                $add_tui['type_id'] = $order_info['id'];
                $add_tui['money'] = $order_info['money'];


                /*$where_add['user_id'] = $order_info['user_id'];
                $where_add['order_id'] = $order_info['id'];
                $where_add['type'] = 2;
                $jian = M('team_money')->where($where_add)->sum('money');
                if($jian){
                    $add_tui['money'] = bcsub($order_info['money'],$jian,2);
                }*/

                $add_tui['create_time'] = time();
                M('tui')->add($add_tui);
            }
            if ($type=='3'){
                $add_system['type'] = 4;//1已发货，2交易成功，3退款成功，4退款失败
                $tis = '拒绝退款';
            }
            //添加消息通知
            //新版
            $add_system['user_id'] = $order_info['user_id'];
            $add_system['send_user_id'] = $user_info['id'];
            $add_system['content'] = $tis;
            $add_system['type_id'] = $order_info['id'];
            $add_system['status'] = 2;
            $add_system['create_time'] = time();
            M('system')->add($add_system);
            $rong_user[] = $order_info['user_id'];
            SendRongSystem($rong_user,$tis);



            $arr = array(
                'code'=> 1,
                'res'=>'操作成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'操作失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的店铺-订单操作-修改未支付订单价格
     */
    function ShopOrderEditPrice(){
        $user = M('user');

        $shop = M('shop');
        $shop_order = M('shop_order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$type = decrypt1(trim(I('post.type')));//操作类型：1发货，2同意退款，3拒绝退款
        $order_id = decrypt1(trim(I('post.order_id')));
        $price = decrypt1(trim(I('post.price')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();
        if (!$shop_info || $shop_info['status']!='1') {$arr = array('code' => 0, 'res' => '您还没有开通店铺');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($shop_info['is_show']!='1') {$arr = array('code' => 0, 'res' => '您的店铺已被后台封禁，请联系客服');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $shop_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['shop_id']!=$shop_info['id']) {$arr = array('code' => 0, 'res' => '没有权限操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单无法修改价格');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['is_confirm']!='1') {$arr = array('code' => 0, 'res' => '此订单无法修改价格');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['money_type']!='2') {$arr = array('code' => 0, 'res' => '只能修改全款支付价格');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($price<=0) {$arr = array('code' => 0, 'res' => '修改价格不能小于0');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($price==$order_info['total_money']) {$arr = array('code' => 0, 'res' => '价格无变动');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $save_order['total_money'] = $price;
        $save_order['update_time'] = time();


        $query = $shop_order->where(array('id'=>$order_id))->save($save_order);

        if ($query){
                $add_system['type'] = 5;//1已发货，2交易成功，3退款成功，4退款失败,5订单价格修改
                $tis = '订单价格已修改';

            //添加消息通知
            //新版
            $add_system['user_id'] = $order_info['user_id'];
            $add_system['send_user_id'] = $user_info['id'];
            $add_system['content'] = $tis;
            $add_system['type_id'] = $order_info['id'];
            $add_system['status'] = 2;
            $add_system['create_time'] = time();
            M('system')->add($add_system);
            $rong_user[] = $order_info['user_id'];
            SendRongSystem($rong_user,$tis);


            $arr = array(
                'code'=> 1,
                'res'=>'操作成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'操作失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 订单-查看物流
     */
    function CheckOrderExpress(){
        $shop_order = M('shop_order');
        $shop_goods = M('shop_goods');
        $user = M('user');
        $shop_order_express = M('shop_order_express');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$type = decrypt1(trim(I('post.type')));//操作类型：1发货，2同意退款，3拒绝退款
        $order_id = decrypt1(trim(I('post.order_id')));
        //$token = 'bf8739cb479fa5d17c98dfbb7beb1452';
        //$order_id = '284';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $order_info = $shop_order->where(array('id'=>$order_id))->find();

        $goods_info = $shop_goods->where(array('id'=>$order_info['goods_id']))->field('name,cover')->find();

        $head_info['goods_name'] = $goods_info['name'];
        $head_info['goods_cover'] = $goods_info['cover'];
        $is_bao = $shop_order_express->where(array('parent'=>$order_info['id']))->find();
        if($order_info['express_number']){
            $head_info['express_number'] = $order_info['express_number'];
        }else{
            $head_info['express_number'] = '';
            $head_info['express_name'] = '';
        }

        if(!$head_info['express_name']){
            $head_info['express_name'] = '';
        }
        if ($order_info['express_type']!=1) {
            $arr = array(
                'code' => 1,
                'res' => '此订单无物流信息！',
                'head_info' => $head_info,
                'list' => array(),
            );
            $data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if($is_bao){
            $head_info['express_name'] = $order_info['express_name'];
            $data = json_decode($is_bao['data'],true);
            $list = $data['showapi_res_body']['data'];
            $arr = array(
                'code'=> 1,
                'res'=>'查询成功',
                'head_info'=>$head_info,
                'list'=>$list,
            );
        }else{
            if (!$order_info['express_phone']) {$arr = array('code' => 0, 'res' => '未查询到此订单物流信息！');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if (!$order_info['express_number']) {$arr = array('code' => 0, 'res' => '未查询到此订单物流信息！');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            if($order_info['express_code']){
                $com = $order_info['express_code'];
            }else{
                $com = 'auto';
            }
            $host = "https://ali-deliver.showapi.com";
            $path = "/showapi_expInfo";
            $method = "GET";
            $appcode = "cfb98726e660404280d1a73d271fc1e6";
            $headers = array();
            array_push($headers, "Authorization:APPCODE " . $appcode);
            //$com = 'auto';
            $number = $order_info['express_number'];
            $phone = $order_info['express_phone'];
            $querys = "com=".$com."&nu=".$number."&receiverPhone=".$phone;
            $bodys = "";
            $url = $host . $path . "?" . $querys;

            $curl = curl_init();
            curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method);
            curl_setopt($curl, CURLOPT_URL, $url);
            curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($curl, CURLOPT_FAILONERROR, false);
            curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($curl, CURLOPT_HEADER, false);
            if (1 == strpos("$".$host, "https://"))
            {
                curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
                curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
            }
            $res = curl_exec($curl);
            curl_close($curl);
            $data = json_decode($res,true);
            $status = $data['showapi_res_body']['status'];
            if($data['showapi_res_code']==0){
                if($status==4){
                    $add['parent'] = $order_info['id'];
                    $add['data'] = $res;
                    $add['create_time'] = time();
                    $shop_order_express->add($add);
                }
                if (!$order_info['express_name']) {
                    $save['express_name'] = $data['showapi_res_body']['expTextName'];
                    $save['update_time'] = time();
                    $shop_order->where(array('id'=>$order_info['id']))->save($save);
                    $head_info['express_name'] = $data['showapi_res_body']['expTextName'];
                }else{
                    $head_info['express_name'] = $order_info['express_name'];
                }

                $list = $data['showapi_res_body']['data'];
                if(!$head_info['express_name']){
                    $head_info['express_name'] = '';
                }
                if(!$list){
                    $list= array();
                }
                $arr = array(
                    'code'=> 1,
                    'res'=>'查询成功',
                    'head_info'=>$head_info,
                    'list'=>$list,
                );

            }else{
                $arr = array('code' => 0, 'res' => $arr['showapi_res_error']);$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }

        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }




    /**
     * 根据地址和商品查询运费
     */
    function OrderCheckPostage(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$type = decrypt1(trim(I('post.type')));//操作类型：1发货，2同意退款，3拒绝退款
        $num = decrypt1(trim(I('post.num')));
        $location_id = decrypt1(trim(I('post.location_id')));
        $select_id = decrypt1(trim(I('post.select_id')));
        //$token = 'bf8739cb479fa5d17c98dfbb7beb1452';
        //$select_id = '1159';
        //$location_id = '3';
        //$num = I('get.num');
        //$shop_id = '44';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $money = JsPostageMoney($select_id,$num,$location_id);

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'money'=>(String)$money,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 店铺运费规则列表
     */
    function ShopPostageList(){
        $user = M('user');
        $shop = M('shop');
        $postage = M('postage');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$type = decrypt1(trim(I('post.type')));//操作类型：1发货，2同意退款，3拒绝退款
        $shop_id = decrypt1(trim(I('post.shop_id')));
        //$token = '89aa485bff72ff364581c2540deed801';
        //$shop_id = '44';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $shop_info = $shop->where(array('id'=>$shop_id))->field('id,user_id')->find();
        if ($shop_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '非法查询！');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $list = $postage->where(array('shop_id'=>$shop_id))->field('id,name')->select();
        if(!$list){
           $list = array();
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            /*'shop_url'=>'http://shop1.yifangmeng.com',*/
            'shop_url'=>'http://shop.ymxte.com',
            'list'=>$list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 个人中心-我的订单-商城订单
     */
    function MyShopOrder(){
        $user = M('user');
        $shop_order = M('shop_order');
        $shop = M('shop');
        $shop_order_goods = M('shop_order_goods');

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;

        //$token = '11ccdc65042cd2283b4b189ccf059fad';
        //$search = '洗发';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $where_order['type'] = 2;
        $where_order['user_id'] = $user_info['id'];
     /*   if ($user_info['id']!= '4' && $user_info['id']!= '5' ){
            $where_order['status'] = array('NEQ','0');
        }else{
           $where_order['is_confirm'] = 1;
        }*/

        $where_order['is_confirm'] = 1;
        $order_list = $shop_order->where($where_order)->limit($start,$num)->order('create_time desc')
            ->field('id,order_number,total_money,status,refund_status,user_id,shop_id,create_time,money_type')
            ->select();



        $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
        foreach ($order_list as $key1=>$val){
            $goods_list = array();
            $goods_list = $shop_order_goods
                ->join('lyx_shop_goods ON lyx_shop_order_goods.goods_id = lyx_shop_goods.id')
                ->where(array('lyx_shop_order_goods.order_id'=>$val['id']))
                ->field('lyx_shop_order_goods.goods_id,lyx_shop_order_goods.select_id,lyx_shop_order_goods.num,lyx_shop_order_goods.money,
            lyx_shop_goods.name,lyx_shop_goods.cover,lyx_shop_order_goods.select_val')
                ->select();
            $order_list[$key1]['goods_list'] = $goods_list;
            $shop_info = $shop->where(array('id'=>$val['shop_id']))->field('user_id,name,classify')->find();
            $order_list[$key1]['shop_user'] = $shop_info['user_id'];
            $order_list[$key1]['shop_name'] = $shop_info['name'];

            $order_list[$key1]['is_noun'] = '0';

            if($val['total_money']>=$noun_money['set_value']){
                if($shop_info['classify']=='11'){
                    $order_list[$key1]['is_noun'] = '1';
                    $where_bx['order_id'] = $val['id'];
                    $where_bx['type'] = 1;
                    $is_have_noun = M('order_bx')->where($where_bx)->count();
                    if($is_have_noun>0){
                        $order_list[$key1]['is_noun'] = '2';
                    }
                }
            }

        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'order_list' =>$order_list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     * 个人中心-我的订单-商城订单-订单详情
     */
    function ShopMyOrderDetail(){

        $shop_order = M('shop_order');

        $shop = M('shop');
        $shop_select = M('shop_select');
        $shop_order_goods = M('shop_order_goods');
        $user = M('user');
        $token = decrypt1(trim(I('post.token')));
        $shop_order_id = decrypt1(trim(I('post.shop_order_id')));
        //$location_id = decrypt1(trim(I('post.location_id')));

        //$shop_order_id = 2;
        //$token = '38e59920c3837c2f1e7606c78551c12c';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $order_info = $shop_order->where(array('id'=>$shop_order_id))->field('id as shop_order_id,total_money,order_number,status,refund_status,location_id,addressee,location,mobile,particular,create_time,shop_id,money,user_id,money_type')->find();
        $user_name = $user->where(array('id'=>$order_info['user_id']))->field('name,phone')->find();
        $order_info['user_name'] = $user_name['name'];
        $order_info['user_phone'] = $user_name['phone'];


        $order_info['location'] = $order_info['location'].$order_info['particular'];

        unset($order_info['particular']);
        $goods_list= $shop_order_goods
            ->join('lyx_shop_goods ON lyx_shop_order_goods.goods_id = lyx_shop_goods.id')
            ->where(array('lyx_shop_order_goods.order_id'=>$shop_order_id))
            ->field('lyx_shop_order_goods.goods_id,lyx_shop_order_goods.select_id,lyx_shop_order_goods.num,lyx_shop_order_goods.money,
            lyx_shop_goods.name,lyx_shop_goods.cover')
            ->select();
        $zong_num = 0;
        foreach($goods_list as $key=>$item){
            $arr_select = explode('.',$item['select_id']);
            $select_arr = array();


            foreach($arr_select as $val){
                $select_info = $shop_select->where(array('id'=>$val))->field('select_name,value,add_price')->find();
                $select_arr[] = $select_info['select_name'].':'.$select_info['value'];
            }

            $goods_list[$key]['select_val'] = implode(',',$select_arr);
            $zong_num +=$item['num'];
        }
        if ($order_info['status']=='0'){
            $end_time = $order_info['create_time']+86400;
            $count_down = $end_time-time();


            if ($count_down<0){
                $count_down= 0;
            }
            $order_info['count_down'] = (String)$count_down;
        }else{
            $order_info['count_down'] = '0';
        }
        $order_info['zong_num'] = $zong_num;
        $order_info['goods_list'] = $goods_list;

        $order_info['create_time'] = date('Y-m-d H:i:s',$order_info['create_time']);
        $shop_info = $shop->where(array('id'=>$order_info['shop_id']))->field('user_id,name,service_type,phone,classify')->find();

        $order_info['is_noun'] = '0';
        $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
        if($order_info['total_money']>=$noun_money['set_value']){
            if($shop_info['classify']=='11'){
                $order_info['is_noun'] = '1';
                $where_bx['order_id'] = $shop_order_id;
                $where_bx['type'] = 1;
                $is_have_noun = M('order_bx')->where($where_bx)->count();
                if($is_have_noun>0){
                    $order_info['is_noun'] = '2';
                }
            }
        }





        $shop_user_info = $user->where(array('id'=>$shop_info['user_id']))->field('id,phone')->find();

        $shop_list['service_type'] = $shop_info['service_type'];
        $shop_list['user_id'] = $shop_user_info['id'];
        $shop_list['shop_name'] = $shop_info['name'];
        if($shop_info['phone']){
            $shop_list['phone'] = $shop_info['phone'];
        }else{
            $shop_list['phone'] = $shop_user_info['phone'];
        }



        if(!$order_info['addressee']){$order_info['addressee']='';}
        if(!$order_info['mobile']){$order_info['mobile']='';}
        if(!$order_info['location']){$order_info['location']='';}
        if(!$order_info['particular']){$order_info['particular']='';}




        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'order_info'=>$order_info,
            'shop_list'=>$shop_list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-医院订单-订单详情
     */
    function HospitalMyOrderDetail(){

        $hospital_order = M('hospital_order');

        $hospital = M('hospital');
        $doctor = M('doctor');
        $shop = M('shop');
        $user = M('user');
        $ticket_user = M('ticket_user');
        $ticket = M('ticket');
        $token = decrypt1(trim(I('post.token')));
        $hospital_order_id = decrypt1(trim(I('post.hospital_order_id')));
        //$location_id = decrypt1(trim(I('post.location_id')));

        //$hospital_order_id = 33;
        //$token = 'e411e2cec473c28db5b56ba680815f85';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $order_info = $hospital_order->where(array('id'=>$hospital_order_id))
            ->field('id as hospital_order_id,pay_money,order_number,shop_id,
            status,refund_status,parent,doctor_id,total_money,cost,loans,create_time,is_loans,
            money,user_id,money_type,ticket_id,ticket_money,score,score_money,refund_money,project_apply_id')->find();
        if ($user_info['id'] != $order_info['user_id']) {$arr = array('code' => 0, 'res' => '没有此订单');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['status']==0) {$arr = array('code' => 0, 'res' => '没有此订单:1001');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}




        //$doc_name = $doctor->where(array('id'=>$order_info['doctor_id']))->field('name')->find();
        $order_info['doctor_name'] = '';
        if($order_info['ticket_id']){
           $have_info =  $ticket_user->where(array('id'=>$order_info['ticket_id']))->field('parent')->find();
           $ticket_info =  $ticket->where(array('id'=>$have_info['parent']))->field('title')->find();
            $order_info['ticket_name'] = $ticket_info['title'];
        }else{
            $order_info['ticket_name']  ='';
        }
        $project = [];
        if($order_info['project_apply_id']){
            $apply = M('project_apply')->where(['id'=>$order_info['project_apply_id']])->find();
            $project['apply_name'] = $apply['name'];
            $project_name = M('project')->where(['id'=>$apply['project_id']])->field('id,name')->find();
            $project['pro_name'] = $project_name['name'];
            $class_name = M('project_class')->where(['id'=>$apply['parent']])->field('id,name')->find();
            $project['class_name'] = $class_name['name'];
        }
        $order_info['project'] = $project;


        $order_info['create_time'] = date('Y-m-d H:i:s',$order_info['create_time']);



        $shop_info = $shop->where(array('id'=>$order_info['shop_id']))->field('id,user_id,name,service_type,phone,classify,logo')->find();
        $class_name = M('store_classify')->where(array('id'=>$shop_info['classify']))->find();
        $order_info['hospital_name'] = $shop_info['name'];
        $order_info['classify'] = $class_name['name'];
        $order_info['logo'] = $shop_info['logo'];

        $order_info['shop_id'] = $shop_info['id'];
        if($shop_info){
            $shop_user = $user->where(array('id'=>$shop_info['user_id']))->field('phone')->find();
            $service_info['service_type'] = $shop_info['service_type'];
            $service_info['user_id'] = $shop_info['user_id'];
            $service_info['shop_name'] = $shop_info['name'];
            if($shop_info['phone']){
                $service_info['phone'] = $shop_info['phone'];
            }else{
                $service_info['phone'] = $shop_user['phone'];
            }

            $order_info['is_noun'] = '0';
            $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
            if($order_info['total_money']>=$noun_money['set_value']){
                if($shop_info['classify']=='11'){
                    $order_info['is_noun'] = '1';
                    $where_bx['order_id'] = $order_info['hospital_order_id'];
                    $where_bx['type'] = 2;
                    $is_have_noun = M('order_bx')->where($where_bx)->count();
                    if($is_have_noun>0){
                        $order_info['is_noun'] = '2';
                    }
                }
            }

        }else{
            $service_info['service_type'] = '1';
            $service_info['user_id'] ='0';
            $service_info['shop_name'] ='';
            $service_info['phone'] ='';
            $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
            if($order_info['total_money']>=$noun_money['set_value']){
                $order_info['is_noun'] = '1';
                $where_bx['order_id'] = $order_info['hospital_order_id'];
                $where_bx['type'] = 1;
                $is_have_noun = M('order_bx')->where($where_bx)->count();
                if($is_have_noun>0){
                    $order_info['is_noun'] = '2';
                }
            }else{
                $order_info['is_noun'] = '0';
            }

        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'order_info'=>$order_info,
            'service_info'=>$service_info,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 个人中心-我的订单-商城订单-订单操作
     */
    function MyShopOrderEdit(){
        $user = M('user');

        $shop = M('shop');
        $shop_order = M('shop_order');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//操作类型：1退款，2客服介入，3确认收货，4取消退款，5取消订单
        $order_id = decrypt1(trim(I('post.order_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $shop_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '没有权限操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if  ($type!='5'){
            if ($order_info['status']=='0') {$arr = array('code' => 0, 'res' => '请先支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if (!$type) {$arr = array('code' => 0, 'res' => '请传入要操作的类型');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info  = $shop->where(array('id'=>$order_info['shop_id']))->find();
        if($type=='1'){
            //if (!$user_info['ali_number'] || !$user_info['ali_name']) {$arr = array('code' => 0, 'res' => '请先绑定支付宝账号后进行此操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if (!$user_info['ali_user_id']) {$arr = array('code' => 3001, 'res' => '请先绑定支付宝账号再进行退款操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            if ($order_info['status']=='3' && $order_info['refund_status']=='1') {$arr = array('code' => 0, 'res' => '您已提交退款申请，请勿重复提交');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['status']!='3'){
                $save_order['front_status'] = $order_info['status'];
            }
            $save_order['status'] = '3';
            $save_order['refund_status'] = '1';
        }


        if($type=='2'){
            if ($order_info['status']=='3' && $order_info['refund_status']=='2') {
                $save_order['status'] = '3';
                $save_order['refund_status'] = '3';
            }else{
                $arr = array('code' => 0, 'res' => '订单状态错误：301');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }

        }
        if($type=='3'){
            if ($order_info['status']!='4' ) {$arr = array('code' => 0, 'res' => '订单状态错误：302');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $save_order['status'] = '5';

            //平台抽水
            $goods_info  = $shop_goods->where(array('id'=>$order_info['goods_id']))->field('odds,is_fan')->find();
            if($goods_info['is_fan']==1){
                if($goods_info['odds']!=NULL){
                    $chou_odds['set_value'] =  $goods_info['odds'];
                }else{
                    if($shop_info['odds']!=NULL){
                        $chou_odds['set_value'] =  $shop_info['odds'];
                    }else{
                        $odds_val = M('odds_type')->where(array('id'=>$shop_info['odds_type']))->find();
                        $chou_odds['set_value'] =  $odds_val['odds'];
                    }
                }
                if($chou_odds['set_value']!='0'){
                    $odds = $chou_odds['set_value']/100;
                    $chou = $order_info['total_money'] * $odds;
                    $save_order['chou'] = $chou;
                    $save_order['odds'] = $chou_odds['set_value'];
                }
            }

        }

        if($type=='4'){
            if ($order_info['status']!='3' ) {$arr = array('code' => 0, 'res' => '订单状态错误：303');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['refund_status']=='4' ) {$arr = array('code' => 0, 'res' => '订单状态错误：304');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['refund_status']=='5' ) {$arr = array('code' => 0, 'res' => '订单状态错误：305');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $save_order['status'] = $order_info['front_status'];
            //$save_order['refund_status'] = 0;
        }

        if($type=='5'){
            if ($order_info['status']!='0' ) {$arr = array('code' => 0, 'res' => '订单状态错误：503');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $save_order['update_time'] = time();


        if(!$save_order['refund_status']){
            $save_order['refund_status'] = $order_info['refund_status'];
        }
        if ($type=='5'){
            $query = $shop_order->where(array('id'=>$order_id))->delete();
        }else{
            $query = $shop_order->where(array('id'=>$order_id))->save($save_order);
        }



        if ($query){
            if($type=='3'){
                //代理抽水
                ShopOrderAgentChou($order_id);

                $add_system['type'] = 2;//1新的订单，2订单交易成功，3待处理订单
                $tis = '交易完成';

                //城市合伙人抽水
                if($user_info['rebate_city']){
                    cityRebateMoney(1,$order_id);
                }

            }

            if ($type=='1'){
                $add_system['type'] = 3;//1新的订单，2订单交易成功，3待处理订单
                $tis = '订单申请退款';
            }
            if ($type=='2'){
                $add_system['type'] = 3;//1新的订单，2订单交易成功，3待处理订单
                $tis = '买家申请客服介入';
            }

            if ($type=='4'){
                $add_system['type'] = 3;//1新的订单，2订单交易成功，3待处理订单
                $tis = '取消退款';
            }
            if ($type!='5'){
                //添加消息通知


                //新版
                $add_system['user_id'] = $shop_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $tis;
                $add_system['type_id'] = $order_info['id'];
                $add_system['status'] = 3;
                $add_system['create_time'] = time();
                M('system')->add($add_system);
                $rong_user[] = $shop_info['user_id'];
                SendRongSystem($rong_user,$tis);

            }else{
                M('shop_order_goods')->where(array('order_id'=>$order_id))->delete();
            }


            $arr = array(
                'code'=> 1,
                'res'=>'操作成功',
                'status'=>$save_order['status'],
                'refund_status'=>$save_order['refund_status'],
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'操作失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 个人中心-医院订单-订单操作
     */
    function MyHospitalOrderEdit(){
        $user = M('user');

        $shop = M('shop');
        $hospital_order = M('hospital_order');
        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//操作类型：1申请退款，2客服介入，3同意退款，4取消退款,5拒绝退款确认
        $order_id = decrypt1(trim(I('post.order_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($order_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '没有权限操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if ($order_info['status']=='0') {$arr = array('code' => 0, 'res' => '请先支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if (!$type) {$arr = array('code' => 0, 'res' => '请传入要操作的类型');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $shop_info  = $shop->where(array('hospital_id'=>$order_info['parent']))->find();
        if($type=='1'){
            //if (!$user_info['ali_number'] || !$user_info['ali_name']) {$arr = array('code' => 0, 'res' => '请先绑定支付宝账号后进行此操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if (!$user_info['ali_user_id']) {$arr = array('code' => 0, 'res' => '请先绑定支付宝账号再进行退款操作');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            if ($order_info['status']=='3' && $order_info['refund_status']=='1') {$arr = array('code' => 0, 'res' => '您已提交退款申请，请勿重复提交');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['status']!='3'){
                $save_order['front_status'] = $order_info['status'];
            }
            $save_order['status'] = '3';
            $save_order['refund_status'] = '1';
        }


        if($type=='2'){
            if ($order_info['status']=='3') {
                if($order_info['refund_status']=='2' || $order_info['refund_status']=='6'){
                    $save_order['status'] = '3';
                    $save_order['refund_status'] = '3';
                }else{
                    $arr = array('code' => 0, 'res' => '订单状态错误：302');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");

                }

            }else{
                $arr = array('code' => 0, 'res' => '订单状态错误：301');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }

        }
        if($type=='3'){
            if ($order_info['status']!='3' ) {$arr = array('code' => 0, 'res' => '订单状态错误：303');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['refund_status']!='6' ) {$arr = array('code' => 0, 'res' => '订单状态错误：303');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            $save_order['status'] = '3';
            $save_order['refund_status'] = '5';
            $save_order['ok_time'] = time();

            //平台抽水
            $shop_type = M('shop')->where(array('hospital_id'=>$order_info['parent']))->field('odds_type,odds')->find();

            if($shop_type['odds']!=NULL){
                $chou_odds['set_value']  = $shop_type['odds'];
            }else{
                if(!$shop_type['odds_type']){
                    $odds_type_id = $shop_type['odds_type'];
                }else{
                    $odds_type_id = 1;
                }
                $odds_type_odds = M('odds_type')->where(array('id'=>$odds_type_id))->field('odds')->find();
                $chou_odds['set_value']   = $odds_type_odds['odds'];
            }

            if($chou_odds['set_value']!='0'){
                $chou_money = $order_info['money'] - $order_info['refund_money'];
                $odds = $chou_odds['set_value']/100;
                $chou = $chou_money * $odds;
                $save_order['chou'] = $chou;
                $save_order['odds'] = $chou_odds['set_value'];

            }


        }

        if($type=='4'){
            if ($order_info['status']!='3' ) {$arr = array('code' => 0, 'res' => '订单状态错误：304');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['refund_status']=='4' ) {$arr = array('code' => 0, 'res' => '订单状态错误：305');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['refund_status']=='5' ) {$arr = array('code' => 0, 'res' => '订单状态错误：306');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $save_order['status'] = $order_info['front_status'];
            //$save_order['refund_status'] = 0;
        }

        if($type=='5'){
            if ($order_info['status']!='3' ) {$arr = array('code' => 0, 'res' => '订单状态错误：304');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($order_info['refund_status']=='2' ) {$arr = array('code' => 0, 'res' => '订单状态错误：305');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            $save_order['status'] = $order_info['front_status'];
            //$save_order['refund_status'] = 0;
        }

        $save_order['update_time'] = time();


        if(!$save_order['refund_status']){
            $save_order['refund_status'] = $order_info['refund_status'];
        }
      /*  if ($type=='5'){
            $query = $shop_order->where(array('id'=>$order_id))->delete();
        }else{
            $query = $shop_order->where(array('id'=>$order_id))->save($save_order);
        }*/


        $query = $hospital_order->where(array('id'=>$order_id))->save($save_order);
        if ($query){
            //操作类型：1申请退款，2客服介入，3同意退款，4取消退款
            if($type=='1'){
                //代理抽水
                //ShopOrderAgentChou($order_id);
                $add_system['type'] = 1;//1申请退款，2客服介入，3订单退款中，4取消退款，
                $tis = '申请退款';
            }
            if($type=='2'){
                //代理抽水
                //ShopOrderAgentChou($order_id);
                $add_system['type'] = 2;//1申请退款，2客服介入，3订单退款中，4取消退款，
                $tis = '申请退款';
            }

            if($type=='3'){

                //退款
                $add_tui['user_id'] = $order_info['user_id'];
                $add_tui['type'] = 4;
                $add_tui['type_id'] = $order_info['id'];
                $add_tui['money'] = $order_info['refund_money'];
                $add_tui['status'] = 0;
                $add_tui['create_time'] = time();
                $tui = M('tui');
                $query2 = $tui->add($add_tui);
                //代理抽水
                HosOrderAgentChou($order_info['id']);

                if($order_info['score']>0){
                    $user->where(array('id'=>$order_info['user_id']))->setInc('score',$order_info['score']);
                    //增加积分
                    $add_log['user_id'] = $order_info['user_id'];
                    $add_log['add_or_del'] = 1;
                    $add_log['type'] = 9;
                    $add_log['num'] = $order_info['score'];
                    $add_log['order_id'] = $order_info['id'];
                    $add_log['create_time'] = time();
                    M('shop_score_log')->add($add_log);
                }

                if($order_info['ticket_id']){
                    M('ticket_user')->where(array('id'=>$order_info['ticket_id']))->save(array('status'=>'0','update_time'=>time()));
                }

                //代理抽水
                //ShopOrderAgentChou($order_id);
                $add_system['type'] = 3;//1申请退款，2客服介入，3订单退款中，4取消退款，5订单退款成功,6医院拒绝退款
                $tis = '订单退款中';



            }

            if ($type=='4'){
                $add_system['type'] = 4;//1申请退款，2客服介入，3订单退款中，4取消退款，
                $tis = '取消退款';
            }

            if($shop_info['user_id']){
                if($type!='5'){
                    //新版
                    $add_system['user_id'] = $shop_info['user_id'];
                    $add_system['send_user_id'] = $user_info['id'];
                    $add_system['content'] = $tis;
                    $add_system['type_id'] = $order_info['id'];
                    $add_system['status'] = 6;
                    $add_system['create_time'] = time();
                    M('system')->add($add_system);
                    $rong_user[] = $shop_info['user_id'];
                    SendRongSystem($rong_user,$tis);
                }

            }


            $arr = array(
                'code'=> 1,
                'res'=>'操作成功',
                'status'=>$save_order['status'],
                'refund_status'=>$save_order['refund_status'],
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'操作失败',
            );
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 模拟购买优惠券
     */
    function BuyTicket(){
        die;
        $user = M('user');

        $ticket = M('ticket');
        $ticket_user = M('ticket_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $ticket_id = decrypt1(trim(I('post.ticket_id')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $ticket_info = $ticket->where(array('id'=>$ticket_id))->find();
        if (!$ticket_info) {$arr = array('code' => 0, 'res' => '优惠券不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($ticket_info['type']=='2') {$arr = array('code' => 0, 'res' => '无法购买体验券');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if ($ticket_info['type']=='3') {
            if ($user_info['is_agent']!='1'){
                $arr = array('code' => 0, 'res' => '没有购买权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
        }



        $add['user_id'] = $user_info['id'];
        $add['parent'] = $ticket_info['id'];
        $add['buy_money'] = $ticket_info['price'];
        $add['rebate_money'] = $ticket_info['rebate'];
        $add['discount'] = $ticket_info['discount'];
        $add['create_time'] = time();



        $query = $ticket_user->add($add);

        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>'购买成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'购买失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 商城首页
     */
    function ShopHomeData2(){
        $user = M('user');

        $banner = M('banner');
        $shop_classify = M('shop_classify');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $splendid = M('splendid');
        $shop_goods = M('shop_goods');


        //接收
        $scope = 25000;

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $from = decrypt1(trim(I('post.from')));

        if(!$page){$page = 1;}
        if(!$from){$from = 2;}
        if($from=='1'){
            $num = 30;//分页数
        }else{
            $num = 50;//分页数
        }

        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $banner_list = $banner->where(array('is_show'=>'1','show_type'=>'2'))->order('sort,create_time desc')->field('id,img_url,type,to_url')->select();
        foreach($banner_list as $key=>$item){
            if(!$item['to_url']){
                $banner_list[$key]['to_url'] = '';
            }
        }


        if ($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }


        $where1['is_show'] = 1;
        $where1['is_home'] = 1;
        $where1['classify'] = 11;
        $where1['type'] = 1;
        $class_list[] = $shop_classify->where($where1)->order('sort desc')->field('id,name,logo')->select();


        $where1['classify'] = 12;
        $class_list[] = $shop_classify->where($where1)->order('sort desc')->field('id,name,logo')->select();

        $where1['classify'] = 13;
        $class_list[] = $shop_classify->where($where1)->order('sort desc')->field('id,name,logo')->select();


        //精彩推荐
        $splendid_list = $splendid->where(array('is_show'=>'1'))->order('rand()')->field('id,type,type_id')->select();
        foreach ($splendid_list as $key=>$item){
            if($item['type']=='1'){
                $type_info = $user_blogs->where(array('id'=>$item['type_id']))->field('content,type,video_thumb')->find();
                if ($type_info['type']=='1'){
                    $img_val = $user_blogs_photo->where(array('blogs_id'=>$item['type_id']))->order('id')->find();
                    $splendid_list[$key]['cover'] = $img_val['img_url'];
                }else{
                    $splendid_list[$key]['cover'] = $type_info['video_thumb'];
                }

                $splendid_list[$key]['price'] = '';
                $splendid_list[$key]['name'] = $type_info['content'];
                $splendid_list[$key]['blogs_type'] = $type_info['type'];
            }else{
                $type_info = $shop_goods->where(array('id'=>$item['type_id']))->field('cover,price,name')->find();
                $splendid_list[$key]['cover'] = $type_info['cover'];
                $splendid_list[$key]['price'] = $type_info['price'];
                $splendid_list[$key]['name'] = $type_info['name'];
                $splendid_list[$key]['blogs_type'] = '';
            }
        }

        //平台案例
        $blogs_list = $user_blogs->where(['is_show'=>1,'is_shop'=>1,'type'=>1])
            ->field('id')
            ->limit(10)->select();
        foreach ($blogs_list as $key=>$item){
            $blogs_img = $user_blogs_photo->where(['blogs_id'=>$item['id']])->order('id')->find();
            $blogs_list[$key]['img'] = $blogs_img['img_url'];
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'banner_list' => $banner_list,
            'blogs_list' => $blogs_list,
            'class_list' => $class_list,
            'jx_list' => $splendid_list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 商城首页
     */
    function ShopHomeData3(){
        $user = M('user');


        $shop_goods = M('shop_goods');
        $shop = M('shop');

        //接收数据
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度
        $class_id = decrypt1(trim(I('post.class_id')));//纬度
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $type = decrypt1(trim(I('post.type')));//排序类型：1综合排序（默认），2距离，3销量，4价格高，5价格低
        //if(!$scope){$scope = 25000;}
        $scope = 25000;

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $from = decrypt1(trim(I('post.from')));

        if(!$type){$type = 1;}
        if(!$page){$page = 1;}
        if(!$from){$from = 2;}
        if($from=='1'){
            $num = 30;//分页数
        }else{
            $num = 50;//分页数
        }

        $start = ($page-1)*$num;


        if(!$lng){
            $lng = '114.085947';
        }
        if(!$lat){
            $lat = '22.547267';
        }
        //$lng = '114.063554';
        //$lat = '22.643267';

        if ($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();
        if($type=='1'){
            /*$top_list = $shop_goods->where(array('is_show'=>'1','is_freeze'=>'1','is_top'=>'1'))
                ->field('id,lat,lng,shop_id,name,cover,price,sales')
                ->order('sort desc,create_time')
                ->select();*/
            $where_top = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_top` = 1  AND `is_freeze` = 1 AND `class1`=13 AND `class2` = ".$class_id;


            $desc_asc_top = 'ORDER BY dis asc,sort';
            $scope_top = 80;
            // 加入排序，从最近到最近排序。
            $sql_top = "select id,lat,lng,shop_id,name,cover,price,sort,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where_top." having dis <".$scope_top." ".$desc_asc_top." limit 0,6";
            $top_list = $Dao->query($sql_top);
            if(!$top_list){
                $top_list = $shop_goods->where(array('is_show'=>'1','is_freeze'=>'1','is_top'=>'1','is_del'=>'0'))
                    ->field('id,lat,lng,shop_id,name,cover,price,sales')
                    ->limit(4)
                    ->order('sort,create_time')
                    ->select();
            }else{

                $arrSort = array();
                foreach($top_list AS $key => $value){
                    foreach($value AS $k=>$v){
                        $arrSort[$k][$key] = $v;
                    }

                }
            }
            array_multisort($arrSort['sort'], SORT_DESC, $top_list);
        }

        if  ($top_list){
            if (count($top_list)>1){
                foreach ($top_list as $item){
                    $not_in[] = $item['id'];
                }
                $not_val = implode(',',$not_in);
                $where = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_home` = 1  AND `is_freeze` = 1 AND `id` NOT IN (".$not_val.") ";
            }else{
                $where = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_home` = 1  AND `is_freeze` = 1 AND `id`!= ".$top_list[0]['id'];
            }

        }else{
            $where = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_home` = 1  AND `is_freeze` = 1";
        }

        $where .= ' AND `class1`=13 AND `class2` = '.$class_id;



        //排序类型：1综合排序（默认），2距离，3销量，4价格高，5价格低，6智能排序
        if($type=='2'){
            $desc_asc = 'ORDER BY dis asc';
        }else if($type=='3'){
            $desc_asc = 'ORDER BY sales desc,dis asc';
        }else if($type=='4'){
            $desc_asc = 'ORDER BY price desc,dis asc';
        }else if($type=='5'){
            $desc_asc = 'ORDER BY price asc,dis asc';
        }else if($type=='6'){
            $desc_asc = 'ORDER BY dis asc,sales desc';
        }else{
            $desc_asc = 'ORDER BY sales desc,is_home desc,dis asc';
        }


        // 加入排序，从最近到最近排序。
        $sql = "select id,lat,lng,shop_id,name,cover,price,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where." having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;

        $goods_list2 = $Dao->query($sql);
        $guding_list = array();
        if($goods_list2){
            foreach ($goods_list2 as $key=>$item){
                if(array_key_exists($item['shop_id'],$guding_list)){
                    if($item['dis']<100){
                        $head_list[] = $item;
                    }else{
                        $foot_list[] = $item;
                    }
                }else{
                    $guding_list[$item['shop_id']] = $item;
                }

            }
            shuffle($guding_list);
            $goods_list = $guding_list;
            if($head_list){
                shuffle($head_list);
                $goods_list = array_merge($guding_list,$head_list);
            }
            if($foot_list){
                shuffle($foot_list);
                $goods_list = array_merge($goods_list,$foot_list);
            }
        }
        if  ($page=='1' && $top_list){
            if (count($top_list)>=1){
                foreach ($top_list as $item){
                    array_unshift($goods_list,$item);
                }
            }
        }
        if($type=='3'){
            $last_names = array_column($goods_list,'sales');
            array_multisort($last_names,SORT_DESC,$goods_list);
        }
        if($type=='4'){
            $last_names = array_column($goods_list,'price');
            array_multisort($last_names,SORT_DESC,$goods_list);
        }
        if($type=='5'){
            $last_names = array_column($goods_list,'price');
            array_multisort($last_names,SORT_ASC,$goods_list);
        }

        if($goods_list){
            foreach ($goods_list as $key=>$item){
                $goods_list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $shop_name = $shop->where(array('id'=>$item['shop_id']))->field('name')->find();
                $goods_list[$key]['shop_name'] = $shop_name['name'];
                $goods_list[$key]['sales'] = '销量 '.$item['sales'];
                $goods_list[$key]['price'] = (String)floatval($item['price']);

            }
        }else{
            $goods_list = array();
        }




        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'goods_list' => $goods_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 商城首页
     */
    function ShopHomeData(){
        $user = M('user');

        $banner = M('banner');
        $shop_classify = M('shop_classify');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $shop_goods = M('shop_goods');
        $shop_prize = M('shop_prize');

        $shop = M('shop');
        $shop_jx = M('shop_jx');
        $set = M('set');

        //接收数据
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度
        $class_id = decrypt1(trim(I('post.class_id')));//纬度
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $type = decrypt1(trim(I('post.type')));//排序类型：1综合排序（默认），2距离，3销量，4价格高，5价格低
        //if(!$scope){$scope = 25000;}
        $scope = 25000;

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $from = decrypt1(trim(I('post.from')));

        if(!$type){$type = 1;}
        if(!$page){$page = 1;}
        if(!$from){$from = 2;}
        if($from=='1'){
            $num = 30;//分页数
        }else{
            $num = 50;//分页数
        }

        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $banner_list = $banner->where(array('is_show'=>'1','show_type'=>'2'))->order('sort,create_time desc')->field('id,img_url,type,to_url')->select();
        foreach($banner_list as $key=>$item){
            if(!$item['to_url']){
                $banner_list[$key]['to_url'] = '';
            }
        }
        if(!$lng){
            $lng = '114.085947';
        }
        if(!$lat){
            $lat = '22.547267';
        }
        //$lng = '114.063554';
        //$lat = '22.643267';

        if ($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $where['is_show'] = 1;
        $where['is_home'] = 1;
        $where['type'] = 1;
        $list = $shop_classify->where($where)->order('sort')->limit(9)->field('id,name,logo')->select();
        if (count($list)<9){
            $list = $shop_classify->where(array('is_show'=>'1','type'=>'1'))->order('is_home desc,sort')->limit(9)->field('id,name,logo')->select();
        }


        $where1['is_show'] = 1;
        $where1['is_home'] = 1;
        $where1['classify'] = 11;
        $where1['type'] = 1;
        $class_list[] = $shop_classify->where($where1)->order('sort')->limit(9)->field('id,name,logo')->select();


        $where1['classify'] = 12;
        $class_list[] = $shop_classify->where($where1)->order('sort')->limit(9)->field('id,name,logo')->select();

        $where1['classify'] = 13;
        $class_list[] = $shop_classify->where($where1)->order('sort')->limit(9)->field('id,name,logo')->select();


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        $Dao = M();
        if(!$class_id){
            if($type=='1'){
                /*$top_list = $shop_goods->where(array('is_show'=>'1','is_freeze'=>'1','is_top'=>'1'))
                    ->field('id,lat,lng,shop_id,name,cover,price,sales')
                    ->order('sort desc,create_time')
                    ->select();*/
                $where_top = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_top` = 1  AND `is_freeze` = 1 ";


                $desc_asc_top = 'ORDER BY dis asc,sort';
                $scope_top = 80;
                // 加入排序，从最近到最近排序。
                $sql_top = "select id,lat,lng,shop_id,name,cover,price,sort,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where_top." having dis <".$scope_top." ".$desc_asc_top." limit 0,6";
                $top_list = $Dao->query($sql_top);
                if(!$top_list){
                    $top_list = $shop_goods->where(array('is_show'=>'1','is_freeze'=>'1','is_top'=>'1','is_del'=>'0'))
                        ->field('id,lat,lng,shop_id,name,cover,price,sales')
                        ->limit(4)
                        ->order('sort,create_time')
                        ->select();
                }else{

                    $arrSort = array();
                    foreach($top_list AS $key => $value){
                        foreach($value AS $k=>$v){
                            $arrSort[$k][$key] = $v;
                        }

                    }
                }
                array_multisort($arrSort['sort'], SORT_DESC, $top_list);
            }
        }



        if  ($top_list){
            if (count($top_list)>1){
                foreach ($top_list as $item){
                    $not_in[] = $item['id'];
                }
                $not_val = implode(',',$not_in);
                $where = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_home` = 1  AND `is_freeze` = 1 AND `id` NOT IN (".$not_val.") ";
            }else{
                $where = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_home` = 1  AND `is_freeze` = 1 AND `id`!= ".$top_list[0]['id'];
            }

        }else{
            $where = "WHERE `is_show` = 1  AND `is_del` = 0 AND `is_home` = 1  AND `is_freeze` = 1";
        }

        if($class_id){
            $where .= ' AND `classify`='.$class_id;
        }


        //排序类型：1综合排序（默认），2距离，3销量，4价格高，5价格低，6智能排序
        if($type=='2'){
            $desc_asc = 'ORDER BY dis asc';
        }else if($type=='3'){
            $desc_asc = 'ORDER BY sales desc,dis asc';
        }else if($type=='4'){
            $desc_asc = 'ORDER BY price desc,dis asc';
        }else if($type=='5'){
            $desc_asc = 'ORDER BY price asc,dis asc';
        }else if($type=='6'){
            $desc_asc = 'ORDER BY dis asc,sales desc';
        }else{
            $desc_asc = 'ORDER BY sales desc,is_home desc,dis asc';
        }



        // 加入排序，从最近到最近排序。
        $sql = "select id,lat,lng,shop_id,name,cover,price,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where." having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;

        $goods_list2 = $Dao->query($sql);
        $guding_list = array();
        if($goods_list2){
            foreach ($goods_list2 as $key=>$item){
                if(array_key_exists($item['shop_id'],$guding_list)){
                    if($item['dis']<100){
                        $head_list[] = $item;
                    }else{
                        $foot_list[] = $item;
                    }
                }else{
                    $guding_list[$item['shop_id']] = $item;
                }

            }
            shuffle($guding_list);
            $goods_list = $guding_list;
            if($head_list){
                shuffle($head_list);
                $goods_list = array_merge($guding_list,$head_list);
            }
            if($foot_list){
                shuffle($foot_list);
                $goods_list = array_merge($goods_list,$foot_list);
            }
        }
        if  ($page=='1' && $top_list){
            if (count($top_list)>=1){
                foreach ($top_list as $item){
                    array_unshift($goods_list,$item);
                }
            }
        }
        if($type=='3'){
            $last_names = array_column($goods_list,'sales');
            array_multisort($last_names,SORT_DESC,$goods_list);
        }
        if($type=='4'){
            $last_names = array_column($goods_list,'price');
            array_multisort($last_names,SORT_DESC,$goods_list);
        }
        if($type=='5'){
            $last_names = array_column($goods_list,'price');
            array_multisort($last_names,SORT_ASC,$goods_list);
        }

        if($goods_list){

            foreach ($goods_list as $key=>$item){
                $goods_list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $shop_name = $shop->where(array('id'=>$item['shop_id']))->field('name')->find();
                $goods_list[$key]['shop_name'] = $shop_name['name'];
                $goods_list[$key]['sales'] = '销量 '.$item['sales'];
                $goods_list[$key]['price'] = (String)floatval($item['price']);

            }
        }else{
            $goods_list = array();
        }



        /*     $goods_list = $shop_goods
                 ->where(array('is_show'=>'1','is_home'=>'1','is_freeze'=>'1'))
                 ->limit($start,$num)
                 ->order('sort,create_time desc')->field('id,shop_id,name,cover,price,sales')->select();*/



        $set_info = $set->where(array('set_type'=>'search_val'))->field('set_value')->find();


        $prize_list = $shop_prize->where(array('is_home'=>'1','is_show'=>'1'))
            ->field('id,name,cover,price,score')
            ->order('sort desc')->select();
        foreach($prize_list as $key=>$item){
            $prize_list[$key]['price'] = (String)floatval($item['price']);
        }

        $jx_list = $shop_jx->where(array('is_show'=>'1'))->field('id,cover,goods_id1,goods_id2,goods_id3')->order('sort desc')->select();

        foreach ($jx_list as $key=>$item){
            $all_goods = array();
            $goods_info1 = $shop_goods->where(array('id'=>$item['goods_id1']))->field('id,cover,name')->find();
            $all_goods[] = $goods_info1;
            $goods_info2 = $shop_goods->where(array('id'=>$item['goods_id2']))->field('id,cover,name')->find();
            $all_goods[] = $goods_info2;
            $goods_info3 = $shop_goods->where(array('id'=>$item['goods_id3']))->field('id,cover,name')->find();
            $all_goods[] = $goods_info3;
            $jx_list[$key]['goods_list'] = $all_goods;
            unset($jx_list[$key]['goods_id1']);
            unset($jx_list[$key]['goods_id2']);
            unset($jx_list[$key]['goods_id3']);
        }

        //平台案例
        $blogs_list = $user_blogs->where(['is_show'=>1,'is_shop'=>1,'type'=>1])
            ->field('id')
            ->limit(10)->select();
        foreach ($blogs_list as $key=>$item){
            $blogs_img = $user_blogs_photo->where(['blogs_id'=>$item['id']])->order('id')->find();
            $blogs_list[$key]['img'] = $blogs_img['img_url'];
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'banner_list' => $banner_list,
            'class_list' => $class_list,
            'blogs_list' => $blogs_list,
            'jx_list' => $jx_list,
            'list' => $list,
            'prize_list' => $prize_list,
            'search_val' => $set_info['set_value'],
            'goods_list' => $goods_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 商城-搜索-热门搜索+历史搜索
     */
    function SearchData(){
        $shop_search = M('shop_search');
        $shop_search_hot = M('shop_search_hot');
        $user = M('user');
        $set = M('set');
        $shop = M('shop');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');

        $token = decrypt1(trim(I('post.token')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $page = decrypt1(trim(I('post.page')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        //if(!$scope){$scope = 25000;}
        $scope = 25000;

        if(!$page){$page = 1;}

        $num = 12;//分页数
        $start = ($page-1)*$num;
        if(!$scope){$scope = 2500;}


        if(!$lng){
            $lng = '114.085947';
        }
        if(!$lat){
            $lat = '22.547267';
        }



        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token' => $token))->find();
        if($token){
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $diary_classify = M('diary_classify');

        $class_list = $diary_classify->where(array('is_show'=>'1'))->order('sort,create_time desc')->field('id,name')->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }
        //热门搜索
        $hot_list = $shop_search_hot->where(array('is_show'=>'1'))->order('sort')->field('antistop,is_fen')->limit(6)->select();

        //历史搜索
        //$search_info = $shop_search->where(array('user_id'=>$user_info['id']))->find();
        $search_list = array();
        /*
        if($search_info['search1']){$search_list[] = $search_info['search1'];}
        if($search_info['search2']){$search_list[] = $search_info['search2'];}
        if($search_info['search3']){$search_list[] = $search_info['search3'];}
        if($search_info['search4']){$search_list[] = $search_info['search4'];}

        */
        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x
        $Dao = M();

        // 商品
        //$desc_asc = 'ORDER BY is_home desc,dis asc';
        $desc_asc_goods = 'ORDER BY rand(),dis asc';
        $where_goods = "WHERE `is_show` = 1  AND `is_del` = 0  AND `is_freeze` = 1";
        // 加入排序，从最近到最近排序。
        $goods_list = array();
        if($page==1){
            $sql_goods = "select id,lat,lng,shop_id,name,cover,price,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where_goods." having dis <".$scope." ".$desc_asc_goods." limit 0,3";
            $goods_list = $Dao->query($sql_goods);
        }

        if($goods_list){
            foreach ($goods_list as $key=>$item){
                $goods_list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $shop_name = $shop->where(array('id'=>$item['shop_id']))->field('name')->find();
                $goods_list[$key]['shop_name'] = $shop_name['name'];
                $goods_list[$key]['sales'] = '销量 '.$item['sales'];
                $goods_list[$key]['price'] = (String)floatval($item['price']);

            }
        }else{
            $goods_list = array();
        }



        //案例
        $where_blogs = "WHERE `is_show` = 1 AND `type` IN ( 1,2 )";
        $desc_asc_blogs = 'ORDER BY rand(),dis asc';

            // 加入排序，从最近到最近排序。
            $sql_blogs = "select id,user_id,lng,lat,content,zan,browse,comment_count,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type,sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_user_blogs ".$where_blogs."  having dis <".$scope." ".$desc_asc_blogs." limit ".$start.",".$num;
            $list = $Dao->query($sql_blogs);


        if($list){
            foreach($list as $key=>$item){
                if(!$item['video_url']){
                    $list[$key]['video_url'] = "";
                }
                if(!$item['video_height']){
                    $list[$key]['video_height'] = "0";
                }
                if(!$item['video_width']){
                    $list[$key]['video_width'] = "0";
                }
                if(!$item['video_thumb']){
                    $list[$key]['video_thumb'] = "";
                }
                if(!$item['ad_url']){
                    $list[$key]['ad_url'] = "";
                }
                if(!$item['lng']){
                    $list[$key]['lng'] = "";
                }

                //用户信息
                $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
                $list[$key]['name'] = $user_info2['name'];
                $list[$key]['head'] = $user_info2['head'];
                $list[$key]['sex'] = $user_info2['sex'];
                $list[$key]['age'] = $user_info2['age'];
                $list[$key]['level'] = $user_info2['level'];

                $list[$key]['create_time'] = mdate($item['create_time']);
                //点赞数
                $list[$key]['zan'] = WanChu($item['zan']);
                //评论数
                $list[$key]['comment_count'] = WanChu($item['comment_count']);
                //浏览人数
                $list[$key]['browse'] = WanChu($item['browse']);
                $list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $list[$key]['img_width'] = '0';
                $list[$key]['img_height'] = '0';
                $new_img_list = array();
                $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
                if ($img_list) {
                    foreach ($img_list as $key2=>$val) {
                        if ($key2==0){
                            $list[$key]['img_width'] = $val['width'];
                            $list[$key]['img_height'] = $val['height'];
                        }
                        $new_img_list[] = $val['img_url'];
                    }
                }
                $list[$key]['img_list'] = $new_img_list;


                //自己是否有点赞
                $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
                if ($is_zan) {
                    $list[$key]['is_zan'] = '1';
                } else {
                    $list[$key]['is_zan'] = '0';
                }

                unset($list[$key]['video_icon']);

            }

        }else{
            $list = array();
        }

        $set_info = $set->where(array('set_type'=>'search_val'))->field('set_value')->find();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'search_val' =>$set_info['set_value'],
            'hot_list' =>$hot_list,
            'search_list' =>$search_list,
            'goods_list' =>$goods_list,
            'blogs_list' =>$list,
        );


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 商城-全部分类
     */
    function ShopClassAll(){
        $shop_classify = M('shop_classify');
        $user = M('user');


        $token = decrypt1(trim(I('post.token')));
        //$token = "edee9b9b0373a97d06a4376113a90fb2";

        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }

        $list = $shop_classify->where(array('is_show'=>'1','type'=>'1'))->order('sort')->field('id,name,logo')->select();
        foreach ($list as $key=>$item){
            $class_list = array();
            $class_list = $shop_classify->where(array('is_show'=>'1','type'=>'2','parent'=>$item['id']))->field('id,name')->select();
            if ($class_list){
                $list[$key]['is_next'] = '1';
                $list[$key]['next_list'] = $class_list;
            }else{
                $list[$key]['is_next'] = '0';
                $list[$key]['next_list'] = array();
            }
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 商城-清除历史搜索记录
     */
    function ShopClearSearchHistory(){
        $user = M('user');

        $shop_search = M('shop_search');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $query = $shop_search->where(array('user_id'=>$user_info['id']))->delete();

        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>'清除成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'清除失败',
            );
        }
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 商城-搜索商品-分类商品
     */
    function ShopSearch(){
        $shop_classify = M('shop_classify');
        $shop_goods = M('shop_goods');
        $shop_search = M('shop_search');
        $user = M('user');
        $shop = M('shop');

        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度


        //$lng = '116.445522';
        //$lat = '39.923834';

        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        if(!$scope){$scope = 2500;}

        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $search = decrypt1(trim(I('post.search')));
        $classify = decrypt1(trim(I('post.classify')));
        $type = decrypt1(trim(I('post.type')));//查看类型：1搜索商品，2分类商品,3店铺商品
        $sort = decrypt1(trim(I('post.sort')));//默认综合排序,1销量，2价格高，3价格低
        $page = decrypt1(trim(I('post.page')));
        if(!$type){$type = '1';}
        if(!$page){$page = 1;}
        $num = 12;//分页数
        $start = ($page-1)*$num;
        if($classify){
            $type=2;
        }


        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$search = '洗发';

        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }

       /* if($sort=='1'){
            $asc_desc = 'sales_volume desc';
        }else if($sort=='2'){
            $asc_desc = 'price desc';
        }else if($sort=='3'){
            $asc_desc = 'price';
        }else{
            $asc_desc = 'sort,id desc';
        }*/

        $class_list = [];
        if ($type=='1'){

            $class_list = $shop_classify->where(array('type'=>1))->select();
           /* if($search){
                $where['name'] =   array("like","%".$search."%");
            }*/
            $where = "WHERE `is_show` = 1 AND `is_freeze` = 1 AND `name` LIKE '%".$search."%' ";
        }else if ($type=='3'){
            $class_list = $shop_classify->where(array('type'=>1))->select();
            $where = "WHERE `is_show` = 1 AND `is_freeze` = 1 AND  `shop_id` = ".$shop_id;

        }else{
            $class_info = $shop_classify->where(array('id'=>$classify))->find();
            if ($class_info['type']=='1'){
                $class_list = $shop_classify->where(array('parent'=>$classify))->select();
                $new_class[] = $classify;
                if($class_list){

                    foreach ($class_list as $item){
                        $new_class[] = $item['id'];
                    }
                    $where_class  = implode(',',$new_class);
                    $where = "WHERE `is_show` = 1 AND `is_del` = 0 AND `is_freeze` = 1 AND `classify` IN (".$where_class.")";

                }else{
                    $where = "WHERE `is_show` = 1 AND `is_del` = 0 AND `is_freeze` = 1 AND `classify` = ".$classify;

                }
                $class_list[] = $class_info;
            }else{
                $class_list = $shop_classify->where(array('parent'=>$class_info['parent']))->select();
                $where = "WHERE `is_show` = 1 AND `is_del` = 0 AND `is_freeze` = 1 AND `classify` = ".$classify;
            }
            if($shop_id){
                $where .= ' AND `shop_id`='.$shop_id;
            }
        }
        $new_class_list = [];
        foreach ($class_list as $item){
            if($item['id']==$classify){
                $new_class_list[] = $item;
            }
        }
        foreach ($class_list as $item){
            if($item['id']!=$classify){
                $new_class_list[] = $item;
            }
        }
        foreach ($new_class_list as $key=>$item){
            if($item['type']==1){
                $new_class_list[$key]['logo'] = $item['img'];
            }
        }

        //商品信息
/*        $goods_list = $shop_goods->where($where)->limit($start,$num)->order($asc_desc)->field('id,shop_id,name,cover,price,sales')->select();*/

        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x


        if($sort=='2'){
            $desc_asc = 'ORDER BY dis asc';
        }else if($sort=='3'){
            $desc_asc = 'ORDER BY sales desc,dis asc';
        }else if($sort=='4'){
            $desc_asc = 'ORDER BY price desc,dis asc';
        }else if($sort=='5'){
            $desc_asc = 'ORDER BY price asc,dis asc';
        }else if($sort=='6'){
            $desc_asc = 'ORDER BY dis asc,sales desc';
        }else{
            $desc_asc = 'ORDER BY sales desc,is_home desc,dis asc';
        }
        //$desc_asc = 'ORDER BY sales desc,dis asc';
        //$where = "WHERE `is_show` = 1 AND `is_freeze` = 1";
        $Dao = M();

        // 加入排序，从最近到最近排序。
        $sql = "select id,lat,lng,shop_id,name,cover,price,sales, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_shop_goods ".$where."  having dis <".$scope." ".$desc_asc." limit ".$start.",".$num;

        $goods_list = $Dao->query($sql);

        if($goods_list){
            foreach ($goods_list as $key=>$item){
                $goods_list[$key]['dis'] = MiZhuanhuan($item['dis']);
                $shop_name = $shop->where(array('id'=>$item['shop_id']))->field('name')->find();
                $goods_list[$key]['shop_name'] = $shop_name['name'];
                $goods_list[$key]['sales'] = '销量 '.$item['sales'];
            }
        }else{
            $goods_list = array();
        }



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' =>$goods_list,
            'new_class' =>$new_class_list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }




    /**
     * 商城-商品详情
     */
    function ShopGoodsDetail(){
        $shop_order = M('shop_order');
        $shop_goods = M('shop_goods');
        $shop_goods_banner = M('shop_goods_banner');
        $shop_select = M('shop_select');
        $shop_classify = M('shop_classify');
        $hospital = M('hospital');
        $shop = M('shop');
        $user = M('user');
        $collect = M('collect');
        $cache = M('cache');


        $token = decrypt1(trim(I('post.token')));
        $goods_id =  decrypt1(trim(I('post.goods_id')));
        $share_user_id =  decrypt1(trim(I('post.share_user_id')));

        $type =  decrypt1(trim(I('post.type')));//查看类型：1正常查看，2修改商品获取数据;
        if (!$type){$type='1';}

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$goods_id = 20;

        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

            if(!$user_info['code_user']){
                if($share_user_id){
                    //绑定邀请人
                    $bind_status = BindCodeUser($share_user_id,$user_info['id']);
                }
            }


        }


        //是否添加收藏
        $is_col = $collect->where(array('user_id'=>$user_info['id'],'type'=>'2','type_id'=>$goods_id))->find();

        if($is_col){
            $is_collect = '1';
            $collect_id = $is_col['id'];
        }else{
            $is_collect = '0';
            $collect_id = '0';
        }

        $where['id'] = $goods_id;
        if ($type=='1'){
            $where['is_show'] = 1;
        }

        $goods_info = $shop_goods->where($where)->field('id,name,cover,price,sales,shop_id,stock,prepay,is_prepay,classify,max,postage_id')->find();

        if(!$goods_info){

            $arr = array(
                'code'=> 0,
                'res'=>'商品已下架',
            );

            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $content = M('shop_goods_photo')->where(array('goods_id'=>$goods_id))->find();
         $goods_info['content'] = $content['content'];


        $s1='<!--[if gte mso 9]>';
        $s2='</style>';
        $i1=strpos( $goods_info['content'],$s1);//开始位置
        $i2=strpos( $goods_info['content'],$s2);//结束位置
        if ($i1!==false && $i2!==false){
            $goods_info['content']=substr( $goods_info['content'],0,$i1-1) . substr( $goods_info['content'],$i2+strlen($s2));
        }
        $is_max = '0';
        if($goods_info){
            $is_thumb = $cache->where(array('url'=>$goods_info['cover']))->find();
            if($is_thumb['thumb']){
                $goods_info['thumb'] = $is_thumb['thumb'];
            }else{
                $goods_info['thumb'] = '';
            }

            if($goods_info['max']>0){
                $where_buy['user_id'] = $user_info['id'];
                $where_buy['goods_id'] = $goods_id;
                $where_buy['status'] = array('NEQ',0);
                $buy_num = $shop_order->where($where_buy)->sum('total_num');
                if ($buy_num>$goods_info['max']){
                    $is_max = $buy_num;
                }
            }
            $goods_info['max_num'] = $is_max;

            $class_name = $shop_classify->where(array('id'=>$goods_info['classify']))->field('name')->find();
            $goods_info['class_name'] = $class_name['name'];


            $goods_info['description'] = XUANIMG.'/home/shopshow/index/shop_id/'.$goods_id;

            $select_list = $shop_select->where(array('goods_id'=>$goods_id))->order('id')->field('id as select_id,select_name,value,add_price')->select();
            $goods_info['select_list'] = $select_list;




            $postage_val = '包邮';
            if($user_info){
                $shop_location = M('shop_location');
                $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->field('id')->find();
                $select_id = $select_list[0]['select_id'];
                if($location_info){
                    $money = JsPostageMoney($select_id,'1',$location_info['id']);
                }else{
                    $money = JsPostageMoney($select_id,'1','广东','2');
                }
                if($money>0){
                    $postage_val = '运费 '.$money.' 元';
                }
            }
            $banner_list = array();
            $banner_list[] = $goods_info['cover'];
            $banner_val = $shop_goods_banner->order('sort')->where(array('goods_id'=>$goods_id))->field('img_url')->select();
            foreach($banner_val as $item){
                $banner_list[]  = $item['img_url'];
            }

            $goods_info['banner_list'] = $banner_list;
            $goods_info['sales'] = "销量 ".$goods_info['sales'];

            if ($type=='1'){
                $goods_info['edit_content_url'] = '';
                $goods_info['edit_content_url_a'] = '';
            }else{
                $goods_info['edit_content_url'] = XUANIMG.'/home/shopshow/showedit/goods_id/'.$goods_info['id'];
                $goods_info['edit_content_url_a'] = XUANIMG.'/home/shopshow/showedita/goods_id/'.$goods_info['id'];



            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'商品已下架',
            );

            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $shop_user = $shop->where(array('id'=>$goods_info['shop_id']))->field('user_id,name,service_type,hospital_id')->find();

        if(!$shop_user){
            $shop_user['service_type'] = '1';
            $shop_user['user_id'] = '';
            $shop_user['name'] = '';
        }
        $goods_info['hos_id'] = '0';
        $goods_info['hos_name'] = '';

        if($shop_user['hospital_id']){
            $hos_info = $hospital->where(array('id'=>$shop_user['hospital_id']))->field('id,name')->find();
            if($hos_info){
                //$goods_info['hos_id'] = $hos_info['id'];
                $goods_info['hos_id'] = $goods_info['shop_id'];
                $goods_info['hos_name'] = $hos_info['name'];
            }
        }


        if($goods_info['postage_id']){
            $post_name = M('postage')->where(array('id'=>$goods_info['postage_id']))->field('name')->find();
            $goods_info['postage_name'] = $post_name['name'];
        }else{
            $goods_info['postage_name'] = '';
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'postage_val'=>$postage_val,
            'collect_id'=>$collect_id,
            'is_collect'=>$is_collect,
            'service_type'=>$shop_user['service_type'],
            'shop_id'=>$shop_user['id'],
            'shop_user'=>$shop_user['user_id'],
            'shop_name'=>$shop_user['name'],
            'goods_info' =>$goods_info,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 商城-立即购买/购物城计算-生成缓存订单
     */
    function CreateOrder(){
        $shop_select = M('shop_select');
        $shop_goods = M('shop_goods');
        $shop_order = M('shop_order');
        $shop_order_goods = M('shop_order_goods');
        $user = M('user');
        $shop = M('shop');
        $token = decrypt1(trim(I('post.token')));
        //$type = decrypt1(trim(I('post.type')));//类型：1立即购买，2购物车结算
        $goods_id = decrypt1(trim(I('post.goods_id')));
        $select_id = decrypt1(trim(I('post.select_id')));
        $num = decrypt1(trim(I('post.num')));

        //$trolley_val = '2,3';
        //$type = '2';
        //$token = '7680d109eecf3429780c3a11309b5aba';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_number = time().$user_info['id'].rand(1000,9999);



        $add['order_number'] = $order_number;
        $add['create_time'] = time();
        $add['status'] = 0;
        $add['user_id'] = $user_info['id'];

        //立即购买
            if(!$goods_id){$arr = array('code'=> 0, 'res'=>'请选择商品',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if(!is_numeric($num)){$arr = array('code'=> 0, 'res'=>'商品数量只能为整数',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($num<1){$arr = array('code'=> 0, 'res'=>'商品数量不能小于1',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            $add['order_type'] = 1;

            $goods_info = $shop_goods->where(array('id'=>$goods_id))->field('price,add_score,stock,prepay,is_prepay,shop_id,max,is_show,is_freeze')->find();
            if($goods_info['is_show']=='0'){$arr = array('code'=> 0, 'res'=>'此商品已下架，无法购买',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($goods_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'此商品已下架，无法购买',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if($goods_info['max']>0){
            $where_buy['user_id'] = $user_info['id'];
            $where_buy['goods_id'] = $goods_id;
            $where_buy['status'] = array('NEQ',0);
            $where_buy['refund_status'] = array('NOT IN','4,5');
            $buy_num = $shop_order->where($where_buy)->sum('total_num');
            $now_num = $num+$buy_num;
            if ($now_num>$goods_info['max']){
                $arr = array(
                    'code'=> 0,
                    'res'=>'此商品限购'.$goods_info['max'].'件'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }


        $shop_info = $shop->where(array('id'=>$goods_info['shop_id']))->field('user_id')->find();
        if($shop_info['user_id']==$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'无法购买自己店铺的商品！'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
            if(($goods_info['stock']-$num)<0){
                $arr = array(
                    'code'=> 0,
                    'res'=>'商品库存不足，请稍后购买或浏览其他商品！'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }



        $shop_location  = M('shop_location');
        $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->find();
        if($location_info){
            $add['location_id'] = $location_info['id'];
            $add['location'] = $location_info['province'].$location_info['city'].$location_info['district'].$location_info['street'];
            $add['mobile'] = $location_info['mobile'];
            $add['addressee'] = $location_info['addressee'];
            $add['particular'] = $location_info['particular'];
        }else{
           /* $arr = array(
                'code'=> 0,
                'res'=>'请先填写收货地址'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");*/
        }


        $add_price = 0;
            //$add_cost = 0;
            if($select_id){
                $arr_select = explode('.',$select_id);
                foreach($arr_select as $val){
                    $select_info = $shop_select->where(array('id'=>$val))->field('add_price')->find();
                    $add_price += $select_info['add_price'];
                    //$add_cost += $select_info['add_cost'];
                }
            }

            //$price = $add_price+$goods_info['price'];
            $price = $add_price;
            $total_money = $price*$num;

            $prepay = $goods_info['prepay'] * $num;

            /*$zong_cost = $add_cost+$goods_info['cost'];
            $total_cost = $zong_cost*$num;*/

            $scores = $goods_info['add_score']*$num;
            //$postage_money = JsPostageMoney($select_id,$num,$location_info['id']);
            //$total_money += $postage_money;
            $add['goods_id'] = $goods_id;
            $add['shop_id'] = $goods_info['shop_id'];
            $add['total_money'] = $total_money;
            $add['is_prepay'] = $goods_info['is_prepay'];
            $add['prepay_money'] = $prepay;
            //$add['postage_money'] = $postage_money;
            //$add['total_cost'] = $total_cost;
            $add['total_num'] = $num;
            $add['type'] = 2;
            $add['scores'] = $scores;
            $order_id = $shop_order->add($add);
            if($order_id){
                $arr_select = explode('.',$select_id);
                $select_arr = array();
                $select_cost = array();
                $select_price = array();
                foreach($arr_select as $val){
                    $select_info = $shop_select->where(array('id'=>$val))->field('select_name,value,add_price,add_cost')->find();
                    if(!$select_info){
                        $arr = array(
                            'code'=> 0,
                            'res'=>'商品信息有变动'
                        );
                        $data = json_encode($arr);
                        $return['encryption'] =  encrypt1($data);
                        $this->ajaxReturn($return,"JSON");
                    }
                    $select_arr[] = $select_info['select_name'].':'.$select_info['value'];
                    $select_cost[] = $select_info['select_name'].':'.$select_info['value'].':'.$select_info['add_cost'];
                    $select_price[] = $select_info['select_name'].':'.$select_info['value'].':'.$select_info['add_price'];
                }
                $select_val = implode(',',$select_arr);

                $select_cost_val = implode(',',$select_cost);
                $select_price_val = implode(',',$select_price);

                //$add_order_goods['total_cost'] = $total_cost;//商品总成本
                //$add_order_goods['cost'] = $goods_info['cost'];//商品成本
                $add_order_goods['select_cost'] = $select_cost_val;//商品规格成本
                $add_order_goods['select_price'] = $select_price_val;//商品规格价格


                $add_order_goods['order_id'] = $order_id;
                $add_order_goods['select_val'] = $select_val;
                $add_order_goods['goods_id'] = $goods_id;
                $add_order_goods['select_id'] = $select_id;
                $add_order_goods['num'] = $num;
                $add_order_goods['money'] = $total_money;
                $add_order_goods['create_time'] = time();
                $is_add = $shop_order_goods->add($add_order_goods);
                if(!$is_add){
                    $shop_order->where(array('id'=>$order_id))->delete();
                    $arr = array(
                        'code'=> 0,
                        'res'=>'订单生成错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }else{
                    $arr = array(
                        'code'=> 1,
                        'res'=>'订单生成成功',
                        'shop_order_id'=>$order_id,
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'订单生成错误'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

    }

    /**
     * 商城-确认订单基础信息
     */
    function maiDanCheckChou(){
        $token = decrypt1(trim(I('post.token')));
        $cost = decrypt1(trim(I('post.cost')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $have_id = decrypt1(trim(I('post.have_id')));
        $money = decrypt1(trim(I('post.money')));
        $user = M('user');
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = HosOrderAgentChouCheck($money,$cost,$shop_id,$have_id,$user_info['id']);
        $list['is_agent'] = $user_info['is_agent'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 商城-确认订单基础信息
     */
    function SuccessOrderCheck(){
        $shop_location = M('shop_location');
        $shop_order = M('shop_order');
        $shop_order_goods = M('shop_order_goods');
        $user = M('user');
        $shop = M('shop');
        $token = decrypt1(trim(I('post.token')));
        $shop_order_id = decrypt1(trim(I('post.shop_order_id')));
        $from = decrypt1(trim(I('post.from')));
        if(!$from){$from=1;}
        //$location_id = decrypt1(trim(I('post.location_id')));

        //$shop_order_id = 1;
        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->field('id as location_id,addressee,mobile,province,city,district,particular,street')->find();
        if($location_info){
            $is_location = '0';
            $location_info['location'] = $location_info['province'].$location_info['city'].$location_info['district'].$location_info['street'].$location_info['particular'];
            unset($location_info['province']);
            unset($location_info['city']);
            unset($location_info['district']);
            unset($location_info['particular']);
        }else{
            $is_location = '1';
            $location_info['location_id'] = '0';
            $location_info['addressee'] = '';
            $location_info['mobile'] = '';
            $location_info['location'] = '';
        }

        $order_info = $shop_order->where(array('id'=>$shop_order_id))->field('id as shop_order_id,total_money,is_prepay,prepay_money,shop_id')->find();
        $shop_info = $shop->where(array('id'=>$order_info['shop_id']))->field('id,classify')->find();

        $ticket_list =  $this->ShopOrderTicket($shop_order_id,$token,$from);
        $order_info['usable_ticket'] = (String)count($ticket_list);

        $noun_money = M('set')->where(array('set_type'=>'noun_money'))->find();
        if($order_info['total_money']>=$noun_money['set_value']){
            if($shop_info['classify']=='11'){
                $order_info['is_noun'] = '1';
            }else{
                $order_info['is_noun'] = '0';
            }
        }else{
            $order_info['is_noun'] = '0';
        }



        $goods_list= $shop_order_goods
            ->join('lyx_shop_goods ON lyx_shop_order_goods.goods_id = lyx_shop_goods.id')
            ->where(array('lyx_shop_order_goods.order_id'=>$shop_order_id))
            ->field('lyx_shop_order_goods.goods_id,lyx_shop_order_goods.select_id,lyx_shop_order_goods.num,lyx_shop_order_goods.money,
            lyx_shop_goods.name,lyx_shop_goods.cover,lyx_shop_order_goods.select_val')
            ->select();
        foreach($goods_list as $key=>$item){



            $goods_list[$key]['select_val'] = $item['select_val'].',数量:'.$item['num'];
        }
        $order_info['is_location'] = $is_location;
        $order_info['location_info'] = $location_info;
        $order_info['goods_list'] = $goods_list;
        $order_info['is_agent'] = $user_info['is_agent'];
        $agent_money = 0;
        $agent_money2['odds'] = 0;
        if($user_info['is_agent']==1){
            $agent_money2 = ShopOrderAgentChou($order_info['shop_order_id'],'2');
            if($agent_money2['money']>0){
                $agent_money = $agent_money2['money'];

            }
        }
        $order_info['agent_money'] = $agent_money;
        $order_info['agent_odds'] = 10-$agent_money2['odds'];

        //if (!$user_info['ali_number'] || !$user_info['ali_name']){
        if (!$user_info['ali_user_id']){
            $is_ali = '0';
        }else{
            $is_ali = '1';
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'is_ali'=>$is_ali,
            'order_info'=>$order_info,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }
    /**
     * 查询街道
     */
    function jiedaoList(){
        $pro = decrypt1(trim(I('post.pro')));
        $city = decrypt1(trim(I('post.city')));
        $dis = decrypt1(trim(I('post.dis')));
        $zs_region = M('zs_region');
        $where_1['level'] = 1;
        $where_1['name'] = $pro;
        $pro_info  = $zs_region->where($where_1)->find();

        $where_2['level'] = 2;
        $where_2['parent_id'] = $pro_info['id'];
        $where_2['name'] = $city;
        $city_info  = $zs_region->where($where_2)->find();

        $where_3['level'] = 3;
        $where_3['parent_id'] = $city_info['id'];
        $where_3['name'] = $dis;
        $dis_info  = $zs_region->where($where_3)->find();

        $list = M('zs_region')
            ->where(array('level'=>4,'parent_id'=>$dis_info['id']))->select();
        if($list){
            $arr = array(
                'code'=> 1,
                'res'=>'查询成功',
                'list'=>$list
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'查询成功'
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 商城-添加/修改 收货地址
     */
    function AddLocation(){
        $shop_location = M('shop_location');
        $user = M('user');
        $token = decrypt1(trim(I('post.token')));
        $addressee = decrypt1(trim(I('post.addressee')));
        $mobile = decrypt1(trim(I('post.mobile')));
        $province = decrypt1(trim(I('post.province')));
        $city = decrypt1(trim(I('post.city')));
        $district = decrypt1(trim(I('post.district')));
        $street = decrypt1(trim(I('post.street')));
        $particular = decrypt1(trim(I('post.particular')));

        //$token = '7680d109eecf3429780c3a11309b5aba';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if(!$addressee){$arr = array('code'=> 0, 'res'=>'请填写收件人',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$mobile){$arr = array('code'=> 0, 'res'=>'请填写手机号码',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //判断输入非法
        if(preg_match("/[\',:;*?？！~`!#$%^&=)(<>{}]|\]|\[|\/|\\\|\"|\|/",$mobile) || strlen($mobile)!=11){  //不允许特殊字符
            $arr = array(
                'code'=> 0,
                'res'=>'手机号码格式错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if(!$province){$arr = array('code'=> 0, 'res'=>'请选择省市',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($province=='北京' || $province=='天津' || $province=='上海' || $province=='重庆'){
            if(!$city){$arr = array('code'=> 0, 'res'=>'请选择区域',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            //if(!$street){$arr = array('code'=> 0, 'res'=>'请选择街道',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }else{
            if(!$city){$arr = array('code'=> 0, 'res'=>'请选择城市',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            //if(!$district){$arr = array('code'=> 0, 'res'=>'请选择区域',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            //if(!$street){$arr = array('code'=> 0, 'res'=>'请选择街道',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        }
    if(!$particular){$arr = array('code'=> 0, 'res'=>'请填写详细地址',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $is_add = $shop_location->where(array('user_id'=>$user_info['id']))->find();


        $add['addressee'] = $addressee;
        $add['mobile'] = $mobile;
        $add['province'] = $province;
        $add['city'] = $city;
        $add['district'] = $district;
        $add['street'] = $street;
        $add['particular'] = $particular;
        $add['user_id'] = $user_info['id'];


        if ($is_add){
            $add['update_time'] = time();
            $query = $shop_location->where(array('id'=>$is_add['id']))->save($add);
            $res = '修改';
            $lid = $is_add['id'];
        }else{
            $add['create_time'] = time();
            $query = $shop_location->add($add);
            $res = '新增';
            $lid = $query;
        }

        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
                'location_id'=>$lid
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 商城-查询收货地址
     */
    function CheckLocation(){
        $user = M('user');
        $zs_region = M('zs_region');
        $shop_location = M('shop_location');
        $token = decrypt1(trim(I('post.token')));

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->field('id as location_id,addressee,mobile,province,city,district,street,particular')->find();




        $location_info['pro_id'] = '';
        if($location_info){
            $where_pro['level'] = 1;
            $where_pro['name'] =  array("like","%".$location_info['province']."%");;
            $pro_info = $zs_region->where($where_pro)->find();
            $location_info['pro_id'] = (String)$pro_info['id'];
            $location_info['province'] = $pro_info['name'];

            $where_city['level'] = 2;
            $where_city['parent_id'] = $pro_info['id'];
            $where_city['name'] =  array("like","%".$location_info['city']."%");;
            $city_info = $zs_region->where($where_city)->find();
            $location_info['city'] = $city_info['name'];



        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'location_info'=>$location_info,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 测试-模拟支付宝支付订单
     */
   function TestAlipay(){
       die;
        $user = M('user');
        $shop = M('shop');
        $token = decrypt1(trim(I('post.token')));
        $pay_type = decrypt1(trim(I('post.pay_type')));//支付类型：1支付全款，2支付预定金,3支付剩余金额
        $shop_order_id = decrypt1(trim(I('post.shop_order_id')));
        $location_id = decrypt1(trim(I('post.location_id')));
        $remark = decrypt1(trim(I('post.remark')));


        //$token = '7680d109eecf3429780c3a11309b5aba';
       $user_info = $user->where(array('token' => $token))->find();
       if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
       if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


       $shop_order = M('shop_order');



        $order_info = $shop_order->where(array('id'=>$shop_order_id))->field('id,status,total_money,prepay_money,is_prepay,shop_id')->find();

        if($order_info){

            $shop_location  = M('shop_location');
            $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->find();
            if(!$location_info){
                $arr = array(
                    'code' => 0,
                    'res' => '请先完善收货地址'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save_order['location_id'] = $location_info['id'];
            $save_order['location'] = $location_info['province'].$location_info['city'].$location_info['district'].$location_info['street'];
            $save_order['mobile'] = $location_info['mobile'];
            $save_order['addressee'] = $location_info['addressee'];
            $save_order['particular'] = $location_info['particular'];
            $save_order['remark'] = $remark;
            $save_order['pay_time'] = time();
            $save_order['pay_type'] = 2;
            if ($pay_type=='2'){

                if ($order_info['is_prepay']=='0'){$arr = array('code' => 0, 'res' => '该商品不支持支付预定金');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
                if ($order_info['status']!='0'){$arr = array('code' => 0, 'res' => '订单已支付，请勿重复支付');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

                $save_order['money'] = $order_info['prepay_money'];
                $save_order['need_money'] = $order_info['total_money'] - $order_info['prepay_money'];
                $save_order['status'] = 1;
                $save_order['money_type'] = 1;
            }else if ($pay_type=='3'){
                if ($order_info['status']!='1'){$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

                $save_order['money'] = $order_info['total_money'];
                $save_order['need_money'] = 0;
                $save_order['status'] = 2;
                $save_order['money_type'] = 2;
            }else{
                if ($order_info['status']!='0'){$arr = array('code' => 0, 'res' => '订单已支付，请勿重复支付');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

                $save_order['money'] = $order_info['total_money'];
                $save_order['need_money'] = 0;
                $save_order['status'] = 2;
                $save_order['money_type'] = 2;
            }
            $query = $shop_order->where(array('id'=>$shop_order_id))->save($save_order);
        }else{
            $arr = array(
                'code' => 0,
                'res' => '订单不存在'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        /*M('shop_order')->where(array('id'=>$shop_order_id))->save(array('status'=>'1','pay_type'=>'2','pay_time'=>time()));
        $order_info = M('shop_order')->where(array('id'=>$shop_order_id))->field('id,user_id,scores,order_type,trolley_val')->find();
        M('user')->where(array('id'=>$order_info['user_id']))->setInc('score',$order_info['scores']);
        //增加积分
        M('user')->where(array('id'=>$order_info['user_id']))->setInc('score',$order_info['scores']);
        $add_log['user_id'] = $order_info['user_id'];
        $add_log['add_or_del'] = 1;
        $add_log['type'] = 1;
        $add_log['num'] = $order_info['scores'];
        $add_log['order_id'] = $shop_order_id;
        $add_log['create_time'] = time();
        M('shop_score_log')->add($add_log);*/




        if  ($query){

            $shop_info = $shop->where(array('id'=>$order_info['shop_id']))->find();
            if ($pay_type=='1'){
                $add_system['type'] = 1;//1新的订单，2订单交易成功，3待处理订单
                $tis = '新订单';
            }
            if ($pay_type=='2'){
                $add_system['type'] = 1;//1新的订单，2订单交易成功，3待处理订单
                $tis = '新订单-已支付预约金';
            }
            if ($pay_type=='3'){
                $add_system['type'] = 3;//1新的订单，2订单交易成功，3待处理订单
                $tis = '支付完成';
            }
            //添加消息通知
            //新版
            $add_system['user_id'] = $shop_info['user_id'];
            $add_system['send_user_id'] = $user_info['id'];
            $add_system['content'] = $tis;
            $add_system['type_id'] = $order_info['id'];
            $add_system['status'] = 3;
            $add_system['create_time'] = time();
            M('system')->add($add_system);
            $rong_user[] = $shop_info['user_id'];
            SendRongSystem($rong_user,$tis);

            if ($pay_type=='1' || $pay_type=='3'){
                $goods_list = M('shop_order_goods')->where(array('order_id'=>$order_info['id']))->field('goods_id')->select();
                foreach($goods_list as $item){
                    M('shop_goods')->where(array('id'=>$item['goods_id']))->setInc('sales','1');
                    M('shop_goods')->where(array('id'=>$item['goods_id']))->setDec('stock','1');
                }
            }
            $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'0',$order_info['id']);
            $arr = array(
                'code'=> 1,
                'res'=>'支付成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'支付失败',
            );
        }



        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 查询用户支付宝信息
     */
    function CheckUserAli(){
        $user = M('user');
        $token = decrypt1(trim(I('post.token')));

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if (!$user_info['ali_user_id']){
            $is_ali = '0';
        }else{
            $is_ali = '1';
        }
        $list['ali_number'] = $user_info['ali_number']?$user_info['ali_number']:"";
        $list['ali_name'] = $user_info['ali_name']?$user_info['ali_name']:"";

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'is_ali'=>$is_ali,
            'list'=>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /**
     * 绑定支付宝信息
     */
    function BindUserAli(){
        $user = M('user');
        //$a =  'Ycn96TuvRdPeR1lXQgoeBKI44uAUhyASO0MqYs23cgd+BdrF3L/VzW1Ea0Gtj/Px';
        $token = decrypt1(trim(I('post.token')));
        //$token2 = I('post.token');
        $ali_number = decrypt1(trim(I('post.ali_number')));
        $ali_name = decrypt1(trim(I('post.ali_name')));


        //$token = '7680d109eecf3429780c3a11309b5aba';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if(!$ali_number){$arr = array('code'=> 0, 'res'=>'请填写支付宝账号',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$ali_name){$arr = array('code'=> 0, 'res'=>'请填写支付宝真实姓名',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $save['ali_number'] = $ali_number;
        $save['ali_name'] = $ali_name;
        $save['update_time'] = time();

        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        $res = '操作';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }








    /**
 * 优惠券列表
 */
    function TicketList(){
        $user = M('user');

        $ticket = M('ticket');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        if ($user_info['is_agent']=='1'){
            $where['type']  = array('IN','1,3');
        }else{
            $where['type']  =1;
        }
        $where['is_show']  =1;
        $list = $ticket->where($where)->limit($start,$num)->order('sort')->field('id,title,info,discount,price,type,use_type,dis_title,sales')->select();
        foreach ($list as $key=>$item){
            if($item['use_type']==1){
                $list[$key]['discount'] = (String)($item['discount']/10);
            }
            if($item['use_type']==3){
                $list[$key]['use_type'] = '2';
            }
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-我的优惠券
     */
    function MyTicketList(){
        $user = M('user');

        $ticket_user = M('ticket_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $ticket_user
            ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
            ->where(array('lyx_ticket_user.user_id'=>$user_info['id'],'lyx_ticket_user.status'=>0))
            ->field('lyx_ticket.id as ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.use_type,lyx_ticket.dis_title,
            lyx_ticket_user.discount,lyx_ticket.type,lyx_ticket_user.id as have_id,lyx_ticket_user.status')
            ->order('lyx_ticket_user.create_time desc')->limit($start,$num)->select();

        foreach ($list as $key=>$item){
            if($item['use_type']==1){
                $list[$key]['discount'] = (String)($item['discount']/10);
            }
            if($item['use_type']==3){
                $list[$key]['use_type'] = '2';
            }

        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'score'=>$user_info['score'],
            'list' => $list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 优惠券详细
     */
    function TicketDetail(){
        $user = M('user');

        $ticket = M('ticket');
        $ticket_user = M('ticket_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $ticket_id = decrypt1(trim(I('post.ticket_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1查看销售优惠券，2查看自己的优惠券
        $have_id = decrypt1(trim(I('post.have_id')));
       /* $page = decrypt1(trim(I('post.page')));




        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;*/

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$ticket_id = '1';

        if  (!$type){
            $type='1';
        }

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        if($type=='1'){
            $list = $ticket->where(array('id'=>$ticket_id))->field('id,title,info,explain,discount,price,rebate,type,use_type,dis_title,sales')->find();

        }else{
           $list =  $ticket_user
                ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                ->where(array('lyx_ticket_user.id'=>$have_id))
                ->field('lyx_ticket.id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.explain,lyx_ticket_user.discount,lyx_ticket.use_type,lyx_ticket.dis_title,lyx_ticket.sales,
                lyx_ticket_user.buy_money as price,lyx_ticket_user.rebate_money as rebate,lyx_ticket.type,lyx_ticket_user.is_zhuan')
                ->find();

           if($list['price']==0 || $list['is_zhuan']=='1'){
               $list['price'] = '--';
           }
        }

        if($list['use_type']==1){
            $list['discount'] = (String)($list['discount']/10);
        }
        if($list['use_type']==3){
            $list['use_type'] = '2';
        }

        if (!$list['explain']){$list['explain']='';}


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }







    /**
     * 医院详情
     */
    function HospitalDetail(){
        $user = M('user');
        $hospital = M('hospital');
        $shop = M('shop');
        $doctor = M('doctor');
        $shop_goods = M('shop_goods');
        $hospital_comment = M('order_comment');
        $hospital_comment_photo = M('order_comment_photo');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hos_id = decrypt1(trim(I('post.hos_id')));

        $page = decrypt1(trim(I('post.page')));

         if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$hos_id = '1';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }

        $list = $hospital->where(array('id'=>$hos_id))->field('id,name,phone,logo,bg,classify,location,lng,lat,grade')->find();

        $is_shop = $shop->where(array('hospital_id'=>$hos_id))->field('id,name,user_id,service_type')->find();
        if ($is_shop){
            $list['shop_id'] = $is_shop['id'];
            $list['user_id'] = $is_shop['user_id'];
            $list['shop_name'] = $is_shop['name'];
            $list['service_type'] = $is_shop['service_type'];
        }else{
            $list['user_id'] = '';
            $list['service_type'] = '1';
            $list['shop_id'] = '';
            $list['shop_name'] = '';
        }
        $list['doctor_list'] = $doctor->where(array('is_show'=>'1','hospital_id'=>$hos_id))
            ->order('sort')->field('id,name,head')->select();

        $list['comment_count'] = $hospital_comment->where(array('parent'=>$hos_id))->count();



        $comment_list = $hospital_comment->where(array('parent'=>$list['shop_id'],'order_type'=>'2'))
            ->limit($start,$num)
            ->order('create_time desc')->field('id,user_id,content,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type,goods_id')->select();
        foreach($comment_list as $key=>$item){
            if(!$item['video_url']){
                $comment_list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $comment_list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $comment_list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $comment_list[$key]['video_thumb'] = "";
            }

            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
            $comment_list[$key]['name'] = $user_info2['name'];
            $comment_list[$key]['head'] = $user_info2['head'];
            $comment_list[$key]['sex'] = $user_info2['sex'];
            $comment_list[$key]['age'] = $user_info2['age'];
            $comment_list[$key]['level'] = $user_info2['level'];

            $comment_list[$key]['create_time'] = mdate($item['create_time']);


            $new_img_list = array();
            $img_list = $hospital_comment_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $comment_list[$key]['img_list'] = $new_img_list;

            unset($comment_list[$key]['video_icon']);
            $goods_name = $shop_goods->where(array('id'=>$item['goods_id']))->field('id,name')->find();
            if($goods_name){
                $comment_list[$key]['goods_name'] = $goods_name['name'];
            }else{
                $comment_list[$key]['goods_name'] = '扫码支付';
            }
        }

        $list['comment_list'] = $comment_list;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 商城-商品评论
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    function GoodsDetailCommentList(){
        $user = M('user');
        $hospital_comment = M('order_comment');
        $hospital_comment_photo = M('order_comment_photo');



        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$goods_id = '692';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        $where_main['goods_id'] = $goods_id;
        $where_main['order_type'] = 1;
        $comment_list = $hospital_comment->where($where_main)
            ->limit($start,$num)
            ->order('create_time desc')->field('id,user_id,content,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type')->select();
        foreach($comment_list as $key=>$item){
            if(!$item['video_url']){
                $comment_list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $comment_list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $comment_list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $comment_list[$key]['video_thumb'] = "";
            }

            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
            $comment_list[$key]['name'] = $user_info2['name'];
            $comment_list[$key]['head'] = $user_info2['head'];
            $comment_list[$key]['sex'] = $user_info2['sex'];
            $comment_list[$key]['age'] = $user_info2['age'];
            $comment_list[$key]['level'] = $user_info2['level'];

            $comment_list[$key]['create_time'] = mdate($item['create_time']);


            $new_img_list = array();
            $img_list = $hospital_comment_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $comment_list[$key]['img_list'] = $new_img_list;

            unset($comment_list[$key]['video_icon']);
        }

        $list = $comment_list;

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
       /* $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }*/

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 预约页面前置信息
     */
    function appointmentInfo(){
        $shop = M('shop');
        $user = M('user');
        $store_classify = M('store_classify');


        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));

        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$shop_id = '4';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $list = $shop->where(array('id'=>$shop_id))->field('id,name,logo,classify,service_type,user_id,ticket_id,yuyue,location')->find();

        //$list['yuyue'] = $list['yuyue']?$list['yuyue']:'其他';
        $yuyue_info  = $this->yuyue($list['classify'],$list['ticket_id'],$list['yuyue'],$user_info['id']);
        $list['foot_type'] = $yuyue_info['foot_type'];
        $list['is_send_ticket'] = $yuyue_info['is_send_ticket'];
        $list['ticket_list'] = $yuyue_info['ticket_list'];
        $list['project_list'] = $yuyue_info['project_list'];

        unset($list['ticket_id']);
        unset($list['yuyue']);

        $class_name = $store_classify->where(array('id'=>$list['classify']))->field('name')->find();
        $list['classify'] = $class_name['name'];

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    //预约查询
    public function yuyue($classify,$ticket_id,$yuyue,$user_id){
        $ticket = M('ticket');

        $ticket_user = M('ticket_user');

        $list['foot_type'] = '0';
        $list['is_send_ticket'] = '0';
        $ticket_list = array();
        if($classify==11  || $classify==12){
            if($yuyue){
                $project_list = explode('+',$yuyue);
            }else{
                $set_info = M('set')->where(array('set_type'=>'yuyue_'.$classify))->find();
                $project_list = explode('+',$set_info['set_value']);
            }
            if($classify==11){
                $list['foot_type'] = '1';
            }else{
                $list['foot_type'] = '2';
            }
            if($ticket_id){
            //if(1){
                //判断是否未使用
                $is_have = $ticket_user->where(array('user_id'=>$user_id,'parent'=>$ticket_id,'status'=>'0'))->find();
                if(!$is_have){
                    $list['is_send_ticket'] = '1';
                    $ticket_list = $ticket->where(array('id'=>$ticket_id))->field('id,title,info,discount,price,type,use_type,dis_title,sales')->select();
                    //$ticket_list = $ticket->limit(2)->order('sort')->field('id,title,info,discount,price,type,use_type,dis_title,sales')->select();
                    foreach ($ticket_list as $key=>$item){
                        $ticket_list[$key]['discount'] = (String)($item['discount']/10);
                    }
                }
            }
        }
        $list['ticket_list'] = $ticket_list;

        $list['project_list'] = $project_list;
        return $list;
    }

    /**
     * 预约列表
     */
    public function appointmenList(){
        $yuyue = M('yuyue');
        $user = M('user');
        $shop = M('shop');
        $store_classify = M('store_classify');
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$shop_id = '4';


        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $yuyue
            ->where(array('user_id'=>$user_info['id']))
            ->limit($start,$num)
            ->order('create_time desc')
            ->field('id,shop_id,status,create_time')
            ->select();
        foreach ($list as $key=>$item){
            $shop_info = $shop->where(array('id'=>$item['shop_id']))
                ->field('name,logo,classify,user_id,location,phone')->find();

            $class_name = $store_classify->where(array('id'=>$shop_info['classify']))->field('name')->find();
            $list[$key]['name'] = $shop_info['name'];
            $list[$key]['logo'] = $shop_info['logo'];
            $list[$key]['location'] = $shop_info['location'];
            $list[$key]['phone'] = $shop_info['phone']?$shop_info['phone']:'';
            $list[$key]['classify'] =  $class_name['name'];
            $list[$key]['create_time'] =  date('Y-m-d H:i:s',$item['create_time']);
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    function testyuyue(){
        $shop = M('shop');
        $user = M('user');
        $token = 'bf8739cb479fa5d17c98dfbb7beb1452';
        $shop_id = 56;
        $user_info = $user->where(array('token' => $token))->find();

        $list = $shop->where(array('id'=>$shop_id))->field('id,name,logo,classify,service_type,user_id,ticket_id,yuyue')->find();

        $list['yuyue'] = '隆鼻+丰胸';
        $yuyue_info  = $this->yuyue($list['classify'],$list['ticket_id'],$list['yuyue'],$user_info['id']);
        dump($yuyue_info);die;
    }
    /**
     * 提交预约
     */
    public function submitAppointment(){
        $shop = M('shop');
        $user = M('user');
        $yuyue = M('yuyue');
        $ticket_user = M('ticket_user');

        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $name = decrypt1(trim(I('post.name')));
        $phone = decrypt1(trim(I('post.phone')));
        $age = decrypt1(trim(I('post.age')));
        $sex = decrypt1(trim(I('post.sex')));
        $project = decrypt1(trim(I('post.project')));
        $date = decrypt1(trim(I('post.date')));
        $time = decrypt1(trim(I('post.time')));
        $money = decrypt1(trim(I('post.money')));
        $remark = decrypt1(trim(I('post.remark')));

        /*$name = '测试';
        $phone = '14718171817';
        $age = '20';
        $project = '隆鼻';
        $date = '2020-08-16';
        $time = '09：00 - 11：00';
        $token = "bf8739cb479fa5d17c98dfbb7beb1452";
        $shop_id = '4';*/

        if (!$name) {$arr = array('code' => 0, 'res' => '请输入姓名');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$phone) {$arr = array('code' => 0, 'res' => '请输入手机号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$age) {$arr = array('code' => 0, 'res' => '请输入年龄');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$project) {$arr = array('code' => 0, 'res' => '请选择预约项目');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$date) {$arr = array('code' => 0, 'res' => '请选择预约日期');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $date_time = strtotime($date);
        //if ($date_time<=time()) {$arr = array('code' => 0, 'res' => '请选择正确的日期');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if (!$time) {$arr = array('code' => 0, 'res' => '请选择预约时间段');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $shop->where(array('id'=>$shop_id))->field('id,name,logo,classify,service_type,user_id,ticket_id,yuyue')->find();

        $list['yuyue'] = '隆鼻+丰胸';
        $yuyue_info  = $this->yuyue($list['classify'],$list['ticket_id'],$list['yuyue'],$user_info['id']);
        $list['foot_type'] = $yuyue_info['foot_type'];

        $list['is_send_ticket'] = $yuyue_info['is_send_ticket'];
        $list['ticket_list'] = $yuyue_info['ticket_list'];
        $list['project_list'] = $yuyue_info['project_list'];

        if ($yuyue_info['foot_type'] == '0') {$arr = array('code' => 0, 'res' => '当前机构无法预约');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        $add['user_id'] = $user_info['id'];
        $add['shop_id'] = $list['id'];
        $add['name'] = $name;
        $add['phone'] = $phone;
        $add['age'] = $age;
        $add['sex'] = $sex;
        $add['date'] = $date;
        $add['time'] = $time;
        $add['project'] = $project;
        $add['money'] = $money;
        $add['remark'] = $remark;
        $add['create_time'] = time();

        $query = $yuyue->add($add);
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'预约成功',
            );
            if($yuyue_info['ticket_list']){
                $add_ticket['user_id'] = $user_info['id'];
                foreach ($yuyue_info['ticket_list'] as $item){
                    $add_ticket['parent'] = $item['id'];
                    $add_ticket['buy_money'] = 0;
                    if($item['use_type']==1){
                        $add_ticket['discount'] = $item['discount']*10;
                    }else{
                        $add_ticket['discount'] = $item['discount'];
                    }
                    $add_ticket['create_time'] = time();
                    $ticket_user->add($add_ticket);
                }
            }
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'预约失败',
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    //更新没有医院的店铺
    function updateShopIsHospital(){
        $list = M('shop')->where(array('hospital_id'=>0))->select();
        $i = 0;
        foreach ($list as $item){
            updateShopHos($item['id']);
            $i++;
        }
        dump($i);
    }

    /**
     * 机构详情
     */

    function ShopDetail(){
        $user = M('user');
        $hospital = M('hospital');
        $shop = M('shop');
        $doctor = M('doctor');
        $hospital_comment = M('order_comment');
        $hospital_comment_photo = M('order_comment_photo');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');
        $store_classify = M('store_classify');
        $shop_goods = M('shop_goods');
        $ticket = M('ticket');
        $ticket_user = M('ticket_user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;
        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$shop_id = '4';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $list = $shop->where(array('id'=>$shop_id))->field('id,name,logo,bg,classify,location,lng,lat,grade,hospital_id,service_type,user_id,ticket_id,yuyue')->find();


        $yuyue_info  = $this->yuyue($list['classify'],$list['ticket_id'],$list['yuyue'],$user_info['id']);
        $list['foot_type'] = $yuyue_info['foot_type'];
        $list['is_send_ticket'] = $yuyue_info['is_send_ticket'];
        $list['ticket_list'] = $yuyue_info['ticket_list'];

        unset($list['ticket_id']);
        unset($list['yuyue']);
        $list['classify_id'] = $list['classify'];
        if($list['classify_id']==13){
            $list['hospital_id'] = 0;
        }

        $class_name = $store_classify->where(array('id'=>$list['classify']))->field('name')->find();
        $list['classify'] = $class_name['name'];



        $list['is_hospital'] = '0';

        if($list['hospital_id']){
            $hospital_info = $hospital->where(array('id'=>$list['hospital_id']))->field('id,name,phone,logo,bg,classify,location,lng,lat')->find();
            if($hospital_info){
                $hos_id = $hospital_info['id'];
                $list['is_hospital'] = '1';
                //$list['logo'] = $hospital_info['logo'];
                //$list['bg'] = $hospital_info['bg'];
                $list['doctor_list'] = $doctor->where(array('is_show'=>'1','hospital_id'=>$hos_id))
                    ->order('sort')->field('id,name,head')->select();
            }
        }
        if($list['is_hospital']=='1'){
            $where_1['parent'] = $hos_id;
            $where_1['order_type'] = 2;
            $where_2['parent'] = $list['id'];
            $where_2['order_type'] = 1;
            $where_main['_complex'] = array(
                $where_1,
                $where_2,
                '_logic' => 'or'
            );
        }else{
            $where_main['parent'] = $list['id'];
            $where_main['order_type'] = 1;
        }


        $blogs_list = $user_blogs->where(array('shop_id'=>$shop_id,'type'=>array('IN','1,2'),'is_show'=>'1'))
            ->order('create_time desc')
            ->field('id,user_id,lng,lat,content,zan,browse,comment_count,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type')
            ->limit(4)->select();
        foreach($blogs_list as $key=>$item){
            if(!$item['video_url']){
                $blogs_list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $blogs_list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $blogs_list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $blogs_list[$key]['video_thumb'] = "";
            }
            if(!$item['ad_url']){
                $blogs_list[$key]['ad_url'] = "";
            }
            if(!$item['lng']){
                $blogs_list[$key]['lng'] = "";
            }
            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
            $blogs_list[$key]['name'] = $user_info2['name'];
            $blogs_list[$key]['head'] = $user_info2['head'];
            $blogs_list[$key]['sex'] = $user_info2['sex'];
            $blogs_list[$key]['age'] = $user_info2['age'];
            $blogs_list[$key]['level'] = $user_info2['level'];

            $blogs_list[$key]['create_time'] = mdate($item['create_time']);
            //点赞数
            $blogs_list[$key]['zan'] = WanChu($item['zan']);
            //评论数
            $blogs_list[$key]['comment_count'] = WanChu($item['comment_count']);
            //浏览人数
            $blogs_list[$key]['browse'] = WanChu($item['browse']);
            $blogs_list[$key]['dis'] = MiZhuanhuan($item['dis']);
            $blogs_list[$key]['img_width'] = '0';
            $blogs_list[$key]['img_height'] = '0';
            $new_img_list = array();
            $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $key2=>$val) {
                    if ($key2==0){
                        $blogs_list[$key]['img_width'] = $val['width'];
                        $blogs_list[$key]['img_height'] = $val['height'];
                    }
                    $new_img_list[] = $val['img_url'];
                }
            }
            $blogs_list[$key]['img_list'] = $new_img_list;


            //自己是否有点赞
            $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
            if ($is_zan) {
                $blogs_list[$key]['is_zan'] = '1';
            } else {
                $blogs_list[$key]['is_zan'] = '0';
            }

            unset($blogs_list[$key]['video_icon']);

        }
        $list['blogs_list'] = $blogs_list;

        $list['comment_count'] = $hospital_comment->where($where_main)->count();



        $comment_list = $hospital_comment->where($where_main)
            ->limit($start,$num)
            ->order('create_time desc')->field('id,user_id,content,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type,goods_id')->select();
        foreach($comment_list as $key=>$item){
            if(!$item['video_url']){
                $comment_list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $comment_list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $comment_list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $comment_list[$key]['video_thumb'] = "";
            }

            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level')->find();
            $comment_list[$key]['name'] = $user_info2['name'];
            $comment_list[$key]['head'] = $user_info2['head'];
            $comment_list[$key]['sex'] = $user_info2['sex'];
            $comment_list[$key]['age'] = $user_info2['age'];
            $comment_list[$key]['level'] = $user_info2['level'];

            $comment_list[$key]['create_time'] = mdate($item['create_time']);


            $new_img_list = array();
            $img_list = $hospital_comment_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $comment_list[$key]['img_list'] = $new_img_list;

            unset($comment_list[$key]['video_icon']);

            $goods_name = $shop_goods->where(array('id'=>$item['goods_id']))->field('id,name')->find();
            if($goods_name){
                $comment_list[$key]['goods_name'] = $goods_name['name'];
            }else{
                $comment_list[$key]['goods_name'] = '扫码支付';
            }
        }

        $list['comment_list'] = $comment_list;



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 医院支持的优惠券
     */
    function HospitalTicketList(){
        $user = M('user');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hos_id = decrypt1(trim(I('post.hos_id')));

        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;
        //$token = "bfe61fc6813d23f70d60302beb815347";
        //$hos_id = '2';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        if  ($user_info['is_agent'] == '1'){
            $where['lyx_ticket.type'] = array('IN','1,3');
        }else{
            $where['lyx_ticket.type'] = '1';
        }
        $where['lyx_ticket.is_show'] = '1';
        $where['lyx_ticket_hospital.hospital_id'] = $hos_id;
        $list =  $ticket_hospital->where($where)
            ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
            ->field('lyx_ticket.id,lyx_ticket.discount,lyx_ticket.title,lyx_ticket.info,lyx_ticket.price,lyx_ticket.sales,lyx_ticket.use_type,lyx_ticket.dis_title,lyx_ticket.type')
            ->limit($start,$num)->order('lyx_ticket.sort')->select();
        foreach ($list as $key=>$item){
            $list[$key]['discount']= (String)($item['discount']/10);
            $is_have = $ticket_user->where(array('parent'=>$item['id'],'user_id'=>$user_info['id']))->field('id')->find();

            if ($is_have){
                $list[$key]['have_id'] = $is_have['id'];
                $list[$key]['is_have'] = '1';
            }else{
                $list[$key]['have_id'] = '0';
                $list[$key]['is_have'] = '0';
            }
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    function testto(){
        header('Location:ymxte://');
    }



    /**
     * 医院更多信息
     */
    function HospitalMoreInfo(){
        $user = M('user');
        $hospital = M('hospital');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hos_id = decrypt1(trim(I('post.hos_id')));

      /*  $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$hos_id = '1';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        $list = $hospital->where(array('id'=>$hos_id))->field('id,open_time,operating_room,treatment_room,proportion,administrative,intro')->find();
        $list['open_time'] = date('Y-m-d',$list['open_time']);
        $list['operating_room'] = $list['operating_room'].'个';
        $list['treatment_room'] = $list['treatment_room'].'个';
        $administrative = explode('+',$list['administrative']);
        $list['administrative'] =implode('、',$administrative);



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
 * 医院环境
 */
    function HospitalHj(){
        $user = M('user');
        $hospital_hj = M('hospital_hj');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hos_id = decrypt1(trim(I('post.hos_id')));

        /*  $page = decrypt1(trim(I('post.page')));

          if(!$page){$page = 1;}
          $num = 20;//分页数
          $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$hos_id = '1';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        $list = $hospital_hj->where(array('parent'=>$hos_id))->field('id,img_url')->select();
        $new_list = array();
        foreach ($list as $item){
            $new_list[] = $item['img_url'];
        }




        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$new_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 医院执业许可
     */
    function HospitalPapers(){
        $user = M('user');
        $hospital_papers = M('hospital_papers');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hos_id = decrypt1(trim(I('post.hos_id')));

        /*  $page = decrypt1(trim(I('post.page')));

          if(!$page){$page = 1;}
          $num = 20;//分页数
          $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$hos_id = '1';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        $list = $hospital_papers->where(array('parent'=>$hos_id,'type'=>'1'))->field('id,title,img_url')->select();


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 医院荣誉证书
     */
    function HospitalGlory(){
        $user = M('user');
        $hospital_papers = M('hospital_papers');
        $doctor_glory = M('doctor_glory');
        $shop = M('shop');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hos_id = decrypt1(trim(I('post.hos_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1医院，2医生

        $shop->where(array('id'=>$hos_id))->field('id,hospital_id')->find();

        /*  $page = decrypt1(trim(I('post.page')));

          if(!$page){$page = 1;}
          $num = 20;//分页数
          $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$hos_id = '1';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        if ($type=='2'){
            $list = $doctor_glory->where(array('hospital_id'=>$hos_id))->field('id,title,img_url')->select();
        }else{
            $list = $hospital_papers->where(array('parent'=>$hos_id,'type'=>'2'))->field('id,title,img_url')->select();
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 医生详细
     */
    function DoctorDetail(){
        $user = M('user');
        $doctor = M('doctor');
        $hospital = M('hospital');
        $shop = M('shop');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $doc_id = decrypt1(trim(I('post.doc_id')));

        /*  $page = decrypt1(trim(I('post.page')));

          if(!$page){$page = 1;}
          $num = 20;//分页数
          $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$doc_id = '18';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        $list = $doctor->where(array('id'=>$doc_id))->field('id,name,head,job,job_age,skilled,hospital_id,user_id')->find();
        $list['job_age'] = '从业'.$list['job_age'].'年';
        $list['skilled'] = explode('+',$list['skilled']);
        $hos_name = $hospital->where(array('id'=>$list['hospital_id']))->field('name')->find();
        $list['hos_name'] = $hos_name['name'];
        $shop_info = $shop->where(array('hospital_id'=>$list['hospital_id']))->field('id')->find();
        $list['shop_id'] = $shop_info['id'];

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 医生资料
     */
    function DoctorMoreInfo(){
        $user = M('user');
        $doctor = M('doctor');
        $doctor_photo = M('doctor_photo');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $doc_id = decrypt1(trim(I('post.doc_id')));

        /*  $page = decrypt1(trim(I('post.page')));

          if(!$page){$page = 1;}
          $num = 20;//分页数
          $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$doc_id = '18';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        $list = $doctor->where(array('id'=>$doc_id))->field('id,name,head,job,job_age,skilled,intro')->find();
        $list['job_age'] = '从业'.$list['job_age'].'年';
        $list['skilled'] = explode('+',$list['skilled']);
        $img_list = $doctor_photo->where(array('parent'=>$doc_id))->select();
        foreach ($img_list as $item){
            $new_img[]= $item['img_url'];
        }
        if ($new_img){
            $list['img_url'] = $new_img;
        }else{
            $list['img_url'] = array();
        }





        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 医生证件与荣誉证书
     */
    function DoctorGlory(){
        $user = M('user');
        $doctor_glory = M('doctor_glory');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $doc_id = decrypt1(trim(I('post.doc_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1医生证件，2医生荣誉证书

        /*  $page = decrypt1(trim(I('post.page')));

          if(!$page){$page = 1;}
          $num = 20;//分页数
          $start = ($page-1)*$num;*/
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$doc_id = '18';
        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }
        if ($type=='2'){
            $list = $doctor_glory->where(array('parent'=>$doc_id,'type'=>'2'))->field('id,title,img_url')->select();
        }else{
            $list = $doctor_glory->where(array('parent'=>$doc_id,'type'=>'2'))->field('id,title,img_url')->select();
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 提交个性定制
     */
    function SubmitMade(){
        $user = M('user');
        $made = M('made');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $class_val = decrypt1(trim(I('post.class_val')));
        $sex = decrypt1(trim(I('post.sex')));
        //$explain = decrypt1(trim(I('post.explain')));
        $province = decrypt1(trim(I('post.province')));
        $city = decrypt1(trim(I('post.city')));
        $method = decrypt1(trim(I('post.method')));
        $yawp = decrypt1(trim(I('post.yawp')));
        $money = decrypt1(trim(I('post.money')));
        $img_val = decrypt1(trim(I('post.img_val')));
        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        if (!$name) {$arr = array('code' => 0, 'res' => '请输入称呼');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        //if (!$explain) {$arr = array('code' => 0, 'res' => '请输入个人情况说明');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$class_val) {$arr = array('code' => 0, 'res' => '请选择定制部位');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$yawp) {$arr = array('code' => 0, 'res' => '请输入不满意部分');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$city) {$arr = array('code' => 0, 'res' => '请选择期望城市');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if (!$money) {$arr = array('code' => 0, 'res' => '请输入预算金额');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $add['user_id'] = $user_info['id'];
        $add['name'] = $name;
        $add['money'] = $money;
        $add['class_val'] = $class_val;
        $add['sex'] = $sex;
        $add['img_val'] = $img_val;
        //$add['explain'] = $explain;
        $add['province'] = $province;
        $add['city'] = $city;
        $add['method'] = $method;
        $add['yawp'] = $yawp;
        $add['create_time'] = time();

        $res = '提交';
        $query = $made->add($add);

        if ($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 商城订单-使用优惠券
     */
    function checkShopOrderTicket(){
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.shop_order_id')));
        $from = decrypt1(trim(I('post.from')));
        if(!$from){$from=1;}
        $list = $this->ShopOrderTicket($order_id,$token,$from);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'usable_list'=>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

   /**
     * 商城订单-支付0元订单
     */
    function PayShopOrder0Money(){
        $user = M('user');
        $shop_order = M('shop_order');
        $shop_location = M('shop_location');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type_id = decrypt1(trim(I('post.type_id')));
        $have_id = decrypt1(trim(I('post.have_id')));
        $from = decrypt1(trim(I('post.from')));
        $remark = decrypt1(trim(I('post.remark')));
        $pay_type = 1;
        if(!$from){$from=1;}
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $order_info = $shop_order->where(array('id'=>$type_id))->find();
        if($order_info){
            $shop_location  = M('shop_location');
            $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->find();
            if(!$location_info){
                $arr = array('code' => 0, 'res' =>'请先完善收货地址');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            $add_pay['remark'] = $remark;
            $add_pay['money_type'] = $pay_type;
            $num = $order_info['total_num'];
            $goods_info = M('shop_goods')->where(array('id'=>$order_info['goods_id']))->field('price,add_score,stock,prepay,is_prepay,shop_id,max,is_show,is_freeze,is_fan_my')->find();
            if($goods_info['price']==0){
                $pay_type = 1;
            }
            if($goods_info['max']>0){
                $where_buy['user_id'] = $user_info['id'];
                $where_buy['goods_id'] = $goods_info['goods_id'];
                $where_buy['status'] = array('NEQ',0);
                $where_buy['refund_status'] = array('NOT IN','4,5');
                $buy_num = $shop_order->where($where_buy)->sum('total_num');
                $now_num = $num+$buy_num;
                if ($now_num>$goods_info['max']){
                    $arr = array('code' => 0, 'res' => '此商品限购'.$goods_info['max'].'件');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");

                }
            }

            if(($goods_info['stock'])-$num<0){
                $arr = array('code' => 0, 'res' => '商品库存不足，请稍后购买或浏览其他商品！');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }


            if($pay_type==1 || $pay_type==2){
                $se_info = M('shop_order_goods')->where(array('order_id'=>$order_info['id']))->field('select_id')->find();
                $postage_money = JsPostageMoney($se_info['select_id'],$order_info['total_num'],$location_info['id']);
                $order_info['total_money'] += $postage_money;
                //$save_order['total_money'] = $order_info['total_money'];
                $save_order['postage_money'] = $postage_money;
            }

            if ($order_info['status']!='0'){
                $arr = array('code' => 0, 'res' => '订单已支付，请勿重复支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            $money = $order_info['total_money'];


            if($have_id){
                if ($pay_type!=1){
                    $arr = array('code' => 0, 'res' => '当前订单状态不允许使用优惠券');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
                }
                $ajax_controller = A('ajax');
                $ticket_list = $ajax_controller->ShopOrderTicket($type_id,$token,$from);
                foreach ($ticket_list as $item){
                    if($item['have_id'] == $have_id){
                        $t_info = $item;
                        break;
                    }
                }
                if($t_info){
                    $add_pay['ticket_id'] = $have_id;
                    $ticket_money = $money - $t_info['ticket_money'];
                    $money = $t_info['ticket_money'];
                    $add_pay['ticket_money'] = $ticket_money;
                }
            }

            if($money>0){
                $arr = array('code' => 0, 'res' => '订单错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }



            $save_order['is_confirm'] = 1;
            $save_order['location_id'] = $location_info['id'];
            $save_order['location'] = $location_info['province'].$location_info['city'].$location_info['district'].$location_info['street'];
            $save_order['mobile'] = $location_info['mobile'];
            $save_order['addressee'] = $location_info['addressee'];
            $save_order['particular'] = $location_info['particular'];
            $save_order['remark'] = $remark;

            if ($pay_type=='2'){
                $save_order['money_type'] = 1;
            }else if ($pay_type=='3'){
                $save_order['money_type'] = 2;
            }else{
                $save_order['money_type'] = 2;
            }

        }else{
            $arr = array('code' => 0, 'res' => '订单不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");

        }
            $save_order['pay_time'] = time();
            $save_order['ticket_id'] = $have_id;
            $save_order['ticket_money'] = $ticket_money;
            $save_order['pay_type'] = 1;//1微信，2支付宝


            $save_order['money'] = $money;
            $save_order['need_money'] = 0;
            $save_order['status'] = 2;
            $save_order['money_type'] = 2;

            $query = M('shop_order')->where(array('id'=>$type_id))->save($save_order);
            if ($query){
                if($have_id){
                    M('ticket_user')->where(array('id'=>$have_id))->save(array('status'=>'1','update_time'=>time()));
                }

                $shop_info = M('shop')->where(array('id'=>$order_info['shop_id']))->find();
                $add_system['type'] = 1;//1新的订单，2订单交易成功，3待处理订单
                $tis = '新订单';
                //添加消息通知
                //新版
                $add_system['user_id'] = $shop_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $tis;
                $add_system['type_id'] = $order_info['id'];
                $add_system['status'] = 3;
                $add_system['create_time'] = time();
                M('system')->add($add_system);
                $rong_user[] = $shop_info['user_id'];
                SendRongSystem($rong_user,$tis);

                $goods_list = M('shop_order_goods')->where(array('order_id'=>$order_info['id']))->field('goods_id')->select();
                foreach($goods_list as $item){
                    M('shop_goods')->where(array('id'=>$item['goods_id']))->setInc('sales',$order_info['total_num']);
                    M('shop_goods')->where(array('id'=>$item['goods_id']))->setDec('stock',$order_info['total_num']);
                }
                $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'0',$order_info['id']);

                if($user_info['is_agent']=='1'){
                    $add_fan = ShopOrderAgentChou($order_info['id'],'3');
                }
                $arr = array('code' => 1, 'res' => '支付成功');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");

            }else{
                $arr = array('code' => 0, 'res' => '支付失败');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");

            }



    }




    /**
     * 商城订单-可用优惠券
     */
    function ShopOrderTicket($order_id,$token,$from=1){
        $user = M('user');
        $shop = M('shop');
        $hospital_order = M('shop_order');
        $ticket_hospital = M('ticket_hospital');
        $ticket_user = M('ticket_user');
        //接收数据
        //$order_id = decrypt1(trim(I('post.order_id')));
        //$page = decrypt1(trim(I('post.page')));

        /* if(!$page){$page = 1;}
         $num = 20;//分页数
         $start = ($page-1)*$num;*/
        //$order_id = '118';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($arr, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($arr, "JSON");}

        $order_info = $hospital_order->where(array('id'=>$order_id))->find();
        if (!$order_info) {$arr = array('code' => 0, 'res' => '订单信息错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($arr, "JSON");}
        if ($order_info['status']!='0') {$arr = array('code' => 0, 'res' => '此订单已支付');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($arr, "JSON");}


        //$hos_info = $hospital->where(array('id'=>$order_info['shop_id']))->find();
        $usable_list = array();
        $t_list1 = $ticket_hospital
            ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
            ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,
            lyx_ticket.use_type,lyx_ticket.ticket_type')
            ->where(array('lyx_ticket_hospital.hospital_id'=>$order_info['goods_id'],'lyx_ticket.type'=>array('IN','1,3'),
                'lyx_ticket.use_type'=>array('IN','1,3'),'lyx_ticket.ticket_type'=>2))
            ->select();

        $t_list2 = $ticket_hospital
            ->join('lyx_ticket ON lyx_ticket_hospital.ticket_id = lyx_ticket.id')
            ->field('lyx_ticket_hospital.ticket_id,lyx_ticket.title,lyx_ticket.info,lyx_ticket.discount,lyx_ticket.price,lyx_ticket.type,lyx_ticket.dis_title,lyx_ticket.sales,
            lyx_ticket.use_type,lyx_ticket.ticket_type')
            ->where(array('lyx_ticket_hospital.hospital_id'=>$order_info['shop_id'],'lyx_ticket.type'=>array('IN','1,3'),
                'lyx_ticket.use_type'=>array('IN','1,3'),'lyx_ticket.ticket_type'=>1))
            ->select();
        $t_list = array_merge($t_list1,$t_list2);
        if($t_list){
            foreach ($t_list as $item){
                $t_arr[] = $item['ticket_id'];
            }
            $t_val = implode(',',$t_arr);
            $where_t['lyx_ticket_user.user_id']= $user_info['id'];
            $where_t['lyx_ticket_user.status']= 0;
            $where_t['lyx_ticket.use_type']= array('IN','1,3');
            $where_t['lyx_ticket_user.parent']= array('IN',$t_val);
            $usable_list = $ticket_user
                ->join('lyx_ticket ON lyx_ticket_user.parent = lyx_ticket.id')
                ->where($where_t)
                ->field('lyx_ticket_user.id as have_id,
                lyx_ticket.id as ticket_id,
                lyx_ticket.title,lyx_ticket.info,
                lyx_ticket_user.discount,lyx_ticket.type,
                lyx_ticket.dis_title,lyx_ticket.sales,lyx_ticket.use_type')
                ->select();

            foreach ($usable_list as $key=>$item){
                if($item['use_type']==1){
                    $usable_list[$key]['discount'] = (String)($item['discount']/10);
                    $js_dis = $item['discount']/100;

                    $jian = $order_info['total_money']*$js_dis;
                    $jian = sprintf("%.2f",substr(sprintf("%.3f", $jian), 0, -2));
                    $usable_list[$key]['ticket_money'] = $jian;
                }else{
                    $usable_list[$key]['ticket_money'] = $order_info['total_money']- $item['discount'];
                }

                if ($usable_list[$key]['ticket_money']<=0){
                    if($from==3){
                        $usable_list[$key]['ticket_money'] =0;
                    }else{
                        $usable_list[$key]['ticket_money'] = 0.01;
                    }
                }
            }

        }

        foreach ($t_list as $key=>$item){
            if($item['use_type']==1){
                $t_list[$key]['discount'] = (String)($item['discount']/10);
            }

        }


        $usable_list = array_merge($usable_list);

        return $usable_list;
    }





    /**
     * 搜索游戏
     */
    function SearchGame(){
        $user = M('user');

        $game = M('game');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$search = '明';
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if (!$search){
            $arr = array('code'=> 0, 'res'=>'请输入要搜索关键字');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        $where['name|info|classify'] = array("like","%".$search."%");
        $where['is_show'] = 1;

        $game_list = $game->where($where)->order('create_time desc')
            ->field('id,name,logo,info,android_url,ios_url,android_bao,android_versions')
            ->limit($start,$num)->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $game_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 人气游戏风向标
     */
    function MoreGameList(){
        $user = M('user');

        $game = M('game');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$search = '明';
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $where['is_show'] = 1;

        $game_list = $game->where($where)->order('create_time desc')
            ->field('id,name,logo,info,android_url,ios_url,android_bao,android_versions')
            ->limit($start,$num)->select();


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $game_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 猜你喜欢
     */
    function GameLikeList(){
        $user = M('user');

        $game = M('game');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$search = '明';
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $where['is_show'] = 1;

        $game_list = $game->where($where)->order('rand()')
            ->field('id,name,logo,info,android_url,ios_url,android_bao,android_versions')
            ->limit(5)->select();


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $game_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 游戏更新（已下载的游戏）
     */
    function UploadGameList(){
        $user = M('user');

        $game = M('game');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $app_str = decrypt1(trim(I('post.app_str')));



        $app_arr = explode(',',$app_str);


        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$search = '明';
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $list = array();

        foreach ($app_arr as $item){
           $is_my_app =  $game->where(array('android_bao'=>$item))->field('id,name,logo,info,android_url,ios_url,android_bao,android_versions')->find();
           if ($is_my_app){
               $list[]=  $is_my_app;
           }
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 搜索店铺
     */
    function SearchShopList(){
        $user = M('user');

        $shop = M('shop');
        $shop_goods = M('shop_goods');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;



        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$search = '明';
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }
        if (!$search){
            $arr = array('code'=> 0, 'res'=>'请输入要搜索关键字');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        $where['shop_name'] = array("like","%".$search."%");
        $where['is_freeze'] = 1;
        $shop_list = $shop
            ->order('star desc')
            ->limit($start,$num)
            ->where($where)->field('id as shop_id,shop_name,logo,classify,introduce,sales,lng,lat')->select();
        foreach ($shop_list as $key=>$item){
            if($lat&&$lng&&$item['lat']&&$item['lng']){
                $shop_list[$key]['dis'] = getDistance($item['lat'],$item['lng'],$lat,$lng);
            }else{
                $shop_list[$key]['dis'] ='';
            }
            $shop[$key]['classify'] = getShopClassify($item['classify']);

            $goods_info = $shop_goods->where(array('shop_id'=>$item['shop_id']))->order('price')->field('price')->find();
            if ($goods_info){
                $shop_list[$key]['min_price'] = $goods_info['price'];
            }else{
                $shop_list[$key]['min_price'] = '0';
            }


        }
        die;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $shop_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 添加我的方式信息
     */
    function AddingMode(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list['phone_add'] = $user_info['phone_add'];
        $list['im_add'] = $user_info['im_add'];
        $list['group_add'] = $user_info['group_add'];
        $list['qr_add'] = $user_info['qr_add'];
        $list['card_add'] = $user_info['card_add'];
        $list['friend_add'] = $user_info['friend_add'];



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 修改添加我的方式
     */
    function EditAddingMode(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$value = decrypt1(trim(I('post.value')));
        $option = decrypt1(trim(I('post.option')));

        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $option_arr = json_decode($option,true);
        foreach ($option_arr as $key=>$item){
            $save[$key] = $item;

        }


        $save['update_time'] = time();


        $query = $user->where(array('id'=>$user_info['id']))->save($save);

        if ($query){

            $arr = array(
                'code'=> 1,
                'res'=>'修改成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'修改失败',
            );
        }



        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 个人中心-邀请码
     */
    function CheckMyCodeData(){
        $user = M('user');
        $set = M('set');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $set_info = $set->where(array('set_type'=>'month_code_num'))->find();
        //$have_num = $user_info['send_code_num'] + $user_info['code_num'];
        $list['send_code_num'] = $user_info['send_code_num'];
        $list['code_num'] = $user_info['code_num'];
        $list['month_code_num'] = $set_info['set_value'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 邀请码使用记录
     */
    function CodeUseList(){
        $user = M('user');
        $code = M('code');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;
        //$token = "9862453289c545c03bfb077dd6b98264";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $code->where(array('user_id'=>$user_info['id']))
            ->field('id,name,imid,number,have_num,is_open,create_time')
            ->limit($start,$num)->select();
        foreach ($list as $key=>$item){
            $list[$key]['create_time'] = date('Y-m-d H:i:s',$item['create_time']);
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 购买邀请码套餐列表
     */
    function BuyCodeList(){
        $user = M('user');
        $code_buy = M('code_buy');


        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "9862453289c545c03bfb077dd6b98264";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $list = $code_buy->order('sort,create_time')->field('id,num,price')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 邀请码使用记录-详细
     */
    function MyCodeDetail(){
        $user = M('user');
        $code = M('code');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));
        //$token = "9862453289c545c03bfb077dd6b98264";
        //$id = '1';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $list = $code->where(array('id'=>$id))
            ->field('id,name,imid,number,have_num,is_open,is_friend,is_group,is_gzh,num,create_time')->find();

        $list['create_time'] = date('Y-m-d H:i:s',$list['create_time']);
        $list['use_num'] = $list['num'] - $list['have_num'];
        $list['group_name'] = '';
        $list['gzh_name'] = '';
        if ($list['is_group']){
            $list['group_name'] = '';
        }
        if ($list['is_gzh']){
            $list['gzh_name'] = '';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 撤销邀请码
     */
    function CancelCode(){
        $user = M('user');

        $set = M('set');
        $code_db = M('code');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));

        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $code_info = $code_db->where(array('id'=>$id))->find();
        if (!$code_info){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            if($user_info['id']!=$code_info['user_id']){
                $arr = array(
                    'code'=> 0,
                    'res'=>'没有操作权限'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            if ($code_info['is_open']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'邀请码已撤销'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }



        }

        $save['is_open'] = 0;
        $save['update_time'] = time();

        $query = $code_db->where(array('id'=>$id))->save($save);

        if ($query){

            if ($code_info['have_num']>0){
                if($code_info['per_num']>0){
                    if ($code_info['per_num']>$code_info['have_num']){
                        $code_num = $code_info['have_num'];
                        $send_num = 0;
                    }else{
                        $code_num = $code_info['per_num'];
                        $send_num = $code_info['have_num']- $code_info['per_num'];
                    }

                }else{
                    $code_num = 0;
                    $send_num = $code_info['have_num'];
                }

                $user_send_num = $user_info['send_code_num'] + $send_num;
                $user_code_num = $user_info['code_num'] + $code_num;
                $set_info = $set->where(array('set_type'=>'month_code_num'))->find();
                if ($user_send_num>$set_info['set_value']){
                    $user_send_num = $set_info['set_value'];
                }

                $save_user['send_code_num'] = $user_send_num;
                $save_user['code_num'] = $user_code_num;

                $user->where(array('id'=>$user_info['id']))->save($save_user);
            }

            $arr = array(
                'code'=> 1,
                'res'=>'撤销成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'撤销失败',
            );
        }



        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 生成邀请码-查询群与公众号数据
     */
    function CheckAddCodeData(){
        $user = M('user');
        $group_user = M('group_user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $group_arr = array();
        $where_group['lyx_group_user.user_id'] = $user_info['id'];
        $where_group['lyx_group_user.type'] = array('IN','1,2');
        $group_arr = $group_user
            ->where($where_group)
            ->join('lyx_group ON lyx_group_user.group_id = lyx_group.id')
            ->field('lyx_group_user.group_id as id,lyx_group.group_name as name')->select();



        $gzh_arr = array(
            /*array('id'=>'1','name'=>'测试数据公众号1'),
            array('id'=>'2','name'=>'测试数据公众号2'),*/
        );

        $have_num = $user_info['send_code_num'] + $user_info['code_num'];

        $list['group_list'] = $group_arr;
        $list['gzh_list'] = $gzh_arr;
        $list['have_num'] = $have_num;

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 生成邀请码
     */
    function AddCode(){
        $user = M('user');

        $code_db = M('code');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $num = decrypt1(trim(I('post.num')));
        $is_friend = decrypt1(trim(I('post.is_friend')));
        $is_group = decrypt1(trim(I('post.is_group')));
        $is_gzh = decrypt1(trim(I('post.is_gzh')));
        //$token = "66dc8eb82532bfe292dc66ad1e8dae0f";
        //$search = '明';
        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $have_num = $user_info['send_code_num'] + $user_info['code_num'];

        if($num>$have_num){
            $arr = array(
                'code'=> 0,
                'res'=>'当前邀请码剩余数量不足：'.$num
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $number = GetAddCode($user_info['id']);

        $add['user_id'] = $user_info['id'];
        $add['name'] = $user_info['name'];
        $add['imid'] = $user_info['imid']!= 0 ?$user_info['imid']:$user_info['id'];
        $add['number'] = $number;
        $add['is_friend'] = $is_friend;
        $add['is_group'] = $is_group;
        $add['is_gzh'] = $is_gzh;
        $add['is_open'] = 1;
        $add['num'] = $num;
        $add['have_num'] = $num;

        if($user_info['send_code_num']<$num){
            $save_user['send_code_num']  = 0;
            $jian = $num - $user_info['send_code_num'];
            $per_num = $user_info['code_num'] - $jian;

            $save_user['code_num'] = $per_num;

            $add['send_num'] = $user_info['send_code_num'];
            $add['per_num'] = $jian;
        }else{
            $send_num = $user_info['send_code_num'] - $num;
            $save_user['send_code_num'] = $send_num;

            $add['send_num'] = $num;
            $add['per_num'] = 0;
        }


        $add['create_time'] = time();

        $query = $code_db->add($add);



        if ($query){
            $user->where(array('id'=>$user_info['id']))->save($save_user);

            $list['number'] = $number;
            $code_url = $set->where(array('set_type'=>'code_url'))->find();
            $list['qr_url'] = $code_url['set_value'];
            $arr = array(
                'code'=> 1,
                'res'=>'生成成功',
                'list'=>$list
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'生成失败',
                'list'=>array()
            );
        }



        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 更新用户最后登陆时间
     */
    function UpdateUserLoginTime(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $query = $user->where(array('id'=>$user_info['id']))->save(array('login_time'=>time()));
        $arr = array(
            'code'=> 1,
            'res'=>'更新成功',
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 附近的人
     */
    function NearbyUser(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $sex = decrypt1(trim(I('post.sex')));//性别，1男，2女，无则不传
        $age_start = decrypt1(trim(I('post.age_start')));
        $age_end = decrypt1(trim(I('post.age_end')));
        $page = decrypt1(trim(I('post.page')));


        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        if(!$scope){$scope = 2500;}

        //$sex = 1;
        //$age_start = 20;
        //$age_end = 26;
        $user = M('user');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x

        if($token){
            $where = "WHERE `is_freeze` = 1 AND  `is_service` = 0 AND `is_robot` = 0 AND  `id` != ".$user_info['id'];
        }else{
            $where = "WHERE `is_freeze` = 1 AND `is_service` = 0 AND `is_robot` = 0";
        }

        if($sex){
            $where .= ' AND `sex` = '.$sex;
        }
        if($age_start){
            $where .= ' AND ( `age` >= '.$age_start.' AND `age` <= '.$age_end.'  )';
        }

        $Dao = M();

        // 加入排序，从最近到最近排序。
        $sql = "select id,lat,lng,vip,head,name,sex,age,level,signature,login_time, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_user ".$where."  having dis <".$scope." ORDER BY dis asc limit ".$start.",".$num;

        $list = $Dao->query($sql);
        foreach($list as $key=>$item){
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);
            $list[$key]['login_time'] = '一天前';
            if($item['login_time']){
                if(time()-$item['login_time']<86400){
                    $list[$key]['login_time'] = mdate($item['login_time']);
                }
            }
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'user_list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }


    /**
     * 附近动态
     */
    function NearbyBlogs(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $page = decrypt1(trim(I('post.page')));



        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        if(!$scope){$scope = 300;}


        // $sex = 1;
        //$age_start = 20;
        //$age_end = 26;
        $user = M('user');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x

       /* if($token){
            $where = "WHERE `is_show` = 1 AND `is_ad` = 0 AND `is_nearby` = 1 AND  `user_id` != ".$user_info['id'];
        }else{
            $where = "WHERE `is_show` = 1 AND `is_ad` = 0 AND `is_nearby` = 1";
        }*/

        $where = "WHERE `is_show` = 1 AND `is_ad` = 0";

        $Dao = M();
        // 加入排序，从最近到最近排序。
        $sql = "select id,user_id,lng,lat,content,zan,browse,comment_count,classify,
        is_ad,ad_url,create_time,video_url,video_thumb,video_icon,video_width,video_height,type,
        sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_user_blogs ".$where."  having dis <".$scope." ORDER BY create_time desc,dis asc limit ".$start.",".$num;

        $list = $Dao->query($sql);

        if($list){
            $is_sui = rand(1,2);

            if ($is_sui==1){
                $where_ad['is_ad'] = 1;
                $time_now = time();
                $where_ad['end_time'] = array('EGT',$time_now);
                $where_ad['start_time'] = array('ELT',$time_now);
                $ad_list = $user_blogs->where($where_ad)->field('id,user_id,lng,lat,content,zan,browse,comment_count,
                is_ad,ad_url,create_time,video_url,video_thumb,video_icon,video_width,video_height,type,classify')->select();
                $a = $user_blogs->getLastSql();

                if($ad_list){
                    $ad_count = count($ad_list);

                    if ($ad_count==1){
                        $list[] = $ad_list[0];
                    }else{
                        $ad_key = array_rand($ad_list,1);
                        $list_key = array_rand($list,1);
                        $list = addvtorandp($list,$list_key,$ad_list[$ad_key]);

                    }

                }
            }

        }



        foreach($list as $key=>$item){
            if(!$item['video_url']){
                $list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $list[$key]['video_thumb'] = "";
            }
            if(!$item['ad_url']){
                $list[$key]['ad_url'] = "";
            }
            if(!$item['lng']){
                $list[$key]['lng'] = "";
            }
            if(!$item['lat']){
                $list[$key]['lat'] = "";
            }
            if(!$item['classify']){
                $list[$key]['classify'] = "";
            }


            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level,vip')->find();
            $list[$key]['name'] = $user_info2['name'];
            $list[$key]['head'] = $user_info2['head'];
            $list[$key]['sex'] = $user_info2['sex'];
            $list[$key]['age'] = $user_info2['age'];
            $list[$key]['level'] = $user_info2['level'];
            $list[$key]['vip'] = $user_info2['vip'];

            $list[$key]['create_time'] = mdate($item['create_time']);
            //点赞数
            $list[$key]['zan'] = WanChu($item['zan']);
            //评论数
            $list[$key]['comment_count'] = WanChu($item['comment_count']);
            //浏览人数
            $list[$key]['browse'] = WanChu($item['browse']). '阅读';;
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);

            $new_img_list = array();
            $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $list[$key]['img_list'] = $new_img_list;



            $list[$key]['share_url'] = XUANIP.'/Home/share/index/aid/'.$item['id'];
            if($item['type']=='1'){
                $list[$key]['share_icon'] = $img_list[0]['thumb'];
            }else if($item['type']=='2'){
                $list[$key]['share_icon'] = $item['video_icon'];
            }else{
                $list[$key]['share_icon'] = XUANIP.'/logo.jpg';
            }

            $list[$key]['share_info'] = '伊美小天鹅分享';

            //自己是否有点赞
            $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
            if ($is_zan) {
                $list[$key]['is_zan'] = '1';
            } else {
                $list[$key]['is_zan'] = '0';
            }

            unset($list[$key]['video_icon']);

        }




        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }


    /**
     * 附近的群
     */
    function NearbyGroup(){
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $scope = decrypt1(trim(I('post.scope')));//范围，1为1公里
        $page = decrypt1(trim(I('post.page')));



        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        if(!$scope){$scope = 2500;}


        // $sex = 1;
        //$age_start = 20;
        //$age_end = 26;
        $user = M('user');
        $group_user = M('group_user');

        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($lng && $lat){
                $save['lng'] = $lng;
                $save['lat'] = $lat;
                $save['update_time'] = time();
                $user->where(array('id'=>$user_info['id']))->save($save);
            }
        }


        $latitude = $lat; //当前坐标y
        $longitude = $lng; //当前坐标x

        /* if($token){
             $where = "WHERE `is_show` = 1 AND `is_ad` = 0 AND `is_nearby` = 1 AND  `user_id` != ".$user_info['id'];
         }else{
             $where = "WHERE `is_show` = 1 AND `is_ad` = 0 AND `is_nearby` = 1";
         }*/


        $Dao = M();
        $where2 = "WHERE `is_freeze` = 1";

        // 加入排序，从最近到最近排序。
        $sql2 = "select id,lat,lng,introduce,logo,group_name, sqrt( ( ((".$longitude."-lng)*PI()*12656*cos(((".$latitude."+lat)/2)*PI()/180)/180) *
        ((".$longitude."-lng)*PI()*12656*cos (((".$latitude."+lat)/2)*PI()/180)/180) ) + ( ((".$latitude."-lat)*PI()*12656/180) *
        ((".$latitude."-lat)*PI()*12656/180) ) )/2 as dis
            from lyx_group ".$where2." having dis <".$scope." ORDER BY dis asc limit ".$start.",".$num;

        $group_list = $Dao->query($sql2);
        foreach($group_list as $key=>$item){
            $group_list[$key]['dis'] = MiZhuanhuan($item['dis']);
            $group_num = 0;
            $group_num+=$group_user->where(array('group_id'=>$item['id']))->count();
            $group_list[$key]['group_num'] = (String)$group_num;
        }







        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$group_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }


   /**
     * 他人全部动态-附近动态
     */
    function NearbyBlogsUserID(){

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));
        $page = decrypt1(trim(I('post.page')));



        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;



        // $sex = 1;
        //$age_start = 20;
        //$age_end = 26;
        $user = M('user');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }



        $where_blogs['user_id'] = $user_id;
        $where_blogs['is_show'] = 1;
        $where_blogs['is_ad'] = 0;
        $list = $user_blogs->where($where_blogs)
            ->limit($start,$num)->order('create_time desc')
            ->field('id,user_id,lng,lat,content,zan,browse,comment_count,
        is_ad,ad_url,create_time,video_url,video_thumb,video_icon,video_width,video_height,type')->select();
   /*     if ($list){
            $ad_info = $user_blogs->where(array('is_ad'=>'1'))->field('id,user_id,lng,lat,content,zan,browse,comment_count,
        is_ad,ad_url,create_time,video_url,video_thumb,video_icon,video_width,video_height,type')->find();
            if($ad_info){
                $list[] = $ad_info;
            }
        }*/




        foreach($list as $key=>$item){
            if(!$item['video_url']){
                $list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $list[$key]['video_thumb'] = "";
            }
            if(!$item['ad_url']){
                $list[$key]['ad_url'] = "";
            }
            if(!$item['lng']){
                $list[$key]['lng'] = "";
            }
            if(!$item['lat']){
                $list[$key]['lat'] = "";
            }


            //用户信息
            $user_info2 =  $user->where(array('id'=>$item['user_id']))->field('name,head,sex,age,level,vip')->find();
            $list[$key]['name'] = $user_info2['name'];
            $list[$key]['head'] = $user_info2['head'];
            $list[$key]['sex'] = $user_info2['sex'];
            $list[$key]['age'] = $user_info2['age'];
            $list[$key]['level'] = $user_info2['level'];
            $list[$key]['vip'] = $user_info2['vip'];

            $list[$key]['create_time'] = mdate($item['create_time']);
            //点赞数
            $list[$key]['zan'] = WanChu($item['zan']);
            //评论数
            $list[$key]['comment_count'] = WanChu($item['comment_count']);
            //浏览人数
            $list[$key]['browse'] = WanChu($item['browse']). '阅读';;
            $list[$key]['dis'] =MiZhuanhuan($item['dis']);

            $new_img_list = array();
            $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $list[$key]['img_list'] = $new_img_list;



            $list[$key]['share_url'] = XUANIP.'/Home/share/index/aid/'.$item['id'];
            if($item['type']=='1'){
                $list[$key]['share_icon'] = $img_list[0]['thumb'];
            }else if($item['type']=='2'){
                $list[$key]['share_icon'] = $item['video_icon'];
            }else{
                $list[$key]['share_icon'] = XUANIP.'/logo.jpg';
            }

            $list[$key]['share_info'] = '伊美小天鹅分享';

            //自己是否有点赞
            $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
            if ($is_zan) {
                $list[$key]['is_zan'] = '1';
            } else {
                $list[$key]['is_zan'] = '0';
            }

            unset($list[$key]['video_icon']);

        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }



    /**
     * 举报
     */
    function SubmitReport(){
        $user = M('user');
        $report = M('report');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $report_id = decrypt1(trim(I('post.report_id')));
        $type = decrypt1(trim(I('post.type')));
        $report_type = decrypt1(trim(I('post.report_type')));


        //$token = "329d458ffd8b7bde2a13bd33a71d867a";
        //$place_id = 1;

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$type){
            $arr = array(
                'code'=> 0,
                'res'=>'请选择举报内容',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $is_cf = $report->where(array('user_id'=>$user_info['id'],'report_type'=>$report_type,'report_id'=>$report_id,'type'=>$type))->find();
        if($is_cf){
            $arr = array(
                'code'=> 0,
                'res'=>'重复举报',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $add['user_id'] = $user_info['id'];
        $add['report_id'] = $report_id;
        $add['report_type'] = $report_type;
        $add['type'] = $type;
        $add['create_time'] = time();
        $query = $report->add($add);

        $arr = array(
            'code'=> 1,
            'res'=>'举报成功',
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 美容日志-发布日志
     */
    function SubmitBlogs(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $content = decrypt1(trim(I('post.content')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $type = decrypt1(trim(I('post.type')));
        $video_url = decrypt1(trim(I('post.video_url')));
        $video_thumb = decrypt1(trim(I('post.video_thumb')));
        $video_width = decrypt1(trim(I('post.video_width')));
        $video_height = decrypt1(trim(I('post.video_height')));
        $class_type = decrypt1(trim(I('post.class_type')));
        $hospital_id = decrypt1(trim(I('post.hospital_id')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $doctor_id = decrypt1(trim(I('post.doctor_id')));
        $time = decrypt1(trim(I('post.time')));
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

    /*   $token ='59b8d705259608fe1d874077ff08617e';
        $content ='测试';
        $type ='3';
        $lng ='114.1107791662';
        $lat ='22.6136444273';*/


        //$token = "329d458ffd8b7bde2a13bd33a71d867a";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if(!$content){$arr = array('code'=> 0, 'res'=>'请输入朋友圈内容');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$hospital_id){$arr = array('code'=> 0, 'res'=>'请选择医院');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if(!$doctor_id){$arr = array('code'=> 0, 'res'=>'请选择医生');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$time){$arr = array('code'=> 0, 'res'=>'请选择手术时间');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(strlen($content)>420){
            $arr = array('code'=> 0, 'res'=>'发帖内容字符长度不能超过140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if($img_url){
            $img_list = explode(',',$img_url);
            if(count($img_list)>9){
                $arr = array('code'=> 0, 'res'=>'最多只能发布九张图片');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }
        }


        if(!$type){
            $type =3;
        }

        $add['lng'] = $lng;
        $add['lat'] = $lat;
        $add['content'] = $content;
        $add['is_show'] = 0;
        $add['shop_id'] = $shop_id;
        $add['hospital_id'] = $hospital_id;
        $add['doctor_id'] = $doctor_id;
        $add['time'] = strtotime($time);
        $add['class_type'] = $class_type;


        if($type=='2'){
            $cache_info = M('cache')->where(array('url'=>$video_url,'type'=>'2'))->field('thumb')->find();

            $add['video_icon'] = $cache_info['thumb'];
            $add['video_thumb'] = $video_thumb;
            $add['video_width'] = $video_width;
            $add['video_height'] = $video_height;
            $add['type'] = $type;
            $j_img = str_replace(XUANIMG,'',$video_url);
            $a = VideoAddLogo($j_img,$video_width);
            if($a['code']==0){
                $add['video_url'] = XUANIMG.$a['url'];
            }else{
                $add['video_url'] = $video_url;
            }

        }else{
            if(count($img_list)>0){
                $add['type'] = 1;
            }else{
                $add['type'] = 3;
            }
        }


        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();
        $add['update_time'] = time();
        $query = $user_blogs->add($add);



        if($img_url){

            foreach($img_list as $item){
                $cache_info_img = M('cache')->where(array('url'=>$item))->field('thumb')->find();
                    $size_info = getimagesize($item);
                    $add_phone2['width'] = $size_info[0];
                    $add_phone2['height'] = $size_info[1];
                    $add_phone2['thumb'] = $cache_info_img['thumb'];
                    $add_phone2['blogs_id'] = $query;
                    $add_phone2['img_url'] = $item;
                    $add_phone2['create_time'] = time();
                    $user_blogs_photo->add($add_phone2);
            }
        }

        if($query){
            //发帖增加积分
            //$add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'1',$query);

            $arr = array(
                'code'=> 1,
                'res'=>'发布成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'发布失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
 * 美容日志-日志分类
 */
    function DiaryClassifyList(){
        $user = M('user');
        $diary_classify = M('diary_classify');


        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$article_id = "1";
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $diary_classify->where(array('is_show'=>'1'))->order('sort')->field('id,name')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    function sendio(){
        $status = SendSocket('123123','111222');
        dump($status);
    }


    /**
     * 活动分享图标与文字
     */
    function ActivityShareInfo(){
        $type = decrypt1(trim(I('post.type')));//1橙子模板，2鲜花模板
        if(!$type){$type=1;}
        $activity = M('activity');
        $list = $activity->where(array('id'=>$type))->field('title,share_info,share_icon')->find();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的店铺-店铺分类
     */
    function StoreClassifyList(){
        $user = M('user');
        $diary_classify = M('store_classify');


        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$article_id = "1";
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $diary_classify->where(array('is_show'=>'1'))->order('sort')->field('id,name')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 积分商城
     */
    function PrizeList(){
        $shop_prize = M('shop_prize');
        $user = M('user');

        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$search = '拉杆箱';

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $where['is_show'] =   1;
        //商品信息
        $prize_list = $shop_prize->where($where)->limit($start,$num)->order('sort desc')->field('id as prize_id,name,cover,price,score,sales')->select();

        if($prize_list){
            //
        }else{
            $prize_list = array();
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'my_score'=>$user_info['score'],
            'prize_list' =>$prize_list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 积分商城-商品详情
     */
    function PrizeGoodsDetail(){
        $shop_prize = M('shop_prize');
        $shop_prize_select = M('shop_prize_select');
        $shop_prize_banner = M('shop_prize_banner');
        $shop_prize_photo = M('shop_prize_photo');
        $user = M('user');
        $set = M('set');
        $game = M('game');

        $token = decrypt1(trim(I('post.token')));
        $prize_id =  decrypt1(trim(I('post.prize_id')));
        $share_user_id =  decrypt1(trim(I('post.share_user_id')));


        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        //$prize_id = 1;

        if($token){
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

            if(!$user_info['code_user']){
                if($share_user_id){
                    //绑定邀请人
                    $bind_status = BindCodeUser($share_user_id,$user_info['id']);
                }
            }


        }


        $set_info = $set->where(array('set_type'=>'game_info'))->find();
        $game_info = json_decode($set_info['remark'],true);
        $game_prize_id =  $game_info['prize_id'];



        $where['id'] = $prize_id;
        $where['is_show'] = 1;
        $prize_info = $shop_prize->where($where)->field('id as prize_id,name,cover,price,score,sales')->find();

        $content = $shop_prize_photo->where(array('prize_id'=>$prize_info['prize_id']))->find();
        $prize_info['content'] = $content['content'];
        if($prize_info){
            if($game_prize_id==$prize_id){
                $prize_info['is_game'] = '1';
                $where_game['user_id'] = $user_info['id'];
                $where_game['is_get'] = 0;
                $where_game['prize_type'] = 2;
                $where_game['status'] = 1;
                $where_game['type'] = 1;
                $where_game['is_win'] = 1;
                $exchange_num = $game->where($where_game)->count();
            }else{
                $prize_info['is_game'] = '0';
                $exchange_num = '0';
            }
            $prize_info['exchange_num'] = $exchange_num;
            $prize_info['description'] = XUANIP.'/home/shopshow/index/shop_id/'.$prize_id.'/type/2';

            $select_list = $shop_prize_select->where(array('prize_id'=>$prize_id))->field('id as select_id,select_name,value,add_price')->select();
            $prize_info['select_list'] = $select_list;

            $banner_list = array();
            $banner_list[] = $prize_info['cover'];
            $banner_val = $shop_prize_banner->where(array('prize_id'=>$prize_id))->field('img_url')->select();
            foreach($banner_val as $item){
                $banner_list[]  = $item['img_url'];
            }

            $prize_info['banner_list'] = $banner_list;
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'商品已下架',
            );

            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if($user_info['score']<$prize_info['score']  && $user_info){
            $prize_info['is_buy'] = '0';
        }else{
            $prize_info['is_buy'] = '1';
        }


        $service_info  = $user->where(array('is_service'=>'1'))->order('rand()')->field('id,rong_token')->find();
        $service_info['rong_token'] = $service_info['rong_token']?$service_info['rong_token']:"";

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'service_info'=>$service_info,
            'my_score'=>$user_info['score'],
            'prize_info' =>$prize_info,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }


    /**
     * 积分商品-生成缓存订单
     */
    function CreatePrizeOrder(){
        $shop_prize_select = M('shop_prize_select');
        $shop_prize = M('shop_prize');
        $shop_prize_order = M('shop_prize_order');
        $game = M('game');
        $user = M('user');
        $set = M('set');
        $token = decrypt1(trim(I('post.token')));

        $prize_id = decrypt1(trim(I('post.prize_id')));
        $select_id = decrypt1(trim(I('post.select_id')));
        $num = decrypt1(trim(I('post.num')));

        $set_info = $set->where(array('set_type'=>'game_info'))->find();
        $game_info = json_decode($set_info['remark'],true);
        $game_prize_id =  $game_info['prize_id'];


        //$select_id = '1';
        //$prize_id = '1';
        //$num = '1';
        //$type = '2';
        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_number = time().$user_info['id'].rand(1000,9999).$prize_id;
        $add['order_number'] = $order_number;
        $add['create_time'] = time();
        $add['status'] = 0;
        $add['user_id'] = $user_info['id'];
        //立即购买

        if(!$prize_id){$arr = array('code'=> 0, 'res'=>'请选择商品',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!is_numeric($num)){$arr = array('code'=> 0, 'res'=>'商品数量只能为整数',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($num<1){$arr = array('code'=> 0, 'res'=>'商品数量不能小于1',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $goods_info = $shop_prize->where(array('id'=>$prize_id))->field('score')->find();

        $add_price = 0;

        if($select_id){
            $arr_select = explode('.',$select_id);
            foreach($arr_select as $val){
                $select_info = $shop_prize_select->where(array('id'=>$val))->field('add_price')->find();
                $add_price += $select_info['add_price'];
            }
        }

        $price = $add_price;
        $total_money = $price*$num;

        $is_game = false;
        if($game_prize_id == $prize_id){
            $where_game['user_id'] = $user_info['id'];
            $where_game['is_get'] = 0;
            $where_game['prize_type'] = 2;
            $where_game['status'] = 1;
            $where_game['type'] = 1;
            $where_game['is_win'] = 1;
            $exchange_num = $game->where($where_game)->count();
            if($exchange_num){
                $is_game = true;
            }
        }

        if($is_game){
            if($exchange_num<$num){
                $arr = array(
                    'code'=> 0,
                    'res'=>'可兑换次数不足'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $add['type'] = 2;
        }else{
            if($user_info['score']<$total_money){
                $arr = array(
                    'code'=> 0,
                    'res'=>'您的积分不足'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }

            $add['type'] = 1;
        }


        $arr_select = explode('.',$select_id);
        $select_arr = array();
        $select_price = array();
        foreach($arr_select as $val){
            $select_info = $shop_prize_select->where(array('id'=>$val))->field('select_name,value,add_price')->find();
            $select_arr[] = $select_info['select_name'].':'.$select_info['value'];
            $select_price[] = $select_info['select_name'].':'.$select_info['value'].':'.$select_info['add_price'];
        }
        $select_val = implode(',',$select_arr);
        $select_price_val = implode(',',$select_price);


        $add['total_score'] = $total_money;
        $add['select_val'] = $select_val;
        $add['select_price'] = $select_price_val;
        $add['prize_id'] = $prize_id;
        $add['select_id'] = $select_id;
        $add['num'] = $num;
        $order_id = $shop_prize_order->add($add);

        if($order_id){
            $arr = array(
                'code'=> 1,
                'res'=>'订单生成成功',
                'prize_order_id'=>$order_id,
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'订单生成错误'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
    }


    /**
     * 积分商品-确认订单基础信息
     */
    function SuccessPrizeOrderCheck(){
        $shop_location = M('shop_location');
        $shop_prize_order = M('shop_prize_order');
        $shop_prize = M('shop_prize');
        $shop_prize_select = M('shop_prize_select');
        $user = M('user');
        $token = decrypt1(trim(I('post.token')));
        $prize_order_id = decrypt1(trim(I('post.prize_order_id')));

        //$prize_order_id = 1;
        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->field('id as location_id,addressee,mobile,province,city,district,particular')->find();
        if($location_info){
            $is_location = '0';
            $location_info['location'] = $location_info['province'].$location_info['city'].$location_info['district'].$location_info['particular'];
            unset($location_info['province']);
            unset($location_info['city']);
            unset($location_info['district']);
            unset($location_info['particular']);
        }else{
            $is_location = '1';
            $location_info['location_id'] = '0';
            $location_info['addressee'] = '';
            $location_info['mobile'] = '';
            $location_info['location'] = '';
        }


        $order_info = $shop_prize_order->where(array('id'=>$prize_order_id))->field('id as prize_order_id,total_score,prize_id,select_id,num,select_val,type')->find();

        if($order_info['type']=='2'){
            $order_info['total_score'] = '0';
        }
        $prize_info = $shop_prize->where(array('id'=>$order_info['prize_id']))->field('name,cover')->find();


        $prize_info['select_val'] = $order_info['select_val'].",数量:".$order_info['num'];

        $order_info['is_location'] = $is_location;
        $order_info['location_info'] = $location_info;
        $order_info['prize_info'] = $prize_info;
        unset($order_info['select_val']);

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'order_info'=>$order_info,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     * 积分商城-支付积分商品订单
     */
    function PayPrizeOrder(){
        $user = M('user');
        $shop_prize_order = M('shop_prize_order');
        $shop_location = M('shop_location');
        $game = M('game');
        $token = decrypt1(trim(I('post.token')));
        $prize_order_id = decrypt1(trim(I('post.prize_order_id')));
        $location_id = decrypt1(trim(I('post.location_id')));

        //$city = decrypt1(trim(I('post.city')));
        //$district = decrypt1(trim(I('post.district')));
        //$street = decrypt1(trim(I('post.street')));
        $remark = decrypt1(trim(I('post.remark')));

        //$prize_order_id = 1;
        //$token = 'edee9b9b0373a97d06a4376113a90fb2';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //if(!$addressee){$arr = array('code' => 0, 'res' => '请传入收件人信息');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if(!$mobile){$arr = array('code' => 0, 'res' => '请传入手机号');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if(!$location){$arr = array('code' => 0, 'res' => '请选择收货地址');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_info = $shop_prize_order->where(array('id'=>$prize_order_id))->field('id,total_score,status,type,num,prize_id')->find();

        if($order_info['type']=='2'){
            $where_game['user_id'] = $user_info['id'];
            $where_game['is_get'] = 0;
            $where_game['prize_type'] = 2;
            $where_game['status'] = 1;
            $where_game['type'] = 1;
            $where_game['is_win'] = 1;
            $exchange_num = $game->where($where_game)->count();
            if($exchange_num<$order_info['num']){
                $arr = array(
                    'code'=> 0,
                    'res'=>'可兑换次数不足'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }else{
            if($user_info['score']<$order_info['total_score']){
                $arr = array(
                    'code'=> 0,
                    'res'=>'您的积分不足'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $prize_buy_num = M('set')->where(array('set_type'=>'prize_buy_num'))->find();
            if($prize_buy_num['set_value']>0){
                $where_1['user_id'] = $user_info['id'];
                $where_1['prize_id'] = $order_info['prize_id'];
                $where_1['status'] = array('IN','1,2,3');
                $buy_num = 0;
                $buy_num += $shop_prize_order->where($where_1)->sum('num');
                if($buy_num>=$prize_buy_num['set_value']){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'此积分商品限购'.$prize_buy_num['set_value'].'个 , 您已购买'.$buy_num.'个'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }





        if($order_info['status']!='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'订单已支付'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($order_info){
            $location_info = $shop_location->where(array('user_id'=>$user_info['id']))->find();
            if(!$location_info){
                $arr = array(
                    'code' => 0,
                    'res' => '请先完善收货地址'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save_order['location_id'] = $location_info['id'];
            $save_order['location'] = $location_info['province'].$location_info['city'].$location_info['district'];
            $save_order['mobile'] = $location_info['mobile'];
            $save_order['addressee'] = $location_info['addressee'];
            $save_order['particular'] = $location_info['particular'];

            $save_order['remark'] = $remark;
            $save_order['status'] = 1;
            $save_order['pay_time'] = time();
            $is_pay = $shop_prize_order->where(array('id'=>$prize_order_id))->save($save_order);

            if($is_pay){
                if($order_info['type']=='2'){
                    $where_game['user_id'] = $user_info['id'];
                    $where_game['is_get'] = 0;
                    $where_game['prize_type'] = 2;
                    $where_game['status'] = 1;
                    $where_game['type'] = 1;
                    $where_game['is_win'] = 1;

                    $save_game['is_get'] = 1;
                    $save_game['get_time'] = time();
                    $save_game['order_id'] = $order_info['id'];
                    $save_game['prize_id'] = $order_info['prize_id'];
                    $query  = $game->where($where_game)->limit($order_info['num'])->save($save_game);
                    if($query){
                        $arr = array(
                            'code' => 1,
                            'res' => '购买成功'
                        );
                        $data = json_encode($arr);
                        $return['encryption'] =  encrypt1($data);
                        $this->ajaxReturn($return,"JSON");
                    }else{
                        $shop_prize_order->where(array('id'=>$prize_order_id))->save(array('status'=>'0','pay_time'=>'0'));
                        $arr = array(
                            'code' => 0,
                            'res' => '支付失败'
                        );
                        $data = json_encode($arr);
                        $return['encryption'] =  encrypt1($data);
                        $this->ajaxReturn($return,"JSON");
                    }
                }else{
                    $new_score = $user_info['score'] - $order_info['total_score'];
                    $is_save = $user->where(array('token'=>$token))->save(array('score'=>$new_score,'update_time'=>time()));
                    if($is_save){
                        //减去积分
                        $add_log['user_id'] = $user_info['id'];
                        $add_log['add_or_del'] = 2;
                        $add_log['type'] = 1;
                        $add_log['num'] = $order_info['total_score'];
                        $add_log['order_id'] = $prize_order_id;
                        $add_log['create_time'] = time();
                        M('shop_score_log')->add($add_log);

                        $arr = array(
                            'code' => 1,
                            'res' => '购买成功'
                        );
                        $data = json_encode($arr);
                        $return['encryption'] =  encrypt1($data);
                        $this->ajaxReturn($return,"JSON");
                    }else{
                        $shop_prize_order->where(array('id'=>$prize_order_id))->save(array('status'=>'0','pay_time'=>'0'));
                        $arr = array(
                            'code' => 0,
                            'res' => '支付失败'
                        );
                        $data = json_encode($arr);
                        $return['encryption'] =  encrypt1($data);
                        $this->ajaxReturn($return,"JSON");
                    }
                }

            }else{
                $arr = array(
                    'code' => 0,
                    'res' => '支付失败'
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }else{
            $arr = array(
                'code' => 0,
                'res' => '订单不存在'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

    }







    /**
     * 根据Key查询需要授权APP信息
     */
    function CheckAppInfo(){
        $app = M('app');

        //接收数据
        $key = decrypt1(trim(I('post.key')));

        $list = $app->where(array('key'=>$key))->field('name,logo')->find();
        if($list){
            $arr = array(
                'code'=> 1,
                'res'=>'查询成功 ',
                'list'=>$list
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'Key不存在',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 朋友圈-点赞
     */
    function ArticleZan(){
        $user = M('user');
        $article = M('article');
        $article_zan = M('article_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $article_id = decrypt1(trim(I('post.article_id')));

        //$article_id = "1";
        //$token = "59b8d705259608fe1d874077ff08617e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $add['user_id'] = $user_info['id'];
        $add['article_id'] = $article_id;
        $is_zan = $article_zan->where($add)->find();
        if($is_zan){
            $arr = array(
                'code'=> 0,
                'res'=>'您已赞过',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $add['create_time'] = time();
        $query = $article_zan->add($add);

        if($query){
            $article_info = $article->where(array('id'=>$article_id))->field('user_id,zan')->find();
            $new_zan = $article_info['zan']+1;
            $article->where(array('id'=>$article_id))->save(array('zan'=>$new_zan));
            $user_other = $user->where(array('id'=>$article_info['user_id']))->find();
            //点赞增加积分
           // $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'2',$article_id);

            //点赞增加积分
            //$add_status = AddScore($user_other['id'],$user_other['score'],$user_other['level'],'6',$article_id,$user_info['id']);




            //添加消息通知
            if($article_info['user_id']!=$user_info['id']){

                //新增消息
                $add_message['article_id'] = $article_id;
                $add_message['user_id'] = $article_info['user_id'];
                $add_message['type'] = 2;
                $add_message['zx_user_id'] = $user_info['id'];
                $add_message['create_time'] = time();
                M('message')->add($add_message);
                //新增消息
                $tz_con['type'] = 'new_message';
                SendSocket($article_info['user_id'],json_encode($tz_con));
            }


            $arr = array(
                'code'=> 1,
                'res'=>'点赞成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'点赞失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 朋友圈-取消点赞
     */
    function ArticleZanCancel(){
        $user = M('user');
        $article = M('article');
        $article_zan = M('article_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $article_id = decrypt1(trim(I('post.article_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $where['user_id'] = $user_info['id'];
        $where['article_id'] = $article_id;
        $query = $article_zan->where($where)->delete();
        if($query){
            $article_info = $article->where(array('id'=>$article_id))->field('user_id,zan')->find();
            $new_zan = $article_info['zan']-1;
            $article->where(array('id'=>$article_id))->save(array('zan'=>$new_zan));


            $where_del['article_id'] = $article_id;
            $where_del['user_id'] = $article_info['user_id'];
            $where_del['type'] = 2;
            $where_del['zx_user_id'] = $user_info['id'];
            M('message')->where($where_del)->delete();


            $arr = array(
                'code'=> 1,
                'res'=>'取消成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'取消失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 朋友圈-屏蔽朋友圈
     */
    function PbQuan(){
        $user = M('user');
        $user_friend = M('user_friend');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $friend_id = decrypt1(trim(I('post.friend_id')));
        $status = decrypt1(trim(I('post.status')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['user_id'] = $user_info['id'];
        $where['friend_user_id'] = $friend_id;
       $is_friend =  $user_friend->where($where)->find();
       if ($is_friend){
           $query = $user_friend->where(array('id'=>$is_friend['id']))->save(array('is_pb'=>$status,'update_time'=>time()));
           if($query){
               $arr = array(
                   'code'=> 1,
                   'res'=>'操作成功 ',
               );
           }else{
               $arr = array(
                   'code'=> 0,
                   'res'=>'操作失败',
               );
           }
           $data = json_encode($arr);
           $return['encryption'] =  encrypt1($data);
           $this->ajaxReturn($return,"JSON");
       }else{
           $arr = array(
               'code'=> 0,
               'res'=>'不是好友关系',
           );
           $data = json_encode($arr);
           $return['encryption'] =  encrypt1($data);
           $this->ajaxReturn($return,"JSON");
       }
    }



    /**
     * 朋友圈-发布评论
     */
    function SubmitCommentFriend(){
        $user = M('user');
        $article = M('article');
        $article_comment = M('article_comment');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $article_id = decrypt1(trim(I('post.article_id')));
        $content = decrypt1(trim(I('post.content')));
        $appoint_user_id = decrypt1(trim(I('post.appoint_user_id')));
        $from = decrypt1(trim(I('post.from')));


        /*$article_id = "1";
        $content = "hu";
        $token = "59b8d705259608fe1d874077ff08617e";
        $appoint_user_id = "2";*/


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($appoint_user_id==$user_info['id']){
            $arr = array('code'=> 0, 'res'=>'不能回复自己');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if(!$content){$arr = array('code'=> 0, 'res'=>'评论不能为空');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(strlen($content)>420){$arr = array('code'=> 0, 'res'=>'评论字数最长为140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $article_info = $article->where(array('id'=>$article_id))->field('user_id,content')->find();

        if($appoint_user_id){
            $add['appoint_user_id'] = $appoint_user_id;
        }

        $add['content'] = $content;
        $add['user_id'] = $user_info['id'];
        $add['article_id'] = $article_id;

        $add['create_time'] = time();
        $query = $article_comment->add($add);
        if($query){
            $list['comment_id'] = $query;
            $list['user_id'] = $user_info['id'];
            $list['content'] = $content;
            $list['name'] = $user_info['name'];
            $list['head'] = $user_info['head'];
            $list['create_time'] = mdate(time());
            $list['appoint_user_id'] = $appoint_user_id;

            if($appoint_user_id){
                $user_other = $user->where(array('id'=>$appoint_user_id))->field('name')->find();
                $list['appoint_user_name'] = $user_other['name'];
            }else{
                $list['appoint_user_name'] = '';
            }
            $new_count = $article_info['comment_count'] +1;
            $article->where(array('id'=>$article_id))->save(array('update_time'=>time(),'comment_count'=>$new_count));

            if($appoint_user_id){
                $add_message['article_id'] = $article_id;
                $add_message['comment_id'] = $query;
                $add_message['user_id'] = $appoint_user_id;
                $add_message['type'] = 3;
                $add_message['content'] = $content;
                $add_message['zx_user_id'] = $user_info['id'];
                $add_message['create_time'] = time();
                M('message')->add($add_message);
                //$send_status = SendSocket($appoint_user_id,'new_message');
                $tz_con['type'] = 'new_message';
                $send_status = SendSocket($appoint_user_id,json_encode($tz_con));
            }

            //添加消息通知
            if($article_info['user_id']!=$user_info['id']){

                if($appoint_user_id){
                    $add_message['article_id'] = $article_id;
                    $add_message['user_id'] = $article_info['user_id'];
                    $add_message['type'] = 3;
                    $add_message['content'] = $content;
                    $add_message['zx_user_id'] = $user_info['id'];
                    $add_message['appoint_user_id'] = $appoint_user_id;
                    $add_message['create_time'] = time();
                    M('message')->add($add_message);

                    //$send_status = SendSocket($article_info['user_id'],'new_message');
                    $tz_con['type'] = 'new_message';
                    $send_status = SendSocket($article_info['user_id'],json_encode($tz_con));
                }else{
                    //新增消息
                    $add_message2['article_id'] = $article_id;
                    $add_message2['user_id'] = $article_info['user_id'];
                    $add_message2['type'] = 1;
                    $add_message2['content'] = $content;
                    $add_message2['zx_user_id'] = $user_info['id'];
                    $add_message2['create_time'] = time();
                    M('message')->add($add_message2);
                    //新增消息
                    //$send_status = SendSocket($article_info['user_id'],'new_message');
                    $tz_con['type'] = 'new_message';
                    $send_status = SendSocket($article_info['user_id'],json_encode($tz_con));
                }



                //新版
                /*$add_system['user_id'] = $article_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 1;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $article_id;
                $add_system['status'] = 1;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $article_info['user_id'];

                $tis = $user_info['name'].'回复了你的帖子《'.$article_info['content'].'》';*/
               // SendRongSystem($rong_user,$tis);

            }

            //评论增加积分
           // $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'5',$article_id);

            //$user_other = $user->where(array('id'=>$article_info['user_id']))->find();
            //评论增加积分
            //$add_status = AddScore($user_other['id'],$user_other['score'],$user_other['level'],'9',$article_id);

            $arr = array(
                'code'=> 1,
                'res'=>'评论成功 ',
                'list'=>$list,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 朋友圈-删除评论
     */
    function DeleteArticleComment(){
        $user = M('user');
        $article = M('article');
        $article_phone = M('article_photo');
        $article_zan = M('article_zan');
        $article_comment = M('article_comment');
        $user_friend = M('user_friend');
        $message = M('message');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $comment_id = decrypt1(trim(I('post.comment_id')));
        //$search = decrypt1(trim(I('post.search')));

        //$token = "be196855ebf12c739990376a58376317";
        //$article_id =1;

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $comment_info = $article_comment->where(array('id'=>$comment_id))->field('id,user_id')->find();
        if(!$comment_info){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($comment_info['user_id']!=$user_info['id']){

            $arr = array(
                'code'=> 0,
                'res'=>'您没有权限删除此条评论',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $article_comment->where(array('id'=>$comment_id))->delete();
        $res = '删除';
        if($query){
            $article->where(array('id'=>$comment_info['article_id']))->setDec('comment_count',1);
            $message->where(array('comment_id'=>$comment_id))->save(array('is_del'=>'1','update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 朋友圈-修改我的朋友圈封面
     */
    function EditMyCover(){
        $user = M('user');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $cover = decrypt1(trim(I('post.cover')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if(!$cover){$arr = array('code'=> 0, 'res'=>'请上传封面图片');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $save['cover'] = $cover;
        $save['update_time'] = time();

        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        $res = '修改';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 朋友圈-列表/指定
     */
    function ArticleList(){
        $user = M('user');
        $article = M('article');
        $article_phone = M('article_photo');
        $article_zan = M('article_zan');
        $article_comment = M('article_comment');
        $user_friend = M('user_friend');
        $message = M('message');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//1全部好友朋友圈，2查看指定好友朋友圈
        $page = decrypt1(trim(I('post.page')));
        $user_id = decrypt1(trim(I('post.user_id')));
        if(!$type){$type='1';}

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "ea3fd6f1ffe27ccf6644c64f6a91c6b3";
        //$user_id = "3";
        //$type = "2";


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $cover_info['cover'] = '';
        $cover_info['head'] = '';
        $cover_info['name'] = '';

        $message_count = 0;
        if($type=='1'){
            $message_count += $message->where(array('user_id'=>$user_info['id'],'is_read'=>'0'))->count();
            if($message_count>0){
                $message_head = $message->where(array('user_id'=>$user_info['id'],'is_read'=>'0'))
                    ->join('lyx_user ON lyx_message.zx_user_id = lyx_user.id')
                    ->order('lyx_message.create_time desc')
                    ->field('lyx_user.head')->find();
            }
            $friend_id[] = $user_info['id'];
            $where_friend['user_id'] = $user_info['id'];

            if ($page==1){
                $cover_info['cover'] = $user_info['cover'];
                $cover_info['head'] = $user_info['head'];
                $cover_info['name'] = $user_info['name'];
            }


        }else{
            $friend_id[] = $user_info['id'];
            $where_friend['user_id'] = $user_info['id'];
            //$where_friend['friend_user_id'] = $user_id;
        }
        $where_friend['is_pb'] =0;
        $friend_list = $user_friend->where($where_friend)->field('friend_user_id,remark_name')->select();

        foreach($friend_list as $item){
            $friend_id[] = $item['friend_user_id'];
            $remark_friend[$item['friend_user_id']] = $item['remark_name'];
        }
        $friend_val = implode(',',$friend_id);
        if ($type=='1'){
            $where['lyx_article.user_id'] = array('IN',$friend_val);
        }else{
            $where['lyx_article.user_id'] = $user_id;
            if ($page==1) {
                $other_user = $user->where(array('id' => $user_id))->field('cover,name,head')->find();
                $cover_info['cover'] = $other_user['cover'];
                $cover_info['head'] = $other_user['head'];
                $cover_info['name'] = $other_user['name'];
                if ($remark_friend[$user_id]) {
                    $cover_info['name'] = $remark_friend[$user_id];
                }
            }
        }

        $where['lyx_article.is_show'] = 1;
        $article_list = $article
            ->where($where)
            ->join('lyx_user ON lyx_article.user_id = lyx_user.id')
            ->limit($start,$num)
            ->order('lyx_article.create_time desc')
            ->field('lyx_article.content,lyx_article.browse,lyx_article.create_time,lyx_user.name,lyx_user.head,
            lyx_article.id as article_id,lyx_article.user_id,lyx_article.type,
            lyx_article.video_url,lyx_article.video_thumb,lyx_article.video_width,lyx_article.video_height,lyx_article.video_icon,lyx_article.zan as zan_count ')
            ->select();

        if($article_list){
            foreach ($article_list as $key => $item) {
                if (!$item['name']) {
                    $article_list[$key]['name'] = '';
                }
                if($remark_friend[$item['user_id']]){
                    $article_list[$key]['name'] = $remark_friend[$item['user_id']];
                }

                if (!$item['head']) {
                    $article_list[$key]['head'] = '';
                }


                if(!$item['video_url']){
                    $article_list[$key]['video_url'] = "";
                }
                if(!$item['video_height']){
                    $article_list[$key]['video_height'] = "0";
                }
                if(!$item['video_width']){
                    $article_list[$key]['video_width'] = "0";
                }
                if(!$item['video_thumb']){
                    $article_list[$key]['video_thumb'] = "";
                }


                $where_comment['article_id'] = $item['article_id'];
                //评论数
                if($user_info['id']==$item['user_id']){
                    unset($where_comment['user_id']);
                    $article_list[$key]['is_self'] = "1";
                }else{
                    $article_list[$key]['is_self'] = "0";
                    $where_comment['user_id'] = array('IN',$friend_val);
                }

                $comment_list = $article_comment->where($where_comment)
                    ->join('lyx_user ON lyx_article_comment.user_id = lyx_user.id')
                    ->field('lyx_article_comment.id as comment_id,lyx_article_comment.user_id,lyx_article_comment.content,lyx_user.name,lyx_article_comment.appoint_user_id')
                    ->order('lyx_article_comment.create_time')
                    ->select();
                foreach($comment_list as $key2=>$item_comment){
                    if($item_comment['appoint_user_id']){
                        $appoint_name = $user->where(array('id'=>$item_comment['appoint_user_id']))->field('name')->find();
                        $comment_list[$key2]['appoint_user_name']  = $appoint_name['name'];
                        if($remark_friend[$item_comment['appoint_user_id']]){
                            $comment_list[$key2]['appoint_user_name'] = $remark_friend[$item_comment['appoint_user_id']];
                        }
                    }else{
                        $comment_list[$key2]['appoint_user_name']  = '';
                    }
                    if($remark_friend[$item_comment['user_id']]){
                        $comment_list[$key2]['name'] = $remark_friend[$item_comment['user_id']];
                    }

                }

                $article_list[$key]['comment_list'] = $comment_list;

                //点赞数

                $where_zan['article_id'] = $item['article_id'];
                if($user_info['id']==$item['user_id']){
                    unset($where_zan['user_id']);
                }else{
                    $where_zan['user_id'] = array('IN',$friend_val);
                }
                $zan_list = $article_zan->where($where_zan)
                    ->join('lyx_user ON lyx_article_zan.user_id = lyx_user.id')
                    ->field('lyx_article_zan.user_id,lyx_user.name')
                    ->order('lyx_article_zan.create_time')
                    ->select();
                foreach ($zan_list as $key3=>$item_zan){
                    if($remark_friend[$item_zan['user_id']]){
                        $zan_list[$key3]['name'] = $remark_friend[$item_zan['user_id']];
                    }
                }

                $article_list[$key]['zan_list'] = $zan_list;


                //图片
                $new_img_list = array();
                $img_list = $article_phone->where(array('article_id' => $item['article_id']))->select();
                if ($img_list) {
                    foreach ($img_list as $val) {
                        $new_img_list[] = $val['img_url'];
                    }
                }
                $article_list[$key]['img_list'] = $new_img_list;



                //自己是否有点赞
                $is_zan = $article_zan->where(array('article_id' => $item['article_id'], 'user_id' => $user_info['id']))->find();
                if ($is_zan) {
                    $article_list[$key]['is_zan'] = '1';
                } else {
                    $article_list[$key]['is_zan'] = '0';
                }
                $article_list[$key]['create_time'] = mdate($item['create_time']);
                //$article_list[$key]['browse'] = WanChu($item['browse']) . '人浏览';
                unset($article_list[$key]['video_icon']);
            }
        }else{
            $article_list = array();
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'message_count' => (String)$message_count,
            'message_head' => $message_head['head'],
            'cover_info' => $cover_info,
            'article_list' => $article_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 朋友圈-查询是否有未读消息
     */
    function CheckArticleMessageNum(){
        $user = M('user');
        $message = M('message');
        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $message_count = 0;

        $message_count += $message->where(array('user_id'=>$user_info['id'],'is_read'=>'0'))->count();
            if($message_count>0){
                $message_head = $message->where(array('user_id'=>$user_info['id'],'is_read'=>'0'))
                    ->join('lyx_user ON lyx_message.zx_user_id = lyx_user.id')
                    ->order('lyx_message.create_time desc')
                    ->field('lyx_user.head')->find();
            }else{
                $message_head['head']='';
            }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'message_count' => (String)$message_count,
            'message_head' => $message_head['head'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 朋友圈-详情
     */
    function ArticleDetail(){
        $user = M('user');
        $article = M('article');
        $article_phone = M('article_photo');
        $article_zan = M('article_zan');
        $article_comment = M('article_comment');
        $user_friend = M('user_friend');
        $message = M('message');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $article_id = decrypt1(trim(I('post.article_id')));
        //$search = decrypt1(trim(I('post.search')));

        //$token = "be196855ebf12c739990376a58376317";
        //$article_id =1;

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $friend_list = $user_friend->where(array('user_id'=>$user_info['id']))->field('friend_user_id')->select();
        $friend_id[] = $user_info['id'];
        foreach($friend_list as $item){
            $friend_id[] = $item['friend_user_id'];
            $remark_friend[$item['friend_user_id']] = $item['remark_name'];
        }
        $friend_val = implode(',',$friend_id);

        //$where['lyx_article.user_id'] = array('IN',$friend_val);
        $where['lyx_article.id'] = $article_id;
        $where['lyx_article.is_show'] = 1;
        $article_info = $article
            ->where($where)
            ->join('lyx_user ON lyx_article.user_id = lyx_user.id')
            ->order('lyx_article.create_time desc')
            ->field('lyx_article.content,lyx_article.browse,lyx_article.create_time,lyx_user.name,lyx_user.head,
            lyx_article.id as article_id,lyx_article.user_id,lyx_article.type,
            lyx_article.video_url,lyx_article.video_thumb,lyx_article.video_width,lyx_article.video_height,lyx_article.video_icon,lyx_article.zan as zan_count ')
            ->find();

        if($article_info){
                if (!$article_info['name']) {
                    $article_info['name'] = '';
                }

            if($remark_friend[$article_info['user_id']]){
                $article_info['name'] = $remark_friend[$article_info['user_id']];
            }

                if (!$article_info['head']) {
                    $article_info['head'] = '';
                }

                if(!$article_info['video_url']){
                    $article_info['video_url'] = "";
                }
                if(!$article_info['video_height']){
                    $article_info['video_height'] = "0";
                }
                if(!$article_info['video_width']){
                    $article_info['video_width'] = "0";
                }
                if(!$article_info['video_thumb']){
                    $article_info['video_thumb'] = "";
                }

            $where_comment['article_id'] = $article_info['article_id'];

            //评论数
                if($user_info['id']==$article_info['user_id']){
                    unset($where_comment['user_id']);
                }else{
                    $where_comment['user_id'] = array('IN',$friend_val);
                }
                $comment_list = $article_comment->where($where_comment)
                    ->join('lyx_user ON lyx_article_comment.user_id = lyx_user.id')
                    ->field('lyx_article_comment.id as comment_id,lyx_article_comment.user_id,lyx_article_comment.content,lyx_user.name,lyx_article_comment.appoint_user_id,lyx_user.head,lyx_article_comment.create_time')
                    ->order('lyx_article_comment.create_time')
                    ->select();
                foreach($comment_list as $key2=>$item_comment){
                    $comment_list[$key2]['create_time'] = mdate($item_comment['create_time']);
                    if($item_comment['appoint_user_id']){
                        $appoint_name = $user->where(array('id'=>$item_comment['appoint_user_id']))->field('name')->find();
                        $comment_list[$key2]['appoint_user_name']  = $appoint_name['name'];
                        if($remark_friend[$item_comment['appoint_user_id']]){
                            $comment_list[$key2]['appoint_user_name'] = $remark_friend[$item_comment['appoint_user_id']];
                        }
                    }else{
                        $comment_list[$key2]['appoint_user_name']  = '';
                    }
                    if($remark_friend[$item_comment['user_id']]){
                        $comment_list[$key2]['name'] = $remark_friend[$item_comment['user_id']];
                    }
                }

            $article_info['comment_list'] = $comment_list;

                //点赞数
            $where_zan['article_id'] = $article_info['article_id'];

                if($user_info['id']==$article_info['user_id']){
                    $article_info['is_self'] = "1";
                    unset($where_zan['user_id']);
                }else{
                    $article_info['is_self'] = "0";
                    $where_zan['user_id'] = array('IN',$friend_val);
                }
                $zan_list = $article_zan->where($where_zan)
                    ->join('lyx_user ON lyx_article_zan.user_id = lyx_user.id')
                    ->field('lyx_article_zan.user_id,lyx_user.name,lyx_user.head')
                    ->order('lyx_article_zan.create_time')
                    ->select();

            foreach ($zan_list as $key3=>$item_zan){
                if($remark_friend[$item_zan['user_id']]){
                    $zan_list[$key3]['name'] = $remark_friend[$item_zan['user_id']];
                }
            }
            $article_info['zan_list'] = $zan_list;


                //图片
                $new_img_list = array();
                $img_list = $article_phone->where(array('article_id' => $article_info['article_id']))->select();
                if ($img_list) {
                    foreach ($img_list as $val) {
                        $new_img_list[] = $val['img_url'];
                    }
                }
            $article_info['img_list'] = $new_img_list;



                //自己是否有点赞
                $is_zan = $article_zan->where(array('article_id' => $article_info['article_id'], 'user_id' => $user_info['id']))->find();
                if ($is_zan) {
                    $article_info['is_zan'] = '1';
                } else {
                    $article_info['is_zan'] = '0';
                }
            $article_info['create_time'] = mdate($item['create_time']);
                //$article_list[$key]['browse'] = WanChu($item['browse']) . '人浏览';
                unset($article_info['video_icon']);

        }else{
            $article_info = array();
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'article_info' => $article_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 朋友圈-删除
     */
    function DeleteArticle(){
        $user = M('user');
        $article = M('article');
        $article_phone = M('article_photo');
        $article_zan = M('article_zan');
        $article_comment = M('article_comment');
        $user_friend = M('user_friend');

        $message = M('message');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $article_id = decrypt1(trim(I('post.article_id')));
        //$search = decrypt1(trim(I('post.search')));

        //$token = "be196855ebf12c739990376a58376317";
        //$article_id =1;

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $article_info = $article->where(array('id'=>$article_id))->field('id,user_id')->find();
        if(!$article_info){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($article_info['user_id']!=$user_info['id']){

            $arr = array(
                'code'=> 0,
                'res'=>'您没有权限删除此条朋友圈',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $article->where(array('id'=>$article_id))->delete();
        $res = '删除';
        if($query){
            $article_phone->where(array('article_id'=>$article_id))->delete();
            $article_zan->where(array('article_id'=>$article_id))->delete();
            $article_comment->where(array('article_id'=>$article_id))->delete();
            $message->where(array('article_id'=>$article_id))->delete();


            //同步删除附近动态
            $user_blogs = M('user_blogs');
            $blogs_info = $user_blogs->where(array('parent'=>$article_id))->find();
            if ($blogs_info){
                $query2 = $user_blogs->where(array('id'=>$blogs_info['id']))->delete();
                if($query2){
                    $user_blogs_photo = M('user_blogs_photo');
                    $blogs_zan = M('blogs_zan');
                    $report = M('report');
                    $blogs_comment = M('blogs_comment');
                    $blogs_reply = M('blogs_reply');
                    $system = M('system');
                    $user_blogs_photo->where(array('blogs_id'=>$blogs_info['id']))->delete();
                    $blogs_zan->where(array('blogs_id'=>$blogs_info['id']))->delete();
                    $report->where(array('report_id'=>$blogs_info['id'],'report_type'=>'2'))->delete();
                    $comment_list = $blogs_comment->where(array('blogs_id'=>$blogs_info['id']))->select();
                    if ($comment_list){
                        foreach ($comment_list as $item){
                            $blogs_reply->where(array('comment_id'=>$item['id']))->delete();
                            $system->where(array('status'=>'1','type'=>array('IN','2,3'),'type_id'=>$item['id']))->delete();
                        }
                    }
                    $system->where(array('status'=>'1','type'=>1,'type_id'=>$blogs_info['id']))->delete();
                    $blogs_comment->where(array('blogs_id'=>$blogs_info['id']))->delete();
                }
            }



            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }

    /**
     * 朋友圈-消息列表
     */
    function ArticleMessageList(){
        $user = M('user');
        $article = M('article');
        $article_phone = M('article_photo');
        $article_zan = M('article_zan');
        $article_comment = M('article_comment');
        $user_friend = M('user_friend');
        $message = M('message');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$search = decrypt1(trim(I('post.search')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "be196855ebf12c739990376a58376317";
        //$article_id =1;



        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $friend_list = $user_friend->where(array('user_id'=>$user_info['id']))->field('friend_user_id')->select();
        //$friend_id[] = $user_info['id'];
        foreach($friend_list as $item){
            //$friend_id[] = $item['friend_user_id'];
            $remark_friend[$item['friend_user_id']] = $item['remark_name'];
        }


        $message_list =  $message
            ->where(array('user_id'=>$user_info['id']))
            ->order('create_time desc')
            ->limit($start,$num)
            ->field('id as message_id,article_id,type,content,zx_user_id,appoint_user_id,is_del,create_time')
            ->select();


        foreach ($message_list as $key=>$item){
            $article_info = $article->where(array('id'=>$item['article_id']))->field('id as article_id,type,content,video_thumb')->find();
            if(!$article_info['video_thumb']){
                $article_info['video_thumb']='';
            }
            if($article_info['type']=='1'){
                $phone_info = $article_phone->where(array('article_id'=>$article_info['article_id']))->order('id')->field('img_url')->find();
                $article_info['img_url'] = $phone_info['img_url'];
            }else if($article_info['type']=='2'){
                $article_info['img_url'] =  '';
            }else{
                $article_info['img_url'] =  '';
            }
            $message_list[$key]['article_info']= $article_info;
            $message_list[$key]['create_time']= mdate($item['create_time']);
            $user_info2= $user->where(array('id'=>$item['zx_user_id']))->field('name,head')->find();
            $message_list[$key]['zx_user_name'] = $user_info2['name'];
            //是否有备注名
            if($remark_friend[$item['zx_user_id']]){
                $message_list[$key]['zx_user_name'] = $remark_friend[$item['zx_user_id']];
            }
            $message_list[$key]['zx_user_head'] = $user_info2['head'];
            if($item['appoint_user_id']){
                $user_info3= $user->where(array('id'=>$item['appoint_user_id']))->field('name')->find();
                $message_list[$key]['appoint_user_name'] = $user_info3['name'];
                if($remark_friend[$item['appoint_user_id']]){
                    $message_list[$key]['appoint_user_name'] = $remark_friend[$item['appoint_user_id']];
                }
            }

        }

        if($message_list){
            $message->where(array('user_id'=>$user_info['id'],'is_read'=>'0'))->save(array('is_read'=>'1','update_time'=>time()));
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'message_list' => $message_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 查看Ta人主页-附近动态
     */
    function CheckOtherUserInfo(){
        $user = M('user');
        $article = M('article');
        $article_photo = M('article_photo');


        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));
        $user_friend = M('user_friend');

        //$user_id = '2';
        //$token = "329d458ffd8b7bde2a13bd33a71d867a";

        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }

        $other_user = $user->where(array('id'=>$user_id))->field('id as user_id,name,head,signature,
        sex,level,explain,age,vip,astro,job,province,city,area,create_time,
        phone_at,id_card_at,qq_at,wx_at,ali_at,weibo_at,bank_at,company_at')->find();
        if(!$other_user){
            $arr = array('code'=> 0, 'res'=>'用户不存在');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }




        if(!$other_user['name']){$other_user['name']='';}
        if(!$other_user['head']){$other_user['head']='';}
        if(!$other_user['astro']){$other_user['astro']='';}
        if(!$other_user['province']){$other_user['province']='';}
        if(!$other_user['city']){$other_user['city']='';}
        if(!$other_user['area']){$other_user['area']='';}
        if(!$other_user['signature']){$other_user['signature']='无';}
        if(!$other_user['explain']){$other_user['explain']='无';}
        if(!$other_user['job']){$other_user['job']='无';}

        $other_user['create_time'] =  date('Y-m-d',$other_user['create_time']);


        $new_head = M('cache')->where(array('thumb'=>$other_user['head']))->find();

        if($new_head){
            $other_user['head']=$new_head['url'];
        }
        $other_user['is_friend'] = '0';
        if($user_id==$user_info['id']){
            $is_self = '1';
            $other_user['is_friend'] = '1';
        }else{
            if($token){
                $where_firned['user_id'] = $user_info['id'];
                $where_firned['friend_user_id'] = $user_id;
                $is_friend = $user_friend->where($where_firned)->find();
                if($is_friend){
                    $other_user['is_friend'] = '1';
                }
            }

            $is_self = '0';
        }
        $other_user['is_self'] = $is_self;
        $other_user['is_pb'] = '0';
        if($token){

            if($user_info['id']!=$user_id){
                $where_firned['user_id'] = $user_info['id'];
                $where_firned['friend_user_id'] = $user_id;
                $is_friend = $user_friend->where($where_firned)->find();
                if($is_friend){
                    $other_user['is_pb'] = $is_friend['is_pb'];
                }
                if($is_friend['remark_name']){
                    $other_user['remark_name'] = $is_friend['remark_name'];
                }else{
                    $other_user['remark_name'] = '';
                }
            }else{
                $other_user['remark_name'] = '';
            }
        }else{
            $other_user['remark_name'] = '';
        }


        $blogs_count = 0;
        $blogs_count+=$user_blogs->where(array('user_id'=>$user_id))->count();
        $other_user['blogs_count'] = (String)$blogs_count;

        $blogs_list = $user_blogs->where(array('user_id'=>$user_id,'type'=>array('IN','1,2')))->limit(4)->order('create_time desc')->field('id,type,video_thumb')->select();
        foreach($blogs_list as $item){
            if ($item['type']=='1'){
                $img_info = $user_blogs_photo->where(array('blogs_id'=>$item['id']))->order('id')->field('img_url')->find();
                if ($img_info){
                    $img_list[] = $img_info['img_url'];
                }
            }else{
                $img_list[] = $item['video_thumb'];
            }

        }

        if($img_list){
            $other_user['img_list'] = $img_list;
        }else{
            $other_user['img_list'] = array();
        }

        $blogs_list2 = $article->where(array('user_id'=>$user_id,'type'=>'1'))->limit(4)->order('create_time desc')->field('id')->select();
        foreach($blogs_list2 as $item){
            $img_info = $article_photo->where(array('article_id'=>$item['id']))->order('id')->field('img_url')->find();
            if ($img_info){
                $img_list2[] = $img_info['img_url'];
            }
        }

        if($img_list2){
            $other_user['blogs_img_list'] = $img_list2;
        }else{
            $other_user['blogs_img_list'] = array();
        }





        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $other_user
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 查看Ta人主页
     */
    function CheckOtherUserInfoArticle(){
        $user = M('user');


        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$user_id = '3';
        //$token = "edee9b9b0373a97d06a4376113a90fb2";


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $other_user = $user->where(array('id'=>$user_id))->field('id as user_id,name,head,
        sex,level,age,province,city,area,create_time')->find();
        if(!$other_user){
            $arr = array('code'=> 0, 'res'=>'用户不存在');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if(!$other_user['name']){$other_user['name']='';}
        if(!$other_user['head']){$other_user['head']='';}
        if(!$other_user['province']){$other_user['province']='';}
        if(!$other_user['city']){$other_user['city']='';}
        if(!$other_user['area']){$other_user['area']='';}



        $other_user['create_time'] =  date('Y-m-d',$other_user['create_time']);


        $new_head = M('cache')->where(array('thumb'=>$other_user['head']))->find();

        if($new_head){
            $other_user['head']=$new_head['url'];
        }


        $list = $user_blogs->where(array('user_id'=>$user_id,'type'=>array('IN','1,2'),'is_show'=>'1'))->limit($start,$num)->order('create_time desc')
            ->field('id,user_id,lng,lat,content,zan,browse,comment_count,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type')->select();
        foreach($list as $key=>$item){

                if(!$item['video_url']){
                    $list[$key]['video_url'] = "";
                }
                if(!$item['video_height']){
                    $list[$key]['video_height'] = "0";
                }
                if(!$item['video_width']){
                    $list[$key]['video_width'] = "0";
                }
                if(!$item['video_thumb']){
                    $list[$key]['video_thumb'] = "";
                }
                if(!$item['lat']){
                    $list[$key]['lat'] = "";
                }

                if(!$item['lng']){
                    $list[$key]['lng'] = "";
                }

                //用户信息
                $list[$key]['name'] = $other_user['name'];
                $list[$key]['head'] = $other_user['head'];
                $list[$key]['sex'] = $other_user['sex'];
                $list[$key]['age'] = $other_user['age'];
                $list[$key]['level'] = $other_user['level'];

                $list[$key]['create_time'] = mdate($item['create_time']);
                //点赞数
                $list[$key]['zan'] = WanChu($item['zan']);
                //评论数
                $list[$key]['comment_count'] = WanChu($item['comment_count']);
                //浏览人数
                $list[$key]['browse'] = WanChu($item['browse']);
                //$list[$key]['dis'] = MiZhuanhuan($item['dis']);

                $new_img_list = array();
                $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
                if ($img_list) {
                    foreach ($img_list as $val) {
                        $new_img_list[] = $val['img_url'];
                    }
                }
                $list[$key]['img_list'] = $new_img_list;


                //自己是否有点赞
                $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
                if ($is_zan) {
                    $list[$key]['is_zan'] = '1';
                } else {
                    $list[$key]['is_zan'] = '0';
                }

                unset($list[$key]['video_icon']);
        }






        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $other_user,
            'blogs_list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 个人中心-我的日记
     */
    function CheckMyArticle(){
        $user = M('user');


        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$user_id = '3';
        //$token = "edee9b9b0373a97d06a4376113a90fb2";


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}




        $list = $user_blogs->where(array('user_id'=>$user_info['id'],'type'=>array('IN','1,2')))->limit($start,$num)->order('create_time desc')
            ->field('id,user_id,lng,lat,content,zan,browse,comment_count,
        create_time,video_url,video_thumb,video_icon,video_width,video_height,type')->select();
        foreach($list as $key=>$item){

            if(!$item['video_url']){
                $list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $list[$key]['video_thumb'] = "";
            }
            if(!$item['lat']){
                $list[$key]['lat'] = "";
            }

            if(!$item['lng']){
                $list[$key]['lng'] = "";
            }



            $list[$key]['create_time'] = mdate($item['create_time']);
            //点赞数
            $list[$key]['zan'] = WanChu($item['zan']);
            //评论数
            $list[$key]['comment_count'] = WanChu($item['comment_count']);
            //浏览人数
            $list[$key]['browse'] = WanChu($item['browse']);
            //$list[$key]['dis'] = MiZhuanhuan($item['dis']);

            $new_img_list = array();
            $img_list = $user_blogs_photo->where(array('blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $list[$key]['img_list'] = $new_img_list;


            //自己是否有点赞
            $is_zan = $blogs_zan->where(array('blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
            if ($is_zan) {
                $list[$key]['is_zan'] = '1';
            } else {
                $list[$key]['is_zan'] = '0';
            }

            unset($list[$key]['video_icon']);
        }






        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'blogs_list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 搜索-根据时光号搜索用户
     */
    function SearchUserId(){
        $user = M('user');



        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));


        //$user_id = '1';
        //$token = "be196855ebf12c739990376a58376317";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!is_numeric($user_id)){
            $arr = array(
                'code'=> 0,
                'res'=>'无搜索结果',
                'user_id'=>'',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where['imid|phone'] = $user_id;
        $where['is_robot'] = 0;
        $user_info2=$user->where($where)->field('id as user_id')->find();
        $from = '';
        if ($user_info2){
            if ($user_info2['phone']==$user_id){
                $from = 'phone_add';
            }else{
                $from = 'im_add';
            }
        }

        if($user_info2){
            $arr = array(
                'code'=> 1,
                'res'=>'搜索成功',
                'user_id'=>$user_info2['user_id'],
                'from'=>$from
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'无搜索结果',
                'user_id'=>'',
                'from'=>'',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 搜索-根据群号搜索群
     */
    function SearchGroupId(){
        $user = M('user');
        $group = M('group');



        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));


        //$user_id = '1';
        //$token = "be196855ebf12c739990376a58376317";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        /*if (!is_numeric($group_id)){
            $arr = array(
                'code'=> 0,
                'res'=>'无搜索结果',
                'user_id'=>'',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/

        $where['id|group_name'] = array("like","%".$group_id."%");
        $group_info = $group->where($where)->field('id as group_id')->find();

        if($group_info){
            $arr = array(
                'code'=> 1,
                'res'=>'搜索成功',
                'group_id'=>$group_info['group_id']
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'无搜索结果',
                'group_id'=>'',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 好友-设置备注名称
     */
    function SetFriendRemarkName(){
        $user = M('user');


        $article = M('article');
        $article_photo = M('article_photo');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));
        $remark_name = decrypt1(trim(I('post.remark_name')));
        $user_friend = M('user_friend');

        //$user_id = '1';
        //$token = "be196855ebf12c739990376a58376317";


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$remark_name){
            $arr = array(
                'code'=> 0,
                'res'=>'备注名称不能为空',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if(strlen($remark_name)>20){
            $arr = array(
                'code'=> 0,
                'res'=>'备注名称最长为20个字符',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($user_info['id']==$user_id){
            $arr = array(
                'code'=> 0,
                'res'=>'不能给自己设置备注名称',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $where_firned['user_id'] = $user_info['id'];
        $where_firned['friend_user_id'] = $user_id;
        $is_friend = $user_friend->where($where_firned)->find();

        if(!$is_friend){
            $arr = array(
                'code'=> 0,
                'res'=>'你们不是好友，无法修改',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $user_friend->where(array('id'=>$is_friend['id']))->save(array('remark_name'=>$remark_name,'update_time'=>time()));

        $res = '设置';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 设置-加我为好友时是否需要验证
     */
    function SetFriendAddStatus(){
        $user = M('user');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $value = decrypt1(trim(I('post.value')));
        if(!$value){
            $value = 0;
        }

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $save['friend_add'] = $value;
        $save['update_time'] = time();

        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        $res = '设置';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 添加好友申请
     */
    function AddFriend(){
        $user = M('user');
        $user_friend = M('user_friend');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $add_user_id = decrypt1(trim(I('post.add_user_id')));
        $from = decrypt1(trim(I('post.from')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['id'] == $add_user_id){
            $arr = array(
                'code'=> 0,
                'res'=>'不能添加自己',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_my['user_id'] = $user_info['id'];
        $where_my['friend_user_id'] = $add_user_id;
        $is_my = $user_friend->where($where_my)->find();


        if($is_my){
            $arr = array(
                'code'=> 0,
                'res'=>'你们已经是好友',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if(!$from){
            $arr = array(
                'code'=> 0,
                'res'=>'来源错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $add_user_info = $user->where(array('id'=>$add_user_id))->find();
        if ($from=='phone_add'){
            if ($add_user_info['phone_add']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'由于对方的隐私设置，你无法通过手机号添加该用户。',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }
        if ($from=='im_add'){
            if ($add_user_info['im_add']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'由于对方的隐私设置，你无法通过IM号添加该用户。',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }
        if ($from=='group_add'){
            if ($add_user_info['group_add']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'由于对方的隐私设置，你无法通过群添加该用户。',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }
        if ($from=='qr_add'){
            if ($add_user_info['qr_add']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'由于对方的隐私设置，你无法通过二维码添加该用户。',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }
        if ($from=='card_add'){
            if ($add_user_info['card_add']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'由于对方的隐私设置，你无法通过名片添加该用户。',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }


        //添加好友判断是否需要验证
        if($add_user_info['friend_add']=='1'){

            $where_my2['user_id'] = $user_info['id'];
            $where_my2['friend_user_id'] = $add_user_id;
            $where_my2['type'] = 1;
            $is_my2 = $user_friend_apply->where($where_my2)->find();
            if($is_my2){
                $save['status'] = 0;
                $save['is_read'] = 0;
                $save['create_time'] = time();
                $query = $user_friend_apply->where(array('id'=>$is_my2['id']))->save($save);
            }else{
                $add['type'] = 1;
                $save['is_read'] = 0;
                $add['user_id'] = $user_info['id'];
                $add['friend_user_id'] = $add_user_id;
                $add['create_time'] = time();
                $query = $user_friend_apply->add($add);
            }
            $res = '申请';

        }else{
            $res = '添加';

            $is_user = $user_friend->where(array('user_id'=>$user_info['id'],'friend_user_id'=>$add_user_id))->find();
            if(!$is_user){
                $add_1['user_id'] =$user_info['id'];
                $add_1['friend_user_id'] = $add_user_id;
                $add_1['create_time'] = time();
                $user_friend->add($add_1);
            }
            $is_user2 = $user_friend->where(array('user_id'=>$add_user_id,'friend_user_id'=>$user_info['id']))->find();
            if(!$is_user2){
                $add_2['user_id'] = $add_user_id;
                $add_2['friend_user_id'] = $user_info['id'];
                $add_2['create_time'] = time();
                $user_friend->add($add_2);
            }


            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->removeBlacklist( $user_info['id'], $add_user_id);
            $result = $RongCloud->user()->removeBlacklist( $add_user_id, $user_info['id']);
            $query = true;


            $rong_user[] = $add_user_id;
            $tis = '我通过了你的朋友验证请求，现在我们可以开始聊天了';
            SendRongUserMessage($user_info['id'],$rong_user,$tis);



        }

        if($query){

            if($add_user_info['friend_add']=='1'){
                //$send_status = SendSocket($add_user_id,'new_add');
                $tz_con['type'] = 'new_add';
                $send_status = SendSocket($add_user_id,json_encode($tz_con));
            }

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 申请通知数
     */
    function AddApplyCount(){
        $user = M('user');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        /*$group_list = $group_user->where(array('user_id'=>$user_info['id'],'type'=>array('IN','1,2')))->field('group_id')->select();
        foreach ($group_list as $item){
           $group_id_list[] = $item['group_id'];
        }*/


        $where['friend_user_id'] = $user_info['id'];
        $where['status'] = 0;
        $where['is_read'] = 0;
        /*   if ($group_id_list){

               $group_id_val = implode(',',$group_id_list);
               $where['group_id'] = array('IN',$group_id_val);
               $where['_logic'] = 'or';
           }*/

        $apply_num = 0;
        $apply_num += $user_friend_apply->where($where)->count();



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'apply_num'=>(String)$apply_num,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 申请好友列表
     */
    function FriendApplyList(){
        $user = M('user');
        $user_friend_apply = M('user_friend_apply');
        $group = M('group');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        /*$group_list = $group_user->where(array('user_id'=>$user_info['id'],'type'=>array('IN','1,2')))->field('group_id')->select();
        foreach ($group_list as $item){
           $group_id_list[] = $item['group_id'];
        }*/


        $where['friend_user_id'] = $user_info['id'];
     /*   if ($group_id_list){

            $group_id_val = implode(',',$group_id_list);
            $where['group_id'] = array('IN',$group_id_val);
            $where['_logic'] = 'or';
        }*/

        $apply_list = $user_friend_apply->where(array('friend_user_id'=>$user_info['id']))->order('create_time desc')->limit($start,$num)->field('id as apply_id,user_id,status,create_time,type,content,group_id')->select();
        foreach($apply_list as $key=>$item){
            $apply_list[$key]['create_time'] = mdate($item['create_time']);
            $user_info2 = $user->where(array('id'=>$item['user_id']))->field('name,head')->find();
            $apply_list[$key]['user_name'] = $user_info2['name'];
            $apply_list[$key]['user_head'] = $user_info2['head'];
            if ($item['type']=='1'){
                $apply_list[$key]['content'] = '';
            }else{
                $group_info = $group->where(array('id'=>$item['group_id']))->field('group_name')->find();
                $apply_list[$key]['content'] = '加入群聊【'.$group_info['group_name'].'】：'.$item['content'];
            }

        }
        $user_friend_apply->where(array('friend_user_id'=>$user_info['id'],'is_read'=>'0'))->save(array('is_read'=>'1'));
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$apply_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 同意申请好友
     */
    function SuccessApplyFriend(){
        $user = M('user');
        $user_friend = M('user_friend');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $apply_id = decrypt1(trim(I('post.apply_id')));


        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$apply_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $apply_info = $user_friend_apply->where(array('id'=>$apply_id))->find();
        if($apply_info['friend_user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限操作',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($apply_info['status']!='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您已接受，请勿重复操作',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($apply_info['type']!='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'请求错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $user_friend_apply->where(array('id'=>$apply_id))->save(array('status'=>'1','update_time'=>time()));
        $res = '添加';
        if($query){
            $is_user = $user_friend->where(array('user_id'=>$apply_info['user_id'],'friend_user_id'=>$apply_info['friend_user_id']))->find();
            if(!$is_user){
                $add_1['user_id'] = $apply_info['user_id'];
                $add_1['friend_user_id'] = $apply_info['friend_user_id'];
                $add_1['create_time'] = time();
                $user_friend->add($add_1);
            }
            $is_user2 = $user_friend->where(array('user_id'=>$apply_info['friend_user_id'],'friend_user_id'=>$apply_info['user_id']))->find();
            if(!$is_user2){
                $add_2['user_id'] = $apply_info['friend_user_id'];
                $add_2['friend_user_id'] = $apply_info['user_id'];
                $add_2['create_time'] = time();
                $user_friend->add($add_2);
            }


            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->removeBlacklist( $apply_info['user_id'], $apply_info['friend_user_id']);
            $result = $RongCloud->user()->removeBlacklist( $apply_info['friend_user_id'], $apply_info['user_id']);


            $rong_user[] = $apply_info['user_id'];
            $tis = '我通过了你的朋友验证请求，现在我们可以开始聊天了';
            SendRongUserMessage($user_info['id'],$rong_user,$tis);




            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 删除好友
     */
    function DeleteFriends(){
        $user = M('user');
        $user_friend = M('user_friend');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));


        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$user_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_my['user_id'] = $user_info['id'];
        $where_my['friend_user_id'] = $user_id;
        $is_my = $user_friend->where($where_my)->find();


        if(!$is_my){
            $arr = array(
                'code'=> 0,
                'res'=>'你们不是好友',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $user_friend->where($where_my)->delete();
        $res = '删除';
        if($query){
            $where_my2['user_id'] = $user_id;
            $where_my2['friend_user_id'] = $user_info['id'];
            $user_friend->where($where_my2)->delete();

            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->addBlacklist($user_info['id'],$user_id);

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 美容日志-点赞
     */
    function BlogsZan(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $blogs_zan = M('blogs_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.blogs_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $add['user_id'] = $user_info['id'];
        $add['blogs_id'] = $blogs_id;
        $is_zan = $blogs_zan->where($add)->find();
        if($is_zan){
            $arr = array(
                'code'=> 0,
                'res'=>'您已赞过',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $add['create_time'] = time();
        $query = $blogs_zan->add($add);

        if($query){
            $article_info = $user_blogs->where(array('id'=>$blogs_id))->field('user_id,zan')->find();
            $new_zan = $article_info['zan']+1;
            $user_blogs->where(array('id'=>$blogs_id))->save(array('zan'=>$new_zan));
            //$user_other = $user->where(array('id'=>$article_info['user_id']))->find();
            //点赞增加积分
            $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'4',$blogs_id);

            //点赞增加积分
            //$add_status = AddScore($user_other['id'],$user_other['score'],$user_other['level'],'6',$article_id,$user_info['id']);
            $arr = array(
                'code'=> 1,
                'res'=>'点赞成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'点赞失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 美容日志-取消点赞
     */
    function BlogsZanCancel(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $blogs_zan = M('blogs_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.blogs_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $where['user_id'] = $user_info['id'];
        $where['blogs_id'] = $blogs_id;
        $query = $blogs_zan->where($where)->delete();
        if($query){


            $user_blogs->where(array('id'=>$blogs_id))->setDec('zan',1);


            $arr = array(
                'code'=> 1,
                'res'=>'取消成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'取消失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 动态-发布评论
     */
    function SubmitComment(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $blogs_comment = M('blogs_comment');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.blogs_id')));
        $content = decrypt1(trim(I('post.content')));
        $from = decrypt1(trim(I('post.from')));


        if($from==3){
            $appid = 'wx29e047dc98f52006';
            $APPSECRET = 'b99cf71cdd3bd8b3b5c800afafb4e8c3';
            $url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$appid.'&secret='.$APPSECRET;
            $s = file_get_contents($url);
            $acctoken = json_decode($s,true);
            $access_token = $acctoken['access_token'];
            $url2 = 'https://api.weixin.qq.com/wxa/msg_sec_check?access_token='.$access_token;

            $post_data = json_encode(array('content'=>$content),JSON_UNESCAPED_UNICODE);
            $res_data = send_post($url2,$post_data);
            $a = json_decode($res_data,true);
            if($a['errcode']!=0){
                $arr = array('code'=> 0, 'res'=>'内容含有违法违规内容	');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }
        }
      /*  $token = "aeb256f7921b1eb14d8ad132335242ae";
        $blogs_id = 1;
        $content = '测试';*/


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if(!$content){$arr = array('code'=> 0, 'res'=>'评论不能为空');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(strlen($content)>420){$arr = array('code'=> 0, 'res'=>'评论字数最长为140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $article_info = $user_blogs->where(array('id'=>$blogs_id))->field('user_id,content,comment_count')->find();

        $add['content'] = $content;
        $add['user_id'] = $user_info['id'];
        $add['blogs_id'] = $blogs_id;
        $add['create_time'] = time();
        $query = $blogs_comment->add($add);
        if($query){
            $new_count = $article_info['comment_count'] +1;
            $user_blogs->where(array('id'=>$blogs_id))->save(array('update_time'=>time(),'comment_count'=>$new_count));

            //添加消息通知
            if($article_info['user_id']!=$user_info['id']){
                //新版
                $add_system['user_id'] = $article_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 1;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $blogs_id;
                $add_system['status'] = 1;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $article_info['user_id'];
                $tis = $user_info['name'].'回复了你的日志《'.$article_info['content'].'》';
                SendRongSystem($rong_user,$tis);

            }

            //评论增加积分
            $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'2',$blogs_id);

            $user_other = $user->where(array('id'=>$article_info['user_id']))->find();
            //评论增加积分
            $add_status = AddScore($user_other['id'],$user_other['score'],$user_other['level'],'3',$blogs_id);

            $arr = array(
                'code'=> 1,
                'res'=>'评论成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 动态-回复评论
     */
    function ReplyComment(){
        $user = M('user');
        $blogs_reply = M('blogs_reply');
        $blogs_comment = M('blogs_comment');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $comment_id = decrypt1(trim(I('post.comment_id')));
        $appoint_user_id = decrypt1(trim(I('post.appoint_user_id')));
        $content = decrypt1(trim(I('post.content')));

 /*     $token = "aeb256f7921b1eb14d8ad132335242ae";
        $comment_id = 1;
        $content = '测试';*/

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $comment_info = $blogs_comment->where(array('id'=>$comment_id))->find();
        if(!$comment_info){$arr = array('code'=> 0, 'res'=>'评论ID错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$content){$arr = array('code'=> 0, 'res'=>'评论不能为空');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(strlen($content)>420){$arr = array('code'=> 0, 'res'=>'评论字数最长为140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $add['comment_id'] =  $comment_id;
        $add['reply_content'] = $content;
        $add['user_id'] = $user_info['id'];
        if($appoint_user_id){
            if($appoint_user_id == $user_info['id']){
                $arr = array('code'=> 0, 'res'=>'不能@自己');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }
            $add['appoint_user_id'] = $appoint_user_id;
        }
        $add['create_time'] = time();
        $query = $blogs_reply->add($add);

        if($query){
            //添加消息通知

            if($appoint_user_id){
               //新版
                $add_system['user_id'] = $appoint_user_id;
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 3;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $comment_info['blogs_id'];
                $add_system['status'] = 1;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $appoint_user_id;

                $tis = $user_info['name'].'@了你';
                SendRongSystem($rong_user,$tis);
            }
            if($comment_info['user_id']!=$user_info['id']){


                //新版
                $add_system['user_id'] = $comment_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 2;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $comment_info['blogs_id'];
                $add_system['status'] = 1;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $comment_info['user_id'];

                $tis = $user_info['name'].'回复了你的评论:'.$comment_info['content'];;
                SendRongSystem($rong_user,$tis);
            }



            $new_count = $comment_info['reply_num']+1;
            $blogs_comment->where(array('id'=>$comment_id))->save(array('reply_num'=>$new_count,'update_time'=>time()));

            $list['reply_id'] = $query;
            $list['user_id'] = $user_info['id'];
            $list['appoint_user_id'] = $appoint_user_id;
            $list['reply_content'] = $content;
            $list['reply_content'] = $content;
            $list['name'] = $user_info['name'];
            if ($appoint_user_id){
                $user_info2 = $user->where(array('id'=>$appoint_user_id))->field('name')->find();
                $list['appoint_user_name'] = $user_info2['name'];
            }else{
                $list['appoint_user_name'] = '';
            }



            $arr = array(
                'code'=> 1,
                'res'=>'评论成功',
                'list'=>$list,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
 * 美容日志-详情
 */
    function BlogsDetail(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_zan = M('blogs_zan');
        $blogs_comment = M('blogs_comment');
        $blogs_reply = M('blogs_reply');
        $shop_goods = M('shop_goods');
        $collect = M('collect');

        //接收数据
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.blogs_id')));
        $page = decrypt1(trim(I('post.page')));
        $share_user_id = decrypt1(trim(I('post.share_user_id')));
        //$check_type = decrypt1(trim(I('post.check_type')));//评论排序方式：1根据最新时间排序，2根据最热排序
        //if(!$check_type){$check_type = 1;}
        if(!$page){$page = 1;}

        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "38e59920c3837c2f1e7606c78551c12c";
        //$blogs_id = 644;

        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

            //是否添加收藏
            $is_col = $collect->where(array('user_id'=>$user_info['id'],'type'=>'1','type_id'=>$blogs_id))->find();

            if($is_col){
                $is_collect = '1';
                $collect_id = $is_col['id'];
            }else{
                $is_collect = '0';
                $collect_id = '0';
            }

            if(!$user_info['code_user']){
                if($share_user_id){
                    //绑定邀请人
                    $bind_status = BindCodeUser($share_user_id,$user_info['id']);
                }
            }
        }else{
            $is_collect = '0';
            $collect_id = '0';
        }





        $where['lyx_user_blogs.id'] = $blogs_id;
        $article_list = $user_blogs
            ->where($where)
            ->join('lyx_user ON lyx_user_blogs.user_id = lyx_user.id')
            ->order('create_time desc')
            ->field('lyx_user_blogs.content,lyx_user_blogs.browse,lyx_user_blogs.create_time,lyx_user.name,lyx_user.head,
            lyx_user_blogs.id as blogs_id,lyx_user_blogs.user_id,lyx_user_blogs.type,lyx_user_blogs.video_url,
            lyx_user_blogs.video_thumb,lyx_user_blogs.video_width,lyx_user_blogs.video_height,lyx_user.sex,
            lyx_user.level,lyx_user_blogs.video_icon,lyx_user_blogs.zan,lyx_user.age,lyx_user_blogs.lng,lyx_user_blogs.lat')
            ->find();


        if(!$article_list['name']){
            $article_list['name'] =  '';
        }

        if(!$article_list['head']){
            $article_list['head'] =  '';
        }


        if(!$article_list['video_url']){
            $article_list['video_url'] = "";
        }
        if(!$article_list['video_thumb']){
            $article_list['video_thumb'] = "";
        }

        if(!$article_list['video_width']){
            $article_list['video_width'] = "0";
        }
        if(!$article_list['video_height']){
            $article_list['video_height'] = "0";
        }

        $article_list['lng'] = $article_list['lng']?$article_list['lng']:"";
        $article_list['lat'] = $article_list['lat']?$article_list['lat']:"";

        if($lat&&$lng&&$article_list['lat']&&$article_list['lng']){
            $article_list['dis'] = getDistance($article_list['lat'],$article_list['lng'],$lat,$lng);
        }else{
            $article_list['dis'] ='';
        }


        $new_browse = $article_list['browse']+rand(1,5);
        $user_blogs->where(array('id'=>$blogs_id))->save(array('browse'=>$new_browse));


        //评论数
        $comment_count = $blogs_comment->where(array('blogs_id'=>$blogs_id))->count();
        $count_comment = WanChu($comment_count);
        $article_list['zan'] = WanChu($article_list['zan']);
        $article_list['comment_count'] =  $count_comment;

        /* if($check_type=='1'){
             $order_a_d = 'lyx_blogs_comment.create_time desc';
         }else{
             $order_a_d  = 'lyx_blogs_comment.zan desc,lyx_blogs_comment.reply_num desc';
         }*/
        $order_a_d = 'lyx_blogs_comment.create_time desc';
        $comment_list = $blogs_comment
            ->order($order_a_d)
            ->limit($start,$num)
            ->join('lyx_user ON lyx_blogs_comment.user_id = lyx_user.id')
            ->field('lyx_blogs_comment.id as comment_id,lyx_blogs_comment.content,lyx_blogs_comment.user_id,
            lyx_blogs_comment.create_time,lyx_user.name,lyx_user.head,lyx_user.sex,lyx_user.level,
            lyx_blogs_comment.reply_num,lyx_user.age,lyx_user.lng,lyx_user.lat')
            ->where(array('blogs_id'=>$article_list['blogs_id']))
            ->select();




        foreach($comment_list as $key=>$item){
            $comment_list[$key]['lng'] = $comment_list[$key]['lng']?$comment_list[$key]['lng']:"";
            $comment_list[$key]['lat'] = $comment_list[$key]['lat']?$comment_list[$key]['lat']:"";

            $comment_list[$key]['create_time'] = mdate($item['create_time']);
            if(!$item['name']){
                $comment_list[$key]['name'] = "";
            }
            if(!$item['head']){
                $comment_list[$key]['head'] = "";
            }

            if($lat&&$lng&&$item['lat']&&$item['lng']){
                $comment_list[$key]['dis'] = getDistance($item['lat'],$item['lng'],$lat,$lng);
            }else{
                $comment_list[$key]['dis'] ='';
            }

            //$comment_list[$key]['zan'] = WanChu($item['zan']);
            if($item['user_id']==$article_list['user_id']){
                $comment_list[$key]['is_self'] = '1';
            }else{
                $comment_list[$key]['is_self'] = '0';
            }

            $reply_list = $blogs_reply
                ->join('lyx_user ON lyx_blogs_reply.user_id = lyx_user.id')
                ->field('lyx_blogs_reply.id as reply_id,lyx_blogs_reply.user_id,lyx_blogs_reply.appoint_user_id,lyx_blogs_reply.reply_content,lyx_user.name')
                ->where(array('lyx_blogs_reply.comment_id'=>$item['comment_id']))
                ->order('lyx_blogs_reply.create_time')
                ->limit(3)
                ->select();

            if($reply_list){
                foreach($reply_list as $key1=>$val){
                    if(!$val['name']){
                        $reply_list[$key1]['name'] = "";
                    }

                    if($val['appoint_user_id']){
                        $appoint_name = $user->where(array('id'=>$val['appoint_user_id']))->field('name')->find();
                        if(!$appoint_name['name']){
                            $appoint_name['name'] = '';
                        }
                        $reply_list[$key1]['appoint_user_name'] = $appoint_name['name'];
                    }else{
                        $reply_list[$key1]['appoint_user_name'] = '';
                    }
                }
            }


            $comment_list[$key]['reply_list'] = $reply_list;

        }

        $article_list['comment_list'] =  $comment_list;



        //图片
        $new_img_list = array();
        $img_list = $user_blogs_photo->where(array('blogs_id'=>$article_list['blogs_id']))->select();
        if($img_list){
            foreach($img_list as $key2=>$val){
                $new_img_list[] = $val['img_url'];
                if ($key2==0){
                    $list['img_width'] = $val['width'];
                    $list['img_height'] = $val['height'];
                }
            }
        }
        $article_list['img_list'] =  $new_img_list;



        /*        $article_list['share_url'] = XUANIP.'/Home/share/index/type/1/aid/'.$article_list['blogs_id'];

                if($article_list['type']=='1'){
                    $article_list['share_icon'] = $img_list[0]['thumb'];
                }else if($article_list['type']=='2'){
                    $article_list['share_icon'] = $article_list['video_icon'];
                }else{
                    $article_list['share_icon'] = XUANIP.'/logo.jpg';
                }

                $article_list['share_info'] = '伊美小天鹅分享';*/
        if($article_list['type']=='1'){
            $is_thumb = M('cache')->where(array('url'=>$img_list[0]['img_url']))->find();
            if($is_thumb['thumb']){
                $article_list['share_icon'] = $is_thumb['thumb'];
            }else{
                $article_list['share_icon'] = '';
            }

        }else if($article_list['type']=='2'){
            $article_list['share_icon'] = $article_list['video_icon'];
        }else{
            $article_list['share_icon'] = '';
        }

        //自己是否有点赞
        $zan_list = $blogs_zan
            ->limit(7)
            ->join('lyx_user ON lyx_user.id = lyx_blogs_zan.user_id')
            ->field('lyx_user.id,lyx_user.head')
            ->order('lyx_blogs_zan.create_time desc')
            ->where(['blogs_id'=>$article_list['blogs_id']])
            ->select();



        $is_zan = $blogs_zan->where(array('blogs_id'=>$article_list['blogs_id'],'user_id'=>$user_info['id']))->find();
        if($is_zan){
            $article_list['is_zan'] =  '1';
        }else{
            $article_list['is_zan'] =  '0';
        }
        $article_list['create_time'] =  mdate($article_list['create_time']);
        $article_list['browse'] =  '浏览 '.WanChu($article_list['browse']);

        unset($article_list['video_icon']);




        $ad_odds_info = M('set')->where(array('set_type'=>'ad_show_odds'))->find();
        $ad_odds = $ad_odds_info['set_value'];
        $rand_num = rand(1,100);


        $is_goods = '0';
      /*  $goods_info = array(
            "goods_id"=>"",
            "shop_name"=>"",
            "name"=>"",
            "cover"=>"",
            "price"=>"",
            "sales"=>"",
        );*/
        $goods_info = array();
        if($ad_odds >= $rand_num){
            $where_ad['is_take'] = 1;
            $where_ad['is_show'] = 1;
            $where_ad['is_freeze'] = 1;
            $show_num = rand(1,3);
            $ad_info = M('ad')->where($where_ad)->order('rand()')->limit($show_num)->select();
            if($ad_info){
                $is_goods = '1';
                foreach ($ad_info as $item){
                    $goods_info[] = $shop_goods
                        ->join('lyx_shop ON lyx_shop_goods.shop_id = lyx_shop.id')
                        ->where(array('lyx_shop_goods.id'=>$item['goods_id']))
                        ->order('rand()')
                        ->field('lyx_shop_goods.id as goods_id,lyx_shop.name as shop_name,lyx_shop_goods.name,lyx_shop_goods.cover,lyx_shop_goods.price,
            lyx_shop_goods.sales')
                        ->find();

                    $now_show = $item['now_show']+1;
                    if($item['type']=='2'){
                        if($item['show_num']!='0'){
                            if($now_show>=$item['show_num']){
                                $save_ad['is_take'] = 0;
                            }
                        }
                    }
                    $save_ad['now_show'] = $now_show;
                    $save_ad['update_time'] = time();
                    M('ad')->where(array('id'=>$item['id']))->save($save_ad);

                    unset($save_ad);
                }

            }
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'collect_id' => $collect_id,
            'is_collect' => $is_collect,
            'list' => $article_list,
            'zan_list' => $zan_list,
            'is_goods' => $is_goods,
            'goods_info' => $goods_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 动态-全部回复
     */
    function ReplyAll(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $blogs_comment = M('blogs_comment');
        $blogs_reply = M('blogs_reply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $comment_id = decrypt1(trim(I('post.comment_id')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $page = decrypt1(trim(I('post.page')));
        //$check_type = decrypt1(trim(I('post.check_type')));//评论排序方式：1根据最新时间排序，2根据最热排序
        //if(!$check_type){$check_type = 1;}
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$comment_id = 2;

        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }


        $list = $blogs_comment->field('blogs_id,user_id,create_time,content')->where(array('id'=>$comment_id))->find();

        $com_user = $user->where(array('id'=>$list['user_id']))->field('name,head,lng,lat,age,level,sex')->find();
        $list['name'] = $com_user['name'];
        $list['head'] = $com_user['head'];
        $list['sex'] = $com_user['sex'];
        $list['age'] = $com_user['age'];
        $list['level'] = $com_user['level'];
        $list['create_time'] = mdate($list['create_time']);;
        $list['dis'] =getDistance($com_user['lat'],$com_user['lng'],$lat,$lng);


        $article_info = $user_blogs->where(array('id'=>$list['blogs_id']))->field('user_id')->find();


        $reply_list = $blogs_reply
            ->limit($start,$num)
            ->join('lyx_user ON lyx_blogs_reply.user_id = lyx_user.id')
            ->field('lyx_blogs_reply.id as reply_id,lyx_blogs_reply.user_id,
            lyx_blogs_reply.appoint_user_id,lyx_blogs_reply.reply_content,
            lyx_user.name,lyx_user.head,lyx_blogs_reply.create_time,lyx_user.age,lyx_user.sex,lyx_user.level,lyx_user.lng,lyx_user.lat')
            ->where(array('lyx_blogs_reply.comment_id'=>$comment_id))
            ->order('lyx_blogs_reply.create_time desc')
            ->select();

        if($reply_list){
            foreach($reply_list as $key1=>$val){

                if($article_info['user_id']==$val['user_id']){
                    $reply_list[$key1]['is_self'] = '1';
                }else{
                    $reply_list[$key1]['is_self'] = '0';
                }

                $reply_list[$key1]['create_time'] = mdate($val['create_time']);

                if(!$val['name']){
                    $reply_list[$key1]['name'] = "";
                }
                if(!$val['head']){
                    $reply_list[$key1]['head'] = "";
                }

                if($lat&&$lng&&$val['lat']&&$val['lng']){
                    $reply_list[$key1]['dis'] = getDistance($val['lat'],$val['lng'],$lat,$lng);
                }else{
                    $reply_list[$key1]['dis'] ='';
                }



                if($val['appoint_user_id']){
                    $appoint_name = $user->where(array('id'=>$val['appoint_user_id']))->field('name')->find();
                    if(!$appoint_name['name']){
                        $appoint_name['name'] = '';
                    }
                    $reply_list[$key1]['appoint_user_name'] = $appoint_name['name'];
                }else{
                    $reply_list[$key1]['appoint_user_name'] = '';
                }

            }
        }


        //$list['reply_list'] = $reply_list;

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'comment_info' => $list,
            'list' => $reply_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 动态-删除
     */
    function BlogsDelete(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $blogs_zan = M('blogs_zan');
        $user_blogs_photo = M('user_blogs_photo');
        $blogs_comment = M('blogs_comment');
        $blogs_reply = M('blogs_reply');
        $report = M('report');
        //$system = M('system');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.blogs_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $blogs_info = $user_blogs->where(array('id'=>$blogs_id))->field('user_id')->find();
        if ($blogs_info['user_id']!=$user_info['id']){
            $arr = array('code'=> 0, 'res'=>'没有删除权限');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        $query = $user_blogs->where(array('id'=>$blogs_id))->delete();

        $res = '删除';
        if($query){


            $user_blogs_photo->where(array('blogs_id'=>$blogs_id))->delete();
            $blogs_zan->where(array('blogs_id'=>$blogs_id))->delete();
            $report->where(array('report_id'=>$blogs_id,'report_type'=>'2'))->delete();
            $comment_list = $blogs_comment->where(array('blogs_id'=>$blogs_id))->select();
            if ($comment_list){
                foreach ($comment_list as $item){
                    $blogs_reply->where(array('comment_id'=>$item['id']))->delete();
                    //$system->where(array('status'=>'1','type'=>array('IN','2,3'),'type_id'=>$item['id']))->delete();
                }
            }
            //$system->where(array('status'=>'1','type'=>1,'type_id'=>$blogs_id))->delete();
            $blogs_comment->where(array('blogs_id'=>$blogs_id))->delete();


            //同步删除朋友圈
            /*if ($blogs_info['parent']){
                $article = M('article');
                $query2 = $article->where(array('id'=>$blogs_info['parent']))->delete();
                if ($query2){
                    $article_phone = M('article_photo');
                    $article_zan = M('article_zan');
                    $article_comment = M('article_comment');
                    $message = M('message');
                    $article_phone->where(array('article_id'=>$blogs_info['parent']))->delete();
                    $article_zan->where(array('article_id'=>$blogs_info['parent']))->delete();
                    $article_comment->where(array('article_id'=>$blogs_info['parent']))->delete();
                    $message->where(array('article_id'=>$blogs_info['parent']))->delete();
                }

            }*/

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 群组-新建
     */
    function CreateGroup(){
        $user = M('user');
        $group_user = M('group_user');
        $group = M('group');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_name = decrypt1(trim(I('post.group_name')));
        $logo = decrypt1(trim(I('post.logo')));
        $classify_id = decrypt1(trim(I('post.classify_id')));
        $introduce = decrypt1(trim(I('post.introduce')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $location = decrypt1(trim(I('post.location')));
        $user_list = decrypt1(trim(I('post.user_list')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        /*if (!$lng || !$lat){
            $arr = array(
                'code'=> 0,
                'res'=>'请先开启GPS定位',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/
        if(!$group_name){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入群昵称',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if(!$introduce){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入群介绍',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
       /* if(strlen($group_name)>20){
            $arr = array(
                'code'=> 0,
                'res'=>'群昵称最长为20个字符',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/
        /*$where_name['group_name'] = $group_name;
        $is_name = $group->where($where_name)->find();
        if($is_name){
            $arr = array(
                'code'=> 0,
                'res'=>'群昵称已存在',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/
        /*if(!$user_list){
            $arr = array(
                'code'=> 0,
                'res'=>'请至少选择一个好友',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/

        if (!$logo){
            $logo = XUANIMG.'/Public/image/group.png';
        }
        $id = GetGroupID();
        $add['id'] = $id;
        $add['group_name'] = $group_name;
        $add['logo'] = $logo;
        $add['user_id'] = $user_info['id'];
        $add['classify_id'] = $classify_id;
        $add['introduce'] = $introduce;
        $add['lng'] = $lng;
        $add['lat'] = $lat;
        $add['location'] = $location;
        $add['create_time'] = time();
        $add['notice_time'] = time();
        $add['max'] = 1;
        $query = $group->add($add);
        $res = '创建';
        if($query){
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->group()->create($user_info['id'],$query,$group_name);
            $rongres =  json_decode($result,true);
            if($result){
                //创建群组
            }


            $add_group_user['group_id'] = $query;
            $add_group_user['user_id'] = $user_info['id'];
            $add_group_user['type'] = 1;
            $add_group_user['is_open'] = 1;
            $add_group_user['is_tick'] = 0;
            $add_group_user['create_time'] = time();
            $group_user->add($add_group_user);
            if ($user_list){
                $user_list2 = explode(',',$user_list);
                foreach ($user_list2 as $item){
                    $add_group_user['group_id'] = $query;
                    $add_group_user['user_id'] = $item;
                    $add_group_user['type'] = 3;
                    $add_group_user['is_open'] = 1;
                    $add_group_user['is_tick'] = 0;
                    $add_group_user['create_time'] = time();
                    $group_user->add($add_group_user);
                    $result2 = $RongCloud->group()->join($item,$query,$group_name);
                }
            }




            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
                'group_id'=>$query,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 群组分类数据
     */
    function GroupTypeList(){
        $group_type = M('group_type');
        $type_list = $group_type->order('create_time desc')->field('id,type_name')->select();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'type_list' => $type_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 群组-群资料
     */
    function GroupDetail(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $group_type = M('group_type');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $group_info = $group->where(array('id'=>$group_id))->field('id as group_id,notice,group_name,logo,notice_time,max,classify_id')->find();
        $group_info['group_user_count'] = $group_user->where(array('group_id'=>$group_id))->count();

        $group_info['group_user_list'] = $group_user
            ->limit(10)
            ->join('lyx_user ON lyx_group_user.user_id = lyx_user.id')
            ->order('lyx_group_user.type')
            ->where(array('group_id'=>$group_id))
            ->field('lyx_group_user.user_id,lyx_user.name,lyx_user.head,lyx_group_user.type')->select();
        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        $group_info['is_open'] = $my_group_info['is_open'];
        $group_info['my_type'] = $my_group_info['type'];
        $group_info['is_stick'] = $my_group_info['is_stick'];
        if ($group_info['notice_time']){
            $group_info['notice_time'] = date('Y-m-d H:i',$group_info['notice_time']);
        }else{
            $group_info['notice_time'] = '';
        }
        if (!$group_info['notice']){
            $group_info['notice'] = '';
        }

        $type_name = $group_type->where(array('id'=>$group_info['classify_id']))->field('type_name')->find();
        $group_info['classify_name'] = $type_name['type_name'];


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_info' => $group_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-管理群资料
     */
    function GroupGlDetail(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $group_type = M('group_type');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $group_info = $group->where(array('id'=>$group_id))->field('id as group_id,introduce,group_name,logo,classify_id,max,location,lng,lat')->find();

        //$group_info['group_user_count'] = $group_user->where(array('group_id'=>$group_id))->count();
        $type_name = $group_type->where(array('id'=>$group_info['classify_id']))->field('type_name')->find();
        $group_info['classify_name'] = $type_name['type_name'];

        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        $group_info['my_type'] = $my_group_info['type'];

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_info' => $group_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-查看群公告
     */
    function CheckGroupNotice(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));

       // $token = "be196855ebf12c739990376a58376317";
       // $group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $group_info = $group->where(array('id'=>$group_id))->field('id as group_id,notice,group_name,logo,notice_time')->find();
        if ($group_info['notice_time']){
            $group_info['notice_time'] = date('Y-m-d H:i',$group_info['notice_time']);
        }else{
            $group_info['notice_time'] = '';
        }

        if (!$group_info['notice']){
            $group_info['notice'] = '';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_info' => $group_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 群组-修改群公告
     */
    function EditGroupNotice(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $notice = decrypt1(trim(I('post.notice')));

        // $token = "be196855ebf12c739990376a58376317";
        // $group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$notice){
            $arr = array(
                'code'=> 0,
                'res'=>'群公告不能为空',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        if (!$my_group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($my_group_info['type']=='3'){
            $arr = array(
                'code'=> 0,
                'res'=>'只有群主和管理员可修改群公告',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $group->where(array('id'=>$group_id))->save(array('notice'=>$notice,'notice_time'=>time()));
        $res = '修改';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-群成员列表
     */
    function GroupUserList(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1全部，2非管理员用户,3去群主
        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));
        if (!$type){$type='1';}
        if(!$page){$page = 1;}
        $num = 31;//分页数
        $start = ($page-1)*$num;

        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //$group_info = $group->where(array('id'=>$group_id))->field('id as group_id,introduce,group_name,logo,notice_time,max,location,classify_id')->find();
        //$group_info['group_user_count'] = $group_user->where(array('group_id'=>$group_id))->count();

        $where['group_id'] = $group_id;
        if ($type=='2'){
            $where['type'] = 3;
        }
        if ($type=='3'){
            $where['type'] = array('IN','2,3');
        }
        if ($search){
            $where['lyx_user.name'] =  array("like","%".$search."%");
        }
        $group_user_list = $group_user
            ->limit($start,$num)
            ->join('lyx_user ON lyx_group_user.user_id = lyx_user.id')
            ->order('lyx_group_user.type')
            ->where($where)
            ->field('lyx_group_user.user_id,lyx_user.name,lyx_user.head,lyx_group_user.type')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_user_list' => $group_user_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 群组-群成员列表不分页
     */
    function GroupUserListAll(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1全部，2非管理员用户,3去群主
        $page = decrypt1(trim(I('post.page')));
        $search = decrypt1(trim(I('post.search')));
        if (!$type){$type='1';}
        if(!$page){$page = 1;}
        $num = 31;//分页数
        $start = ($page-1)*$num;

        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //$group_info = $group->where(array('id'=>$group_id))->field('id as group_id,introduce,group_name,logo,notice_time,max,location,classify_id')->find();
        //$group_info['group_user_count'] = $group_user->where(array('group_id'=>$group_id))->count();

        $where['group_id'] = $group_id;
        if ($type=='2'){
            $where['type'] = 3;
        }
        if ($type=='3'){
            $where['type'] = array('IN','2,3');
        }
        if ($search){
            $where['lyx_user.name'] =  array("like","%".$search."%");
        }
        $where['lyx_group_user.user_id'] = array('NEQ',$user_info['id']);
        $group_user_list = $group_user
            ->join('lyx_user ON lyx_group_user.user_id = lyx_user.id')
            ->order('lyx_group_user.type')
            ->where($where)
            ->field('lyx_group_user.user_id,lyx_user.name,lyx_user.head,lyx_group_user.type')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_user_list' => $group_user_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-群管理员列表
     */
    function GroupAdminList(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //$group_info = $group->where(array('id'=>$group_id))->field('id as group_id,introduce,group_name,logo,notice_time,max,location,classify_id')->find();
        //$group_info['group_user_count'] = $group_user->where(array('group_id'=>$group_id))->count();
        $group_user_list = $group_user
            ->join('lyx_user ON lyx_group_user.user_id = lyx_user.id')
            ->order('lyx_group_user.type')
            ->where(array('group_id'=>$group_id,'type'=>array('IN','1,2')))
            ->field('lyx_group_user.user_id,lyx_user.name,lyx_user.head,lyx_group_user.type')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_user_list' => $group_user_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     *群组-添加管理员
     */
    function GroupSetAdmin(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $user_id = decrypt1(trim(I('post.user_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();
        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        $other_group_info = $group_user->where(array('user_id'=>$user_id,'group_id'=>$group_id))->find();

        if($group_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'只有群主可设置管理员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($user_info['id']==$user_id){
            $arr = array(
                'code'=> 0,
                'res'=>'不能设置自己为管理员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if(!$other_group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'群员不存在',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($other_group_info['type']=='2'){
            $arr = array(
                'code'=> 0,
                'res'=>'此群员已经是管理员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $admin_num = $group_user->where(array('group_id'=>$group_id,'type'=>'2'))->count();
        if ($group_info['max']=='1'){
            if ($admin_num>=10){
                $arr = array(
                    'code'=> 0,
                    'res'=>'管理员人数超出，500人群管理员上限人数为10个',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        if ($group_info['max']=='2'){
            if ($admin_num>=15){
                $arr = array(
                    'code'=> 0,
                    'res'=>'管理员人数超出，1000人群管理员上限人数为15个',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        if ($group_info['max']=='3'){
            if ($admin_num>=20){
                $arr = array(
                    'code'=> 0,
                    'res'=>'管理员人数超出，2000人群管理员上限人数为20个',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        if ($group_info['max']=='4'){
            if ($admin_num>=20){
                $arr = array(
                    'code'=> 0,
                    'res'=>'管理员人数超出，3000人群管理员上限人数为30个',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        $save['type'] = 2;
        $save['update_time'] = time();
        $query = $group_user->where(array('id'=>$other_group_info['id']))->save($save);

        $res = '添加';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-删除管理员
     */
    function GroupDeleteAdmin(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $user_id_val = decrypt1(trim(I('post.user_id_val')));


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();

        if($group_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'只有群主可删除管理员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $user_id_list = explode(',',$user_id_val);
        foreach ($user_id_list as $item){
            if($user_info['id']==$item){
                $arr = array(
                    'code'=> 0,
                    'res'=>'不能设置自己为管理员',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $other_group_info = $group_user->where(array('user_id'=>$item,'group_id'=>$group_id))->find();
            if (!$other_group_info || $other_group_info['type']!='2'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'群员信息错误',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        foreach ($user_id_list as $item){
            $save['type'] = 3;
            $save['update_time'] = time();
            $query  = $group_user->where(array('user_id'=>$item,'group_id'=>$group_id))->save($save);


            $where_del_apply['type'] = 2;
            $where_del_apply['group_id'] = $group_id;
            $where_del_apply['friend_user_id'] = $item;
            $user_friend_apply->where($where_del_apply)->delete();
        }
        $res = '删除';
        if($query){


            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 群组-升级群
     */
    function UpgradeGroup(){
        $user = M('user');
        $group = M('group');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $type = decrypt1(trim(I('post.type')));//1五百人，2一千人，3两千人，4三千人

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();
        if($group_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'需群主才能升级',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if($type<=$group_info['max']){
            $arr = array(
                'code'=> 0,
                'res'=>'升级不能小于当前群规模',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if($type=='2' || $type=='3'){
            if($user_info['vip']=='0'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'需要月VIP或年VIP才可升级',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }else{
            if($user_info['vip']!='2'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'需要年VIP才可升级3000人的群',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        $query = $group->where(array('id'=>$group_id))->save(array('max'=>$type,'update_time'=>time()));
        $res = '升级';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 群组-转让群
     */
    function GroupTransfer(){
        $user = M('user');
        $user_friend = M('user_friend');
        $group = M('group');
        $group_user = M('group_user');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $user_id = decrypt1(trim(I('post.user_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();

        if($group_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'只有群主才能转让群',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($user_info['id']==$user_id){
            $arr = array(
                'code'=> 0,
                'res'=>'您已经是群主',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $other_user_info = $user->where(array('id'=>$user_id))->find();
        if($other_user_info['vip']!=$user_info['vip']){
            $arr = array(
                'code'=> 0,
                'res'=>'接受的群员VIP等级与您的VIP等级不相同，无法转让',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $other_group_info = $group_user->where(array('user_id'=>$user_id,'group_id'=>$group_id))->find();
        if(!$other_group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'该用户不是此群群员，无法转让',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_friend['user_id'] = $user_info['id'];
        $where_friend['friend_user_id'] = $user_id;
        $is_friend = $user_friend->where($where_friend)->find();
        if(!$is_friend){
            $arr = array(
                'code'=> 0,
                'res'=>'该群员不是此您的好友，无法转让，请添加好友后再转让',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $group->where(array('id'=>$group_id))->save(array('user_id'=>$user_id,'update_time'=>time()));

        $res = '转让';
        if($query){
            $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->save(array('type'=>'3','update_time'=>time()));
            $group_user->where(array('user_id'=>$user_id,'group_id'=>$group_id))->save(array('type'=>'1','update_time'=>time()));

            $where_del_apply['type'] = 2;
            $where_del_apply['group_id'] = $group_id;
            $where_del_apply['friend_user_id'] = $user_info['id'];
            $user_friend_apply->where($where_del_apply)->delete();

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 群组-转让群用户选择
     */
    function GroupTransferUserList(){
        $user = M('user');
        $user_friend = M('user_friend');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));

        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "3";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();

        if($group_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'只有群主才能转让群',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $where['lyx_group_user.group_id'] = $group_id;
        $where['lyx_group_user.type'] = array('IN','2,3');
        $where['lyx_user_friend.user_id'] = $user_info['id'];
        $user_list = $group_user->where($where)
            ->join('lyx_user_friend ON lyx_group_user.user_id = lyx_user_friend.friend_user_id')
            ->order('lyx_group_user.type,lyx_group_user.create_time')
            ->field('lyx_group_user.user_id,lyx_group_user.type')
            ->select();
        foreach ($user_list as $key=>$item){
            $user_name = $user->where(array('id'=>$item['user_id']))->field('name,head,vip')->find();
            $user_list[$key]['name'] = $user_name['name'];
            $user_list[$key]['head'] = $user_name['head'];
            $user_list[$key]['vip'] = $user_name['vip'];
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $user_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-退出群
     */
    function GroupQuit(){
        $user = M('user');
        $user_friend = M('user_friend');
        $group = M('group');
        $group_user = M('group_user');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();


        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        if (!$my_group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您不是该群群成员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($group_info['user_id']==$user_info['id']){

            $query = $group->where(array('id'=>$group_id))->delete();
            $query = $user_friend_apply->where(array('group_id'=>$group_id,'type'=>'2'))->delete();
            $query = $group_user->where(array('group_id'=>$group_id))->delete();

        }else{
            $query = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->delete();
        }


        $res = '退出';
        if($query){

            if($group_info['user_id']==$user_info['id']){
                $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                $result = $RongCloud->group()->dismiss($user_info['id'],$group_id);
                $rongres =  json_decode($result,true);
                if($result){

                }
            }else{
                $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                $result = $RongCloud->group()->quit($user_info['id'],$group_id);
                $rongres =  json_decode($result,true);
                if($result){

                }
            }

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-同意入群申请
     */
    function GroupSuccessApply(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $apply_id = decrypt1(trim(I('post.apply_id')));


        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$apply_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $apply_info = $user_friend_apply->where(array('id'=>$apply_id))->find();
        if($apply_info['friend_user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限操作',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $group_info = $group->where(array('id'=>$apply_info['group_id']))->find();


        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$apply_info['group_id']))->find();
        if($my_group_info['type']=='3'){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限操作',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($apply_info['status']!='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您已接受，请勿重复操作',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($apply_info['type']!='2'){
            $arr = array(
                'code'=> 0,
                'res'=>'请求错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_group_user['user_id'] = $apply_info['user_id'];
        $where_group_user['group_id'] = $apply_info['group_id'];
        $is_join = $group_user->where($where_group_user)->find();
        if($is_join){
            $arr = array(
                'code'=> 0,
                'res'=>'此用户已经加入群',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if ($group_info['max']=='1'){$max = 500;}
        if ($group_info['max']=='2'){$max = 1000;}
        if ($group_info['max']=='3'){$max = 2000;}
        if ($group_info['max']=='4'){$max = 3000;}
        $count_num = $group_user->where(array('group_id'=>$group_info['id']))->count();

        if ($count_num>$max){
            $arr = array(
                'code'=> 0,
                'res'=>'群组已满人，无法再添加新成员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }



        $add['user_id'] = $apply_info['user_id'];
        $add['group_id'] = $apply_info['group_id'];
        $add['type'] = 3;
        $add['success_user_id'] = $user_info['id'];
        $add['create_time'] = time();
        $query = $group_user->add($add);
        $res = '操作';
        if($query){

            $save['status'] = '1';
            $save['update_time'] = time();
            $user_friend_apply->where(array('group_id'=>$apply_info['group_id'],'user_id'=>$apply_info['user_id']))->save($save);

            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->group()->join($apply_info['user_id'],$apply_info['group_id'],$group_info['group_name']);
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 群组-删除用户（踢人）
     */
    function GroupDeleteUser(){
        $user = M('user');
        $user_friend = M('user_friend');
        $group = M('group');
        $group_user = M('group_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $user_id = decrypt1(trim(I('post.user_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $group_info = $group->where(array('id'=>$group_id))->find();


        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        if (!$my_group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您不是该群群成员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($my_group_info['type']=='3'){
            $arr = array(
                'code'=> 0,
                'res'=>'只有群主和管理员可删除群成员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($user_info['id']==$user_id){
            $arr = array(
                'code'=> 0,
                'res'=>'不能将自己移除群',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $other_group_info = $group_user->where(array('user_id'=>$user_id,'group_id'=>$group_id))->find();
        if (!$other_group_info) {
            $arr = array(
                'code'=> 0,
                'res'=>'该用户不是此群成员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($other_group_info['type']=='1') {
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($other_group_info['type']=='2') {
            if ($my_group_info['type']!='1'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'没有权限',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }
        $query = $group_user->where(array('user_id'=>$user_id,'group_id'=>$group_id))->delete();
        $res = '删除';
        if($query){
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->group()->quit($user_id,$group_id);
            $rongres =  json_decode($result,true);
            if($result){

            }
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 群组-加群群资料
     */
    function GroupApplyDetail(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $group_type = M('group_type');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $group_info = $group->where(array('id'=>$group_id))->field('id as group_id,introduce,group_name,logo,classify_id,max,location,lng,lat')->find();

        //$group_info['group_user_count'] = $group_user->where(array('group_id'=>$group_id))->count();
        $type_name = $group_type->where(array('id'=>$group_info['classify_id']))->field('type_name')->find();
        $group_info['classify_name'] = $type_name['type_name'];

        $group_info['group_num'] = $group_user->where(array('group_id'=>$group_id))->count();
        $is_join = $group_user->where(array('group_id'=>$group_id,'user_id'=>$user_info['id']))->find();
        if ($is_join){
            $group_info['is_join']  = '1';
        }else{
            $group_info['is_join']  = '0';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'group_info' => $group_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-修改群资料
     */
    function GroupEditDetail(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $group_type = M('group_type');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1修改群分类，2修改群位置，3修改群介绍,4群logo,5群名称
        $classify_id = decrypt1(trim(I('post.classify_id')));
        $introduce = decrypt1(trim(I('post.introduce')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $location = decrypt1(trim(I('post.location')));
        $logo = decrypt1(trim(I('post.logo')));
        $group_name = decrypt1(trim(I('post.group_name')));



        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //$group_info = $group->where(array('id'=>$group_id))->find();
        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();

        if ($my_group_info['type']=='3'){
            $arr = array(
                'code'=> 0,
                'res'=>'仅群主或管理员可修改群资料',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($type=='1'){
            if (!$classify_id){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请选择要修改的群分类',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['classify_id'] = $classify_id;
        }
        if ($type=='2'){
            $save['lng'] = $lng;
            $save['lat'] = $lat;
            $save['location'] = $location;
        }
        if ($type=='3'){
            if (!$introduce){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请输入群介绍',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['introduce'] = $introduce;
        }
        if ($type=='4'){
            if (!$logo){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请上传群logo',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['logo'] = $logo;
        }
        if ($type=='5'){
            if (!$group_name){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请输入群名称',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['group_name'] = $group_name;
        }
        $save['update_time'] = time();
        $query = $group->where(array('id'=>$group_id))->save($save);
        $res = '修改';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 群组-我加入的群组
     */
    function GroupMyGroup(){
        $user = M('user');
        $group = M('group');
        $group_user = M('group_user');
        $group_type = M('group_type');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$token = "be196855ebf12c739990376a58376317";
        //$group_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['lyx_group_user.user_id'] = $user_info['id'];
        $group_list = $group_user
            ->limit($start,$num)
            ->join('lyx_group ON lyx_group_user.group_id = lyx_group.id')
            ->field('lyx_group_user.group_id,lyx_group.group_name,lyx_group.logo')
            ->where($where)->order('lyx_group.create_time desc')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $group_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 群组-申请加群
     */
    function GroupApplyJoin(){
        $user = M('user');
        $user_friend = M('user_friend');
        $group = M('group');
        $group_user = M('group_user');
        $user_friend_apply = M('user_friend_apply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $group_id = decrypt1(trim(I('post.group_id')));
        $content = decrypt1(trim(I('post.content')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $group_info = $group->where(array('id'=>$group_id))->find();
        if(!$group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'群不存在或已解散',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $my_group_info = $group_user->where(array('user_id'=>$user_info['id'],'group_id'=>$group_id))->find();
        if($my_group_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您已经是该群群成员',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $group_list = $group_user->where(array('group_id'=>$group_id,'type'=>array('IN','1,2')))->field('user_id')->select();
        foreach ($group_list as $item){
            $where['type'] = 2;
            $where['group_id'] = $group_id;
            $where['friend_user_id'] = $item['user_id'];
            $where['user_id'] = $user_info['id'];
            $is_apply = $user_friend_apply->where($where)->find();
            if ($is_apply){
                $save['content'] = $content;
                $save['is_read'] = 0;
                $save['status'] = 0;
                $save['create_time'] = time();
                $query = $user_friend_apply->where($where)->save($save);
            }else{
                $add['type'] = 2;
                $add['content'] = $content;
                $add['group_id'] = $group_id;
                $add['friend_user_id'] = $item['user_id'];
                $add['user_id'] = $user_info['id'];
                $add['is_read'] = 0;
                $add['create_time'] = time();
                $query = $user_friend_apply->add($add);
            }
            //$send_status = SendSocket($item['user_id'],'new_add');
            $tz_con['type'] = 'new_add';
            $send_status = SendSocket($item['user_id'],json_encode($tz_con));
        }




        $res = '申请';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }


    /**
     * 我的好友列表
     */
    function MyFriendList(){
        $user = M('user');
        $user_friend = M('user_friend');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where_friend['user_id'] = $user_info['id'];
        $friend_list = $user_friend
            ->join('lyx_user ON lyx_user_friend.friend_user_id =lyx_user.id')
            ->where($where_friend)->field('lyx_user.id as user_id,lyx_user.name,lyx_user.head,remark_name')->select();

        foreach ($friend_list as $key=>$item){
            if ($item['remark_name']){
                $friend_list[$key]['name'] = $item['remark_name'];
            }
            unset($friend_list[$key]['remark_name']);
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'friend_list' => $friend_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 获取别人的融云token
     */
    function OtherRongCloudToken(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));

        //$token = "329d458ffd8b7bde2a13bd33a71d867a";


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if($user_id=='system'){
            $user_other = $user->where(array('phone'=>$user_id))->find();
        }else{
            $user_other = $user->where(array('id'=>$user_id))->find();
        }

        if(!$user_other){$arr = array('code'=> 0, 'res'=>'用户不存在');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_other['rong_token']){
            $rong_token = $user_other['rong_token'];
        }else{

            //融云token
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            if($user_id=='system'){
                $result = $RongCloud->user()->getToken($user_other['id'], $user_other['name'],$user_other['head']);
                $rongres =  json_decode($result,true);
                if($result){
                    $user->where(array('id'=>$user_id))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                }
            }else{
                $result = $RongCloud->user()->getToken($user_other['id'], $user_other['name'],$user_other['head']);
                $rongres =  json_decode($result,true);
                if($result){
                    $user->where(array('phone'=>$user_id))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
                }
            }

            $rong_token  =  $rongres['token'];
        }
    /*    $where_friend['user_id'] = $user_info['id'];
        $where_friend['friend_user_id'] = $user_other['id'];
        $remark_name = $user_friend->where($where_friend)->field('remark_name')->find();
        if ($remark_name['remark_name']){
            $user_other['name'] = $remark_name['remark_name'];
        }*/
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'rong_token'=>$rong_token,
            'user_id'=>$user_other['id'],
            'name'=>$user_other['name'],
            'head'=>$user_other['head'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     * 获取自己的融云token
     */
    function MyRongCloudToken(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "329d458ffd8b7bde2a13bd33a71d867a";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if($user_info['rong_token']){
            $rong_token = $user_info['rong_token'];
        }else{
            //融云token
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->getToken($user_info['id'], $user_info['name'],$user_info['head']);
            $rongres =  json_decode($result,true);
            if($result){
                $user->where(array('id'=>$user_info['id']))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
            }
            $rong_token  =  $rongres['token'];
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'rong_token'=>$rong_token,
            'user_id'=>$user_info['id'],
            'name'=>$user_info['name'],
            'head'=>$user_info['head'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 检查是否有红包
     */
    function TaskCheck(){
        $task = M('task');
        $user = M('user');
        $task_prize = M('task_prize');
        $ticket = M('ticket');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['user_id'] =$user_info['id'];
        $where['status'] = 0;
        $where['is_read'] = 0;
        $where['is_pay'] = 1;
        $list = $task->where($where)->field('id,name,prize,prize_num,prize_id,classes')->select();

        if($list){
            foreach ($list as $key=>$item){
                $list[$key]['ticket_type'] = '1';
                $list[$key]['prize_num'] = (String)floatval($item['prize_num']);
                if($item['prize']=='1'){
                    $ticket_info = $task_prize->where(array('id'=>$item['prize_id']))->field('parent,discount')->find();
                    if($ticket_info['discount']!='0'){
                        $list[$key]['prize_num'] = (String)floatval($ticket_info['discount']/10);
                    }else{
                        $list[$key]['ticket_type'] = '2';
                        $dis_title = $ticket->where(array('id'=>$ticket_info['parent']))->field('dis_title')->find();
                        $list[$key]['prize_num'] = $dis_title['dis_title'];
                    }
                }else{
                    $list[$key]['prize_num'] = (String)floatval($item['prize_num']);
                }



            }

            $arr = array(
                'code'=> 1,
                'res'=>'查询成功',
                'list'=>$list
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'没有红包',
                'list'=>$list
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 红包已读设置
     */
    function TaskRead(){
        $task = M('task');
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $id_val = decrypt1(trim(I('post.id_val')));
        //$id_val = '16,17';
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $id_list = explode(',',$id_val);
        $where['user_id'] = $user_info['id'];
        foreach($id_list as $item){
            $where['id'] = $item;

            $task->where($where)->save(array('is_read'=>'1','update_time'=>time()));
        }
        $arr = array(
            'code'=> 1,
            'res'=>'设置成功',
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 个人中心
     */
    function UserInfo(){
        $user = M('user');
        $user_blogs = M('user_blogs');
        $user_blogs_photo = M('user_blogs_photo');
        $shop_order = M('shop_order');
        $hospital_order = M('hospital_order');
        $ticket_user = M('ticket_user');
        $collect = M('collect');
        $task = M('task');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "996bbda99f87b04e0c65adf3f5b2d2e1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list['user_id'] = $user_info['id'];
        $list['name'] = $user_info['name'];
        $list['head'] = $user_info['head'];
        $list['age'] = $user_info['age'];
        $list['sex'] = $user_info['sex'];
        $list['level'] = $user_info['level'];
        $list['is_gudong'] = $user_info['is_gudong'];

        //优惠券数量
        $list['ticket_num'] = 0;
        $list['ticket_num'] += $ticket_user->where(array('user_id'=>$user_info['id'],'status'=>0))->count();
        $list['ticket_num'] = (String)$list['ticket_num'];

        $where1['user_id'] = $user_info['id'];
        $where1['type'] = 2;
     /*   if  ($user_info['id']!='4' && $user_info['id']!='5' ){
            $where1['status'] = array('NEQ','0');
        }else{
            $where1['is_confirm'] =1;
        }*/
        $where1['is_confirm'] =1;
        $list['shop_order_num'] = 0;
        $list['shop_order_num'] += $shop_order->where($where1)->count();
        $list['shop_order_num'] = (String)$list['shop_order_num'];

        $where2['user_id'] = $user_info['id'];
        $where2['status'] = array('NEQ','0');
        $list['doc_order_num'] = 0;
        $list['doc_order_num'] += $hospital_order->where($where2)->count();
        $list['doc_order_num'] = (String)$list['doc_order_num'];



        $where3['user_id'] = $user_info['id'];
        $list['collect_num'] = 0;
        $list['collect_num'] += $collect->where($where3)->count();
        $list['collect_num'] = (String)$list['collect_num'];


        $blogs_count = 0;
        $blogs_count+=$user_blogs->where(array('user_id'=>$user_info['id']))->count();
        $list['blogs_count'] = (String)$blogs_count;

        $blogs_list = $user_blogs->where(array('user_id'=>$user_info['id'],'type'=>array('IN','1,2')))->limit(4)->order('create_time desc')->field('id,type,video_thumb')->select();
        foreach($blogs_list as $item){
            if ($item['type']=='1'){
                $img_info = $user_blogs_photo->where(array('blogs_id'=>$item['id']))->order('id')->field('img_url')->find();
                if ($img_info){
                    $img_list[] = $img_info['img_url'];
                }
            }else{
                $img_list[] = $item['video_thumb'];
            }
        }

        if($img_list){
            $list['img_list'] = $img_list;
        }else{
            $list['img_list'] = array();
        }
        $list['team_money'] = '0';
        $where_task['user_id'] = $user_info['id'];
        $where_task['is_pay'] = 1;
        $where_task['status'] = array('NEQ','2');
        $task_num = $task->where($where_task)->count();

        if($task_num>0){
            $list['is_task'] = '1';
        }else{
            $list['is_task'] = '0';
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     * APP状态查询接口
     */
    function AppStatus(){
        $set = M('set');

        $set_info = $set->where(array('set_type'=>'app_status'))->find();
        $set_info_ios = $set->where(array('set_type'=>'app_status_ios'))->find();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'status' => $set_info['set_value'],
            'status_ios' => $set_info_ios['set_value'],
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 支付宝绑定信息
     */
    function AliBindInfo(){
        $user = M('user');
        $ali = M('ali');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "996bbda99f87b04e0c65adf3f5b2d2e1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['ali_user_id']){
            $list['is_bind'] = '1';
            $ali_info = $ali->where(array('ali_user_id'=>$user_info['ali_user_id']))->find();
            $list['ali_head'] = $ali_info['head'];
            $list['name'] = $ali_info['name'];
            if(!$ali_info['name']){
                $list['name'] = '';
            }
            if(!$ali_info['head']){
                $list['ali_head'] = '';
            }
        }else{
            $list['is_bind'] = '0';
            $list['ali_head'] = '';
            $list['name'] = '';
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }




    /**
     * 支付宝绑定信息(小程序)
     */
    function AliBindInfoXcx(){
        $user = M('user');
        $ali = M('ali');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "996bbda99f87b04e0c65adf3f5b2d2e1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list['is_bind'] = false;
        if($user_info['ali_user_id']){
            $list['is_bind'] = true;
            $ali_info = $ali->where(array('ali_user_id'=>$user_info['ali_user_id']))->find();
            $list['ali_head'] = $ali_info['head'];
            $list['name'] = $ali_info['name'];
            if(!$ali_info['name']){
                $list['name'] = '';
            }
            if(!$ali_info['head']){
                $list['ali_head'] = '';
            }
            $list['bind_type'] = 1;
        }else{
            if($user_info['ali_number']){
                $list['is_bind'] = true;
                $list['ali_number'] = $user_info['ali_number'];
                $list['ali_name'] = $user_info['ali_name'];
                $list['bind_type'] = 2;
            }
            $list['ali_head'] = '';
            $list['name'] = '';
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 支付宝解绑(小程序)
     */
    function AliDelBindInfoXcx(){
        $user = M('user');
        $ali = M('ali');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "996bbda99f87b04e0c65adf3f5b2d2e1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['ali_user_id']){
            $ali_info = $ali->where(array('ali_user_id'=>$user_info['ali_user_id']))->find();
            $save['ali_user_id'] = NULL;
            $save['update_time'] = time();
            $query  = $user->where(array('id'=>$user_info['id']))->save($save);
            if($query){
                $ali->where(array('id'=>$ali_info['id']))->save(array('user_id'=>0,'update_time'=>time()));
                $arr = array(
                    'code'=> 1,
                    'res'=>'解绑成功',
                );
            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>'解绑失败',
                );
            }
        }else{
           if($user_info['ali_number']){
               $save['ali_number'] = NULL;
               $save['ali_name'] = NULL;
               $save['update_time'] = time();
               $query  = $user->where(array('id'=>$user_info['id']))->save($save);
               if($query){
                   $arr = array(
                       'code'=> 1,
                       'res'=>'解绑成功',
                   );
               }else{
                   $arr = array(
                       'code'=> 0,
                       'res'=>'解绑失败',
                   );
               }
           }else{
               $arr = array(
                   'code'=> 0,
                   'res'=>'解绑失败',
               );
           }
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 支付宝解绑
     */
    function AliDelBindInfo(){
        $user = M('user');
        $ali = M('ali');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "996bbda99f87b04e0c65adf3f5b2d2e1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$user_info['ali_user_id']){$arr = array('code'=> 0, 'res'=>'您未绑定支付宝账号');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $ali_info = $ali->where(array('ali_user_id'=>$user_info['ali_user_id']))->find();

        $save['ali_user_id'] = NULL;
        $save['update_time'] = time();
        $query  = $user->where(array('id'=>$user_info['id']))->save($save);

        if($query){
            $ali->where(array('id'=>$ali_info['id']))->save(array('user_id'=>0,'update_time'=>time()));
            $arr = array(
                'code'=> 1,
                'res'=>'解绑成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'解绑失败',
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 绑定支付宝（APP支付宝登录）
     */
    function AliBindInfoApp(){
        $user = M('user');
        $ali = M('ali');
        $auth_code = decrypt1(trim(I('post.auth_code')));
        $alipay_open_id = decrypt1(trim(I('post.alipay_open_id')));
        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "38e59920c3837c2f1e7606c78551c12c";
        //$auth_code = "77581300f54e4865909c3174b557TC08";
        //$alipay_open_id = "20881086268036449184883280810008";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['ali_user_id']){$arr = array('code'=> 0, 'res'=>'您已绑定支付宝，请先解绑后进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        vendor('appalipay.AopSdk');// 加载类库

        $aop = new \AopClient ();
        $aop->gatewayUrl = 'https://openapi.alipay.com/gateway.do';
        $aop->appId = C('alipay_config.appid');
        $aop->rsaPrivateKey = C('alipay_config.rsaPrivateKey');
        $aop->alipayrsaPublicKey=C('alipay_config.alipayrsaPublicKey');
        $aop->apiVersion = '1.0';
        $aop->signType = 'RSA2';
        $aop->postCharset='utf-8';
        $aop->format='json';
        $request = new \AlipaySystemOauthTokenRequest ();
        $request->setGrantType("authorization_code");
        $request->setCode($auth_code);
        $request->setRefreshToken($alipay_open_id);
        $result = $aop->execute ( $request);

        $responseNode = str_replace(".", "_", $request->getApiMethodName()) . "_response";
        $user_id_start = $result->$responseNode->user_id;
        $access_token = $result->$responseNode->access_token;


        if(!empty($user_id_start) && $access_token){
            $aop2 = new \AopClient ();
            $aop2->gatewayUrl = 'https://openapi.alipay.com/gateway.do';
            $aop2->appId =  C('alipay_config.appid');
            $aop2->rsaPrivateKey =  C('alipay_config.rsaPrivateKey');
            $aop2->alipayrsaPublicKey= C('alipay_config.alipayrsaPublicKey');
            $aop2->apiVersion = '1.0';
            $aop2->signType = 'RSA2';
            $aop2->postCharset='utf-8';
            $aop2->format='json';
            $request2 = new \AlipayUserInfoShareRequest ();
            $result2 = $aop2->execute ( $request2 , $access_token);

            $responseNode2 = str_replace(".", "_", $request2->getApiMethodName()) . "_response";
            $resultCode2 = $result2->$responseNode2->code;
            if(!empty($resultCode2)&&$resultCode2 == 10000) {
                $ali_user_id = $result2->$responseNode2->user_id;
                $gender = $result2->$responseNode2->gender;
                $sex = '1';
                if ($gender == 'f') {
                    $sex = '2';
                }
                $head = $result2->$responseNode2->avatar;
                $city = $result2->$responseNode2->city;
                $province = $result2->$responseNode2->province;
                $name = $result2->$responseNode2->nick_name;

                $is_bind = $ali->where(array('ali_user_id'=>$ali_user_id))->find();
                if($is_bind){
                    if($is_bind['user_id']){$arr = array('code'=> 0, 'res'=>'此支付宝账号已被绑定');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
                    $query = $ali->where(array('id'=>$is_bind['id']))->save(array('user_id'=>$user_info['id'],'update_time'=>time()));
                }else{
                    $add_ali['user_id'] = $user_info['id'];
                    $add_ali['ali_user_id'] = $ali_user_id;
                    $add_ali['name'] = $name;
                    $add_ali['head'] = $head;
                    $add_ali['province'] = $province;
                    $add_ali['city'] = $city;
                    $add_ali['sex'] = $sex;
                    $query = $ali->add($add_ali);
                    if($user_info['code_user'] && $sex=='2'){
                        TaskSex($query,$user_info['code_user']);
                    }

                }
                $user->where(array('id'=>$user_info['id']))->save(array('ali_user_id'=>$ali_user_id,'update_time'=>time()));


            }
        }

        if(!$head){$head='';}
        if(!$name){$name='';}
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'绑定成功',
                'head'=>$head,
                'name'=>$name,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'绑定失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 提升等级详细说明
     */
    function LevelInfo(){
        $user = M('user');
        $level_type = M('level_type');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        }

        $list = $level_type->order('sort')->field('tid,name,score,max')->select();
        foreach($list as $key=>$item){
            if($item['max']){
                $list[$key]['everyday_max'] = '+'.$item['score'].' （每日上限'.(string)($item['score']*$item['max']).'）';

            }else{
                $list[$key]['everyday_max'] = '+'.$item['score']." （无限制）";
            }
            unset($list[$key]['max']);
        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 查看用户等级
     */
    function CheckUserLevel(){
        $user = M('user');
        $level = M('level');

        //接收数据
        $token = decrypt1(trim(I('post.token')));


        //$token = "ce48202aea6fda0cce0727074c7aaf85";

        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {
                $arr = array('code' => 2001, 'res' => 'token错误');
                $data = json_encode($arr);
                $return['encryption'] = encrypt1($data);
                $this->ajaxReturn($return, "JSON");
            }
            if ($user_info['is_freeze'] == '0') {
                $arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');
                $data = json_encode($arr);
                $return['encryption'] = encrypt1($data);
                $this->ajaxReturn($return, "JSON");
            }

            $xia_level = $user_info['level']+1;
            $now_level = 'Lv.'.$user_info['level'];
            $is_max = $level->where(array('lv'=>$xia_level))->field('score')->find();
            if($is_max){
                $upgrade_num = $is_max['score'] - $user_info['score'];
                $next_level = 'Lv.'.$xia_level;
            }else{

                $upgrade_num = '0';
                $next_level= 'MAX';
                $is_max = $level->order('score desc')->field('score')->find();
            }
            $arr = array(
                'code'=> 1,
                'res'=>'查询成功 ',
                'user_level'=>$user_info['level'],
                'user_sex'=>$user_info['sex'],
                'upgrade_num'=>(String)$upgrade_num,
                'now_score'=>$user_info['score'],
                'next_score'=>$is_max['score'],
                'now_level'=>$now_level,
                'next_level'=>$next_level,

            );
        }else{
            $arr = array(
                'code'=> 1,
                'res'=>'查询成功 ',
                'user_level'=>'0',
                'user_sex'=>'1',
                'upgrade_num'=>'100',
                'now_score'=>'0',
                'next_score'=>'100',
                'now_level'=>'Lv.0',
                'next_level'=>'Lv.1',

            );
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 人脸认证
     */
    function FaceVerification(){
        $user = M('user');
        $user_card = M('user_card');
        $cache = M('cache');
        $task = M('task');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $number = decrypt1(trim(I('post.number')));
        $img_val = decrypt1(trim(I('post.img_val')));




        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_id_card']=='1'){$arr = array('code'=> 0, 'res'=>'您已通过人脸认证，请勿重复操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $is_number = $user_card->where(array('number'=>$number))->find();
        if($is_number){$arr = array('code'=> 0, 'res'=>'此号码已绑定');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $is_cache = $cache->where(array('url'=>$img_val))->field('thumb')->find();
        if($is_cache){
            $img_val1 = $is_cache['thumb'];
        }else{
            $img_val1 = $img_val;
        }
        $host = "https://faceidcardb.shumaidata.com";
        $path = "/getfaceidb";
        $method = "POST";
        $appcode = "89c2544da50544e487018a39d26cda2d";
        $headers = array();
        array_push($headers, "Authorization:APPCODE " . $appcode);
        //根据API的要求，定义相对应的Content-Type
        array_push($headers, "Content-Type".":"."application/x-www-form-urlencoded; charset=UTF-8");
        $querys = "";

        $sex = substr($number, (strlen($number)==15 ? -1 : -2), 1) % 2 ? '1' : '2';

       //$img_val = XUANIP.'/Public/Uploads/idimg/'.$mk.'/'.$num.'_thumb.'.$type;;
        $img_url  = str_replace(XUANIP,"/www/wwwroot/default/yimei",$img_val1);
        //$img_url = "/www/wwwroot/default/yimei/Public/Uploads/head/2019-09-25/201909251920372150.jpg";
        //$img_url = '/www/wwwroot/default/yimei/test1.jpg';
        $base64 =imgToBase64($img_url);

        //$name = '凌永炫';
        //$number = '441421199312161119';
        $image=urlencode($base64);
        $bodys = "idcard=".$number."&image=".$image."&name=".$name;
        $url = $host . $path;

        $curl = curl_init();
        curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method);
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($curl, CURLOPT_FAILONERROR, false);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curl, CURLOPT_HEADER, false);
        if (1 == strpos("$".$host, "https://"))
        {
            curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
        }
        curl_setopt($curl, CURLOPT_POSTFIELDS, $bodys);
        $res = curl_exec($curl);
        $list = json_decode($res,true);

        if ($list['code']=='200' && $list['data']['incorrect']=='100' && $list['data']['msg']=='系统判断为同一人'){

            $user->where(array('id'=>$user_info['id']))->save(array('is_id_card'=>'1','sex'=>$sex,'real_sex'=>$sex,'update_time'=>time()));
            if($sex=='2'){
                if($user_info['code_user']){
                    $where_task['user_id'] =  $user_info['code_user'];
                    $where_task['classes'] =  1;
                    $where_task['status'] =  0;
                    $where_task['is_pay'] =  1;
                    $is_have = $task->where($where_task)->order('create_time')->find();
                    if($is_have){

                        $add['task_id'] = $is_have['id'];
                        $new_num = $is_have['now_num'] + 1;
                        if($new_num==$is_have['need_num']){
                            $save_task['status'] = 1;
                        }
                        $save_task['now_num'] = $new_num;
                        $save_task['update_time'] = time();
                        $task->where(array('id'=>$is_have['id']))->save($save_task);
                    }
                }
            }

            $add['user_id'] = $user_info['id'];
            $add['name'] = $name;
            $add['sex'] = $sex;
            $add['number'] = $number;
            $add['img_url'] = $img_val;
            $add['create_time'] = time();
            $user_card->add($add);

            $arr = array(
                'code'=> 1,
                'res'=>'认证通过'.$list['data']['incorrect'],
            );
        }else{

            if($list['code']=='200'){
                $res_info = $list['data']['msg'];
            }else{

                $res_info = $list['msg'];
                if($list['code']=='603'){
                    $res_info = '认证错误，请联系客服';
                }
            }
            if($res_info==''){
                $res_info = '认证失败';
            }
            $arr = array(
                'code'=> 0,
                'res'=>$res_info,
            );
        }



        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 红包 - 选择代理
     */
    function TaskAgentInfo(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['code_user'] = $user_info['id'];
        $where['parent'] = $user_info['id'];
        $where['_logic'] = 'OR';
        $list = $user->where($where)->order('create_time')->limit($start,$num)->field('id,name,head')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 红包 - 任务红包详情
     */
    function TaskDetail(){
        $user = M('user');
        $task = M('task');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $task_id = decrypt1(trim(I('post.task_id')));

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $task_info = $task->where(array('id'=>$task_id))->find();

        if($user_info['id']!=$task_info['user_id']){$arr = array('code'=> 0, 'res'=>'没有权限查看');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $list['id'] = $task_info['id'];
        $list['need_num'] = $task_info['need_num'];
        $list['now_num'] = $task_info['now_num'];
        $list['status'] = $task_info['status'];

        $total_num =0;
        $total_num +=$user->where(array('code_user'=>$user_info['id']))->count();
        $list['total_num'] = (String)$total_num;

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    //清除没有优惠券的红包
    function clearTask(){
        $task = M('task');
        $task_prize = M('task_prize');
        $ticket = M('ticket');
        $list = $task->where(array('prize'=>1))->select();
        $i = 0;
        foreach ($list as $item){
            $dis_info = $task_prize->where(array('id'=>$item['prize_id']))->field('parent,discount')->find();
            $dis_title = $ticket->where(array('id'=>$dis_info['parent']))->field('dis_title')->find();
            if(!$dis_title){
                $i++;
                $task->where(array('id'=>$item['id']))->delete();
                $task_prize->where(array('task_id'=>$item['id']))->delete();
            }
        }
        dump($i);die;
    }

    /**
     * 个人中心 - 我的红包
     */
    function UserMyTask(){
        $user = M('user');
        $task = M('task');
        $task_prize = M('task_prize');
        $ticket = M('ticket');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['is_pay'] = 1;
        $where['user_id'] = $user_info['id'];
        $list = $task->where($where)
            ->field('id,name,type,classes,status,is_read,prize,prize_id,prize_num')
            ->order('status,create_time')->limit($start,$num)->select();
        foreach ($list as $key=>$item){
            if($item['is_read']=='0'){
                $task->where(array('id'=>$item['id']))->save(array('is_read'=>'1'));
            }
            $list[$key]['prize_num'] = (String)floatval($item['prize_num']);
            $list[$key]['ticket_type'] = '1';
            if($item['prize']=='1'){
                $dis_info = $task_prize->where(array('id'=>$item['prize_id']))->field('parent,discount')->find();
                if($dis_info['discount']!='0'){
                    $list[$key]['prize_num'] = (String)floatval($dis_info['discount']/10);
                }else{
                    $list[$key]['ticket_type'] = '2';
                    $dis_title = $ticket->where(array('id'=>$dis_info['parent']))->field('dis_title')->find();
                    $list[$key]['prize_num'] = $dis_title['dis_title'];
                }
            }


        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 红包 - 根据手机号获取用户信息
     */
    function TaskSearchPhone(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $phone = decrypt1(trim(I('post.phone')));

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$phone = "13640976018";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['phone'] = $phone;
        $list = $user->where($where)->field('id,name,head')->find();
        if(!$list['id']){$arr = array('code'=> 0, 'res'=>'没有找到该用户');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($list['id']==$user_info['id']){$arr = array('code'=> 0, 'res'=>'不能发送给自己');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 红包 - 发送红包
     */
    function TaskSend(){
        $user = M('user');
        $ticket_user = M('ticket_user');
        $ticket = M('ticket');
        $task = M('task');
        $task_prize = M('task_prize');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $name = decrypt1(trim(I('post.name')));
        $user_id = decrypt1(trim(I('post.user_id')));
        $type = decrypt1(trim(I('post.type')));//1任务红包，2直接赠送红包
        $need_num = decrypt1(trim(I('post.need_num')));
        $prize = decrypt1(trim(I('post.prize')));//1优惠券，2积分，3现金
        $prize_info = decrypt1(trim(I('post.prize_info')));
        //$token = "edee9b9b0373a97d06a4376113a90fb2";


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if(!$user_info['ali_number']|| !$user_info['ali_name']){$arr = array('code'=> 0, 'res'=>'请先绑定支付宝账号');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$user_info['ali_user_id']){$arr = array('code'=> 3001, 'res'=>'请先绑定支付宝账号');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['id']==$user_id){$arr = array('code'=> 0, 'res'=>'不能发送给自己');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(!$name){$arr = array('code'=> 0, 'res'=>'请输入红包留言');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($type=='1'){
            if($need_num<=0){$arr = array('code'=> 0, 'res'=>'请选择任务邀请人数');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        }
        if(!$prize_info){$arr = array('code'=> 0, 'res'=>'参数错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if ($prize=='1'){
            $ticket_info = $ticket_user->where(array('id'=>$prize_info))->find();
            if(!$ticket_info){$arr = array('code'=> 0, 'res'=>'没有找到优惠券');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($ticket_info['status']!='0'){$arr = array('code'=> 0, 'res'=>'优惠券已使用或已退款');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            $add_task['prize_id'] = $prize_info;
        }


        if ($prize=='2'){
            if($prize_info<100){$arr = array('code'=> 0, 'res'=>'最低赠送100积分');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

            if($user_info['score']<$prize_info){$arr = array('code'=> 0, 'res'=>'积分不足');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            $add_task['prize_num'] = $prize_info;
        }

        if ($prize=='3'){
            if($prize_info<0.1){$arr = array('code'=> 0, 'res'=>'最低赠送0.1元');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

            $add_task['prize_num'] = $prize_info;
            if($prize_info<=0){$arr = array('code'=> 0, 'res'=>'现金不能小于0');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        }


        $add_task['name'] = $name;
        $add_task['user_id'] = $user_id;
        $add_task['type'] = 2;
        $add_task['is_pay'] = 0;
        $add_task['classes'] = $type;
        $add_task['parent'] = $user_info['id'];
        $add_task['need_num'] = $need_num;
        $add_task['prize'] = $prize;

        $add_task['create_time'] = time();
        $query = $task->add($add_task);
        $send_con['type'] = '1';
        $send_con['user_id'] = $user_id;
        $arr = array(
            'code'=> 0,
            'res'=>'发送失败',
        );
        if($query){
            if($prize=='1'){
                $add_prize['user_id'] = $user_info['id'];
                $add_prize['task_id'] =$query;
                $add_prize['parent'] =$ticket_info['parent'];
                $add_prize['buy_money'] =$ticket_info['buy_money'];
                $add_prize['rebate_money'] =$ticket_info['rebate_money'];
                $add_prize['discount'] =$ticket_info['discount'];
                $add_prize['create_time'] =time();
                $query_prize = $task_prize->add($add_prize);
                if($query_prize){
                    $query1  = $ticket_user->where(array('id'=>$ticket_info['id']))->delete();
                    if($query1){
                        $task->where(array('id'=>$query))->save(array('is_pay'=>'1','prize_id'=>$query_prize,'update_time'=>time()));
                        $arr = array(
                            'code'=> 1,
                            'res'=>'发送成功',
                        );

                        SendSocket($user_id,json_encode($send_con));
                    }else{
                        $task_prize->where(array('id'=>$query_prize))->delete();
                    }
                }

            }
            if($prize=='2'){
                $new_score = bcsub($user_info['score'],$prize_info);
                $query1 = $user->where(array('id'=>$user_info['id']))->save(array('score'=>$new_score,'update_time'=>time()));
                if($query1){
                    $task->where(array('id'=>$query))->save(array('is_pay'=>'1','update_time'=>time()));
                    $add_log['user_id'] = $user_info['id'];
                    $add_log['add_or_del'] = 2;
                    $add_log['num'] = $prize_info;
                    $add_log['type'] = 7;
                    $add_log['order_id'] = $query;
                    $add_log['create_time'] = time();
                    M('shop_score_log')->add($add_log);
                    $arr = array(
                        'code'=> 1,
                        'res'=>'发送成功',
                    );
                    SendSocket($user_id,json_encode($send_con));
                }
            }
            if($prize=='3'){
                $arr = array(
                    'code'=> 2,
                    'res'=>'红包创建成功，前往支付',
                    'task_id'=>$query
                );
            }

        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 红包-查看邀请好友
     */
    function TaskFriendList(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}



        $where['code_user'] = $user_info['id'];
        $list = $user->where($where)->field('id,head,name,is_id_card,real_sex')->order('create_time desc')->limit($start,$num)->select();


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 红包-发送认证邀请
     */
    function TaskSendFriend(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $user_id = decrypt1(trim(I('post.user_id')));

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        //$search = '明';

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}


        $send_user = $user->where(array('id'=>$user_id))->field('code_user')->find();

        if($send_user['code_user']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '没有邀请权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        $send_con['type'] = '2';
        $send_con['user_id'] = $user_id;
        SendSocket($user_id,json_encode($send_con));

        $arr = array(
            'code'=> 1,
            'res'=>'发送成功'
        );


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 红包-领取红包
     */
    function TaskGet(){
        $user = M('user');
        $task = M('task');
        $task_prize = M('task_prize');
        $ticket_user = M('ticket_user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $task_id = decrypt1(trim(I('post.task_id')));

        //$token = "dc0047270dc11d8155cbdeb6fd0a574b";
        //$task_id = 3;

        $user_info = $user->where(array('token' => $token))->find();
        if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}




        $task_info = $task->where(array('id'=>$task_id))->find();


        if($task_info['prize']=='1' || $task_info['prize']=='3'){
            //if (!$user_info['ali_number'] || !$user_info['ali_name']) {$arr = array('code' => 0, 'res' => '请先绑定支付宝账号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if (!$user_info['ali_user_id']) {$arr = array('code' => 3001, 'res' => '请先绑定支付宝账号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        if($task_info['user_id']!=$user_info['id']) {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($task_info['is_get']=='1') {$arr = array('code' => 0, 'res' => '没有权限');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        if($task_info['is_pay']!='1') {$arr = array('code' => 0, 'res' => '红包不存在');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        //classes:1任务红包，2赠送红包,prize:1优惠券，2积分，3现金
        if($task_info['classes']=='1'){
            if($task_info['status']!='1') {$arr = array('code' => 0, 'res' => '未完成任务或已领取任务');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        if($task_info['classes']=='2'){
            if($task_info['status']=='2') {$arr = array('code' => 0, 'res' => '您已领取过该红包');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
        }

        $arr = array(
            'code'=> 0,
            'res'=>'领取失败'
        );

        //优惠券
        if($task_info['prize']=='1'){
            $prize_info = $task_prize->where(array('id'=>$task_info['prize_id']))->find();
            $add_ticket['user_id']  = $user_info['id'];
            $add_ticket['parent']  = $prize_info['parent'];
            $add_ticket['buy_money']  = $prize_info['buy_money'];
            $add_ticket['rebate_money']  = $prize_info['rebate_money'];
            $add_ticket['discount']  = $prize_info['discount'];
            $add_ticket['status']  = 0;
            $add_ticket['is_zhuan']  = 1;
            $add_ticket['create_time']  = time();
            $query = $ticket_user->add($add_ticket);
            if($query){
                $save_task['status'] = 2;
                $save_task['is_get'] = 1;
                $save_task['get_time'] = time();
                $save_task['update_time'] = time();
                $task->where(array('id'=>$task_info['id']))->save($save_task);
                $arr = array(
                    'code'=> 1,
                    'res'=>'领取成功'
                );
            }
        }
        //积分
        if($task_info['prize']=='2'){
            //增加积分

            $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'8',$task_info['id'],'0',$task_info['prize_num']);

            if($add_status){
                $save_task['status'] = 2;
                $save_task['is_get'] = 1;
                $save_task['get_time'] = time();
                $save_task['update_time'] = time();
                $task->where(array('id'=>$task_info['id']))->save($save_task);
                $arr = array(
                    'code'=> 1,
                    'res'=>'领取成功'
                );
            }
        }


        //现金
        if($task_info['prize']=='3'){
            $save_task['status'] = 2;
            $save_task['update_time'] = time();
            $task->where(array('id'=>$task_info['id']))->save($save_task);
            $arr = array(
                'code'=> 1,
                'res'=>'领取成功'
            );
        }



        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 新增/修改银行卡
     */
    function AddOrSaveBank(){
        $user = M('user');
        $user_bank = M('user_bank');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        $bank_name = decrypt1(trim(I('post.bank_name')));//银行名称，为了保证代付交易成功，银行名称最好具体到分行，eg：中国银行深圳民治支行
        $bank_city = decrypt1(trim(I('post.bank_city')));//开户行所在城市，eg：深圳市
        $bank_account_no = decrypt1(trim(I('post.bank_account_no')));//银行账户
        $bank_account_name = decrypt1(trim(I('post.bank_account_name')));//银行帐号用户名
        $bank_account_type = decrypt1(trim(I('post.bank_account_type')));//收款方银行账户类型，此处必填 corporate :对公账户;personal:对私账户
        $bank_card_type = decrypt1(trim(I('post.bank_card_type')));//支持卡类型，此处必填 debit:借记卡;credit:信用卡 unit:单位结算卡
        $type = decrypt1(trim(I('post.type')));//1新增，2修改
        $bank_id = decrypt1(trim(I('post.bank_id')));//1手动输入，2使用已记录银行卡信息

        //$token = "51a14fd5f628ef33f3c3cff254d7fa43";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$bank_name){
            $arr = array('code' => 0, 'res' => '请输入银行分行名称');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        if (!$bank_city){
            $arr = array('code' => 0, 'res' => '请选择开户行所在城市');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        if (!$bank_account_no){
            $arr = array('code' => 0, 'res' => '请输入银行账户');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        if (!$bank_account_name){
            $arr = array('code' => 0, 'res' => '请输入银行账户用户名');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        if (!$bank_card_type){$bank_card_type='debit';}
        if (!$bank_account_type){$bank_account_type='personal';}


        if($type=='1'){
            $is_have = $user_bank->where(array('bank_account_no'=>$bank_account_no))->find();

            if ($is_have){
                $arr = array('code' => 0, 'res' => '您已添加过此银行卡号');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            $add_bank['user_id'] = $user_info['id'];
            $add_bank['bank_name'] = $bank_name;
            $add_bank['bank_city'] = $bank_city;
            $add_bank['bank_account_no'] = $bank_account_no;
            $add_bank['bank_account_name'] = $bank_account_name;
            $add_bank['bank_card_type'] = $bank_card_type;
            $add_bank['bank_account_type'] = $bank_account_type;
            $add_bank['create_time'] = time();
            $query = $user_bank->add($add_bank);

            if ($query){
                $user->where(array('id'=>$user_info['id']))->save(array('bank_at'=>'1','update_time'=>time()));
            }
            $res = '新增';
            $return_id = $query;
        }else{
            if (!$bank_id){
                $arr = array('code' => 0, 'res' => '请传入银行卡ID');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            $is_have = $user_bank->where(array('id'=>$bank_id))->find();
            if ($is_have && $user_info['id'] == $is_have['user_id']){
                $save_bank['bank_name'] = $bank_name;
                $save_bank['bank_city'] = $bank_city;
                $save_bank['bank_account_name'] = $bank_account_name;
                $save_bank['bank_card_type'] = $bank_card_type;
                $save_bank['bank_account_type'] = $bank_account_type;
                $save_bank['update_time'] = time();
                $query = $user_bank->where(array('id'=>$is_have['id']))->save($save_bank);

                if($query){
                    $user->where(array('id'=>$user_info['id']))->save(array('bank_at'=>'1','update_time'=>time()));
                }
            }else{
                $arr = array('code' => 0, 'res' => '银行卡ID错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
            }
            $return_id = '';
            $res = '修改';
        }



        if($query){


            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
                'bank_id'=>$return_id,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }

    /**
     * 删除我的银行卡
     */
    function DeleteBank(){
        $user = M('user');
        $user_bank = M('user_bank');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $bank_id = decrypt1(trim(I('post.bank_id')));//1手动输入，2使用已记录银行卡信息

        //$token = "51a14fd5f628ef33f3c3cff254d7fa43";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$bank_id){
            $arr = array('code' => 0, 'res' => '请传入银行卡ID');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        $is_have = $user_bank->where(array('id'=>$bank_id))->find();
        if ($is_have && $user_info['id'] == $is_have['user_id']){
            $query = $user_bank->where(array('id'=>$bank_id))->delete();
        }else{
            $arr = array('code' => 0, 'res' => '银行卡ID错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }

        $res = '删除';
        if($query){
            $have_num = $user_bank->where(array('user_id'=>$user_info['id']))->count();
            if($have_num=='0'){
                $user->where(array('id'=>$user_info['id']))->save(array('bank_at'=>'0','update_time'=>time()));
            }
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 邀请好友对战
     */
    function CreateGame(){
        $user = M('user');
        $set = M('set');
        $game = M('game');
        $game_log = M('game_log');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $score = decrypt1(trim(I('post.score')));

        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$score = 1500;
        $user_info = $user->where(array('token'=>$token))->find();
        //$bank_id = 1;
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $set_info = $set->where(array('set_type'=>'create_game'))->find();
        if($score<$set_info['set_value']){$arr = array('code'=> 0, 'res'=>'邀请好友对战最低积分：'.$set_info['set_value']);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['score']<$score){$arr = array('code'=> 0, 'res'=>'您的积分不足!');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $query = $user->where(array('id'=>$user_info['id']))->setDec('score',$score);
        if($query){
            $add['user_id'] = $user_info['id'];
            $add['score'] = $score;
            $add['type'] = 2;
            $add['create_time'] = time();
            $query2 = $game->add($add);
            if($query2){
                //增加积分明细
                $add_log['user_id'] = $user_info['id'];
                $add_log['add_or_del'] = 2;
                $add_log['num'] = $score;
                $add_log['type'] = 10;//10游戏扣除，11游戏获得，12游戏通关奖励
                $add_log['order_id'] = $query2;
                $add_log['create_time'] = time();
                M('shop_score_log')->add($add_log);

                $add_g_l['game_id'] = $query2;
                $add_g_l['user_id'] = $user_info['id'];
                $add_g_l['create_time'] = time();
                $game_log->add($add_g_l);
                $arr = array(
                    'code'=> 1,
                    'res'=>'查询成功',
                    'game_id'=>$query2,
                    'share_url' => 'https://wx.ymxte.com/home/share/game/user_id/'.$user_info['id'].'/game_id/'.$query2
                );

            }else{
                $user->where(array('id'=>$user_info['id']))->setInc('score',$score);
                $arr = array(
                    'code'=> 0,
                    'res'=>'邀请失败'
                );
            }
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'邀请失败'
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 接受对战邀请
     */
    function AcceptGame(){
        $user = M('user');
        $set = M('set');
        $game = M('game');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $game_id = decrypt1(trim(I('post.game_id')));
        $score = decrypt1(trim(I('post.score')));

        //$token = "8f18e524a051e822926d1b8a042ebcc4";
        //$game_id = 3;
        $user_info = $user->where(array('token'=>$token))->find();
        //$bank_id = 1;
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $game_info  = $game->where(array('id'=>$game_id))->find();
        if($game_info['type']!=2){$arr = array('code'=> 0, 'res'=>'此邀请已失效');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($game_info['status']!=0){$arr = array('code'=> 0, 'res'=>'对战已结束');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($game_info['friend_user_id']){$arr = array('code'=> 0, 'res'=>'此邀请已过期');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($game_info['user_id']==$user_info['id']){$arr = array('code'=> 0, 'res'=>'不能接受自己的邀请');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $set_info = $set->where(array('set_type'=>'create_game'))->find();
        if($score<$set_info['set_value']){$arr = array('code'=> 0, 'res'=>'接受好友对战最低积分：'.$set_info['set_value']);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if($user_info['score']<=$score){$arr = array('code'=> 0, 'res'=>'您的积分不足，请获取积分后进行此操作!');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


       /* if($user_info['score']<$game_info['score']){
            $score = $user_info['score'];
        }else{
            $score = $game_info['score'];
        }*/

        $query = $user->where(array('id'=>$user_info['id']))->setDec('score',$score);
        if($query){
            $save['is_agree'] = 1;
            $save['friend_user_id'] = $user_info['id'];
            $save['friend_score'] = $score;
            $save['accept_time'] = time();
            $save['update_time'] = time();
            $query2 = $game->where(array('id'=>$game_info['id']))->save($save);
            if($query2){
                //增加积分明细
                $add_log['user_id'] = $user_info['id'];
                $add_log['add_or_del'] = 2;
                $add_log['num'] = $score;
                $add_log['type'] = 10;//10游戏扣除，11游戏获得，12游戏通关奖励
                $add_log['order_id'] = $query2;
                $add_log['create_time'] = time();
                M('shop_score_log')->add($add_log);
                $arr = array(
                    'code'=> 1,
                    'res'=>'接受邀请成功',
                    'game_id'=>$query2,
                    'game_url' => 'https://wx.ymxte.com/home/game/index/type/2/token/'.$token.'/game_id/'.$game_info['id']
                );

            }else{
                $user->where(array('id'=>$user_info['id']))->setInc('score',$score);
                $arr = array(
                    'code'=> 0,
                    'res'=>'接受邀请失败'
                );
            }
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'接受邀请失败'
            );
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 游戏排行榜
     */
    function GameHomeData(){
        $user = M('user');
        $set = M('set');
        $game = M('game');
        $game_log = M('game_log');
        //接收数据
        $token = decrypt1(trim(I('post.token')));


        $page = decrypt1(trim(I('post.page')));
        $share_user_id = decrypt1(trim(I('post.share_user_id')));
        $share_game_id = decrypt1(trim(I('post.share_game_id')));


        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "8f18e524a051e822926d1b8a042ebcc4";
        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$game_id = 3;
        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            //$bank_id = 1;
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }

        if(!$user_info['code_user']){
            if($share_user_id){
                //绑定邀请人
                $bind_status = BindCodeUser($share_user_id,$user_info['id']);
            }

        }
        //分享游戏绑定
        if($token){
            if($share_user_id!=$user_info['id']){
                GameBind($share_game_id,$share_user_id,$user_info['id']);
            }
        }


        $list = $user->where(array('game_score'=>array('EXP','IS NOT NULL')))->limit(3)->order('game_score')->field('id,name,head,game_score')->select();
        $set_info = $set->where(array('set_type'=>'game_info'))->find();

        $set_info2 = $set->where(array('set_type'=>'create_game'))->find();
        $set_list = json_decode($set_info['remark'],true);
        $set_list['create_game'] = $set_info2['set_value'];
        $where['user_id|friend_user_id']  = $user_info['id'];
        $where['type'] = 2;
        $where['is_agree'] = 1;
        $game_list = $game
            ->field('id,user_id,friend_user_id,status,score,friend_score,win_type,time,friend_time')
            ->limit($start,$num)->order('status,create_time desc')->where($where)->select();
        foreach($game_list as $key=>$item){
            $game_list[$key]['user_name'] = $user_info['name'];
            $game_list[$key]['user_head'] = $user_info['head'];
            $game_list[$key]['is_win'] = '0';
            if(!$item['time']){
                $game_list[$key]['time'] = '';
            }
            if(!$item['friend_time']){
                $game_list[$key]['friend_time'] = '';
            }

            /*if($item['friend_time']>$item['time']){
                $game_list[$key]['win_time'] =$item['time'];
            }else{
                $game_list[$key]['win_time'] =$item['friend_time'];
            }*/
            if($item['win_type']==1){
                $game_list[$key]['win_time'] =$item['time'];
            }else{
                $game_list[$key]['win_time'] =$item['friend_time'];
            }


            if($item['user_id']==$user_info['id']){
                if($item['friend_user_id']){
                    $friend_user = $user->where(array('id'=>$item['friend_user_id']))->field('id,name,head')->find();
                    $game_list[$key]['user_name'] = $friend_user['name'];
                    $game_list[$key]['user_head'] = $friend_user['head'];
                }
                if($item['win_type']==1){
                    $game_list[$key]['is_win'] = '1';
                }
            }else{
                $friend_user = $user->where(array('id'=>$item['user_id']))->field('id,name,head')->find();
                $game_list[$key]['user_name'] = $friend_user['name'];
                $game_list[$key]['user_head'] = $friend_user['head'];
                if($item['win_type']==2){
                    $game_list[$key]['is_win'] = '1';
                }
            }
            if($item['status']=='0'){
                $game_list[$key]['is_win'] = '2';
            }
            if($item['friend_score']>0){
                $game_list[$key]['game_score'] = $item['friend_score'];
            }else{
                $game_list[$key]['game_score'] = $item['score'];
            }
            unset( $game_list[$key]['score']);
            unset( $game_list[$key]['friend_score']);

        }




        $where2['lyx_game_log.user_id']  = $user_info['id'];
        $where2['lyx_game.user_id']  = array('NEQ',$user_info['id']);
        $where2['lyx_game.is_agree']  = 0;
        $message_num = $game_log
            ->join('lyx_game ON lyx_game_log.game_id = lyx_game.id')
            ->where($where2)->count();
        $user_info['score'] = $user_info['score']?$user_info['score']:0;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'play_url'=>'https://wx.ymxte.com/home/game/index/type/1/token/'.$token,
            'my_score'=>$user_info['score'],
            'message_num'=>$message_num,
            'set_info'=>$set_list,
            'list'=>$list,
            'game_list'=>$game_list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 口红游戏邀请通知
     */
    function GameinviteList(){
        $user = M('user');
        $set = M('set');
        $game = M('game');
        $game_log = M('game_log');
        //接收数据
        $token = decrypt1(trim(I('post.token')));


        $page = decrypt1(trim(I('post.page')));



        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "8f18e524a051e822926d1b8a042ebcc4";
        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$game_id = 3;
        $user_info = $user->where(array('token'=>$token))->find();
        //$bank_id = 1;
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $where['lyx_game_log.user_id']  = $user_info['id'];
        $game_list = $game_log
            ->order('lyx_game.status,lyx_game.create_time desc')
            ->join('lyx_game ON lyx_game_log.game_id = lyx_game.id')
            ->field('lyx_game.id,lyx_game.user_id,friend_user_id,status,score,friend_score,win_type,time,friend_time')
            ->limit($start,$num)
            ->where($where)->select();

        foreach($game_list as $key=>$item){
            if(!$item['time']){
                $game_list[$key]['time'] = '';
            }
            if(!$item['friend_time']){
                $game_list[$key]['friend_time'] = '';
            }


            $game_list[$key]['user_name'] = $user_info['name'];
            $game_list[$key]['user_head'] = $user_info['head'];
            $game_list[$key]['play_url'] = '';

            if($item['user_id']==$user_info['id']){
                if($item['friend_user_id']){
                    $friend_user = $user->where(array('id'=>$item['friend_user_id']))->field('id,name,head')->find();
                    $game_list[$key]['user_name'] = $friend_user['name'];
                    $game_list[$key]['user_head'] = $friend_user['head'];
                }
                $game_list[$key]['is_create'] = '1';
                if($item['status']==0){
                    if($item['friend_user_id']){
                        if($item['time']){
                            $game_list[$key]['status'] = '2';//待好友闯关
                        }else{
                            $game_list[$key]['status'] = '1';//开始对战
                            $game_list[$key]['play_url'] = 'https://wx.ymxte.com/home/game/index/type/2/token/'.$token.'/game_id/'.$item['id'];
                        }
                    }else{
                        $game_list[$key]['status'] = '0';//待接受
                    }
                }else if($item['status']==1){
                    $game_list[$key]['status'] = '3';//已完成
                }else{
                    $game_list[$key]['status'] = '4';//已过期
                }
            }else{
                $friend_user = $user->where(array('id'=>$item['user_id']))->field('id,name,head')->find();
                $game_list[$key]['user_name'] = $friend_user['name'];
                $game_list[$key]['user_head'] = $friend_user['head'];
                $game_list[$key]['is_create'] = '0';
                if($item['status']==0){
                    if($item['friend_user_id']){
                        if($item['friend_time']){
                            $game_list[$key]['status'] = '2';//待好友闯关
                        }else{
                            $game_list[$key]['status'] = '1';//开始对战
                            $game_list[$key]['play_url'] = 'https://wx.ymxte.com/home/game/index/type/2/token/'.$token.'/game_id/'.$item['id'];
                        }
                    }else{
                        $game_list[$key]['status'] = '5';//可接受
                    }
                }else if($item['status']==1){
                    $game_list[$key]['status'] = '3';//已完成
                }else{
                    $game_list[$key]['status'] = '4';//已过期
                }
            }


            if($item['friend_score']>0){
                $game_list[$key]['game_score'] = $item['friend_score'];
            }else{
                $game_list[$key]['game_score'] = $item['score'];
            }

            unset( $game_list[$key]['score']);
            unset( $game_list[$key]['friend_score']);

        }


        $where2['lyx_game_log.user_id']  = $user_info['id'];
        $where2['lyx_game.user_id']  = array('NEQ',$user_info['id']);
        $where2['lyx_game.is_agree']  = 0;
        $message_num = $game_log
            ->join('lyx_game ON lyx_game_log.game_id = lyx_game.id')
            ->where($where2)->count();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'message_num'=>$message_num,
            'game_list'=>$game_list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 根据银行卡ID查询银行卡信息
     */
    function CheckBankDetail(){
        $user = M('user');
        $user_bank = M('user_bank');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $bank_id = decrypt1(trim(I('post.bank_id')));

        //$token = "8f18e524a051e822926d1b8a042ebcc4";
        $user_info = $user->where(array('token'=>$token))->find();
        //$bank_id = 1;
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$bank_id){
            $arr = array('code' => 0, 'res' => '请传入银行卡ID');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }
        $is_have = $user_bank->where(array('id'=>$bank_id))->find();

        if ($is_have && $user_info['id'] == $is_have['user_id']){
            $list = $user_bank->where(array('id'=>$bank_id))->find();
            $list['num'] = substr($list['bank_account_no'],-4);
            unset($list['create_time']);
            unset($list['update_time']);
        }else{
            $arr = array('code' => 0, 'res' => '银行卡ID错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");
        }



        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的银行卡列表
     */
    function MyBankList(){
        $user = M('user');
        $user_bank = M('user_bank');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "51a14fd5f628ef33f3c3cff254d7fa43";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $user_bank->where(array('user_id'=>$user_info['id']))->order('create_time desc')->field('id as bank_id,bank_name,bank_account_no,bank_card_type')->select();
        foreach ($list as $key=>$item){
            $list[$key]['bank_account_no'] = substr($item['bank_account_no'],-4);
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的vip信息
     */
    function MyVipInfo(){
        $user = M('user');
        $user_vip = M('user_vip');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list['user_id'] = $user_info['id'];
        $list['name'] = $user_info['name'];
        $list['head'] = $user_info['head'];
        $list['vip'] = $user_info['vip'];
        if ($user_info['vip']){
            $user_vip_time = $user_vip->where(array('user_id'=>$user_info['id']))->find();
            $Date_1 = date("Y-m-d");
            $Date_2 = date('Y-m-d',$user_vip_time['end_time']);
            $d1 = strtotime($Date_1);
            $d2 = strtotime($Date_2);
            $Days = round(($d2-$d1)/3600/24);
            $list['end_day'] = (String)$Days;
        }else{
            $list['end_day'] = '0';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 个人信息-查询
     */
    function UserMyInfo(){
        $user = M('user');
        $cache = M('cache');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))
            ->field('id,name,head,province,code,city,area,sex,birthday,level,create_time,is_id_card')
            ->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if (!$user_info['province']){$user_info['province'] = '';}
        if (!$user_info['city']){$user_info['city'] = '';}
        if (!$user_info['area']){$user_info['area'] = '';}
        if (!$user_info['code']){$user_info['code'] = '0';}
        if (!$user_info['birthday']){
            $user_info['birthday'] = '';
        }else{
            $user_info['birthday'] = date('Y-m-d',$user_info['birthday']);

        }

        $is_gao = $cache->where(array('thumb'=>$user_info['head']))->find();
        if ($is_gao){
            $user_info['gao_head'] = $is_gao['url'];
        }

        $user_info['create_time'] = date('Y-m-d',$user_info['create_time']);

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $user_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人信息-更多保存
     */
    function UserUpdateInfoDuo(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $birthday = decrypt1(trim(I('post.birthday')));
        $astro = decrypt1(trim(I('post.astro')));
        $job = decrypt1(trim(I('post.job')));
        $explain = decrypt1(trim(I('post.explain')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))
            ->field('id,name,head,province,city,area,signature,sex,birthday,level,explain,astro,job,create_time')
            ->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$birthday){
            $arr = array(
                'code'=> 0,
                'res'=>'请选择您的生日',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if(!$job){
            $arr = array(
                'code'=> 0,
                'res'=>'请填写您的职业',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $age = birthday($birthday);

        $save['birthday'] = $birthday;
        $save['astro'] = $astro;
        $save['job'] = $job;
        $save['explain'] = $explain;
        $save['age'] = $age;
        $save['update_time'] = time();
        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        $res = '修改';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人信息-单个修改
     */
    function UserUpdateInfoDan(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//修改类型：1头像，2昵称，3性别，4生日，5地区
        $head = decrypt1(trim(I('post.head')));
        $name = decrypt1(trim(I('post.name')));
        $sex = decrypt1(trim(I('post.sex')));
        $birthday = decrypt1(trim(I('post.birthday')));
        $province = decrypt1(trim(I('post.province')));
        $city = decrypt1(trim(I('post.city')));
        $area = decrypt1(trim(I('post.area')));


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))
            ->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$type){
            $arr = array(
                'code'=> 0,
                'res'=>'请选择要修改的选项',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($type=='1'){
            if(!$head){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请上传需要修改的头像',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            if($head){
                $save['head'] = $head;
            }


            $save['is_info'] = 1;
        }
        if ($type=='2'){
            if(!$name){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请输入要修改的昵称',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            if(strlen($name)>24){
                $arr = array(
                    'code'=> 0,
                    'res'=>'昵称最大长度不能超过8个汉字',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['name'] = $name;

            $where_name['id'] = array('NEQ',$user_info['id']);
            $where_name['name'] = $name;
            $is_name = $user->where($where_name)->field('id')->find();
            if($is_name){
                $arr = array(
                    'code'=> 0,
                    'res'=>'昵称已存在',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['is_info'] = 1;
        }

        if ($type=='3'){
            if(!$sex){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请选择性别',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['sex'] = $sex;
        }
        if ($type=='4'){
            if(!$birthday){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请选择生日',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $age = birthday($birthday);
            $save['age'] =$age;
            $save['birthday'] = strtotime($birthday);
        }

        if ($type=='5'){
            if(!$province){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请选择您所在的省份',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            $save['province'] = $province;
            $save['city'] = $city;
            $save['area'] = $area;
        }

        $save['update_time'] = time();
        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        $res = '修改';
        if($query){
            if ($save['head'] || $save['name']){
                if ($save['head']){
                    $head = $save['head'];
                }else{
                    $head = $user_info['head'];
                }

                if ($save['name']){
                    $name = $save['name'];
                }else{
                    $name = $user_info['name'];
                }
/*
                //融云token
                $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
                $result = $RongCloud->user()->refresh($user_info['id'], $name,$head);*/
            }

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 认证-身份证认证
     */
    function AuthenticationIdCard(){
        $user = M('user');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $card_no = decrypt1(trim(I('post.card_no')));
        $real_name = decrypt1(trim(I('post.real_name')));

        $token = "edee9b9b0373a97d06a4376113a90fb2";
        $card_no= '441421199312161119';
        $real_name= '凌永炫';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if ($user_info['id_card_at']){
            $arr = array(
                'code'=> 0,
                'res'=>'您已进行过身份证认证',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$card_no){
            $arr = array(
                'code'=> 0,
                'res'=>'请传入身份证号码',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$real_name){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入您的真实姓名',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        /*
        $is_card = $user_at->where(array('card_no'=>$card_no))->find();
        if ($is_card){
            $arr = array(
                'code'=> 0,
                'res'=>'此身份证号已验证',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }*/

        header("Content-type: text/html; charset=utf-8");
        //接口地址
        $url = 'http://idcardpro.market.alicloudapi.com/idcard';
        //appcode查看地址 https://market.console.aliyun.com/imageconsole/
        $appCode = 'cfb98726e660404280d1a73d271fc1e6';
        $params['realName'] = $real_name;
        $params['cardNo'] = $card_no;
        //发送远程请求;
        $result = DUOCAICREDIT($url, $params, $appCode, "POST");
        dump($result);die;
        //返回结果
        if ($result['error_code'] == 0)
        {
            //echo $result['reason']; //信息一致
            $query = $user->where(array('id'=>$user_info['id']))->save(array('id_card_at'=>'1','update_time'=>time()));
            $res = '认证';
            if($query){
                $where['user_id'] = $user_info['id'];
                $is_have = $user_at->where(array('user_id'=>$user_info['id']))->find();
                if ($is_have){
                    $save['card_no'] = $card_no;
                    $save['real_name'] = $real_name;
                    $save['update_time'] = time();
                    $user_at->where(array('user_id'=>$user_info['id']))->save($save);
                }else{
                    $add_at['user_id'] = $user_info['id'];
                    $add_at['card_no'] = $card_no;
                    $add_at['real_name'] = $real_name;
                    $add_at['create_time'] = time();
                    $user_at->add($add_at);
                }
                $arr = array(
                    'code'=> 1,
                    'res'=>$res.'成功 ',
                );
            }else{
                $arr = array(
                    'code'=> 0,
                    'res'=>$res.'失败',
                );
            }
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        else
        {
            $arr = array(
                'code'=> 0,
                'res'=>$result['reason'],
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
            //echo $result['reason'];  //信息不一致
        }




    }


    /**
     * 个人信息-修改IM号
     */
    function UserUpdateInfoIm(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $imid = decrypt1(trim(I('post.imid')));



        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))
            ->field('id,name,head,province,city,area,signature,sex,birthday,level,explain,astro,job,create_time')
            ->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        if ($user_info['is_edit_im']=='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'每个账号只允许修改一次IM号',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$imid){
            $arr = array(
                'code'=> 0,
                'res'=>'请传入要修改的IM号',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if ($imid==$user_info['imid']){
            $arr = array(
                'code'=> 0,
                'res'=>'新IM号不能和旧IM号重复',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!ctype_alnum($imid)){
            $arr = array(
                'code'=> 0,
                'res'=>'IM号只能由字母、数字组合',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if (strlen($imid)<6 || strlen($imid)>16){
            $arr = array(
                'code'=> 0,
                'res'=>'IM号长度为6至16个字符',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where['imid'] = $imid;
        $where['id'] = array('NEQ',$user_info['id']);
        $is_cf = $user->where($where)->find();
        if ($is_cf){
            $arr = array(
                'code'=> 0,
                'res'=>'此IM号已经被占用',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $save['imid'] = $imid;
        $save['is_edit_im'] = 1;
        $save['update_time'] = time();
        $query = $user->where(array('id'=>$user_info['id']))->save($save);
        $res = '修改';
        if($query){

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的钱包
     */
    function MyWallet(){
        $user = M('user');
        $order = M('order');
        $shop = M('shop');
        $money_log = M('money_log');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//类型：1所有账单，2提现记录
        $page = decrypt1(trim(I('post.page')));
        if(!$type){$type = '1';}
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $is_shop = $shop_info = $shop->where(array('user_id'=>$user_info['id']))->field('id')->find();

        $list['money'] = $user_info['money'];

        if ($is_shop){
            $where_order['shop_id'] = $is_shop['id'];
            $where_order['pay_status'] = 1;
            $where_order['is_ti'] = 0;
            $where_order['status'] = array('IN','4,5');
            $account_money = 0;
            $account_money+=$order->where($where_order)->sum('money');
        }else{
            $account_money = 0;
        }
        $list['account_money'] = (String)$account_money;
        $where_money['lyx_money_log.user_id'] = $user_info['id'];
        if ($type=='2'){
            $where_money['lyx_money_log.type'] = 2;
        }
        $log_list = $money_log
            ->join('lyx_money_log_type ON lyx_money_log.type = lyx_money_log_type.value')
            ->where($where_money)
            ->order('lyx_money_log.create_time desc')
            ->limit($start,$num)
            ->field('lyx_money_log.type,lyx_money_log.money,lyx_money_log.add_or_del,lyx_money_log.create_time,lyx_money_log_type.name as type_name')
            ->select();

        foreach ($log_list as $key=>$item){
            $log_list[$key]['create_time'] = date('Y-m-d H:i:s',$item['create_time']);
        }
        $list['log_list'] = $log_list;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的钱包-未结算订单列表
     */
    function MyNOAccountList(){
        $user = M('user');
        $order = M('order');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "d987a291a86b16346379a88b273ad0c8";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info = $shop_info = $shop->where(array('user_id'=>$user_info['id']))->field('id')->find();
        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where_order['shop_id'] = $shop_info['id'];
        $where_order['pay_status'] = 1;
        $where_order['is_ti'] = 0;
        $where_order['status'] = array('IN','4,5');
        $order_list = $order->where($where_order)
            ->limit($start,$num)
            ->order('create_time desc')->field('id as order_id,goods_id,money_type,money,price,status,refund_status')->select();

        foreach ($order_list as $key=>$item){
            $goods_info = $shop_goods->where(array('id'=>$item['goods_id']))->field('name,img_url')->find();
            $order_list[$key]['name'] = $goods_info['name'];
            $order_list[$key]['img_url'] = $goods_info['img_url'];
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $order_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 个人中心-设置信息
     */
    function UserSetInfo(){
        $user = M('user');
        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if ($user_info['pay_pass']){
            $is_pass = '1';
        }else{
            $is_pass = '0';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'is_pass' => $is_pass
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     * 检查版本更新
     */
    function Versionsupdate(){
        $type = decrypt1(trim(I('post.type')));//1ios.2android
        $now_versions = decrypt1(trim(I('post.now_versions')));
        $token = decrypt1(trim(I('post.token')));
        $is_alert = '0';
        if($token){
            if($type=='ios'){
                $user_info = M('user')->where(array('token'=>$token))->field('id')->find();
                if($user_info){
                    $tan_info = M('ios_score')->where(array('user_id'=>$user_info['id']))->order('create_time desc')->find();

                    if($tan_info['create_time']){
                        $tan_num = M('ios_score')->where(array('user_id'=>$user_info['id']))->count;
                        if($tan_num<3){
                            $time = time() - 604800;
                            if($tan_info['create_time']<$time){
                                $is_alert = '1';
                            }
                        }
                    }else{
                        $where_tan['status'] = array('NEQ','0');
                        $where_tan['user_id'] = $user_info['id'];
                        $is_buy = M('shop_order')->where($where_tan)->count();
                        if($is_buy>0){
                            $is_alert = '1';
                        }
                    }
                }

            }
        }



        $set = M('set');
        $set_info = $set->where(array('set_type'=>$type))->find();
        $now_versions=str_replace('.','',$now_versions);



        $admin_versions = str_replace('.','',$set_info['set_value']);

        $is_must = '0';
        if($type=='ios'){
            if($now_versions<277){
                //$admin_versions = '105';
                $is_must = '1';
            }
        }else{
            if($now_versions<121){
                //$admin_versions = '105';
                $is_must = '1';
            }
        }

        if($now_versions<$admin_versions){
            $arr = array(
                'code'=> 1,
                'res'=>'需要更新',
                'update_versions'=>$set_info['set_value'],
                'update_url'=>$set_info['remark'],
                'is_must'=>$is_must,
                'is_alert'=>$is_alert
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'不需要更新',
                'is_must'=>$is_must
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * IOS评分弹出后调用
     */
    function SubmitIosScore(){
        $user = M('user');
        $ios_score = M('ios_score');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();
        $query  = $ios_score->add($add);
        $res = '提交';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 提交意见反馈
     */
    function SubmitOpinion(){
        $user = M('user');
        $opinion = M('opinion');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $content = decrypt1(trim(I('post.content')));
        $img_url = decrypt1(trim(I('post.img_url')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$content){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入反馈内容',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $add['user_id'] = $user_info['id'];
        $add['content'] = $content;
        if ($img_url){
            $add['img_list'] = $img_url;
        }
        $add['create_time'] = time();
        $query  = $opinion->add($add);
        $res = '提交';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功,感谢您的支持！ ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 个人中心-客服中心
     */
    function QuestionList(){
        $user = M('user');
        $question = M('question');
        $set = M('set');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "edee9b9b0373a97d06a4376113a90fb2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $question_list  = $question->where(array('is_show'=>'1'))->order('sort')->field('id as question_id,title')->select();
        foreach ($question_list as $key=>$item){
            $question_list[$key]['url'] = 'https://api.ymxte.com/home/show/index/id/'.$item['question_id'];
        }
        $set_info = $set->where(array('set_type'=>'service_call'))->field('set_value')->find();

        $user_list  =  $user->where(array('is_service'=>"1"))->field('id,rong_token')->order('rand()')->find();
        $user_list['rong_token'] = $user_list['rong_token']?$user_list['rong_token']:"";
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'service_online'=>$user_list,
            'service_call'=>$set_info['set_value'],
            'list' => $question_list
        );




        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-在线客服
     */
    function OnlineService(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $user_list  =  $user->where(array('is_service'=>"1"))->field('id,rong_token')->select();
        $user_key = array_rand($user_list,1);
        $now_service = $user_list[$user_key];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'user_id'=> $now_service['id'],
            'rong_token'=> $now_service['rong_token'],
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 个人中心-客服中心-问题详细
     */
    function QuestionDetail(){
        $user = M('user');
        $question = M('question');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $question_id = decrypt1(trim(I('post.question_id')));

        //$token = "be196855ebf12c739990376a58376317";
        //$question_id=1;
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $question_info  = $question->where(array('id'=>$question_id,'is_show'=>'1'))
            ->field('id as question_id,title,content')->find();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $question_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我关注的店铺列表
     */
    function MyFollowList(){
        $user = M('user');

        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $shop_follow = M('shop_follow');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "d987a291a86b16346379a88b273ad0c8";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $follow_list = $shop_follow
            ->order('create_time desc')
            ->limit($start,$num)
            ->where(array('user_id'=>$user_info['id']))->field('id as follow_id,shop_id')->select();
        foreach ($follow_list as $key=>$item){
            $shop_info = $shop->where(array('id'=>$item['shop_id']))->field('shop_name,logo,classify,introduce,sales,lng,lat')->find();
            if($lat&&$lng&&$shop_info['lat']&&$shop_info['lng']){
                $follow_list[$key]['dis'] = getDistance($shop_info['lat'],$shop_info['lng'],$lat,$lng);
            }else{
                $follow_list[$key]['dis'] ='';
            }
            $follow_list[$key]['shop_name'] = $shop_info['shop_name'];
            $follow_list[$key]['logo'] = $shop_info['logo'];
            $follow_list[$key]['classify'] = $shop_info['classify'];
            $follow_list[$key]['introduce'] = $shop_info['introduce'];
            $follow_list[$key]['sales'] = $shop_info['sales'];
            $goods_info = $shop_goods->where(array('shop_id'=>$item['shop_id']))->order('price')->field('price')->find();
            if ($goods_info){
                $follow_list[$key]['min_price'] = $goods_info['price'];
            }else{
                $follow_list[$key]['min_price'] = '0';
            }


        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $follow_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的订单
     */
    function MyOrderList(){
        $user = M('user');
        $order = M('order');

        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//类型：1全部，2待使用，3待评价，4退款，5已完成
        $page = decrypt1(trim(I('post.page')));
        if(!$type){$type = '1';}
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "59b8d705259608fe1d874077ff08617e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where_order['user_id'] = $user_info['id'];
        $where_order['pay_status'] = 1;
        if ($type=='2'){
            $where_order['status'] = array('IN','1,2');
        }
        if ($type=='3'){
            $where_order['status'] = 4;
        }
        if ($type=='4'){
            $where_order['status'] = 3;
        }
        if ($type=='5'){
            $where_order['status'] = 5;
        }
        $order_list = $order->where($where_order)->order('create_time desc')
            ->limit($start,$num)
            ->field('id as order_id,status,refund_status,money_type,money,shop_id,price,goods_id')->select();
        foreach ($order_list as $key=>$item){
            $goods_info = $shop_goods->where(array('id'=>$item['goods_id']))->field('name,img_url')->find();
            $order_list[$key]['name'] = $goods_info['name'];
            $order_list[$key]['img_url'] = $goods_info['img_url'];
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $order_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }





    /**
     * 我的订单-确认使用
     */
    function MyOrderUse(){
        $user = M('user');
        $order = M('order');
        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $order_info = $order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['money_type']!='2'){
            $arr = array(
                'code'=> 0,
                'res'=>'请先支付尾款',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['status']=='2' || $order_info['status']=='3'){
            if($order_info['status']=='3'){
                if($order_info['money_type']!='2' && $order_info['refund_status'] !='2'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'状态错误',
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $save['status'] = 4;
        $save['ok_time'] = time();
        $query = $order->where(array('id'=>$order_info['id']))->save($save);
        $res = '使用';
        if($query){
            //添加消息通知
            $shop_info  = $shop->where(array('id'=>$order_info['shop_id']))->find();
            $tis = '订单交易成功';
            //新版
            $add_system['user_id'] = $shop_info['user_id'];
            $add_system['send_user_id'] = $user_info['id'];
            $add_system['content'] = $tis;
            $add_system['type'] = 2;//1新的订单，2订单交易成功，3待处理订单
            $add_system['type_id'] = $order_info['id'];
            $add_system['status'] = 3;
            $add_system['create_time'] = time();
            M('system')->add($add_system);

            $rong_user[] = $shop_info['user_id'];

            SendRongSystem($rong_user,$tis);


            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 我的订单-评价打分
     */
    function MyOrderComment(){
        $user = M('user');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $comment = decrypt1(trim(I('post.comment')));
        $star = decrypt1(trim(I('post.star')));
        if (!$star){$star=0;}


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $order_info = $order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['status']!='4'){
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$comment){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入评价',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $save['status'] = 5;
        $save['star'] = $star;
        $save['comment'] = $comment;
        $save['comment_time'] = time();
        $query = $order->where(array('id'=>$order_info['id']))->save($save);
        $res = '评价';
        if($query){
            ShopStarCheck($order_info['shop_id']);
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 我的订单-评价店铺资料
     */
    function MyOrderCommentInfo(){
        $user = M('user');
        $order = M('order');
        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        //$lng = '114.110662';
        //$lat = '22.614833';

        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$order_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $order_info = $order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['status']!='4'){
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $shop_info = $shop->where(array('id'=>$order_info['shop_id']))
            ->field('id as shop_id,shop_name,logo,classify,introduce,star,sales,lng,lat')->find();
        if($lat&&$lng&&$shop_info['lat']&&$shop_info['lng']){
            $shop_info['dis'] = getDistance($shop_info['lat'],$shop_info['lng'],$lat,$lng);
        }else{
            $shop_info['dis'] ='';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $shop_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 我的订单-申请退款
     */
    function MyOrderApplyRefund(){
        $user = M('user');
        $order = M('order');
        $shop = M('shop');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$lng = '114.110662';
        //$lat = '22.614833';

        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$order_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $order_info = $order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['status']!='1' && $order_info['status']!='2'){
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $save['status'] = 3;
        $save['refund_status'] = 1;
        $save['apply_refund_time'] = time();
        $query = $order->where(array('id'=>$order_info['id']))->save($save);
        $res = '申请';
        if($query){
            //添加消息通知
            $shop_info  = $shop->where(array('id'=>$order_info['shop_id']))->find();
            $tis = '订单交易成功';
            //新版
            $add_system['user_id'] = $shop_info['user_id'];
            $add_system['send_user_id'] = $user_info['id'];
            $add_system['content'] = $tis;
            $add_system['type'] = 3;//1新的订单，2订单交易成功，3待处理订单
            $add_system['type_id'] = $order_info['id'];
            $add_system['status'] = 3;
            $add_system['create_time'] = time();
            M('system')->add($add_system);

            $rong_user[] = $shop_info['user_id'];

            SendRongSystem($rong_user,$tis);
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 我的订单-申请客服介入
     */
    function MyOrderApplyService(){
        $user = M('user');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$lng = '114.110662';
        //$lat = '22.614833';

        //$token = "d987a291a86b16346379a88b273ad0c8";
        //$order_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $order_info = $order->where(array('id'=>$order_id))->find();

        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['status']!='3' && $order_info['refund_status']!='2'){
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $save['refund_status'] = 3;
        $save['apply_refund_time'] = time();
        $query = $order->where(array('id'=>$order_info['id']))->save($save);
        $res = '申请';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 我的订单-订单详情
     */
    function MyOrderDetail(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$token = "59b8d705259608fe1d874077ff08617e";
        //$order_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_info = $order->where(array('id'=>$order_id))
            ->field('id as order_id,shop_id,order_number,goods_id,money_type,money,price,status,refund_status,user_id,
            pay_time,ok_time,location_id,location,detailed,name')->find();
        if ($order_info['user_id'] != $user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $goods_info = $shop_goods->where(array('id'=>$order_info['goods_id']))->field('name,img_url')->find();
        $order_info['goods_name'] = $goods_info['name'];
        $order_info['img_url'] = $goods_info['img_url'];

        $order_info['location_content'] = $order_info['location'].$order_info['detailed'];
        $order_info['pay_time'] = date('Y-m-d H:i:s',$order_info['pay_time']);
        if ($order_info['ok_time']){
            $order_info['ok_time'] = date('Y-m-d H:i:s',$order_info['ok_time']);
        }else{
            $order_info['ok_time'] = '未使用';
        }
        $user_info2 = $user->where(array('id'=>$order_info['user_id']))->field('phone')->find();
        $order_info['phone'] = $user_info2['phone'];
        $order_info['my_phone'] = $user_info['phone'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $order_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 订单-提交订单需要的数据
     */
    function SubmitOrderData(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));

        //$token = "be196855ebf12c739990376a58376317";
        //$goods_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $goods_info = $shop_goods->where(array('id'=>$goods_id,'is_show'=>'1'))->field('id as goods_id,shop_id,name,img_url,introduce,price,yy_price')->find();

        if (!$goods_info){$arr = array('code'=> 0, 'res'=>'套餐不存在或已下架',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info = $shop->where(array('id'=>$goods_info['shop_id']))->field('is_open')->find();
        $goods_info['shop_is_open'] = $shop_info['is_open'];
        $goods_info['my_phone'] = $user_info['phone'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $goods_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 订单-生成缓存订单
     */
    function CreateOrderCache(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $location_db = M('location');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));
        $location_id = decrypt1(trim(I('post.location_id')));
        $type = decrypt1(trim(I('post.type')));//类型：1支付预约金，2支付全款


        //$token = "be196855ebf12c739990376a58376317";
        //$goods_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $goods_info = $shop_goods->where(array('id'=>$goods_id,'is_show'=>'1'))->field('id as goods_id,shop_id,name,img_url,introduce,price,yy_price')->find();




        if (!$goods_info){$arr = array('code'=> 0, 'res'=>'套餐不存在或已下架',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info = $shop->where(array('id'=>$goods_info['shop_id']))->field('is_open')->find();
        if ($shop_info['is_open']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'该店铺已打烊',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$type){$arr = array('code'=> 0, 'res'=>'请选择支付金额',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if (!$location_id){$arr = array('code'=> 0, 'res'=>'请选择收货地址',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //$location_info = $location_db->where(array('id'=>$location_id))->find();
        //if (!$location_info){$arr = array('code'=> 0, 'res'=>'收货地址错误',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if ($location_info['user_id']!=$user_info['id']){$arr = array('code'=> 0, 'res'=>'收货地址错误',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_number = date('YmdHis').$user_info['id'].rand(1000,9999);
        $add['order_number'] = $order_number;
        $add['status'] = 0;
        $add['shop_id'] = $goods_info['shop_id'];
        $add['goods_id'] = $goods_info['goods_id'];
        $add['user_id'] = $user_info['id'];
        $add['money_type'] = $type;
        if ($type=='1'){
            $add['money'] = $goods_info['yy_price'];
        }else{
            $add['money'] = $goods_info['price'];
        }

        $add['price'] = $goods_info['price'];
        //$add['name'] = $location_info['name'];
        //$add['phone'] = $location_info['phone'];
        //$add['location'] = $location_info['location'];
        //$add['detailed'] = $location_info['detailed'];
        //$add['location_id'] = $location_id;
        $add['pay_status'] = 0;
        $add['create_time'] = time();
        $query = $order->add($add);
        $res = '生成';
        if ($user_info['pay_pass']){
            $is_pass = '1';
        }else{
            $is_pass = '0';
        }
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
                'is_pass'=>$is_pass,
                'money'=>$add['money'],
                'order_id'=>$query
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
                'is_pass'=>$is_pass,
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 使用钱包（余额）支付订单
     */
    function WalletPayOrder(){
        $user = M('user');
        $order = M('order');
        $pass_error = M('pass_error');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $pay_pass = decrypt1(trim(I('post.pay_pass')));


        //$token = "be196855ebf12c739990376a58376317";
        //$pay_pass = "123456";
        //$order_id = "10";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$user_info['pay_pass']){
            $arr = array(
                'code' => 0,
                'res' => '您还没有设置支付密码,请先设置支付密码'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $num = ERRORNUM;//密码错误次数限制
        $today = strtotime(date('Y-m-d'));
        $error_num = $pass_error->where(array('user_id'=>$user_info['id'],'create_time'=>array('EGT',$today)))->count();
        if(!$error_num){$error_num = 0;}
        if($error_num>=$num){
            $arr = array(
                'code' => 0,
                'res' => '支付密码错误次数超过业务限制，请明天再试'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $op = md5(md5($pay_pass));

        if($op!=$user_info['pay_pass']){
            $add_error['user_id'] = $user_info['id'];
            $add_error['pass'] = $pay_pass;
            $add_error['create_time'] = time();
            $pass_error->add($add_error);
            $now_error = $num -  ($error_num+1);
            $arr = array(
                'code' => 0,
                'res' => '支付密码错误,剩余密码错误次数：'.$now_error.'次',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            $pass_error->where(array('user_id'=>$user_info['id']))->delete();
        }


        $order_info = $order->where(array('id'=>$order_id))->find();
        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['pay_status']=='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'订单已经支付',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($user_info['money']<$order_info['money']){
            $arr = array(
                'code'=> 0,
                'res'=>'您的余额不足',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $new_money = $user_info['money']-$order_info['money'];
        $query = $user->where(array('id'=>$user_info['id']))->save(array('money'=>$new_money,'update_time'=>time()));
        $res = '支付';
        if($query){
            $save_order['pay_status'] = 1;
            $save_order['pay_type'] = 4;
            if ($order_info['money_type']=='1'){
                $save_order['status'] = 1;
            }else{
                $save_order['status'] = 2;
            }
            $save_order['pay_time'] = time();
            $is_save = $order->where(array('id'=>$order_info['id']))->save($save_order);
            if ($is_save){

                //金额交易记录
                $add_money['user_id'] = $user_info['id'];
                $add_money['money'] = $order_info['money'];
                //店铺通知
                $shop_info  = $shop->where(array('id'=>$order_info['shop_id']))->find();
                $other_user = $user->where(array('id'=>$shop_info['user_id']))->field('phone')->find();
                $goods_info  = $shop_goods->where(array('id'=>$order_info['goods_id']))->field('name')->find();
                if ($order_info['money_type']=='1'){
                    //OrderSendSms($user_info['phone'],'1','1',$order_info['order_number'],$goods_info['name']);
                    OrderSendSms($other_user['phone'],'2','1',$order_info['order_number'],$goods_info['name']);


                    $add_money['type'] = 3;
                }else{
                    //OrderSendSms($user_info['phone'],'1','2',$order_info['order_number'],$goods_info['name']);
                    OrderSendSms($other_user['phone'],'2','2',$order_info['order_number'],$goods_info['name']);
                    $add_money['type'] = 7;
                }
                $add_money['add_or_del'] = 2;//1增加，2减去
                $add_money['pay_type'] = 4;//1微信，2支付宝，3银联，4余额
                $add_money['create_time'] = time();
                $add_money['order_id'] = $order_info['id'];
                $add_money['create_type'] = 3;//1管理员操作，2系统操作，3用户操作，4业务员操作
                M('money_log')->add($add_money);
                //金额交易记录

                $shop->where(array('id'=>$order_info['shop_id']))->setInc('sales',1);
                $shop->where(array('id'=>$order_info['shop_id']))->setInc('money',$order_info['money']);
                $shop_goods->where(array('id'=>$order_info['goods_id']))->setInc('sales',1);


                //添加消息通知
                $tis = '您有新的订单';
                    //新版
                    $add_system['user_id'] = $shop_info['user_id'];
                    $add_system['send_user_id'] = $user_info['id'];
                    $add_system['content'] = $tis;
                    $add_system['type'] = 1;//1新的订单，2订单交易成功，3待处理订单
                    $add_system['type_id'] = $order_info['id'];
                    $add_system['status'] = 3;
                    $add_system['create_time'] = time();
                    M('system')->add($add_system);

                    $rong_user[] = $shop_info['user_id'];

                    SendRongSystem($rong_user,$tis);
                    //交易提醒
                if ($order_info['money_type']=='1'){

                    $tis = '预约成功';
                    //新版
                    $add_system['user_id'] = $user_info['id'];
                    $add_system['send_user_id'] = $shop_info['user_id'];
                    $add_system['content'] = $tis;
                    $add_system['type'] = 1;//1预约成功，2交易成功，3退款成功，4退款失败
                    $add_system['type_id'] = $order_info['id'];
                    $add_system['status'] = 4;
                    $add_system['create_time'] = time();
                    M('system')->add($add_system);

                    $rong_user[] = $user_info['id'];

                    SendRongSystem($rong_user,$tis);
                }else{
                    $tis = '交易成功';
                    //新版
                    $add_system['user_id'] = $user_info['id'];
                    $add_system['send_user_id'] = $shop_info['user_id'];
                    $add_system['content'] = $tis;
                    $add_system['type'] = 2;//1预约成功，2交易成功，3退款成功，4退款失败
                    $add_system['type_id'] = $order_info['id'];
                    $add_system['status'] = 4;
                    $add_system['create_time'] = time();
                    M('system')->add($add_system);

                    $rong_user[] = $user_info['id'];

                    SendRongSystem($rong_user,$tis);
                }


                $arr = array(
                    'code'=> 1,
                    'res'=>$res.'成功 ',
                    'order_id'=>$order_id
                );
            }else{
                $user_info->where(array('id'=>$user_info['id']))->save(array('money'=>$user_info['money'],'update_time'=>time()));
                $arr = array(
                    'code'=> 0,
                    'res'=>$res.'失败',
                );
            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的订单-使用钱包（余额）支付尾款
     */
    function MyOrderPayAllMoney(){
        $user = M('user');
        $order = M('order');
        $pass_error = M('pass_error');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));
        $pay_pass = decrypt1(trim(I('post.pay_pass')));


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_info = $order->where(array('id'=>$order_id))->find();
        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['pay_status']!='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'订单未支付或支付结算中，请稍后查看订单列表',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if ($order_info['money_type']=='2'){
            $arr = array(
                'code'=> 0,
                'res'=>'该订单已支付全款',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if(!$user_info['pay_pass']){
            $arr = array(
                'code' => 0,
                'res' => '您还没有设置支付密码,请先设置支付密码'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $num = ERRORNUM;//密码错误次数限制
        $today = strtotime(date('Y-m-d'));
        $error_num = $pass_error->where(array('user_id'=>$user_info['id'],'create_time'=>array('EGT',$today)))->count();
        if(!$error_num){$error_num = 0;}
        if($error_num>=$num){
            $arr = array(
                'code' => 0,
                'res' => '支付密码错误次数超过业务限制，请明天再试'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $op = md5(md5($pay_pass));

        if($op!=$user_info['pay_pass']){
            $add_error['user_id'] = $user_info['id'];
            $add_error['pass'] = $pay_pass;
            $add_error['create_time'] = time();
            $pass_error->add($add_error);
            $now_error = $num -  ($error_num+1);
            $arr = array(
                'code' => 0,
                'res' => '支付密码错误,剩余密码错误次数：'.$now_error.'次',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            $pass_error->where(array('user_id'=>$user_info['id']))->delete();
        }

        $pay_money = $order_info['price'] - $order_info['money'];

        if ($user_info['money']<$pay_money){
            $arr = array(
                'code'=> 0,
                'res'=>'您的余额不足',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $new_money = $user_info['money']-$pay_money;
        $query = $user->where(array('id'=>$user_info['id']))->save(array('money'=>$new_money,'update_time'=>time()));
        $res = '支付';
        if($query){
            $save_order['pay_status'] = 1;
            $save_order['pay_type'] = 4;
            $save_order['money_type'] = 2;
            $save_order['money'] = $order_info['price'];
            $save_order['status'] = 2;
            $save_order['pay_time'] = time();
            $is_save = $order->where(array('id'=>$order_info['id']))->save($save_order);
            if ($is_save){
                //金额交易记录
                $add_money['user_id'] = $user_info['id'];
                $add_money['money'] = $pay_money;
                $add_money['type'] = 4;
                $add_money['add_or_del'] = 2;//1增加，2减去
                $add_money['pay_type'] = 4;//1微信，2支付宝，3银联，4余额
                $add_money['create_time'] = time();
                $add_money['order_id'] = $order_info['id'];
                $add_money['create_type'] = 3;//1管理员操作，2系统操作，3用户操作，4业务员操作
                M('money_log')->add($add_money);
                //金额交易记录
                M('shop')->where(array('id'=>$order_info['shop_id']))->setInc('money',$pay_money);
                $tis = '交易成功';
                //新版
                $add_system['user_id'] = $user_info['id'];
                $add_system['send_user_id'] = '';
                $add_system['content'] = $tis;
                $add_system['type'] = 2;//1预约成功，2交易成功，3退款成功，4退款失败
                $add_system['type_id'] = $order_info['id'];
                $add_system['status'] = 4;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $user_info['id'];

                SendRongSystem($rong_user,$tis);

                $arr = array(
                    'code'=> 1,
                    'res'=>$res.'成功 ',
                    'order_id'=>$order_id
                );
            }else{
                $user_info->where(array('id'=>$user_info['id']))->save(array('money'=>$user_info['money'],'update_time'=>time()));
                $arr = array(
                    'code'=> 0,
                    'res'=>$res.'失败',
                );
            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 订单支付完成页面
     */
    function OrderPayOk(){
        $user = M('user');
        $order = M('order');
        $pass_error = M('pass_error');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$pay_pass = "123456";
        //$order_id = "12";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_info = $order->where(array('id'=>$order_id))->find();
        if ($order_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'参数错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if ($order_info['pay_status']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'订单还未支付',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $list['order_id'] = $order_info['id'];
        $list['order_number'] = $order_info['order_number'];
        $list['create_time'] = date('Y-m-d H:i:s',$order_info['create_time']);
        $list['phone'] = $order_info['phone'];
        $list['money'] = $order_info['money'];
        if ($order_info['ok_time']){
            $list['ok_time'] = date('Y-m-d H:i:s',$order_info['ok_time']);
        }else{
            $list['ok_time'] = "未使用";
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 校验身份证与姓名
     */
    function CheckUserCardInfo(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $real_name = decrypt1(trim(I('post.real_name')));
        $card_number = decrypt1(trim(I('post.card_number')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        if($real_name!=$user_info['real_name'] || $card_number!=$user_info['card_number']){
            $arr = array('code'=> 0, 'res'=>'姓名和身份证输入错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }else{
            $arr = array('code'=> 1, 'res'=>'校验成功');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
    }

    /**
     * 设置/修改 支付密码
     */
    function SetPayPass(){
        $user = M('user');
        $pass_cache = M('pass_cache');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $newpass = decrypt1(trim(I('post.newpass')));
        $oldpass = decrypt1(trim(I('post.oldpass')));
        $real_name = decrypt1(trim(I('post.real_name')));
        $card_number = decrypt1(trim(I('post.card_number')));
        //$pass_key = decrypt1(trim(I('post.pass_key')));


        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $min15 = time()-900;
        $pass_cache->where(array('create_time'=>array('ELT',$min15)))->delete();
        if($user_info['pay_pass']){



            if($oldpass){
                $op = md5(md5($oldpass));
                if  ($op!=$user_info['pay_pass']){
                    $arr = array('code'=> 0, 'res'=>'支付密码错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
                }
            }else{
               /* $where_pass['user_id'] = $user_info['id'];
                $where_pass['pass_key'] = $pass_key;
                $is_key = $pass_cache->where($where_pass)->find();*/
                if($real_name!=$user_info['real_name'] || $card_number!=$user_info['card_number']){
                    $arr = array('code'=> 0, 'res'=>'姓名和身份证输入错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
                }

            }

            if(md5(md5($newpass)) == $user_info['pay_pass']){
                $arr = array('code'=> 0, 'res'=>'新密码不能与旧密码相同');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }

        }else{
            if(!$user_info['real_name'] || !$user_info['card_number']){
                $arr = array('code'=> 0, 'res'=>'请先进行身份验证');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }
        }

        if(!is_numeric($newpass) || strlen($newpass)!=6){
            $arr = array('code'=> 0, 'res'=>'支付密码为6位数的纯数字组成');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        $save['pay_pass'] =  md5(md5($newpass));
        $save['update_time'] = time();
        $query = $user->where(array('id'=>$user_info['id']))->save($save);

        if($query){
            $pass_cache->where(array('user_id'=>$user_info['id']))->delete();
            $arr = array(
                'code'=> 1,
                'res'=>'设置成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'设置失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 支付密码设置账户信息
     */
    function SetPayPassUserInfo(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $real_name = decrypt1(trim(I('post.real_name')));
        $card_number = decrypt1(trim(I('post.card_number')));




        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if(!isChineseName($real_name)){
            $arr = array('code'=> 0, 'res'=>'姓名输入不合法');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if(!isIdCard($card_number)){
            $arr = array('code'=> 0, 'res'=>'身份证输入不合法');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        $save['real_name'] =  $real_name;
        $save['card_number'] =  $card_number;
        $save['update_time'] = time();
        $query = $user->where(array('id'=>$user_info['id']))->save($save);

        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'设置成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'设置失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }



    /**
     * 检查当前是否有设置支付密码
     */
    function CheckSetPayPass(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if($user_info['pay_pass']){
            $is_set = "1";
        }else{
            $is_set = "0";
        }

            $arr = array(
                'code'=> 1,
                'res'=>'验证成功',
                'is_set'=>$is_set ,
            );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 验证修改支付密码验证码
     */
    function CheckPayPassCode(){
        $user = M('user');
        $verify = M('verify');
        $pass_cache = M('pass_cache');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $code = decrypt1(trim(I('post.code')));

        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['code'] = $code;
        $where['phone'] = $user_info['phone'];
        $where['type'] = 2;
        $is_code = $verify->where($where)->find();
        if($is_code){
            $op = md5(md5($code));
            $add['user_id'] = $user_info['id'];
            $add['create_time'] = time();
            $add['pass_key'] = md5($op.time().'editxxxxxx'.$user_info['id']);
            $pass_cache->add($add);
            $arr = array(
                'code'=> 1,
                'res'=>'验证成功',
                'pass_key'=>$add['pass_key'] ,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'验证码错误',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 验证当前支付密码是否正确
     */
    function CheckOldPayPass(){
        $user = M('user');
        $pass_error = M('pass_error');
        $pass_cache = M('pass_cache');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $oldpass = decrypt1(trim(I('post.oldpass')));

        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$user_info['pay_pass']){
            $arr = array(
                'code' => 0,
                'res' => '您还没有设置支付密码'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $num = ERRORNUM;//密码错误次数限制
        $today = strtotime(date('Y-m-d'));
        $error_num = $pass_error->where(array('user_id'=>$user_info['id'],'create_time'=>array('EGT',$today)))->count();
        if(!$error_num){$error_num = 0;}
        if($error_num>=$num){
            $arr = array(
                'code' => 0,
                'res' => '支付密码错误次数超过业务限制，请明天再试'
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $op = md5(md5($oldpass));

        if($op!=$user_info['pay_pass']){
            $add_error['user_id'] = $user_info['id'];
            $add_error['pass'] = $oldpass;
            $add_error['create_time'] = time();
            $pass_error->add($add_error);
            $now_error = $num -  ($error_num+1);
            $arr = array(
                'code' => 0,
                'res' => '支付密码错误,剩余密码错误次数：'.$now_error.'次',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            $add['user_id'] = $user_info['id'];
            $add['create_time'] = time();
            $add['pass_key'] = md5($op.time().'editxxxxxx');
            $pass_cache->add($add);
            $pass_error->where(array('user_id'=>$user_info['id']))->delete();
            $arr = array(
                'code'=> 1,
                'res'=>'验证成功',
                'pass_key'=>$add['pass_key'],
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
    }

    /**
     * 忘记支付密码-当前用户手机号
     */
    function UserPhone(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));


        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功 ',
            'phone'=>$user_info['phone']
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 每日登陆签到
     * @throws \think\db\exception\DataNotFoundException
     * @throws \think\db\exception\ModelNotFoundException
     * @throws \think\exception\DbException
     */
    function EverydayScore(){
        $user = M('user');


        //接收数据
        $token = decrypt1(trim(I('post.token')));


        //$token = "dcb54848991670ee524758cbac370228";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //评论增加积分
        $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'4','0');
        $arr = array(
            'code'=> 1,
            'res'=>'签到成功'
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 扫码获取用户信息
     */
    function QrUserInfo(){
        $user = M('user');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$token = '95c599eb3b507d8328d033d08be501d8';
        $take_user_id = decrypt1(trim(I('post.take_user_id')));
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $other_user = $user->where(array('id'=>$take_user_id))->field('name,head')->find();


        if ($user_info['pay_pass']){
            $is_pay = '1';
        }else{
            $is_pay = '0';
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'is_pay'=>$is_pay,
            'my_money'=>$user_info['money'],
            'other_user'=>$other_user
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 扫码付款
     */
    function QrPay(){
        $user = M('user');
        $money_log = M('money_log');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $money = decrypt1(trim(I('post.money')));
        $take_user_id = decrypt1(trim(I('post.take_user_id')));
        $pay_pass = decrypt1(trim(I('post.pay_pass')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (preg_match('/^[0-9]+(.[0-9]{1,2})?$/', $money)) {
            //整数或小数二位的正则
        }else {
            $arr = array('code'=> 0, 'res'=>'金额输入错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        if ($money<=0){
            $arr = array('code'=> 0, 'res'=>'金额错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if ($money>50000){
            $arr = array('code'=> 0, 'res'=>'付款金额不能超过5万');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if ($user_info['money']<$money){
            $arr = array('code'=> 0, 'res'=>'您的余额不足');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }



        if ($take_user_id==$user_info['id']){
            $arr = array('code'=> 0, 'res'=>'不能给自己付款');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        $take_user_info = $user->where(array('id'=>$take_user_id))->field('id,name,head,money')->find();
        if (!$take_user_info){
            $arr = array('code'=> 0, 'res'=>'付款用户不存在');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        if (!$user_info['pay_pass']){
            $arr = array('code'=> 0, 'res'=>'请先设置支付密码');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        $op = md5(md5($pay_pass));
        if ($op!=$user_info['pay_pass']){
            $arr = array('code'=> 0, 'res'=>'支付密码错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }



        $user_money = $user_info['money'] - $money;
        $query = $user->where(array('id'=>$user_info['id']))->save(array('money'=>$user_money,'update_time'=>time()));

        if($query){
            $take_user_money = $take_user_info['money'] + $money;
            $query_user = $user->where(array('id'=>$take_user_id))->save(array('money'=>$take_user_money,'update_time'=>time()));

            if($query_user){
                //金额变动记录
                $add_log['user_id'] = $user_info['id'];
                $add_log['money'] = $money;
                $add_log['type'] = 7;
                $add_log['add_or_del'] = 2;
                $add_log['create_time'] = time();
                $add_log['create_type'] = 3;
                $add_log['pay_type'] = 4;
                $add_log['order_id'] = $take_user_id;
                $money_log->add($add_log);


                $add_log2['user_id'] = $take_user_id;
                $add_log2['money'] = $money;
                $add_log2['type'] = 6;
                $add_log2['add_or_del'] = 1;
                $add_log2['create_time'] = time();
                $add_log2['create_type'] = 3;
                $add_log2['pay_type'] = 4;
                $add_log2['order_id'] = $user_info['id'];
                $money_log->add($add_log2);


                $tz_con['type'] = 'qr_pay';
                $tz_con['id'] = $user_info['id'];
                $tz_con['name'] = $user_info['name'];
                $tz_con['money'] = $money;
                $tz_con['head'] = $user_info['head'];
                SendSocket($take_user_id,json_encode($tz_con));


                //金额变动记录
                $arr = array(
                    'code'=> 1,
                    'res'=>'付款成功',
                );
            }else{
                $user->where(array('id'=>$user_info['id']))->save(array('money'=>$user_info['money'],'update_time'=>time()));
                $arr = array(
                    'code'=> 0,
                    'res'=>'付款失败'
                );
            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'付款失败'
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 发送红包
     */
    function SendHongBao(){
        $user = M('user');
        $hongbao = M('hongbao');
        $money_log = M('money_log');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $money = decrypt1(trim(I('post.money')));
        $info = decrypt1(trim(I('post.info')));
        $take_user_id = decrypt1(trim(I('post.take_user_id')));
        $pay_pass = decrypt1(trim(I('post.pay_pass')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (preg_match('/^[0-9]+(.[0-9]{1,2})?$/', $money)) {
         //整数或小数二位的正则
        }else {
            $arr = array('code'=> 0, 'res'=>'金额输入错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if ($money<=0){
            $arr = array('code'=> 0, 'res'=>'金额错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        if ($money>200){
            $arr = array('code'=> 0, 'res'=>'红包金额不能超过200');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if ($user_info['money']<$money){
            $arr = array('code'=> 0, 'res'=>'您的余额不足');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }



        if ($take_user_id==$user_info['id']){
            $arr = array('code'=> 0, 'res'=>'不能给自己发红包');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if (!$user_info['pay_pass']){
            $arr = array('code'=> 0, 'res'=>'请先设置支付密码');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        $op = md5(md5($pay_pass));
        if ($op!=$user_info['pay_pass']){
            $arr = array('code'=> 0, 'res'=>'支付密码错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }


        if (!$info){
            $info = "恭喜发财，大吉大利";
        }

        $add['user_id'] = $user_info['id'];
        $add['money'] = $money;
        $add['take_user_id'] = $take_user_id;
        $add['info'] = $info;
        $add['start_time'] = time();
        $add['end_time'] = strtotime('+1 day');
        $add['is_end'] = '0';
        $add['is_ling'] = '0';
        $add['create_time'] = time();

        $query = $hongbao->add($add);
        if($query){
            $user_money = $user_info['money'] - $money;
            $query_user = $user->where(array('id'=>$user_info['id']))->save(array('money'=>$user_money,'update_time'=>time()));
            if($query_user){
                //金额变动记录
                $add_log['user_id'] = $user_info['id'];
                $add_log['money'] = $money;
                $add_log['type'] = 3;
                $add_log['add_or_del'] = 2;
                $add_log['create_time'] = time();
                $add_log['create_type'] = 2;
                $add_log['pay_type'] = 4;
                $add_log['order_id'] = $query;
                $money_log->add($add_log);
                //金额变动记录
                $arr = array(
                    'code'=> 1,
                    'res'=>'发送成功',
                    'hongbao_id'=>$query
                );
            }else{
                $hongbao->where(array('id'=>$query))->delete();
                $arr = array(
                    'code'=> 0,
                    'res'=>'发送失败'
                );
            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'发送失败'
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 领取红包
     */
    function LingHongBao(){
        $user = M('user');
        $hongbao = M('hongbao');
        $money_log = M('money_log');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $hongbao_id = decrypt1(trim(I('post.hongbao_id')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $hongbao_info = $hongbao->where(array('id'=>$hongbao_id))->find();

        if($hongbao_info['take_user_id']!=$user_info['id']){$arr = array('code'=> 0, 'res'=>'没有权限领取该红包');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($hongbao_info['is_end']=='1'){$arr = array('code'=> 0, 'res'=>'红包已过期');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($hongbao_info['is_ling']=='1'){$arr = array('code'=> 0, 'res'=>'红包已被领取');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $query = $hongbao->where(array('id'=>$hongbao_id))->save(array('is_ling'=>'1','ling_time'=>time()));

        if ($query){
            $user_money =  $user_info['money'] + $hongbao_info['money'];
            $query_user = $user->where(array('id'=>$user_info['id']))->save(array('money'=>$user_money,'update_time'=>time()));
            if($query_user){
                //金额变动记录
                $add_log['user_id'] = $user_info['id'];
                $add_log['money'] = $hongbao_info['money'];
                $add_log['type'] = 4;
                $add_log['add_or_del'] = 1;
                $add_log['create_time'] = time();
                $add_log['create_type'] = 2;
                $add_log['pay_type'] = 4;
                $add_log['order_id'] = $hongbao_id;
                $money_log->add($add_log);
                //金额变动记录


                $arr = array(
                    'code'=> 1,
                    'res'=>'领取成功',
                    'hongbao_id'=>$query
                );
            }else{
                $hongbao->where(array('id'=>$query))->delete();
                $arr = array(
                    'code'=> 0,
                    'res'=>'领取失败'
                );
            }

        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'领取失败'
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 红包详情
     */
    function HongBaoInfo(){
        $user = M('user');
        $hongbao = M('hongbao');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        //$token = '2dafb43698a8d612f48a3282ba816a8a';
        $hongbao_id = decrypt1(trim(I('post.hongbao_id')));
        //$hongbao_id = 31;
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $hongbao_info = $hongbao->where(array('id'=>$hongbao_id))->find();
        if($hongbao_info['user_id']!=$user_info['id'] && $hongbao_info['take_user_id'] != $user_info['id'])
        {$arr = array('code'=> 0, 'res'=>'没有查看权限');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        unset($hongbao_info['start_time']);
        unset($hongbao_info['end_time']);
        unset($hongbao_info['update_time']);
        if ($hongbao_info['ling_time']>0){
            $hongbao_info['ling_time'] = date('Y-m-d H:i:s',$hongbao_info['ling_time']);
        }
        $hongbao_info['create_time'] = date('Y-m-d H:i:s',$hongbao_info['create_time']);

        if($hongbao_info['user_id']==$user_info['id']){
            $hongbao_info['user_name'] = $user_info['name'];
            $hongbao_info['user_head'] = $user_info['head'];
            $other_user = $user->where(array('id'=>$hongbao_info['take_user_id']))->field('name,head')->find();
            $hongbao_info['take_user_name'] = $other_user['name'];
            $hongbao_info['take_user_head'] = $other_user['head'];
        }else{
            $hongbao_info['take_user_name'] = $user_info['name'];
            $hongbao_info['take_user_head'] = $user_info['head'];
            $other_user = $user->where(array('id'=>$hongbao_info['user_id']))->field('name,head')->find();
            $hongbao_info['user_name'] = $other_user['name'];
            $hongbao_info['user_head'] = $other_user['head'];
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$hongbao_info
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的红包
     */
    function MyHongBao(){
        $user = M('user');
        $hongbao = M('hongbao');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//类型：1收到的红包，2发出的红包;
        //$token = '95c599eb3b507d8328d033d08be501d8';
        if (!$type){$type='1';}


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $total_money = 0;
        $total_num = 0;

        $where['is_ling'] = 1;

        if ($type=='1'){
            $where['take_user_id'] = $user_info['id'];
        }else{
            $where['user_id'] = $user_info['id'];
        }

        $total_money+=$hongbao->where($where)->sum('money');
        $total_num += $hongbao->where($where)->count();

        $list['name'] = $user_info['name'];
        $list['head'] = $user_info['head'];
        $list['total_money'] = (String)$total_money;
        $list['total_num'] = (String)$total_num;


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 交易记录
     */
    function MoneyLog(){
        $user = M('user');
        $money_log = M('money_log');
        $money_log_type = M('money_log_type');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//类型：0全部，1收入，2支出
        //$token = '95c599eb3b507d8328d033d08be501d8';

        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;
        if (!$type){$type='0';}


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $where['user_id'] = $user_info['id'];
        if ($type=='1'){
            $where['add_or_del'] = 1;
        }else if ($type=='2'){
            $where['add_or_del'] = 2;
        }else{
           //全部
        }

        $type_list = $money_log_type->select();
        foreach ($type_list as $item){
            $new_type[$item['value']] = $item['name'];
        }

        $list = $money_log->where($where)->field('id,money,type,add_or_del,create_time')->limit($start,$num)->order('create_time desc')->select();
        foreach ($list as $key=>$item){
            $list[$key]['create_time'] = date('Y-m-d H:i:s',$item['create_time']);
            $list[$key]['type'] = $new_type[$item['type']];
            if ($item['add_or_del']=='1'){
                $list[$key]['money'] = '+'.$item['money'];
            }else{
                $list[$key]['money'] = '-'.$item['money'];
            }
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /**
     * 积分商城-积分订单
     */
    function ShopMyPrizeOrder(){
        $user = M('user');
        $shop_prize_order = M('shop_prize_order');
        $shop_prize = M('shop_prize');
        $shop_prize_select = M('shop_prize_select');
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 10;//分页数
        $start = ($page-1)*$num;


        /*补位查看收货超出7天*/
        //$time_7 = strtotime("-5 day");
        //M('shop_order')->where(array('status'=>'2','fh_time'=>array('ELT',$time_7)))->save(array('status'=>'3','ok_time'=>time()));
        //M('shop_prize_order')->where(array('status'=>'2','fh_time'=>array('ELT',$time_7)))->save(array('status'=>'3','ok_time'=>time()));

        //$token = '38e59920c3837c2f1e7606c78551c12c';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $where['user_id'] = $user_info['id'];
        $where['status'] = array('NEQ','0');
        $order_list = $shop_prize_order->where($where)->order('create_time desc')
            ->limit($start,$num)->field('id as prize_order_id,order_number,status,total_score,select_id,num,prize_id,select_val')->select();
        foreach($order_list as $key2=>$item){
            $prize_info = $shop_prize->where(array('id'=>$item['prize_id']))->field('name,cover')->find();
            $select_info = $shop_prize_select->where(array('id'=>$item['select_id']))->field('add_price')->find();
            $prize_info['select_val'] = $item['select_val'];
            $prize_info['score'] = $select_info['add_price'];
            unset($order_list[$key2]['select_val']);
            $order_list[$key2]['prize_info'] = $prize_info;
        }


        $user_list  =  $user->where(array('is_service'=>"1"))->field('id,rong_token')->order('rand()')->find();
        $user_list['rong_token'] = $user_list['rong_token']?$user_list['rong_token']:"";

        $set = M('set');
        $set_info = $set->where(array('set_type'=>'service_call'))->field('set_value')->find();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'service_tel'=>$set_info['set_value'],
            'service_online'=>$user_list,
            'order_list'=>$order_list,
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 积分商城-积分订单详细
     */
    function ShopMyPrizeOrderDetail(){

        $shop_prize_order = M('shop_prize_order');
        $shop_prize = M('shop_prize');
        $shop_prize_select = M('shop_prize_select');
        $user = M('user');
        $token = decrypt1(trim(I('post.token')));
        $prize_order_id = decrypt1(trim(I('post.prize_order_id')));

        //$prize_order_id = 1;
        //$token = '38e59920c3837c2f1e7606c78551c12c';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $order_info = $shop_prize_order->where(array('id'=>$prize_order_id))->field('id as prize_order_id,order_number,status,total_score,prize_id,select_id,num,addressee,mobile,location,particular,create_time')->find();
        $order_info['create_time'] = date('Y-m-d H:i:s',$order_info['create_time']);
        $order_info['location'] = $order_info['location'].$order_info['particular'];
        unset($order_info['particular']);
        $prize_info = $shop_prize->where(array('id'=>$order_info['prize_id']))->field('name,cover')->find();

        $arr_select = explode('.',$order_info['select_id']);
        $select_arr = array();

        foreach($arr_select as $val){
            $select_info = $shop_prize_select->where(array('id'=>$val))->field('select_name,value,add_price')->find();
            $select_arr[] = $select_info['select_name'].':'.$select_info['value'];

            $prize_info['score'] = $select_info['add_price'];
        }
        $select_arr[]  = "数量:".$order_info['num'];

        $prize_info['select_val'] = implode(',',$select_arr);


        $order_info['prize_info'] = $prize_info;


        $user_list  =  $user->where(array('is_service'=>"1"))->field('id,rong_token')->order('rand()')->find();
        $user_list['rong_token'] = $user_list['rong_token']?$user_list['rong_token']:"";
        $set = M('set');
        $set_info = $set->where(array('set_type'=>'service_call'))->field('set_value')->find();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'service_tel'=>$set_info['set_value'],
            'service_online'=>$user_list,
            'order_info'=>$order_info,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 积分商城-积分订单确认收货
     */
    function ShopPrizeOrderSuccess(){
        $user = M('user');
        $shop_prize_order = M('shop_prize_order');
        $token = decrypt1(trim(I('post.token')));
        $prize_order_id = decrypt1(trim(I('post.prize_order_id')));

        //$token = '7680d109eecf3429780c3a11309b5aba';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $order_info = $shop_prize_order->where(array('id'=>$prize_order_id))->field('id as prize_order_id,status')->find();
        if($order_info['status']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'订单未支付',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($order_info['status']=='3'){
            $arr = array(
                'code'=> 0,
                'res'=>'订单收货',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $save['status'] = '3';
        $save['ok_time'] = time();
        $query = $shop_prize_order->where(array('id'=>$prize_order_id))->save($save);
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'收货成功',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'收货失败',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
    }



    /**
     * 积分记录
     */
    function UserInfoScore(){
        $user = M('user');
        $shop_order = M('shop_order');
        $shop_score_log = M('shop_score_log');
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = '7680d109eecf3429780c3a11309b5aba';
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $score_list = $shop_score_log->where(array('user_id'=>$user_info['id']))->field('add_or_del,num,type,order_id,create_time,type_id')->order('create_time desc')->limit($start,$num)->select();
        foreach($score_list as $key=>$item){
            $score_list[$key]['create_time'] = date('Y-m-d H:i:s',$item['create_time']);
            if($item['type']=='1'){
                $score_list[$key]['content'] = '兑换礼品';
            }else if ($item['type']=='2'){
                $score_list[$key]['content'] = '支付医院订单抵消';
            }else if ($item['type']=='3'){
                $money = $shop_order->where(array('id'=>$item['order_id']))->field('total_money')->find();
                $score_list[$key]['content'] = '消费'.$money['total_money'].'元';
            }else if ($item['type']=='4'){
                $show_name = M('level_type')->where(array('tid'=>$item['type_id']))->find();
                $score_list[$key]['content'] = $show_name['name'];
            }else if ($item['type']=='5'){
                $score_list[$key]['content'] = '注册获得';
            }else if ($item['type']=='6'){
                $score_list[$key]['content'] = '邀请好友获得';
            }else if ($item['type']=='7'){
                $score_list[$key]['content'] = '发送红包';
            }else if ($item['type']=='8'){
                $score_list[$key]['content'] = '红包获得';
            }else if ($item['type']=='9'){
                $score_list[$key]['content'] = '医院订单退款返还';
            }else if ($item['type']=='10'){
                $score_list[$key]['content'] = '游戏扣除';
            }else if ($item['type']=='11'){
                $score_list[$key]['content'] = '游戏获得';
            }else if ($item['type']=='12'){
                $score_list[$key]['content'] = '游戏通关奖励';
            }else if ($item['type']=='13'){
                $score_list[$key]['content'] = '游戏退还';
            }else if ($item['type']=='14'){
                $score_list[$key]['content'] = '邀请好友玩游戏获得';
            }else{
                $score_list[$key]['content'] = '-';
            }


        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'score'=>$user_info['score'],
            'score_list'=>$score_list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 关于我们
     */
    function AboutUs(){
        $user = M('user');
        $set = M('set');
        $about = M('about');
        $token = decrypt1(trim(I('post.token')));
/*        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;*/

        //$token = '7680d109eecf3429780c3a11309b5aba';
        if ($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }

        $set_info = $set->where(array('set_type'=>'company_info'))->find();
        $company_info['title'] = $set_info['set_value'];
        $company_info['content'] = $set_info['remark'];

        $about_list = $about->where(array('is_show'=>'1'))->field('id,title,img_url')->order('sort,create_time desc')->select();

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'company_info'=>$company_info,
            'list'=>$about_list,
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 新增收藏
     */
    function AddCollect(){
        $user = M('user');
        $collect = M('collect');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//类型：1日记，2商品
        $type_id = decrypt1(trim(I('post.type_id')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        //if(!$content){$arr = array('code'=> 0, 'res'=>'收藏内容不能为空');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}




        $add['user_id'] = $user_info['id'];
        $add['type'] = $type;
        $add['type_id'] = $type_id;

        $is_sc = $collect->where($add)->find();

        if($is_sc){$arr = array('code'=> 0, 'res'=>'已收藏，请勿重复操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $add['create_time'] = time();
        $query = $collect->add($add);
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'收藏成功',
                'collect_id'=>$query
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'收藏失败'
            );
        }


        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 我的收藏
     */
    function MyCollect(){
        $user = M('user');
        $shop_goods = M('shop_goods');
        $collect = M('collect');
        $user_blogs = M('user_blogs');
        $shop = M('shop');
        $user_blogs_photo = M('user_blogs_photo');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));

        //$token = 'bfe61fc6813d23f70d60302beb815347';

        $page = decrypt1(trim(I('post.page')));
        if(!$type){$type = 2;}
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $where['user_id'] = $user_info['id'];
        $where['type'] = $type;

        $diary_classify = M('diary_classify');

        $class_list = $diary_classify->order('sort,create_time desc')->field('id,name')->select();
        foreach ($class_list as $item){
            $new_class[$item['id']] = $item['name'];
        }
        $list = $collect->where($where)->order('create_time desc')->limit($start,$num)->select();

        foreach($list as $key=>$item){
            $blogs_info  = array();
            $goods_list  = array();
            $list[$key]['create_time'] = date('Y.m.d',$item['create_time']);
            if ($item['type']=='1'){


                $blogs_info = $user_blogs->where(array('id'=>$item['type_id'],'is_show'=>'1'))
                    ->field('id,content,video_url,video_thumb,video_width,video_height,type,class_type')->find();

                if  ($blogs_info){
                    $blogs_info['create_time'] = $list[$key]['create_time'];
                    if(!$blogs_info['video_url']){
                        $blogs_info['video_url'] = "";
                    }
                    if(!$blogs_info['video_height']){
                        $blogs_info['video_height'] = "0";
                    }
                    if(!$blogs_info['video_width']){
                        $blogs_info['video_width'] = "0";
                    }
                    if(!$blogs_info['video_thumb']){
                        $blogs_info['video_thumb'] = "";
                    }

                    if($blogs_info['type']=='1'){
                        $img_list = $user_blogs_photo->where(array('blogs_id' => $blogs_info['id']))->order('id')->field('img_url')->find();
                        $blogs_info['img_url'] = $img_list['img_url'];
                    }else{
                        $blogs_info['img_url'] = '';
                    }
                    $blogs_info['is_have'] = '1';
                }else{
                    $blogs_info['is_have'] = '0';
                }

                $goods_list['is_have'] = '0';

                $list[$key]['blogs_info'] = $blogs_info;
                $list[$key]['class_name'] = $new_class[$blogs_info['class_type']];
                $list[$key]['goods_info'] = $goods_list;

            }else{


                $goods_list = $shop_goods->where(array('id'=>$item['type_id'],'is_show'=>'1','is_del'=>'0','is_freeze'=>'1'))->field('id,shop_id,name,cover,price,sales')->find();

                if  ($goods_list){
                    $shop_name = $shop->where(array('id'=>$goods_list['shop_id']))->field('name')->find();
                    $goods_list['shop_name'] = $shop_name['name'];
                    $goods_list['is_have'] = '1';
                }else{
                    $goods_list['is_have'] = '0';
                }
                $blogs_info['is_have'] = '0';



                $list[$key]['goods_info'] = $goods_list;
                $list[$key]['blogs_info'] = $blogs_info;
            }


            //unset($list[$key]['update_time']);

        }





        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 删除收藏
     */
    function DelCollect(){
        $user = M('user');
        $collect = M('collect');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));

        //$token  = 'bfe61fc6813d23f70d60302beb815347';
        //$id  = '3';

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $collect->where(array('id'=>$id))->find();

        if($user_info['id']!= $list['user_id']){$arr = array('code'=> 0, 'res'=>'没有删除权限');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $query = $collect->where(array('id'=>$id))->delete();
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>'删除成功'
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'删除失败'
            );
        }

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 查看收藏-收藏详细
     */
    function CollectDetail(){
        $user = M('user');
        $collect = M('collect');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $id = decrypt1(trim(I('post.id')));

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


       $list =  $collect->where(array('id'=>$id))->field('id,type,content,video_thumb,create_time')->find();

        $list['create_time'] = date('Y-m-d H:i:s',$list['create_time']);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list,
        );

        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 店铺-新开店
     */
    function ShopNewOpen(){
        $user = M('user');
        $shop = M('shop');
        $shop_photo = M('shop_photo');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $shop_name = decrypt1(trim(I('post.shop_name')));
        $classify = decrypt1(trim(I('post.classify')));
        $mobile = decrypt1(trim(I('post.mobile')));
        $is_open = decrypt1(trim(I('post.is_open')));
        $introduce = decrypt1(trim(I('post.introduce')));
        $way = decrypt1(trim(I('post.way')));
        $type = decrypt1(trim(I('post.type')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $location = decrypt1(trim(I('post.location')));


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $is_have = $shop->where(array('user_id'=>$user_info['id']))->find();
        if ($is_have){
            $arr = array(
                'code'=> 0,
                'res'=>'一个账户只能开一个店铺',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if ($type=='1'){
            if ($user_info['id_card_at']=='0'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请先进行身份证认证',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }else{
            if ($user_info['id_card_at']=='0'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请先进行身份证认证',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
            if ($user_info['company_at']=='0'){
                $arr = array(
                    'code'=> 0,
                    'res'=>'请先进行企业认证',
                );
                $data = json_encode($arr);
                $return['encryption'] =  encrypt1($data);
                $this->ajaxReturn($return,"JSON");
            }
        }

        if ($user_info['wx_at']=='0' && $user_info['ali_at']=='0' && $user_info['bank_at']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'微信认证、支付宝认证和银行卡认证中请至少认证一种',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if (!$lng || !$lat){
            $arr = array(
                'code'=> 0,
                'res'=>'请先开启GPS定位',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$img_url){
            $arr = array(
                'code'=> 0,
                'res'=>'请上传店铺logo',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$shop_name){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入店铺名称',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (strlen($shop_name)>30){
            $arr = array(
                'code'=> 0,
                'res'=>'店铺名称不能超过10个汉字',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$classify){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入行业分类',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$introduce){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入服务介绍',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $img_list  = explode(',',$img_url);
        if (count($img_list)<2){
            $arr = array(
                'code'=> 0,
                'res'=>'请上传店铺图片',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $add['shop_name'] = $shop_name;
        $add['user_id'] = $user_info['id'];
        $add['type'] = $type;
        $add['logo'] = $img_list[0];
        $add['classify'] = $classify;
        $add['mobile'] = $mobile;
        $add['is_open'] = $is_open;
        $add['introduce'] = $introduce;
        $add['way'] = $way;
        $add['lng'] = $lng;
        $add['lat'] = $lat;
        $add['location'] = $location;
        $add['create_time'] = time();
        $query = $shop->add($add);
        $res = '开店';
        if($query){
            if (count($img_list)>1){
                $add_photo['shop_id'] = $query;
                foreach ($img_list as $key=>$item){
                    if($key!=0){
                        $add_photo['img_url'] = $item;
                        $add_photo['create_time'] = time();
                        $shop_photo->add($add_photo);
                    }
                }
            }
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
                'shop_id'=>$query,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 店铺-修改店铺资料
     */
    function ShopEdit(){
        $user = M('user');
        $shop = M('shop');
        $shop_photo = M('shop_photo');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $shop_name = decrypt1(trim(I('post.shop_name')));
        $classify = decrypt1(trim(I('post.classify')));
        $mobile = decrypt1(trim(I('post.mobile')));
        $is_open = decrypt1(trim(I('post.is_open')));
        $introduce = decrypt1(trim(I('post.introduce')));
        $way = decrypt1(trim(I('post.way')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        $location = decrypt1(trim(I('post.location')));
        $shop_id = decrypt1(trim(I('post.shop_id')));


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('id'=>$shop_id))->find();
        if($shop_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'您不是此店店主',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if (!$lng || !$lat){
            $arr = array(
                'code'=> 0,
                'res'=>'请先开启GPS定位',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$img_url){
            $arr = array(
                'code'=> 0,
                'res'=>'请上传店铺logo',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$shop_name){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入店铺名称',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (strlen($shop_name)>20){
            $arr = array(
                'code'=> 0,
                'res'=>'店铺名称不能超过20个字符',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$classify){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入行业分类',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if (!$introduce){
            $arr = array(
                'code'=> 0,
                'res'=>'请输入服务介绍',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $img_list  = explode(',',$img_url);

        if (count($img_list)<2){
            $arr = array(
                'code'=> 0,
                'res'=>'请上传店铺图片',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $save['shop_name'] = $shop_name;
        $save['user_id'] = $user_info['id'];
        $save['logo'] = $img_list[0];
        $save['classify'] = $classify;
        $save['mobile'] = $mobile;
        $save['is_open'] = $is_open;
        $save['introduce'] = $introduce;
        $save['way'] = $way;
        $save['lng'] = $lng;
        $save['lat'] = $lat;
        $save['location'] = $location;
        $save['update_time'] = time();
        $query = $shop->where(array('id'=>$shop_info['id']))->save($save);
        $res = '修改';
        if($query){
            $shop_photo->where(array('shop_id'=>$shop_info['id']))->delete();
            if (count($img_list)>1){
                $add_photo['shop_id'] = $shop_info['id'];
                foreach ($img_list as $key=>$item){
                    if($key!=0){
                        $add_photo['img_url'] = $item;
                        $add_photo['create_time'] = time();
                        $shop_photo->add($add_photo);
                    }
                }
            }
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
                'shop_id'=>$shop_id,
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }

    /**
     * 店铺-店铺资料
     */
    function ShopEditDetail(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $shop_photo = M('shop_photo');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));


        //$token = "ee79cc502b8833445681295161e74def";
        //$shop_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('id'=>$shop_id))->find();
        if($shop_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'您不是此店店主',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        unset($shop_info['create_time']);
        unset($shop_info['update_time']);
        unset($shop_info['is_freeze']);
        unset($shop_info['sales']);
        unset($shop_info['star']);
        $shop_img_list = $shop_photo->where(array('shop_id'=>$shop_info['id']))->order('id')->field('img_url')->select();
        foreach ($shop_img_list as $item){
            if ($item['img_url']){
                $img_list[] = $item['img_url'];
            }
        }
        if ($img_list){
            $shop_info['img_list'] = $img_list;
        }else{
            $shop_info['img_list'] = array();
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $shop_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 店铺-店铺详情
     */
    function ShopCheckDetail(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $shop_blogs = M('shop_blogs');
        $shop_blogs_photo = M('shop_blogs_photo');
        $shop_photo = M('shop_photo');
        $shop_follow = M('shop_follow');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $page = decrypt1(trim(I('post.page')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$token = "ee79cc502b8833445681295161e74def";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('id'=>$shop_id))->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'店铺不存在或已关闭',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'店铺不存在或已关闭',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $dian_user_info = $user->where(array('id'=>$shop_info['user_id']))
            ->field('phone_at,id_card_at,wx_at,ali_at,qq_at,weibo_at,bank_at,company_at')->find();
        $shop_info['phone_at'] = $dian_user_info['phone_at'];
        $shop_info['id_card_at'] = $dian_user_info['id_card_at'];
        $shop_info['wx_at'] = $dian_user_info['wx_at'];
        $shop_info['ali_at'] = $dian_user_info['ali_at'];
        $shop_info['qq_at'] = $dian_user_info['qq_at'];
        $shop_info['weibo_at'] = $dian_user_info['weibo_at'];
        $shop_info['bank_at'] = $dian_user_info['bank_at'];
        $shop_info['company_at'] = $dian_user_info['company_at'];

        //是否关注
        $is_follow = $shop_follow->where(array('user_id'=>$user_info['id'],'shop_id'=>$shop_info['id']))->find();
        if ($is_follow){
            $shop_info['is_follow'] = '1';
        }else{
            $shop_info['is_follow'] = '0';
        }


        //banner
        $photo_list = $shop_photo->where(array('shop_id'=>$shop_info['id']))->field('img_url')->select();
        foreach ($photo_list as $item){
            if ($item['img_url']){
                $banner_list[] = $item['img_url'];
            }
        }
        $shop_info['banner_list'] = $banner_list;

        //动态
        $blogs_count = 0;
        $blogs_count+=$shop_blogs->where(array('shop_id'=>$shop_info['id']))->count();
        $shop_info['blogs_count'] = (String)$blogs_count;

        $blogs_list = $shop_blogs->where(array('shop_id'=>$shop_info['id'],'type'=>'1'))->limit(4)->order('create_time desc')->field('id')->select();
        foreach($blogs_list as $item){
            $img_info = $shop_blogs_photo->where(array('shop_blogs_id'=>$item['id']))->order('id')->field('img_url')->find();
            if ($img_info){
                $img_list[] = $img_info['img_url'];
            }
        }

        if($img_list){
            $shop_info['img_list'] = $img_list;
        }else{
            $shop_info['img_list'] = array();
        }

        //套餐
        $goods_list = $shop_goods->where(array('shop_id'=>$shop_info['id'],'is_show'=>'1','is_freeze'=>'1'))
            ->order('create_time desc')
            ->field('id as goods_id,name,img_url,price,introduce,sales')->select();
        $shop_info['goods_list'] = $goods_list;

        if($lat&&$lng&&$shop_info['lat']&&$shop_info['lng']){
            $shop_info['dis'] = getDistance($shop_info['lat'],$shop_info['lng'],$lat,$lng);
        }else{
            $shop_info['dis'] ='';
        }
        //评论
        $where_order['lyx_order.shop_id'] = $shop_info['id'];
        $where_order['lyx_order.pay_status'] = 1;
        $where_order['lyx_order.status'] = 5;
        $where_order['lyx_order.comment'] = array('exp','is not null');
        $comment_list = $order->where($where_order)
            ->join('lyx_user ON lyx_order.user_id = lyx_user.id')
            ->limit($start,$num)
            ->order('lyx_order.create_time desc')
            ->field('lyx_order.user_id,lyx_user.name,lyx_user.head,lyx_user.vip,lyx_user.sex,lyx_user.age,lyx_user.level,lyx_order.comment,lyx_order.create_time')
            ->select();

        $comment_count =  0;
        $comment_count += $order->where($where_order)->count();
        $shop_info['comment_count'] = (String)$comment_count;
        if ($comment_list){
            foreach ($comment_list as $key=>$item){
                $comment_list[$key]['create_time'] = mdate($item['create_time']);
            }
            $shop_info['comment_list'] = $comment_list;
        }else{
            $shop_info['comment_list'] = array();
        }

        unset($shop_info['create_time']);
        unset($shop_info['update_time']);
        unset($shop_info['is_freeze']);

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $shop_info
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 发货-快递公司信息
     */
    function ExpressListInfo(){

        $user = M('user');
        $express_com = M('express_com');
        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "bf8739cb479fa5d17c98dfbb7beb1452";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $express_com->where(array('is_show'=>'1'))->order('sort desc')->field('id,name,code')->select();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );


        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }







    /**
     * 店铺-关注店铺
     */
    function ShopAddFollow(){
        $user = M('user');
        $shop = M('shop');
        $shop_follow = M('shop_follow');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$shop_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where['shop_id'] = $shop_id;
        $where['user_id'] = $user_info['id'];
        $is_follow = $shop_follow->where($where)->find();
        if ($is_follow){
            $arr = array(
                'code'=> 0,
                'res'=>'您已关注此店铺',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $add['shop_id'] = $shop_id;
        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();
        $query = $shop_follow->add($add);
        $res = '关注';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-取消关注店铺
     */
    function ShopCancelFollow(){
        $user = M('user');
        $shop = M('shop');
        $shop_follow = M('shop_follow');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$shop_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $where['shop_id'] = $shop_id;
        $where['user_id'] = $user_info['id'];
        $is_follow = $shop_follow->where($where)->find();
        if (!$is_follow){
            $arr = array(
                'code'=> 0,
                'res'=>'您未关注此店铺',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $query = $shop_follow->where(array('id'=>$is_follow['id']))->delete();
        $res = '取消关注';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-添加服务
     */
    function ShopAddService(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $service_name = decrypt1(trim(I('post.service_name')));
        $price = decrypt1(trim(I('post.price')));
        $yy_price = decrypt1(trim(I('post.yy_price')));
        $introduce = decrypt1(trim(I('post.introduce')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('id'=>$shop_id))->find();

        if($shop_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'您不是此店店主',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if (!$img_url){$arr = array('code'=> 0, 'res'=>'请上传服务图片',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$service_name){$arr = array('code'=> 0, 'res'=>'请上传服务名称',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (strlen($service_name)>100){$arr = array('code'=> 0, 'res'=>'服务名称长度不能超过100个字符',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$price){$arr = array('code'=> 0, 'res'=>'请输入服务总价',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$yy_price){$arr = array('code'=> 0, 'res'=>'请输入预约金额',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if ($price<=0){$arr = array('code'=> 0, 'res'=>'服务总价不能小于0',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if ($yy_price<=0){$arr = array('code'=> 0, 'res'=>'预约金额不能小于0',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if ($yy_price>=$price){$arr = array('code'=> 0, 'res'=>'预约金额不能大于等于服务总价',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$introduce){$arr = array('code'=> 0, 'res'=>'请输入服务介绍',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $img_list = explode(',',$img_url);

        $add['shop_id'] = $shop_id;
        $add['name'] = $service_name;
        $add['img_url'] = $img_list[0];
        $add['price'] = $price;
        $add['yy_price'] = $yy_price;
        $add['introduce'] = $introduce;
        $add['introduce'] = $introduce;
        $add['create_time'] = time();
        $query = $shop_goods->add($add);
        $res = '添加';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 店铺-服务-修改
     */
    function ShopEditService(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $goods_id = decrypt1(trim(I('post.goods_id')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $service_name = decrypt1(trim(I('post.service_name')));
        $introduce = decrypt1(trim(I('post.introduce')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('id'=>$shop_id))->find();

        if($shop_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'您不是此店店主',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
        if(!$goods_info || $goods_info['shop_id']!=$shop_id){
            $arr = array(
                'code'=> 0,
                'res'=>'需要修改的服务不存在',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        //if (!$img_url){$arr = array('code'=> 0, 'res'=>'请上传服务图片',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$service_name){$arr = array('code'=> 0, 'res'=>'请上传服务名称',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (strlen($service_name)>100){$arr = array('code'=> 0, 'res'=>'服务名称长度不能超过100个字符',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$introduce){$arr = array('code'=> 0, 'res'=>'请输入服务介绍',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if ($img_url){
            $img_list = explode(',',$img_url);
            $save['img_url'] = $img_list[0];
        }


        //$save['shop_id'] = $shop_id;
        $save['name'] = $service_name;
        $save['introduce'] = $introduce;
        $save['update_time'] = time();
        $query = $shop_goods->where(array('id'=>$goods_id))->save($save);
        $res = '修改';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-发布动态
     */
    function SubmitShopBlogs(){
        $user = M('user');

        $shop = M('shop');
        $shop_blogs = M('shop_blogs');
        $shop_blogs_photo = M('shop_blogs_photo');


        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $content = decrypt1(trim(I('post.content')));
        $img_url = decrypt1(trim(I('post.img_url')));
        $type = decrypt1(trim(I('post.type')));
        $video_url = decrypt1(trim(I('post.video_url')));
        $video_thumb = decrypt1(trim(I('post.video_thumb')));
        $video_width = decrypt1(trim(I('post.video_width')));
        $video_height = decrypt1(trim(I('post.video_height')));


        /*  $token ='59b8d705259608fe1d874077ff08617e';
            $content ='测试';
            $type ='3';
            $lng ='114.1107791662';
            $lat ='22.6136444273';*/


        //$token = "329d458ffd8b7bde2a13bd33a71d867a";

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $shop_info = $shop->where(array('user_id'=>$user_info['id']))->find();

        if(!$shop_info){$arr = array('code'=> 0, 'res'=>'您没有店铺，无法发布店铺动态');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        if(!$content){$arr = array('code'=> 0, 'res'=>'请输入动态内容');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(strlen($content)>420){
            $arr = array('code'=> 0, 'res'=>'发帖内容字符长度不能超过140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }

        if($img_url){
            $img_list = explode(',',$img_url);
            if(count($img_list)>9){
                $arr = array('code'=> 0, 'res'=>'最多只能发布九张图片');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }
        }


        if(!$type){
            $type =3;
        }

        $add['shop_id'] = $shop_info['id'];
        $add['lng'] = $shop_info['lng'];
        $add['lat'] = $shop_info['lat'];
        $add['content'] = $content;


        if($type=='2'){
            $cache_info = M('cache')->where(array('url'=>$video_url,'type'=>'2'))->field('thumb')->find();
            $add['video_url'] = $video_url;
            $add['video_icon'] = $cache_info['thumb'];
            $add['video_thumb'] = $video_thumb;
            $add['video_width'] = $video_width;
            $add['video_height'] = $video_height;
            $add['type'] = $type;
        }else{
            if(count($img_list)>0){
                $add['type'] = 1;
            }else{
                $add['type'] = 3;
            }
        }


        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();
        $add['update_time'] = time();
        $query = $shop_blogs->add($add);



        if($img_url){
            foreach($img_list as $item){
                $cache_info_img = M('cache')->where(array('url'=>$item))->field('thumb')->find();
                $add_phone['thumb'] = $cache_info_img['thumb'];
                $add_phone['shop_blogs_id'] = $query;
                $add_phone['img_url'] = $item;
                $add_phone['create_time'] = time();
                $shop_blogs_photo->add($add_phone);

            }
        }

        if($query){
            //发帖增加积分
            $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'1',$query);

            $arr = array(
                'code'=> 1,
                'res'=>'发布成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'发布失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");

    }


    /**
     * 店铺-我的店铺
     */
    function MyShopDetail(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$token = "59b8d705259608fe1d874077ff08617e";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $where1['shop_id'] = $shop_info['id'];
        $where1['pay_status'] = 1;
        $where1['status'] = array('IN','1,2');
        $use_count = 0;
        $use_count += $order->where($where1)->count();
        $shop_info['use_count'] = (String)$use_count;


        $where2['shop_id'] = $shop_info['id'];
        $where2['pay_status'] = 1;
        $where2['status'] = 3;
        $where2['refund_status'] = array('IN','1,3');
        $chuli_count = 0;
        $chuli_count += $order->where($where2)->count();
        $shop_info['chuli_count'] = (String)$chuli_count;

        $today = strtotime(date('Y-m-d'));
        $where3['shop_id'] = $shop_info['id'];
        $where3['pay_time'] = array('EGT',$today);
        $where3['pay_status'] = 1;
        $where3['status'] = array('IN','4,5');
        $today_success_count = 0;
        $today_success_count += $order->where($where3)->count();
        $shop_info['today_success_count'] = (String)$today_success_count;

        $where_order['shop_id'] = $shop_info['id'];
        if  ($user_info['id'] !='4' && $user_info['id'] !='5'){
            $where_order['pay_status'] = 1;

        }
        $order_list  = $order->where($where_order)->order('create_time desc')
            ->field('id as order_id,goods_id,money_type,money,price,status,refund_status')
            ->limit($start,$num)->select();

        foreach ($order_list as $key=>$item){
            $goods_info = $shop_goods->where(array('id'=>$item['goods_id']))->field('name,img_url')->find();
            $order_list[$key]['name'] = $goods_info['name'];
            $order_list[$key]['img_url'] = $goods_info['img_url'];
        }
        $shop_info['order_list'] = $order_list;
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $shop_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-服务管理列表
     */
    function ShopServiceList(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;


        //$token = "59b8d705259608fe1d874077ff08617e";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $goods_list  = $shop_goods->where(array('shop_id'=>$shop_info['id'],'is_del'=>'0'))
            ->limit($start,$num)
            ->order('create_time desc')->field('id as goods_id,name,img_url,introduce,price,is_show,yy_price')->select();
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $goods_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-服务上架
     */
    function ShopServiceShang(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if (!$goods_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
        if ($goods_info['shop_id']!=$shop_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if ($goods_info['is_show']=='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'服务已上架',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $save['is_show'] = 1;
        $save['update_time'] = time();
        $query = $shop_goods->where(array('id'=>$goods_id))->save($save);
        $res = '上架';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-服务下架
     */
    function ShopServiceXia(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if (!$goods_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
        if ($goods_info['shop_id']!=$shop_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if ($goods_info['is_show']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'服务已下架',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $save['is_show'] = 0;
        $save['update_time'] = time();
        $query = $shop_goods->where(array('id'=>$goods_id))->save($save);
        $res = '下架';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-服务-删除
     */
    function ShopServiceDel(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $goods_id = decrypt1(trim(I('post.goods_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if (!$goods_id){
            $arr = array(
                'code'=> 0,
                'res'=>'缺少参数',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $goods_info = $shop_goods->where(array('id'=>$goods_id))->find();
        if ($goods_info['shop_id']!=$shop_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }




        $save['is_show'] = 0;
        $save['is_del'] = 1;
        $save['update_time'] = time();
        $query = $shop_goods->where(array('id'=>$goods_id))->save($save);
        $res = '删除';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-开店
     */
    function ShopOpenShop(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($shop_info['is_open']=='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'店铺已打开',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }



        $save['is_open'] = 1;
        $save['update_time'] = time();
        $query = $shop->where(array('id'=>$shop_info['id']))->save($save);
        $res = '打开';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-打烊
     */
    function ShopCloseShop(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');

        //接收数据
        $token = decrypt1(trim(I('post.token')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($shop_info['is_open']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'店铺已关闭',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }



        $save['is_open'] = 0;
        $save['update_time'] = time();
        $query = $shop->where(array('id'=>$shop_info['id']))->save($save);
        $res = '关闭';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 店铺-全部订单
     */
    function ShopAllOrder(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $type = decrypt1(trim(I('post.type')));//类型：1待使用，2今日完成，3待处理，4已完成
        $page = decrypt1(trim(I('post.page')));
        if(!$page){$page = 1;}
        if(!$type){$type = '1';}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "59b8d705259608fe1d874077ff08617e";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $where['shop_id'] = $shop_info['id'];
        $where['pay_status'] = 1;
        if ($type=='1'){
            $where['status'] = array('IN','1,2');
        }
        if ($type=='2'){
            $where['status'] = array('IN','4,5');
            $today = strtotime(date('Y-m-d'));
            $where['pay_time'] = array('EGT',$today);
        }
        if($type=='3'){
            $where['status'] = 3;
            $where['refund_status'] = array('IN','1,3');
        }
        if ($type=='4'){
            $where['status'] = array('IN','4,5');
        }
        $order_list  = $order->where($where)->order('create_time desc')->limit($start,$num)
            ->field('id as order_id,goods_id,money_type,money,price,status,refund_status,user_id')->select();
        foreach ($order_list as $key=>$item){
            $goods_info = $shop_goods->where(array('id'=>$item['goods_id']))->field('name,img_url')->find();
            $order_list[$key]['name'] = $goods_info['name'];
            $order_list[$key]['img_url'] = $goods_info['img_url'];
        }

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $order_list,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-订单-同意退款
     */
    function ShopOrderRefundSuccess(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$token = "59b8d705259608fe1d874077ff08617e";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $order_info = $order->where(array('id'=>$order_id))->find();
        if ($order_info['shop_id'] != $shop_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($order_info['status']!= '3' && $order_info['refund_status']!='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $buy_user_info = $user->where(array('id'=>$order_info['user_id']))->field('money')->find();
        $new_money = $buy_user_info['money'] + $order_info['money'];
        $query = $user->where(array('id'=>$order_info['user_id']))->save(array('money'=>$new_money,'update_time'=>time()));
        $res = '退款';
        if($query){
            $is_save = $order->where(array('id'=>$order_info['id']))->save(array('refund_status'=>'4','refund_time'=>time()));
            if ($is_save){
                //金额交易记录
                $add_money['user_id'] =  $order_info['user_id'];
                $add_money['money'] = $order_info['money'];
                if ($order_info['money_type']=='1'){
                    $add_money['type'] = 5;
                }else{
                    $add_money['type'] = 6;
                }
                $add_money['add_or_del'] = 1;//1增加，2减去
                $add_money['pay_type'] = 4;//1微信，2支付宝，3银联，4余额
                $add_money['create_time'] = time();
                $add_money['order_id'] = $order_info['id'];
                $add_money['create_type'] = 3;//1管理员操作，2系统操作，3用户操作，4业务员操作
                M('money_log')->add($add_money);
                //金额交易记录

                $shop->where(array('id'=>$order_info['shop_id']))->setDec('money',$order_info['money']);
                $shop->where(array('id'=>$order_info['shop_id']))->setDec('sales',1);
                $shop_goods->where(array('id'=>$order_info['goods_id']))->setDec('sales',1);


                $tis = '退款成功';
                //新版
                $add_system['user_id'] = $order_info['user_id'];
                $add_system['send_user_id'] = '';
                $add_system['content'] = $tis;
                $add_system['type'] = 3;//1预约成功，2交易成功，3退款成功，4退款失败
                $add_system['type_id'] = $order_info['id'];
                $add_system['status'] = 4;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $order_info['user_id'];

                SendRongSystem($rong_user,$tis);

                $arr = array(
                    'code'=> 1,
                    'res'=>$res.'成功 ',
                );
            }else{
                $user->where(array('id'=>$order_info['user_id']))->save(array('money'=>$buy_user_info['money'],'update_time'=>time()));
                $arr = array(
                    'code'=> 0,
                    'res'=>$res.'失败',
                );
            }


        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-订单-拒绝退款
     */
    function ShopOrderRefundRefuse(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$token = "59b8d705259608fe1d874077ff08617e";
        //$shop_id = "2";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $order_info = $order->where(array('id'=>$order_id))->find();
        if ($order_info['shop_id'] != $shop_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        if($order_info['status']!= '3' && $order_info['refund_status']!='1'){
            $arr = array(
                'code'=> 0,
                'res'=>'状态错误',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }


        $query = $order->where(array('id'=>$order_info['id']))->save(array('refund_status'=>'2','refund_time'=>time()));
        $res = '操作';
        if($query){
            $tis = '退款失败';
            //新版
            $add_system['user_id'] = $order_info['user_id'];
            $add_system['send_user_id'] = '';
            $add_system['content'] = $tis;
            $add_system['type'] = 4;//1预约成功，2交易成功，3退款成功，4退款失败
            $add_system['type_id'] = $order_info['id'];
            $add_system['status'] = 4;
            $add_system['create_time'] = time();
            M('system')->add($add_system);

            $rong_user[] = $order_info['user_id'];

            SendRongSystem($rong_user,$tis);

            $arr = array(
                    'code'=> 1,
                    'res'=>$res.'成功 ',
                );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-订单详情
     */
    function ShopOrderDetail(){
        $user = M('user');
        $shop = M('shop');
        $shop_goods = M('shop_goods');
        $order = M('order');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $order_id = decrypt1(trim(I('post.order_id')));

        //$token = "59b8d705259608fe1d874077ff08617e";
        //$order_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        $shop_info  = $shop->where(array('user_id'=>$user_info['id']))->field('id,shop_name,logo,is_open,is_freeze')->find();

        if(!$shop_info){
            $arr = array(
                'code'=> 0,
                'res'=>'您还没有开店',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        if($shop_info['is_freeze']=='0'){
            $arr = array(
                'code'=> 0,
                'res'=>'您的店铺已被系统封店，如有疑问，请联系客服！',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $order_info = $order->where(array('id'=>$order_id))
            ->field('id as order_id,shop_id,order_number,goods_id,money_type,money,price,status,refund_status,user_id,
            pay_time,ok_time,location_id,location,detailed,name,phone')->find();
        if ($order_info['shop_id'] != $shop_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $goods_info = $shop_goods->where(array('id'=>$order_info['goods_id']))->field('name,img_url')->find();
        $order_info['goods_name'] = $goods_info['name'];
        $order_info['img_url'] = $goods_info['img_url'];

        $order_info['location_content'] = $order_info['location'].$order_info['detailed'];
        $order_info['pay_time'] = date('Y-m-d H:i:s',$order_info['pay_time']);
        if ($order_info['ok_time']){
            $order_info['ok_time'] = date('Y-m-d H:i:s',$order_info['ok_time']);
        }else{
            $order_info['ok_time'] = '未使用';
        }

        $user_info2 = $user->where(array('id'=>$order_info['user_id']))->field('phone')->find();
        $order_info['phone'] = $user_info2['phone'];
        $order_info['my_phone'] = $user_info['phone'];
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $order_info,
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 店铺-动态-发布评论
     */
    function SubmitShopComment(){
        $user = M('user');
        $shop_blogs = M('shop_blogs');
        $shop_blogs_comment = M('shop_comment');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.shop_blogs_id')));
        $content = decrypt1(trim(I('post.content')));

        /*  $token = "aeb256f7921b1eb14d8ad132335242ae";
          $blogs_id = 1;
          $content = '测试';*/


        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        if(!$content){$arr = array('code'=> 0, 'res'=>'评论不能为空');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(strlen($content)>420){$arr = array('code'=> 0, 'res'=>'评论字数最长为140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $article_info = $shop_blogs->where(array('id'=>$blogs_id))->field('user_id,content,comment_count')->find();

        $add['content'] = $content;
        $add['user_id'] = $user_info['id'];
        $add['shop_blogs_id'] = $blogs_id;
        $add['create_time'] = time();
        $query = $shop_blogs_comment->add($add);
        if($query){
            $new_count = $article_info['comment_count'] +1;
            $shop_blogs->where(array('id'=>$blogs_id))->save(array('update_time'=>time(),'comment_count'=>$new_count));



            //添加消息通知
            if($article_info['user_id']!=$user_info['id']){
                //新版
                $add_system['user_id'] = $article_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 1;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $blogs_id;
                $add_system['status'] = 2;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $article_info['user_id'];
                $tis = $user_info['name'].'回复了你的帖子《'.$article_info['content'].'》';
                SendRongSystem($rong_user,$tis);

            }



            //评论增加积分
            // $add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'5',$article_id);

            $user_other = $user->where(array('id'=>$article_info['user_id']))->find();
            //评论增加积分
            // $add_status = AddScore($user_other['id'],$user_other['score'],$user_other['level'],'9',$article_id);

            $arr = array(
                'code'=> 1,
                'res'=>'评论成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-动态-回复评论
     */
    function ReplyShopComment(){
        $user = M('user');
        $shop_reply = M('shop_reply');
        $shop_comment = M('shop_comment');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $comment_id = decrypt1(trim(I('post.comment_id')));
        $appoint_user_id = decrypt1(trim(I('post.appoint_user_id')));
        $content = decrypt1(trim(I('post.content')));

        /*       $token = "aeb256f7921b1eb14d8ad132335242ae";
               $comment_id = 1;
               $content = '测试';*/

        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $comment_info = $shop_comment->where(array('id'=>$comment_id))->find();
        if(!$comment_info){$arr = array('code'=> 0, 'res'=>'评论ID错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if(!$content){$arr = array('code'=> 0, 'res'=>'评论不能为空');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if(strlen($content)>420){$arr = array('code'=> 0, 'res'=>'评论字数最长为140个字符');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}


        $add['comment_id'] =  $comment_id;
        $add['reply_content'] = $content;
        $add['user_id'] = $user_info['id'];
        if($appoint_user_id){
            if($appoint_user_id == $user_info['id']){
                $arr = array('code'=> 0, 'res'=>'不能@自己');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
            }
            $add['appoint_user_id'] = $appoint_user_id;
        }
        $add['create_time'] = time();
        $query = $shop_reply->add($add);

        if($query){
            //添加消息通知

            $new_count = $comment_info['reply_num']+1;
            $shop_comment->where(array('id'=>$comment_id))->save(array('reply_num'=>$new_count,'update_time'=>time()));


            if($appoint_user_id){

                //新版
                $add_system['user_id'] = $appoint_user_id;
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 3;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $comment_id;
                $add_system['status'] = 2;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $appoint_user_id;

                $tis = $user_info['name'].'@了你';
                SendRongSystem($rong_user,$tis);
            }
            if($comment_info['user_id']!=$user_info['id']){


                //新版
                $add_system['user_id'] = $comment_info['user_id'];
                $add_system['send_user_id'] = $user_info['id'];
                $add_system['content'] = $content;
                $add_system['type'] = 2;//1回复帖子，2回复评论，3@用户
                $add_system['type_id'] = $comment_id;
                $add_system['status'] = 2;
                $add_system['create_time'] = time();
                M('system')->add($add_system);

                $rong_user[] = $comment_info['user_id'];

                $tis = $user_info['name'].'回复了你的评论:'.$comment_info['content'];;
                SendRongSystem($rong_user,$tis);
            }



            $list['reply_id'] = $query;
            $list['user_id'] = $user_info['id'];
            $list['appoint_user_id'] = $appoint_user_id;
            $list['reply_content'] = $content;
            $list['reply_content'] = $content;
            $list['name'] = $user_info['name'];
            if ($appoint_user_id){
                $user_info2 = $user->where(array('id'=>$appoint_user_id))->field('name')->find();
                $list['appoint_user_name'] = $user_info2['name'];
            }else{
                $list['appoint_user_name'] = '';
            }


            $arr = array(
                'code'=> 1,
                'res'=>'评论成功 ',
                'list'=>$list
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'评论失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-动态-点赞
     */
    function ShopBlogsZan(){
        $user = M('user');
        $shop_blogs = M('shop_blogs');
        $shop_zan = M('shop_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.shop_blogs_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_service']=='1'){$arr = array('code'=> 0, 'res'=>'客服账号不可进行此操作');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $add['user_id'] = $user_info['id'];
        $add['shop_blogs_id'] = $blogs_id;
        $is_zan = $shop_zan->where($add)->find();
        if($is_zan){
            $arr = array(
                'code'=> 0,
                'res'=>'您已赞过',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }
        $add['create_time'] = time();
        $query = $shop_zan->add($add);

        if($query){
            $article_info = $shop_blogs->where(array('id'=>$blogs_id))->field('user_id,zan')->find();
            $new_zan = $article_info['zan']+1;
            $shop_blogs->where(array('id'=>$blogs_id))->save(array('zan'=>$new_zan));
            //$user_other = $user->where(array('id'=>$article_info['user_id']))->find();
            //点赞增加积分
            //$add_status = AddScore($user_info['id'],$user_info['score'],$user_info['level'],'2',$article_id);

            //点赞增加积分
            //$add_status = AddScore($user_other['id'],$user_other['score'],$user_other['level'],'6',$article_id,$user_info['id']);
            $arr = array(
                'code'=> 1,
                'res'=>'点赞成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'点赞失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-动态-取消点赞
     */
    function ShopBlogsZanCancel(){
        $user = M('user');
        $shop_blogs = M('shop_blogs');
        $shop_zan = M('shop_zan');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.shop_blogs_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}



        $where['user_id'] = $user_info['id'];
        $where['shop_blogs_id'] = $blogs_id;
        $query = $shop_zan->where($where)->delete();
        if($query){


            $shop_blogs->where(array('id'=>$blogs_id))->setDec('zan',1);


            $arr = array(
                'code'=> 1,
                'res'=>'取消成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>'取消失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-动态-详情
     */
    function ShopBlogsDetail(){
        $user = M('user');
        $shop_blogs = M('shop_blogs');
        $shop_blogs_photo = M('shop_blogs_photo');
        $shop_zan = M('shop_zan');
        $shop_comment = M('shop_comment');
        $shop_reply = M('shop_reply');

        //接收数据
        $lng = decrypt1(trim(I('post.lng')));//经度
        $lat = decrypt1(trim(I('post.lat')));//纬度

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.shop_blogs_id')));
        $page = decrypt1(trim(I('post.page')));
        $check_type = decrypt1(trim(I('post.check_type')));//评论排序方式：1根据最新时间排序，2根据最热排序
        if(!$check_type){$check_type = 1;}
        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;

        //$token = "59b8d705259608fe1d874077ff08617e";
        //$blogs_id = 4;

        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }


        $where['lyx_shop_blogs.id'] = $blogs_id;
        $article_list = $shop_blogs
            ->where($where)
            ->join('lyx_shop ON lyx_shop_blogs.shop_id = lyx_shop.id')
            ->order('create_time desc')
            ->field('lyx_shop_blogs.content,lyx_shop_blogs.browse,lyx_shop_blogs.create_time,lyx_shop.shop_name as name,lyx_shop.logo as head,
            lyx_shop_blogs.id as shop_blogs_id,lyx_shop_blogs.user_id,lyx_shop_blogs.shop_id,lyx_shop_blogs.type,lyx_shop_blogs.video_url,
            lyx_shop_blogs.video_thumb,lyx_shop_blogs.video_width,lyx_shop_blogs.video_height,lyx_shop_blogs.video_icon,lyx_shop_blogs.zan,lyx_shop_blogs.lng,lyx_shop_blogs.lat')
            ->find();


        if(!$article_list['name']){
            $article_list['name'] =  '';
        }

        if(!$article_list['head']){
            $article_list['head'] =  '';
        }


        if(!$article_list['video_url']){
            $article_list['video_url'] = "";
        }
        if(!$article_list['video_thumb']){
            $article_list['video_thumb'] = "";
        }

        if(!$article_list['video_width']){
            $article_list['video_width'] = "0";
        }
        if(!$article_list['video_height']){
            $article_list['video_height'] = "0";
        }

        if($lat&&$lng&&$article_list['lat']&&$article_list['lng']){
            $article_list['dis'] = getDistance($article_list['lat'],$article_list['lng'],$lat,$lng);
        }else{
            $article_list['dis'] ='';
        }


        $new_browse = $article_list['browse']+rand(1,5);
        $shop_blogs->where(array('id'=>$blogs_id))->save(array('browse'=>$new_browse));


        //评论数
        $comment_count = $shop_comment->where(array('shop_blogs_id'=>$blogs_id))->count();
        $count_comment = WanChu($comment_count);
        $article_list['zan'] = WanChu($article_list['zan']);
        $article_list['comment_count'] =  $count_comment;

        if($check_type=='1'){
            $order_a_d = 'lyx_shop_comment.create_time desc';
        }else{
            $order_a_d  = 'lyx_shop_comment.zan desc,lyx_shop_comment.reply_num desc';
        }
        $comment_list = $shop_comment
            ->order($order_a_d)
            ->limit($start,$num)
            ->join('lyx_user ON lyx_shop_comment.user_id = lyx_user.id')
            ->field('lyx_shop_comment.id as comment_id,lyx_shop_comment.content,lyx_shop_comment.user_id,
            lyx_shop_comment.create_time,lyx_user.name,lyx_user.head,lyx_user.sex,lyx_user.level,
            lyx_shop_comment.reply_num,lyx_user.vip,lyx_user.age,lyx_user.lng,lyx_user.lat')
            ->where(array('shop_blogs_id'=>$article_list['shop_blogs_id']))
            ->select();


        foreach($comment_list as $key=>$item){
            $comment_list[$key]['create_time'] = mdate($item['create_time']);
            if(!$item['name']){
                $comment_list[$key]['name'] = "";
            }
            if(!$item['head']){
                $comment_list[$key]['head'] = "";
            }

            if($lat&&$lng&&$item['lat']&&$item['lng']){
                $comment_list[$key]['dis'] = getDistance($item['lat'],$item['lng'],$lat,$lng);
            }else{
                $comment_list[$key]['dis'] ='';
            }

            $comment_list[$key]['zan'] = WanChu($item['zan']);
            if($item['user_id']==$article_list['user_id']){
                $comment_list[$key]['is_self'] = '1';
            }else{
                $comment_list[$key]['is_self'] = '0';
            }

            $reply_list = $shop_reply
                ->join('lyx_user ON lyx_shop_reply.user_id = lyx_user.id')
                ->field('lyx_shop_reply.id as reply_id,lyx_shop_reply.user_id,lyx_shop_reply.appoint_user_id,lyx_shop_reply.reply_content,lyx_user.name')
                ->where(array('lyx_shop_reply.comment_id'=>$item['comment_id']))
                ->order('lyx_shop_reply.create_time')
                ->limit(3)
                ->select();

            if($reply_list){
                foreach($reply_list as $key1=>$val){
                    if(!$val['name']){
                        $reply_list[$key1]['name'] = "";
                    }

                    if($val['appoint_user_id']){
                        $appoint_name = $user->where(array('id'=>$val['appoint_user_id']))->field('name')->find();
                        if(!$appoint_name['name']){
                            $appoint_name['name'] = '';
                        }
                        $reply_list[$key1]['appoint_user_name'] = $appoint_name['name'];
                    }else{
                        $reply_list[$key1]['appoint_user_name'] = '';
                    }
                }
            }


            $comment_list[$key]['reply_list'] = $reply_list;

        }

        $article_list['comment_list'] =  $comment_list;



        //图片
        $new_img_list = array();
        $img_list = $shop_blogs_photo->where(array('shop_blogs_id'=>$article_list['shop_blogs_id']))->select();
        if($img_list){
            foreach($img_list as $val){
                $new_img_list[] = $val['img_url'];
            }
        }
        $article_list['img_list'] =  $new_img_list;

        $article_list['share_url'] = XUANIP.'/Home/share/index/type/2/aid/'.$article_list['shop_blogs_id'];

        if($article_list['type']=='1'){
            $article_list['share_icon'] = $img_list[0]['thumb'];
        }else if($article_list['type']=='2'){
            $article_list['share_icon'] = $article_list['video_icon'];
        }else{
            $article_list['share_icon'] = XUANIP.'/logo.jpg';
        }

        $article_list['share_info'] = '伊美小天鹅分享';


        //自己是否有点赞
        $is_zan = $shop_zan->where(array('shop_blogs_id'=>$article_list['shop_blogs_id'],'user_id'=>$user_info['id']))->find();
        if($is_zan){
            $article_list['is_zan'] =  '1';
        }else{
            $article_list['is_zan'] =  '0';
        }
        $article_list['create_time'] =  mdate($article_list['create_time']);
        $article_list['browse'] =  WanChu($article_list['browse']).'阅读';

        unset($article_list['video_icon']);


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $article_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 店铺-动态-全部回复
     */
    function ShopReplyAll(){
        $user = M('user');
        $shop_blogs = M('shop_blogs');
        $shop_comment = M('shop_comment');
        $shop_reply = M('shop_reply');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $comment_id = decrypt1(trim(I('post.comment_id')));
        $lng = decrypt1(trim(I('post.lng')));
        $lat = decrypt1(trim(I('post.lat')));

        //$token = "be196855ebf12c739990376a58376317";
        //$comment_id = 1;

        if($token){
            $user_info = $user->where(array('token'=>$token))->find();
            if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
            if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        }


        $list = $shop_comment->field('shop_blogs_id')->where(array('id'=>$comment_id))->find();
        $article_info = $shop_blogs->where(array('id'=>$list['shop_blogs_id']))->field('user_id')->find();


        $reply_list = $shop_reply
            ->join('lyx_user ON lyx_shop_reply.user_id = lyx_user.id')
            ->field('lyx_shop_reply.id as reply_id,lyx_shop_reply.user_id,
            lyx_shop_reply.appoint_user_id,lyx_shop_reply.reply_content,
            lyx_user.name,lyx_user.head,lyx_shop_reply.create_time,lyx_user.vip,lyx_user.age,lyx_user.sex,lyx_user.level,lyx_user.lng,lyx_user.lat')
            ->where(array('lyx_shop_reply.comment_id'=>$comment_id))
            ->order('lyx_shop_reply.create_time desc')
            ->select();

        if($reply_list){
            foreach($reply_list as $key1=>$val){

                if($article_info['user_id']==$val['user_id']){
                    $reply_list[$key1]['is_self'] = '1';
                }else{
                    $reply_list[$key1]['is_self'] = '0';
                }

                $reply_list[$key1]['create_time'] = mdate($val['create_time']);

                if(!$val['name']){
                    $reply_list[$key1]['name'] = "";
                }
                if(!$val['head']){
                    $reply_list[$key1]['head'] = "";
                }

                if($lat&&$lng&&$val['lat']&&$val['lng']){
                    $reply_list[$key1]['dis'] = getDistance($val['lat'],$val['lng'],$lat,$lng);
                }else{
                    $reply_list[$key1]['dis'] ='';
                }



                if($val['appoint_user_id']){
                    $appoint_name = $user->where(array('id'=>$val['appoint_user_id']))->field('name')->find();
                    if(!$appoint_name['name']){
                        $appoint_name['name'] = '';
                    }
                    $reply_list[$key1]['appoint_user_name'] = $appoint_name['name'];
                }else{
                    $reply_list[$key1]['appoint_user_name'] = '';
                }

            }
        }


        //$list['reply_list'] = $reply_list;

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $reply_list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 店铺-动态-列表/指定店铺
     */
    function ShopBlogsList(){

        //$lng = '114.110806';
        //$lat = '22.614503';

        $token = decrypt1(trim(I('post.token')));
        $shop_id = decrypt1(trim(I('post.shop_id')));
        $page = decrypt1(trim(I('post.page')));
        $type = decrypt1(trim(I('post.type')));//类型：1全部，2指定店铺
        if(!$type){$type = '1';}


        if(!$page){$page = 1;}
        $num = 20;//分页数
        $start = ($page-1)*$num;



        // $sex = 1;
        //$age_start = 20;
        //$age_end = 26;
        $user = M('user');
        $shop = M('shop');
        $shop_blogs = M('shop_blogs');
        $shop_blogs_photo = M('shop_blogs_photo');
        $shop_zan = M('shop_zan');
        if($token) {
            $user_info = $user->where(array('token' => $token))->find();
            if (!$user_info) {$arr = array('code' => 2001, 'res' => 'token错误');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}
            if ($user_info['is_freeze'] == '0') {$arr = array('code' => 0, 'res' => '您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] = encrypt1($data);$this->ajaxReturn($return, "JSON");}

        }


        if ($type=='2'){
            $where_blogs['shop_id'] = $shop_id;
        }
        $where_blogs['is_show'] = 1;
        $list = $shop_blogs->where($where_blogs)
            ->limit($start,$num)->order('create_time desc')
            ->field('id,user_id,shop_id,lng,lat,content,zan,browse,comment_count,create_time,video_url,video_thumb,video_icon,video_width,video_height,type')->select();




        foreach($list as $key=>$item){
            if(!$item['video_url']){
                $list[$key]['video_url'] = "";
            }
            if(!$item['video_height']){
                $list[$key]['video_height'] = "0";
            }
            if(!$item['video_width']){
                $list[$key]['video_width'] = "0";
            }
            if(!$item['video_thumb']){
                $list[$key]['video_thumb'] = "";
            }

            if(!$item['lng']){
                $list[$key]['lng'] = "";
            }
            if(!$item['lat']){
                $list[$key]['lat'] = "";
            }


            //用户信息
            $shop_info =  $shop->where(array('id'=>$item['shop_id']))->field('shop_name,logo')->find();
            $list[$key]['name'] = $shop_info['shop_name'];
            $list[$key]['head'] = $shop_info['logo'];


            $list[$key]['create_time'] = mdate($item['create_time']);
            //点赞数
            $list[$key]['zan'] = WanChu($item['zan']);
            //评论数
            $list[$key]['comment_count'] = WanChu($item['comment_count']);
            //浏览人数
            $list[$key]['browse'] = WanChu($item['browse']). '阅读';;
            $list[$key]['dis'] = MiZhuanhuan($item['dis']);

            $new_img_list = array();
            $img_list = $shop_blogs_photo->where(array('shop_blogs_id' => $item['id']))->select();
            if ($img_list) {
                foreach ($img_list as $val) {
                    $new_img_list[] = $val['img_url'];
                }
            }
            $list[$key]['img_list'] = $new_img_list;



            $list[$key]['share_url'] = XUANIP.'/Home/share/index/aid/'.$item['id'];
            if($item['type']=='1'){
                $list[$key]['share_icon'] = $img_list[0]['thumb'];
            }else if($item['type']=='2'){
                $list[$key]['share_icon'] = $item['video_icon'];
            }else{
                $list[$key]['share_icon'] = XUANIP.'/logo.jpg';
            }

            $list[$key]['share_info'] = '伊美小天鹅分享';

            //自己是否有点赞
            $is_zan = $shop_zan->where(array('shop_blogs_id' => $item['id'], 'user_id' =>$user_info['id']))->find();
            if ($is_zan) {
                $list[$key]['is_zan'] = '1';
            } else {
                $list[$key]['is_zan'] = '0';
            }

            unset($list[$key]['video_icon']);

        }


        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list'=>$list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }

    /**
     * 店铺-动态-删除
     */
    function ShopBlogsDelete(){
        $user = M('user');
        $shop_blogs = M('shop_blogs');
        $shop_zan = M('shop_zan');
        $shop_blogs_photo = M('shop_blogs_photo');
        $shop_comment = M('shop_comment');
        $shop_reply = M('shop_reply');
        $report = M('report');
        $system = M('system');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $shop_blogs_id = decrypt1(trim(I('post.shop_blogs_id')));

        //$token = "8ade5a27152494161fbbda4771ad9e9e";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $blogs_info = $shop_blogs->where(array('id'=>$shop_blogs_id))->field('user_id')->find();
        if ($blogs_info['user_id']!=$user_info['id']){
            $arr = array('code'=> 0, 'res'=>'没有删除权限');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");
        }
        $query = $shop_blogs->where(array('id'=>$shop_blogs_id))->delete();

        $res = '删除';
        if($query){
            $shop_blogs_photo->where(array('shop_blogs_id'=>$shop_blogs_id))->delete();
            $shop_zan->where(array('shop_blogs_id'=>$shop_blogs_id))->delete();
            $report->where(array('report_id'=>$shop_blogs_id,'report_type'=>'3'))->delete();
            $comment_list = $shop_comment->where(array('shop_blogs_id'=>$shop_blogs_id))->select();
            if ($comment_list){
                foreach ($comment_list as $item){
                    $shop_reply->where(array('comment_id'=>$item['id']))->delete();
                    $system->where(array('status'=>'2','type'=>array('IN','2,3'),'type_id'=>$item['id']))->delete();
                }
            }
            $system->where(array('status'=>'2','type'=>1,'type_id'=>$shop_blogs_id))->delete();
            $shop_comment->where(array('shop_blogs_id'=>$shop_blogs_id))->delete();

            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 系统助手-消息列表
     */
    function SystemList(){
        $user = M('user');
        $system = M('system');
        $shop = M('shop');
        $shop_order = M('shop_order');
        $hospital_order = M('hospital_order');
        $hospital = M('hospital');
        $shop_prize_order = M('shop_prize_order');
        $shop_prize = M('shop_prize');
        $shop_goods = M('shop_goods');
        $user_blogs = M('user_blogs');
        $agent_share = M('agent_share');
        $user_blogs_photo = M('user_blogs_photo');



        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $page = decrypt1(trim(I('post.page')));

        if(!$page){$page = 1;}
        $num = 10;//分页数
        $start = ($page-1)*$num;
        //$token = "ea3fd6f1ffe27ccf6644c64f6a91c6b3";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $new_list  = array();
        $list = $system
            ->where(array('user_id'=>array('IN','0,'.$user_info['id']),'create_time'=>array('EGT',$user_info['create_time'])))
            ->limit($start,$num)
            ->order('create_time desc')
            ->field('id,send_user_id,status,type,content,type_id,create_time,is_read')
            ->select();
        foreach ($list as $key=>$item){
            $list[$key]['send_user_name'] = '';
            $list[$key]['send_user_head'] = '';
            $list[$key]['goods_name'] = '';
            $list[$key]['goods_introduce'] = '';
            $list[$key]['goods_img'] = '';
            $list[$key]['goods_id'] = '';
            $list[$key]['blogs_type'] = '';
            $list[$key]['blogs_content'] = '';
            $list[$key]['blogs_video_thumb'] ='';
            $list[$key]['blogs_img_url'] ='';
            $list[$key]['send_user_name'] = '';
            $list[$key]['send_user_head'] = '';
            $list[$key]['notice_url'] = '';
            $list[$key]['hos_name'] = '';
            $list[$key]['hos_logo'] = '';
            $list[$key]['hos_classify'] = '';
            if ($item['status']=='1'){
                $send_user_info  = $user->where(array('id'=>$item['send_user_id']))->field('id,name,head')->find();
                $list[$key]['send_user_name'] = $send_user_info['name'];
                $list[$key]['send_user_head'] = $send_user_info['head'];


                $blogs_info = $user_blogs->where(array('id'=>$item['type_id']))->field('type,content,video_thumb')->find();
                $list[$key]['blogs_type'] = $blogs_info['type'];
                $list[$key]['blogs_content'] = $blogs_info['content'];
                $list[$key]['blogs_video_thumb'] = $blogs_info['video_thumb'];
                if($blogs_info['type']=='1'){
                    $img_info = $user_blogs_photo->where(array('blogs_id'=>$item['type_id']))->order('id')->field('img_url')->find();
                    $list[$key]['blogs_img_url'] = $img_info['img_url'];
                }else{
                    $list[$key]['blogs_img_url'] = '';
                }
            }else if ($item['status']=='5'){
                $send_user_info  = $user->where(array('id'=>$item['send_user_id']))->field('id,name,head')->find();
                $list[$key]['send_user_name'] = $send_user_info['name'];
                $list[$key]['send_user_head'] = $send_user_info['head'];

                $list[$key]['notice_url'] = XUANIP.'/home/shopshow/notice/id/'.$item['type_id'].'/user_id/'.$user_info['id'];
            }else if ($item['status']=='6'){
                $send_user_info  = $user->where(array('id'=>$item['send_user_id']))->field('id,name,head')->find();
                $list[$key]['send_user_name'] = $send_user_info['name'];
                $list[$key]['send_user_head'] = $send_user_info['head'];

                $order_info = $hospital_order->where(array('id'=>$item['type_id']))->field('parent')->find();
                $hospital_info = $hospital->where(array('id'=>$order_info['parent']))->field('id,name,logo,classify')->find();
                $list[$key]['hos_name'] = $hospital_info['name'];
                $list[$key]['hos_logo'] = $hospital_info['logo'];
                $list[$key]['hos_classify'] = $hospital_info['classify'];

                $list[$key]['notice_url'] = XUANIP.'/home/shopshow/notice/id/'.$item['type_id'].'/user_id/'.$user_info['id'];
            }else{

                if($item['status']=='4'){
                    $order_info = $shop_prize_order->where(array('id'=>$item['type_id']))->field('prize_id')->find();
                    $goods_info = $shop_prize->where(array('id'=>$order_info['prize_id']))->field('cover,name')->find();

                    $shop_name['name'] = '积分商城';
                }else{
                    $order_info = $shop_order->where(array('id'=>$item['type_id']))->field('shop_id,goods_id')->find();
                    $goods_info = $shop_goods->where(array('id'=>$order_info['goods_id']))->field('cover,name')->find();

                    $shop_name = $shop->where(array('id'=>$order_info['shop_id']))->field('name')->find();

                }

                $list[$key]['goods_name'] = $goods_info['name'];
                $list[$key]['shop_name'] = $shop_name['name'];
                $list[$key]['goods_img'] = $goods_info['cover'];
                $list[$key]['goods_id'] = $order_info['goods_id'];


            }
            $list[$key]['create_time'] = mdate($item['create_time']);
            if ($item['is_read']=='0'){
                $system->where(array('id'=>$item['id']))->save(array('is_read'=>'1','update_time'=>time()));
            }


            if  ($item['status']=='5'){
                if ($item['type']=='2'){
                    if ($user_info['is_agent']=='1'){
                        $new_list[] = $list[$key];
                    }
                }else{
                    $new_list[] = $list[$key];
                }
            }else{
                $new_list[] = $list[$key];
            }


        }

        $num_list['total_num'] = 0;
        $ticket_num = M('ticket_user')
            ->where(['lyx_ticket_user.status'=>0,
                'lyx_ticket_user.user_id'=>$user_info['id'],
                'lyx_ticket.ticket_type'=>3
            ])
            ->join('lyx_ticket ON lyx_ticket_user.parent=lyx_ticket.id')
            ->count();
        $num_list['ticket_num'] = $ticket_num;

        $num_list['total_num'] += $ticket_num;

       // $new_list = array_reverse($list);
        $info_num  = $agent_share->where(['user_id'=>$user_info['id'],'is_read'=>0])->count();
        $num_list['info_num'] = $info_num;
        $num_list['total_num'] += $info_num;

        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'shop_name' => $shop_name['name'],
            'list' => $new_list,
            'num_list' => $num_list
        );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");


    }






    /**
     * 新增收货地址
     */
    function LocationAdd(){
        $user = M('user');
        $shop = M('shop');
        $location_db = M('location');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $location = decrypt1(trim(I('post.location')));
        //$street = decrypt1(trim(I('post.street')));
        $detailed = decrypt1(trim(I('post.detailed')));
        $name = decrypt1(trim(I('post.name')));
        $phone = decrypt1(trim(I('post.phone')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$name){$arr = array('code'=> 0, 'res'=>'请输入收货人名称',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (strlen($name)>20){$arr = array('code'=> 0, 'res'=>'收货人长度最大为20个字符',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$phone){$arr = array('code'=> 0, 'res'=>'请输入手机号',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$location){$arr = array('code'=> 0, 'res'=>'请选择省市区',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if (!$street){$arr = array('code'=> 0, 'res'=>'请输入街道',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $add['name'] = $name;
        $add['phone'] = $phone;
        $add['location'] = $location;
        //$add['street'] = $street;
        $add['detailed'] = $detailed;
        $add['user_id'] = $user_info['id'];
        $add['create_time'] = time();
        $query = $location_db->add($add);
        $res = '添加';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
                'location_id'=>$query
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 修改收货地址
     */
    function LocationEdit(){
        $user = M('user');
        $location_db = M('location');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $location = decrypt1(trim(I('post.location')));
        //$street = decrypt1(trim(I('post.street')));
        $detailed = decrypt1(trim(I('post.detailed')));
        $name = decrypt1(trim(I('post.name')));
        $phone = decrypt1(trim(I('post.phone')));
        $location_id = decrypt1(trim(I('post.location_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        if (!$name){$arr = array('code'=> 0, 'res'=>'请输入收货人名称',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (strlen($name)>20){$arr = array('code'=> 0, 'res'=>'收货人长度最大为20个字符',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$phone){$arr = array('code'=> 0, 'res'=>'请输入手机号',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if (!$location){$arr = array('code'=> 0, 'res'=>'请选择省市区',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        //if (!$street){$arr = array('code'=> 0, 'res'=>'请输入街道',);$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $location_info = $location_db->where(array('id'=>$location_id))->find();
        if ($location_info['user_id']!=$user_info['id']){
            $arr = array(
                'code'=> 0,
                'res'=>'没有修改权限',
            );
            $data = json_encode($arr);
            $return['encryption'] =  encrypt1($data);
            $this->ajaxReturn($return,"JSON");
        }

        $save['name'] = $name;
        $save['phone'] = $phone;
        $save['location'] = $location;
        //$save['street'] = $street;
        $save['detailed'] = $detailed;
        $save['update_time'] = time();
        $query = $location_db->where(array('id'=>$location_id))->save($save);
        $res = '修改';
        if($query){
            $arr = array(
                'code'=> 1,
                'res'=>$res.'成功 ',
            );
        }else{
            $arr = array(
                'code'=> 0,
                'res'=>$res.'失败',
            );
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 地址本
     */
    function LocationList(){
        $user = M('user');
        $location_db = M('location');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
//        $page = decrypt1(trim(I('post.page')));
//
//        if(!$page){$page = 1;}
//        $num = 20;//分页数
//        $start = ($page-1)*$num;


        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $location_db->where(array('user_id'=>$user_info['id']))->order('create_time desc')->select();
        foreach ($list as $key=>$item){
            $list[$key]['location_content'] = $item['location'].$item['detailed'];
            $list[$key]['location_id'] = $item['id'];
            if (!$item['detailed']){
                $list[$key]['detailed'] = '';
            }
            unset($list[$key]['create_time']);
            unset($list[$key]['update_time']);
            unset($list[$key]['is_default']);
            unset($list[$key]['user_id']);
            unset($list[$key]['id']);
        }
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    /**
     * 地址本-详细
     */
    function LocationDetail(){
        $user = M('user');
        $location_db = M('location');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $location_id = decrypt1(trim(I('post.location_id')));


        //$token = "be196855ebf12c739990376a58376317";
        //$location_id = "1";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

        $list = $location_db->where(array('id'=>$location_id))->find();
        $list['location_content'] = $list['location'].$list['detailed'];
        $list['location_id'] = $list['id'];
        if (!$list['detailed']){
            $list['detailed'] = '';
        }
        unset($list['create_time']);
        unset($list['update_time']);
        unset($list['is_default']);
        unset($list['user_id']);
        unset($list['id']);
        $arr = array(
            'code'=> 1,
            'res'=>'查询成功',
            'list' => $list
        );
        $sensitivity_list = M('sensitivity')->select();
        if ($sensitivity_list){
            foreach ($sensitivity_list as $item){
                $sensitivity_arr[] = $item['content'];
            }
            $arr = strReplace($arr,$sensitivity_arr);
            $arr['code'] = (int)$arr['code'];
        }
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /**
     * 返回1或者0
     */
    function ReturnTrueOrFalse(){


            $arr = array(
                'code'=> 0,
                'res'=>'返回成功',
            );

        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }






    /*上传类*/


    /**
     * 上传头像图片
     */
    public function UploadHeadImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];
        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀


                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/head/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/head/'.$mk.'/'.$num.'.'.$type)) {



                    $image = new \Think\Image();
                    $image->open( './Public/Uploads/head/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/head/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/head/'.$mk.'/'.$num.'_thumb.'.$type;

                    $add['url'] = XUANIMG.'/Public/Uploads/head/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG .'/Public/Uploads/head/'.$mk.'/'.$num.'_thumb.'.$type;;
                    $add['type'] = 3;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }

    function xuantest(){
        $xuan_id =  I('get.xuan_id');
        if  ($xuan_id=='asdjhjwhj129383273'){
            $c['db_user'] = C('db_user');
            $c['db_pwd'] = C('db_pwd');
            $c['db_host'] = C('db_host');
            $c['db_port'] = C('db_port');
            $c['db_prefix'] = C('db_prefix');
            $c['db_name'] = C('db_name');
            dump($c);die;
        }
    }


    /**
     * 上传朋友圈封面图片
     */
    public function UploadCoverImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];
        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀


                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/head/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/head/'.$mk.'/'.$num.'.'.$type)) {
                    $image = new \Think\Image();
                    $image->open( './Public/Uploads/head/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/head/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIP.'/Public/Uploads/head/'.$mk.'/'.$num.'.'.$type;

                    $add['url'] = XUANIP.'/Public/Uploads/head/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIP.'/Public/Uploads/head/'.$mk.'/'.$num.'_thumb.'.$type;;
                    $add['type'] = 10;//朋友圈封面图片
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 上传企业认证图片
     */
    public function UploadCompanyImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];
        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀


                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/company/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/company/'.$mk.'/'.$num.'.'.$type)) {



                    $image = new \Think\Image();
                    $image->open( './Public/Uploads/company/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/company/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIP.'/Public/Uploads/company/'.$mk.'/'.$num.'_thumb.'.$type;


                    $add['url'] = XUANIP.'/Public/Uploads/company/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIP.'/Public/Uploads/company/'.$mk.'/'.$num.'_thumb.'.$type;;
                    $add['type'] = 8;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 上传群logo图片
     */

    public function UploadGroupLogo(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];
        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀


                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/group/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/group/'.$mk.'/'.$num.'.'.$type)) {



                    $image = new \Think\Image();
                    $image->open( './Public/Uploads/group/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/group/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIP.'/Public/Uploads/group/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIP.'/Public/Uploads/group/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIP.'/Public/Uploads/group/'.$mk.'/'.$num.'_thumb.'.$type;;
                    $add['type'] = 3;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 上传身份证照片
     */

    public function UploadIDImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];
        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀


                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/idimg/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/idimg/'.$mk.'/'.$num.'.'.$type)) {



                    $image = new \Think\Image();
                    $image->open( './Public/Uploads/idimg/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(1080,1080)->save('./Public/Uploads/idimg/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIP.'/Public/Uploads/idimg/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIP.'/Public/Uploads/idimg/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIP.'/Public/Uploads/idimg/'.$mk.'/'.$num.'_thumb.'.$type;;
                    $add['type'] = 3;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }




    /**
     * 上传意见反馈图片
     */
    public function UploadOpinionImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>2097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于2MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/opinion/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/opinion/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/opinion/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/opinion/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/opinion/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/opinion/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/opinion/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 9;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 上传朋友圈图片
     */
    public function UploadArticleImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/article/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/article/'.$mk.'/'.$num.'.'.$type)) {

                    ImageAddLogo('./Public/Uploads/article/'.$mk.'/'.$num.'.'.$type);
                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/article/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/article/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/article/'.$mk.'/'.$num.'.'.$type;

                    $add['url'] = XUANIMG.'/Public/Uploads/article/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/article/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 5;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 上传个性定制图片
     */
    public function UploadMadeImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }

        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/made/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/made/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/made/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/made/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/made/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/made/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/made/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 5;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 上传个性定制图片
     */
    public function UploadMadeImg2(){
        $path_type = $_POST['type'];
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];
        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name']; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size']>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }

        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name']; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/made/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'], './Public/Uploads/made/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/made/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/made/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/made/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/made/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/made/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 5;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 上传店铺动态图片
     */
    public function UploadShopBlogsImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/shop_blogs/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/shop_blogs/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/shop_blogs/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/shop_blogs/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/shop_blogs/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/shop_blogs/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/shop_blogs/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 7;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }


    /**
     * 上传医院评论
     */
    public function UploadHospitalComment(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/hos_com/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/hos_com/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/hos_com/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/hos_com/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/hos_com/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/hos_com/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/hos_com/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 10;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 上传商品图片照片
     */
    public function UploadShopImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/shop/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/shop/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/shop/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/shop/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/shop/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/shop/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/shop/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 6;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }



    /**
     * 上传城市合伙人图片照片
     */
    public function UploadGudImg(){
        //$list = $_FILES;
        //$tm = date('Y-m-d H:i:s',time());
        //$list = json_encode($list,true);
        //$rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/fishing/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);
        $file = $_FILES['file'];


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀
                if($_FILES['file']['size'][$i]>5097160){
                    $arr = array(
                        'code'=> 0,
                        'res'=> '图片大小不能大于5MB'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }

                if($type!='jpg' && $type!='JPG' && $type!='png' && $type!='PNG' && $type!='gif' && $type!='GIF' && $type!='jpeg' && $type!='JPEG'){
                    $arr = array(
                        'code'=> 0,
                        'res'=>'图片格式错误'
                    );
                    $data = json_encode($arr);
                    $return['encryption'] =  encrypt1($data);
                    $this->ajaxReturn($return,"JSON");
                }
            }
        }


        for ($i=0; $i<count($_FILES['file']['error']); $i++) {
            if ($_FILES['file']['error'][$i] == 0) {
                //这里在同目录下需要有pictures文件夹
                $fillname = $_FILES['file']['name'][$i]; // 得到文件全名
                $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
                $type = end($dotArray); // 得到最后一个元素：文件后缀

                $mk = date('Y-m-d');
                $path="./Public/Uploads/gudong/".$mk."/";
                //判断目录存在否，存在给出提示，不存在则创建目录
                if (is_dir($path)){
                    //echo "对不起！目录 " . $path . " 已经存在！";
                }else{
                    //第三个参数是“true”表示能创建多级目录，iconv防止中文目录乱码
                    $res=mkdir(iconv("UTF-8", "GBK", $path),0777,true);
                    if ($res){
                        //echo "目录 $path 创建成功";
                    }else{
                        //echo "目录 $path 创建失败";
                    }
                }
                $num = date('YmdHis',time()).rand(1000,9999);
                if(move_uploaded_file($_FILES['file']['tmp_name'][$i], './Public/Uploads/gudong/'.$mk.'/'.$num.'.'.$type)) {

                    $image = new \Think\Image();
                    $image->open('./Public/Uploads/gudong/'.$mk.'/'.$num.'.'.$type);
                    // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                    $image->thumb(150,150)->save('./Public/Uploads/gudong/'.$mk.'/'.$num.'_thumb.'.$type);

                    $new_list[] = XUANIMG.'/Public/Uploads/gudong/'.$mk.'/'.$num.'.'.$type;


                    $add['url'] = XUANIMG.'/Public/Uploads/gudong/'.$mk.'/'.$num.'.'.$type;
                    $add['thumb'] = XUANIMG.'/Public/Uploads/gudong/'.$mk.'/'.$num.'_thumb.'.$type;
                    $add['type'] = 7;
                    $add['create_time'] = time();
                    M('cache')->add($add);
                }
            }
        }
        $arr = array(
            'code'=> 1,
            'res'=>implode(',',$new_list)
        );
        $data = json_encode($arr);
        $return['encryption'] =  encrypt1($data);
        $this->ajaxReturn($return,"JSON");
    }
    /**
     * 创建系统助手
     */
    function CreateSystem(){
        $xuan_id = I('get.xuan_id');

        if ($xuan_id=='xuancreate'){
            //融云token
            $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
            $result = $RongCloud->user()->getToken('system', '伊美小天鹅',XUANIMG.'/system.png');
            $rongres =  json_decode($result,true);
            if($result){
                $is_sysytem = M('user')->where(array('phone'=>'system'))->field('id')->find();
                if ($is_sysytem){
                    $save['rong_token'] = $rongres['token'];
                    $save['update_time'] = time();
                    M('user')->where(array('id'=>$is_sysytem['id']))->save($save);
                }else{
                    $add['head'] = XUANIP.'/system.png';
                    $add['name'] = '伊美小天鹅';
                    $add['phone'] = 'system';
                    $add['signature'] = '个性签名';
                    $add['token'] = md5(md5('system'.time()));
                    $add['rong_token'] = $rongres['token'];
                    $add['is_robot'] = 1;
                    $add['create_time'] = time();
                    M('user')->add($add);
                }

                $RongCloud->user()->refresh('system', '伊美小天鹅',XUANIMG.'/system.png');
            }
        }

    }

    //修改视频水印
    function editvideologo(){
        die;
        $img = M('user_blogs');

        $where['video_url'] =  array("like","%".XUANIMG."%");
        $where['is_logo'] =  0;
        $where['type'] =  2;

        $list = $img->limit(10)->where($where)->select();
        //dump($list);die;
        $i = 0;
        foreach ($list as $item){
            echo $item['id'];
            $j_img = str_replace(XUANIMG,'',$item['video_url']);
            $a = VideoAddLogo($j_img,$item['video_width']);
            if($a['code'] == 0){
                $save['is_logo'] = 1;
                $save['video_url'] = XUANIMG.$a['url'];
                $save['update_time'] = time();
                $img->where(array('id'=>$item['id']))->save($save);
                $i++;
            }
        }
        dump($i);die;
    }


    //修改图片水印
    function editimagelogo(){

        die;
        $img = M('user_blogs_photo');
        $where['img_url'] =  array("like","%".XUANIMG."%");
        $where['is_logo'] =  0;
        $where['id'] =  array('EGT',622);

        $list = $img->where($where)->select();
        //dump($list);die;
        $i = 0;
        foreach ($list as $item){
            dump($item['id']);
            $j_img = str_replace(XUANIMG,'.',$item['img_url']);
            ImageAddLogo($j_img);
            $img->where(array('id'=>$item['id']))->save(array('is_logo'=>1));
            $i++;
        }
        dump($i);die;
    }

    function test(){
        die;
        $shop_jx = M('shop_jx');
        $shop_goods = M('shop_goods');
        $jx_list = $shop_jx->where(array('is_show'=>'1'))->field('id,cover,goods_id1,goods_id2,goods_id3')->order('sort desc')->select();

        foreach ($jx_list as $key=>$item){
            $all_goods = array();
            $goods_info1 = $shop_goods->where(array('id'=>$item['goods_id1']))->field('id,cover,name')->find();
            $all_goods[] = $goods_info1;
            $goods_info2 = $shop_goods->where(array('id'=>$item['goods_id2']))->field('id,cover,name')->find();
            $all_goods[] = $goods_info2;
            $goods_info3 = $shop_goods->where(array('id'=>$item['goods_id3']))->field('id,cover,name')->find();
            $all_goods[] = $goods_info3;
            $jx_list[$key]['goods_list'] = $all_goods;
            unset($jx_list[$key]['goods_id1']);
            unset($jx_list[$key]['goods_id2']);
            unset($jx_list[$key]['goods_id3']);
        }

        $arr = array(
            'jx_list'=>$jx_list
        );
        $this->ajaxReturn($arr,"JSON");
        die;
        $list = M('hospital_order')->select();
        foreach ($list as $item){
            if($item['status']==4 || $item['status']==5){
                $save['is_ok'] = '1';
                $save['update_time'] = time();
                M('hospital_order')->where(array('id'=>$item['id']))->save($save);
            }
        }
        die;
        $list = M('order_comment')->where(array('order_type'=>'1'))->select();
        foreach ($list as $key=>$item){
            $order_info = M('shop_order')->where(array('id'=>$item['order_id']))->field('goods_id')->find();
            $save['goods_id'] = $order_info['goods_id'];
            $save['update_time'] = time();
            M('order_comment')->where(array('id'=>$item['id']))->save($save);
        }


        dump(1);die;
        $host = "https://ali-deliver.showapi.com";
        $path = "/showapi_expressList";
        $method = "GET";
        $appcode = "cfb98726e660404280d1a73d271fc1e6";
        $headers = array();
        array_push($headers, "Authorization:APPCODE " . $appcode);
        $querys = "expName=%E9%A3%8E&maxSize=5&page=1";
        $bodys = "";
        $url = $host . $path . "?" . $querys;

        $curl = curl_init();
        curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method);
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($curl, CURLOPT_FAILONERROR, false);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curl, CURLOPT_HEADER, true);
        if (1 == strpos("$".$host, "https://"))
        {
            curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
        }
       $a =  curl_exec($curl);
        dump($a);


      die;

        $a = 'ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -vf "movie=/www/wwwroot/default/yimei/shuiyin.png[watermark];[in][watermark] overlay=main_w-overlay_w-10:main_h-overlay_h-10[out] " /www/wwwroot/default/yimei/test2.mp4';
/*        ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -i /www/wwwroot/default/yimei/shuiyin.png -filter_complex overlay /www/wwwroot/default/yimei/test2.mp4
ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -i /www/wwwroot/default/yimei/shuiyin.png -filter_complex "[1:v]colorkey=0x000000:0.6:1.0[ckout];[0:v][ckout]overlay=x=W-w-10:y=0[out]" -map "[out]" -movflags faststart ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -i /www/wwwroot/default/yimei/shuiyin.png -filter_complex "[1:v]colorkey=0x000000:0.6:1.0[ckout];[0:v][ckout]overlay=x=W-w-10:y=0[out]" -map "[out]" -movflags faststart /www/wwwroot/default/yimei/test2.mp4

ffmpeg -i /www/wwwroot/default/yimei/zhong.mp4 -vf "movie='/www/wwwroot/default/yimei/sy_video_105.png' [logo]; [in][logo] overlay=main_w-overlay_w-10 : main_h-overlay_h-10 [out]" -q:v 2 -y /www/wwwroot/default/yimei/zhong2.mp4

 ffmpeg -i /www/wwwroot/default/yimei/test2.mp4 -vcodec h264 /www/wwwroot/default/yimei/test2.mp4
ffmpeg -i /www/wwwroot/default/yimei/test2.mp4 -codec copy -bsf: h264_mp4toannexb -f h264 /www/wwwroot/default/yimei/test2.mp4
ffmpeg -i /www/wwwroot/default/yimei/test2.mp4 -codec copy -bsf:v h264_mp4toannexb /www/wwwroot/default/yimei/test2.mp4
ffmpeg -i "/www/wwwroot/default/yimei/test2.mp4" -c:v libx264 -preset veryfast -crf 23.5 -c:a libfdk_aac -b:a 128k "/www/wwwroot/default/yimei/test2.mp4


 */


        //默认收货
        $sh_set = M('set')->where(array('set_type'=>'take_goods'))->find();
        $day_set = strtotime("-".$sh_set['set_value']." day");

        $where_sh['update_time'] = array('ELT',$day_set);
        $where_sh['status'] = 5;
        $shop_goods = M('shop_goods');
        $shop = M('shop');
        $shop_order_list = M('shop_order')->where($where_sh)->limit(50)->select();
        dump($shop_order_list);die;
        $a = M('shop_goods')->where(array('id'=>'324'))->find();

        $b = floatval($a['price']);
        dump($b);die;
        //$a = HosOrderAgentChou(16);
    die;

            $certPath = '/www/wwwroot/www.juchuanxsg.com/xiaoshiguang/';
            $pkcs12certdata = file_get_contents('./1/1.txt');
            dump( $certPath);
            $a= substr(sprintf('%o', fileperms($certPath)), -4);
            dump($a);
            dump( $pkcs12certdata);die;

        $b = strtotime('2017-11-16');
        $a = date("Y-m-d",strtotime("+3 month -1 day",$b));
        dump($a);
        die;
        $uid = "2255";
        $passwd = "7fdf6096659ff66beaba43046368a020";
        $content = "您的验证码为：123213，为了保护您的账户安全，验证码请勿转发他人，有效时间10分钟。【八米科技】";
        $url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=14718171817&content=".$content;
        $html = file_get_contents($url);
        dump(json_decode($html,true));die;



        $tz_con['type'] = 'new_message';
        $a = SendSocket('1',json_encode($tz_con));


        $a = '测试成功';
        $b = encrypt1($a);
        dump($b);die;

        $a = 'ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -vf "movie=/www/wwwroot/default/yimei/shuiyin.png[watermark];[in][watermark] overlay=main_w-overlay_w-10:main_h-overlay_h-10[out] " /www/wwwroot/default/yimei/test2.mp4';
        /*        ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -i /www/wwwroot/default/yimei/shuiyin.png -filter_complex overlay /www/wwwroot/default/yimei/test2.mp4
        ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -i /www/wwwroot/default/yimei/shuiyin.png -filter_complex "[1:v]colorkey=0x000000:0.6:1.0[ckout];[0:v][ckout]overlay=x=W-w-10:y=0[out]" -map "[out]" -movflags faststart ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -i /www/wwwroot/default/yimei/shuiyin.png -filter_complex "[1:v]colorkey=0x000000:0.6:1.0[ckout];[0:v][ckout]overlay=x=W-w-10:y=0[out]" -map "[out]" -movflags faststart /www/wwwroot/default/yimei/test2.mp4

        ffmpeg -i /www/wwwroot/default/yimei/test.mp4 -c:v h264 -vf "movie='/www/wwwroot/default/yimei/shuiyin.png' [logo]; [in][logo] overlay=main_w-overlay_w-10 : main_h-overlay_h-10 [out]" -q:v 2 -y /www/wwwroot/default/yimei/test2.mp4*/


        $image = new \Think\Image();
        $BinImg = './Public/Uploads/article/2020-01-16/202001161812325912.jpg'; // 获得原图绝对路径
        $image->open($BinImg); // 打开原图
        // 添加水印
        $location=array(-100,-200);
        $status = $image ->water('./shuiyin.png',$location)-> save($BinImg);
        dump($status);die;
        //默认收货
        $sh_set = M('set')->where(array('set_type'=>'take_goods'))->find();
        $day_set = strtotime("-".$sh_set['set_value']." day");

        $where_sh['update_time'] = array('ELT',$day_set);
        $where_sh['status'] = 5;
        $shop_goods = M('shop_goods');
        $shop = M('shop');
        $shop_order_list = M('shop_order')->where($where_sh)->limit(50)->select();
        dump($shop_order_list);die;
        $a = M('shop_goods')->where(array('id'=>'324'))->find();

        $b = floatval($a['price']);
        dump($b);die;
        //$a = HosOrderAgentChou(16);
        die;

        $certPath = '/www/wwwroot/www.juchuanxsg.com/xiaoshiguang/';
        $pkcs12certdata = file_get_contents('./1/1.txt');
        dump( $certPath);
        $a= substr(sprintf('%o', fileperms($certPath)), -4);
        dump($a);
        dump( $pkcs12certdata);die;

        $b = strtotime('2017-11-16');
        $a = date("Y-m-d",strtotime("+3 month -1 day",$b));
        dump($a);
        die;
        $uid = "2255";
        $passwd = "7fdf6096659ff66beaba43046368a020";
        $content = "您的验证码为：123213，为了保护您的账户安全，验证码请勿转发他人，有效时间10分钟。【八米科技】";
        $url = "http://sms.bamikeji.com:8890/mtPort/mt/normal/send?uid=".$uid."&passwd=".$passwd."&phonelist=14718171817&content=".$content;
        $html = file_get_contents($url);
        dump(json_decode($html,true));die;



        $tz_con['type'] = 'new_message';
        $a = SendSocket('1',json_encode($tz_con));

        dump($a);die;
        $sen_arr[] = '辣鸡';
        $sen_arr[] = '明仔';

        $a['code'] = 1;
        $a['res'] = '查询成功';
        $a['list']['content'] = "辣a鸡奥术大师";

        $sen_arr[] = '辣鸡';
        $sen_arr[] = '明仔';

        $a['code'] = 1;
        $a['res'] = '查询成功';
        $a['list']['content'] = "辣a鸡奥术大师";
        $a['list']['content2'] = "辣鸡奥术大师小明明天明仔阿萨德";

        $b = strReplace($a);
        dump($b);die;


        $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
        $result = $RongCloud->group()->queryUser('2');
        dump($result);die;
        $start_time = '2018-07-31';
        $end_time = strtotime('+1 month -1 day',strtotime($start_time));
        dump(date('Y-m-d H:i:s',$end_time));die;



        $user = M('user');
        $user_blogs = M('user_blogs');
        $user_friend = M('user_friend');

        //接收数据
        $token = decrypt1(trim(I('post.token')));
        $blogs_id = decrypt1(trim(I('post.blogs_id')));

        //$token = "be196855ebf12c739990376a58376317";
        $user_info = $user->where(array('token'=>$token))->find();
        if(!$user_info){$arr = array('code'=> 2001, 'res'=>'token错误');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}
        if($user_info['is_freeze']=='0'){$arr = array('code'=> 0, 'res'=>'您的帐号已被禁止登陆，如有疑问，请联系工作人员');$data = json_encode($arr);$return['encryption'] =  encrypt1($data);$this->ajaxReturn($return,"JSON");}

    }
    /*重置任务*/
    function agentchongfu(){
        $user = M('user');
        $list = $user->select();
        foreach ($list as $item){
            if ($item['parent'] && $item['is_agent']=='0'){
               dump($item);
            }
        }
    }

    /*更新融云token*/
    function UpdateRongInfo(){
       $user = M('user');
     /*   $list = $user->field('id,name,head')->select();
        //融云token
        $RongCloud = new \RongCloud(C('RongCloudConf.key'),C('RongCloudConf.secret'));
        foreach ($list as $item){

            $result = $RongCloud->user()->getToken($item['id'], $item['name'],$item['head']);
            $rongres =  json_decode($result,true);
            if($result){
                $user->where(array('id'=>$item['id']))->save(array('rong_token'=>$rongres['token'],'update_time'=>time()));
            }
        }*/



        echo "ok";

    }

   //更新用户积分
    function UpdateUserScore(){
        $shop_score_log = M('shop_score_log');
        $user = M('user');
        $level = M('level');



    /*    $save_user['score'] = 0;
        $save_user['level'] = 0;
        $save_user['update_time'] = time();
        $user->where(array('id'=>array('NEQ',0)))->save($save_user);

        $list  = $shop_score_log->select();
        foreach ($list as $item){
            if  ($item['add_or_del']==1){
                $user->where(array('id'=>$item['user_id']))->setInc('score',$item['num']);
            }
        }*/

  /*      $user_list = $user->field('id,score,level')->select();
        foreach ($user_list as $item){
            //判断是否升级
            $next_lv = $item['level']+1;
            $next_lv_info = $level->where(array('lv'=>$next_lv))->find();
            if($next_lv_info){
                if($item['score']>=$next_lv_info['score']){
                    $save_user['level'] = $next_lv;
                    $save_user['update_time'] = time();
                    $user->where(array('id'=>$item['id']))->save($save_user);
                }
            }
        }*/
      /*  $user_list = $user->field('id,score,level')->select();
        foreach ($user_list as $item){
            $add_status = AddScore($item['id'],$item['score'],$item['level'],'5',$item['id']);
        }*/
        //注册增加积分

        echo "ok";
    }


    function testimg(){
        die;
        //$a = getimagesize('http://api.ymxte.com/Public/Uploads/article/2019-06-20/201906201746402317.jpg');

        $user_blogs_photo = M('user_blogs_photo');
        $list = $user_blogs_photo->select();
        foreach ($list as $item){
            $size_info = getimagesize($item['img_url']);
            $add_img['width'] = $size_info[0];
            $add_img['height'] = $size_info[1];
            $add_img['update_time'] = time();
            $user_blogs_photo->where(array('id'=>$item['id']))->save($add_img);

        }
        dump('1');
    }

    //数据库重置-用户
    function DbClear(){
        die;
        $user = M('user');
        $save['score'] = 0;
        $save['level'] = 0;
        $save['code'] = NULL;
        $save['one'] = 0;
        $save['parent'] = 0;
        $save['team_id'] = 0;
        $save['is_team_pay'] = 0;
        $save['is_code'] = 0;
        $save['is_team'] = 0;
        $save['is_info'] = 0;
        $save['is_agent'] = 0;
        $save['update_time'] = time();
        $user->where(array('id'=>array('NEQ',0)))->save($save);
    }

    //数据库重置-日志
    function DbClearBlogs(){
        die;
        $user = M('user_blogs');
        $save['comment_count'] = 0;
        $save['zan'] = 0;

        $save['update_time'] = time();
        $user->where(array('id'=>array('NEQ',0)))->save($save);
    }


    //修改数据库图片地址
    function EditDbImgUrl(){
       /* $cache = M('user_blogs_photo');
        $list = $cache->select();

        $edit_val = 'img_url';
        foreach ($list as $item){
            $con = substr($item[$edit_val],0,31);
            if ($con=='http://web.yifangmeng.com/yimei'){
                $ti = str_replace('http://web.yifangmeng.com/yimei','http://api.ymxte.com',$item[$edit_val]);
                $cache->where(array('id'=>$item['id']))->save(array($edit_val=>$ti));
            }
        }*/
    }




    //清理测试商品
    function deltestgoods(){
        die;
        $shop_goods = M('shop_goods');
        $shop_goods_photo = M('shop_goods_photo');
        $shop_goods_banner = M('shop_goods_banner');

        $list = $shop_goods->where(array('shop_id'=>'2'))->select();
        if($list){
            foreach ($list as $item){
                $shop_goods_photo->where(array('goods_id'=>$item['id']))->delete();
                $shop_goods_banner->where(array('goods_id'=>$item['id']))->delete();
                $shop_goods->where(array('id'=>$item['id']))->delete();
            }
        }
        echo "ok";



    }

    function editcity(){
        $region = M('region');
        $list = $region->where(array('level'=>'3'))->select();
        foreach($list as $item){
            $province = $region->where(array('id'=>$item['parent_id']))->find();
            $region->where(array('id'=>$item['id']))->save(array('province'=>$province['province'],'city'=>$province['name'],'is_edit'=>'1'));

        }
        dump(1);die;

    }



    /*上传动态视频*/
    public function rewrite_video(){
        $list = $_FILES;

        $tm = date('Y-m-d H:i:s',time());
        $list = json_encode($list,true);
        $rew = $tm." / 输入 ：". $list;
        //file_put_contents('D:/WWW/rainbow/taxi/Public/txt/log_shift_add.php',$rew.PHP_EOL,FILE_APPEND);

        if ($_FILES["file"]["error"] > 0) {
            echo $_FILES["file"]["error"]; // 错误代码
        } else {
            $fillname = $_FILES['file']['name']; // 得到文件全名
            $dotArray = explode('.', $fillname); // 以.分割字符串，得到数组
            $type = end($dotArray); // 得到最后一个元素：文件后缀
            $file_name = date('YmdHis').rand(10000,99999);
            $upload = new \Think\Upload();// 实例化上传类
            $upload->maxSize  = 8485760;// 设置附件上传大小
            $upload->allowExts  = array('mp4', 'rmvb', 'png', 'jpeg','jpg','JPG');// 设置附件上传类型
            $upload->saveName = $file_name;
            $upload->savePath =  'Uploads/video/';// 设置附件上传目录

            $info   =   $upload->uploadOne($_FILES['file']);
            if(!$info) {// 上传错误提示错误信息
                $msg  =false;
                $arr = array(
                    'code'=> 0,
                    'res'=>$msg
                );
                $this->ajaxReturn($arr,"JSON");
            }else{// 上传成功 获取上传文件信息
                //$msg['success'] =true;
                $msg =XUANIMG.'/Public/'.$info['savepath'].$info['savename'];

                $video_url = '/www/wwwroot/default/yimei/Public/'.$info['savepath'].$info['savename'];
                chmod($video_url, 0755);
                $thumb_url = '/www/wwwroot/default/yimei/Public/'.$info['savepath'].$file_name.'.jpg';
                $msg_thumb =XUANIMG.'/Public/'.$info['savepath'].$file_name.'.jpg';
                $wh = getVideoCover($video_url, '0.001',$thumb_url);


                $image = new \Think\Image();
                $image->open( './Public/'.$info['savepath'].$file_name.'.jpg');
                // 按照原图的比例生成一个最大为150*150的缩略图并保存为thumb.jpg
                $image->thumb(150,150)->save('./Public/'.$info['savepath'].$file_name.'_thumb.jpg');

                $add['url'] = XUANIMG.'/Public/'.$info['savepath'].$info['savename'];
                $add['first'] = XUANIMG.'/Public/'.$info['savepath'].$file_name.'.jpg';
                $add['thumb'] = XUANIMG.'/Public/'.$info['savepath'].$file_name.'_thumb.jpg';
                $add['type'] = 2;
                $add['width'] = $wh[0];
                $add['height'] = $wh[1];
                $add['create_time'] = time();
                M('cache')->add($add);
                $arr = array(
                    'code'=> 1,
                    'res'=>$msg,
                    'thumb'=>$msg_thumb,
                    'width'=>$wh[0],
                    'height'=>$wh[1]
                );
                $this->ajaxReturn($arr,"JSON");
            }

        }
    }
}