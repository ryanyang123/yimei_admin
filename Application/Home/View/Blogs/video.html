<!--引用文件head-->
<include file="common/header"/>


<!-- 上传图片 -->

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-fileupload.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/jquery.gritter.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/chosen.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/select2_metro.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/jquery.tagsinput.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/clockface.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-wysihtml5.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/datepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/timepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/colorpicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-toggle-buttons.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/daterangepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/datetimepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/multi-select-metro.css" />

<link href="__PUBLIC__/css/bootstrap-modal.css" rel="stylesheet" type="text/css"/>

<!-- 上传图片-->

<!-- END HEAD -->

<!-- BEGIN BODY -->

<body class="page-header-fixed">

<!-- BEGIN HEADER -->

<!--头部导航栏-->
<include file="common/top"/>



<div class="page-container">


    <!--导航栏-->
    <include file="common/nav"/>



    <div class="page-content">


        <!-- BEGIN PAGE CONTAINER-->

        <div class="container-fluid">

            <!-- BEGIN PAGE HEADER-->

            <div class="row-fluid">

                <div class="span12">



                    <!--颜色选择-->
                    <include file="common/color"/>



                    <!-- BEGIN PAGE TITLE & BREADCRUMB-->

                    <h3 class="page-title">

                        日志 <small>列表</small>

                    </h3>

                    <ul class="breadcrumb">

                        <li>

                            <i class="icon-home"></i>

                            <a href="<?php echo U('home/home/index');?>">主页</a>

                            <i class="icon-angle-right"></i>

                        </li>

                        <li>

                            <i class="icon-user"></i>

                            <a href="<?php echo U('home/'.$at.'/index');?>">日志列表</a>

                            <i class="icon-angle-right"></i>

                        </li>

                        <li><a href="#"><?php echo $is_edit?'修改'.$title:'新增'.$title;?></a></li>



                    </ul>

                    <!-- END PAGE TITLE & BREADCRUMB-->

                </div>

            </div>

            <!-- END PAGE HEADER-->

            <div id="dashboard">



                <div class="row-fluid">

                    <div class="span12">

                        <!-- BEGIN PORTLET-->

                        <div class="portlet box">



                            <div class="portlet-body form">

                                <!-- BEGIN FORM-->

                                <form action="<?php echo U('home/GameAdd/upload_thumb');?>" class="form-horizontal">
                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font></font></label>

                                        <div class="controls">


                                          <!--  <a href="{:U('home/'.$at.'/plus')}" class="btn icn-only">文字</a>-->
                                            <a href="{:U('home/'.$at.'/photo')}" class="btn icn-only">图片</a>
                                            <a href="#" class="btn green icn-only">视频</a>

                                        </div>

                                    </div>

                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帖子内容</font></font></label>

                                        <div class="controls">

                                            <textarea class="large m-wrap" name="content" id="content" rows="6">{$list.content}</textarea>
                                        </div>

                                    </div>


                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">日志分类</font></font></label>
                                        <div class="controls">

                                            <select name="classify" data-placeholder="Your Favorite Type of Bear" class="chosen-with-diselect span3" tabindex="-1" id="classify">
                                                <option value="" selected>请选择</option>
                                                <foreach name="class_list" item="v">
                                                    <option   value="{$v.id}" <if condition="$list.class_type eq $v['id']">selected</if> >{$v.name}</option>
                                                </foreach>

                                            </select>

                                        </div>
                                    </div>
                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布用户</font></font></label>

                                        <div class="controls">

                                            <input type="number" placeholder="请输入用户ID" name="user_id"  value="{$list.user_id}" class="m-wrap medium">


                                        </div>

                                    </div>

                                  <!--  <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布用户</font></font></label>
                                        <div class="controls">

                                            <select name="user_id" data-placeholder="Your Favorite Type of Bear" class="chosen-with-diselect span3" tabindex="-1" id="user_id">

                                                <foreach name="user_list" item="v">
                                                    <option  <if condition="$list.user_id eq $v['id']">selected</if>   value="{$v.id}" >
                                                        名称：{$v.name}-&#45;&#45;&#45;&#45;<img src="{$v.head}" alt=""/>&#45;&#45;&#45;&#45;性别：{$v.sex}
                                                    </option>
                                                </foreach>

                                            </select>

                                        </div>


                                    </div>-->





                                    <?php if($is_edit){?>

                                    <div class="control-group " >

                                        <label class="control-label">
                                            <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原有视频</font></font></label>

                                        <div class="controls">

                                            <a href="<?php echo $list['video_url'];?>" target="_blank">查看</a>
                                        </div>

                                    </div>
                                    <?php }?>



                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><?php echo $is_edit2&&$list4?'修改logo':'视频';?></font></font></label>


                                        <div class="controls" style="position: relative;">
                                            <!--<div id="upload_kuang"  class="dan_upload_img_div1">
                                                <div id="uploadPreview" >

                                                </div>
                                            </div>-->

                                            <label class="on_img_btn" for="uploadImage" style="display: inline;"> <span  class="btn btn-default" style="">选择视频</span></label>
                                            <label class="change_img_btn" for="uploadImage" style="display: none;"> <span  class="btn btn-default" style="">更改</span></label>
                                            <label class="del_img_btn" style="display: none;" onclick="ClearImg('')"> <span  class="btn btn-default" style="">删除</span></label>
                                            <input id="uploadImage" style="opacity: 1;font-size: 15px;left: 0;bottom: 0!important;top: inherit;padding-left: 4px;" type="file"  name="photoimage" class="fimg1"  />
                                        </div>
                                    </div>


                                    <div class="control-group">
                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择医院</font></font></label>

                                        <div class="controls">
                                            <select id="hospital_id" name="hospital_id"  <!--onchange="CheckDoctor()"--> class="m-wrap">
                                                <option value="" >请选择</option>
                                                <foreach name="hos_list" item="v">
                                                    <option <if condition="$list['shop_id'] eq $v['id']"> selected </if> value="{$v.id}" >{$v.name}</option>
                                                </foreach>
                                            </select>
                                        </div>
                                    </div>

                                 <!--   <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">医生</font></font></label>

                                        <div class="controls">
                                            <select id="doctor_id" name="doctor_id" class="m-wrap">
                                                <option value="" >请选择</option>
                                                <if condition="$doc_list neq null">
                                                    <foreach name="doc_list" item="v">
                                                        <option <if condition="$list['doctor_id'] eq $v['id']"> selected </if> value="{$v.id}" >{$v.name}</option>
                                                    </foreach>
                                                </if>

                                            </select>
                                        </div>

                                    </div>-->


                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手术时间</font></font></label>

                                        <div class="controls">
                                            <input type="text" placeholder="请选择手术时间" name="time"  readonly <if condition="$list['time'] gt 0">value="{$list.time|date='Y-m-d',###}"</if> class="m-wrap medium auto-kal" autocomplete="off">
                                        </div>

                                    </div>






                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">点赞数</font></font></label>

                                        <div class="controls">

                                            <input type="number" placeholder="请输入点赞数" name="zan"  value="{$list.zan}" class="m-wrap medium">


                                        </div>

                                    </div>


                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">浏览数</font></font></label>

                                        <div class="controls">

                                            <input type="number" placeholder="请输入浏览数" name="browse"  value="{$list.browse}" class="m-wrap medium">


                                        </div>

                                    </div>




                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                            经度
                                            <br>
                                            经度范围：0°——180°
                                        </font></font></label>

                                        <div class="controls">
                                            <input type="text" placeholder="请输入经度" name="lng"  value="{$list.lng}" class="m-wrap medium">

                                            <a href="https://lbs.amap.com/console/show/picker" target="_blank">点击查询经纬度</a>

                                        </div>


                                    </div>

                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                                            纬度
                                            <br>
                                            纬度范围：0°——90°
                                        </font></font></label>

                                        <div class="controls">
                                            <input type="text" placeholder="请输入纬度" name="lat"  value="{$list.lat}" class="m-wrap medium">

                                        </div>


                                    </div>








                                    <div class="form-actions">

                                        <button type="button" id="js_btn" onclick="UploadImg()" class="btn blue"><i class="icon-ok"></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 保存</font></font></button>

                                        <button type="button" onclick="to_gen()" class="btn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取消</font></font></button>



                                    </div>

                                </form>

                                <!-- END FORM-->

                            </div>

                        </div>

                        <!-- END PORTLET-->

                    </div>

                </div>


                <div class="clearfix"></div>





            </div>

        </div>

        <!-- END PAGE CONTAINER-->

    </div>

    <!-- END PAGE -->

</div>

<!-- END CONTAINER -->
<include file="common/footer"/>
<!-- END JAVASCRIPTS -->

</body>


<!-- END BODY -->

</html>
<script src="__PUBLIC__/js/ajaxfileupload.js"></script>

<script>
    var is_Edit = '<?php echo $is_edit;?>';
    $("#uploadImage").on("change", function(){
        // Get a reference to the fileList
        var files = !!this.files ? this.files : [];
        // If no files were selected, or no FileReader support, return
        if (!files.length || !window.FileReader) return;
        // Only proceed if the selected file is an image
        if (/^image/.test( files[0].type)){
            // Create a new instance of the FileReader
            var reader = new FileReader();
            // Read the local file as a DataURL
            reader.readAsDataURL(files[0]);
            // When loaded, set image data as background of div
            reader.onloadend = function(){
                $("#uploadPreview").html("<img style='max-height: 150px;border:1px solid #ddd;' src='"+this.result+"'/>");
                $('.on_img_btn').hide();
                $('.change_img_btn').show().css('display','inline-block');
                $('.del_img_btn').show().css('display','inline-block');
                $("#upload_kuang").removeClass("dan_upload_img_div1");
            }
        }
    });



    var parent_url = "<?php echo U('home/'.$at.'/index');?>";

    function to_gen(){
        window.location.href = parent_url;
    }

    function ClearImg(str){
        if(str){
            $("#upload_kuang"+str).addClass("dan_upload_img_div1");
            $("#uploadImage"+str).val('');
            $('.on_img_btn'+str).show();
            $('.change_img_btn'+str).hide();
            $('.del_img_btn'+str).hide();
            $('#uploadPreview'+str).html('');
        }else{
            $("#upload_kuang").addClass("dan_upload_img_div1");
            $("#uploadImage").val('');
            $('.on_img_btn').show();
            $('.change_img_btn').hide();
            $('.del_img_btn').hide();
            $('#uploadPreview').html('');
        }

    }


    function CheckDoctor(){
        var parent = $('#hospital_id').val();
        if(parent){
            $.ajax({
                type: 'POST',
                url: "<?php echo U('home/'.$at.'/checkdoctor'); ?>",
                data:{parent:parent},
                success: function (result) {
                    $('#doctor_id').html('');
                    $('#doctor_id').append('<option value="" >请选择</option>');
                    /*  if (result.is_tic==1){
                          $('#tic_p').html('');
                          $.each(result.tic_list,function(index,value){
                              $('#tic_p').append('     <label class="checkbox limits_'+value.id+'" ">' +
                                  '                        <span><input class="limits" type="checkbox"  name="limits" value="'+value.id+'"></span> ' +value.title+
                                  '                    </label>');
                          });
                      } else{
                          $('#tic_p').html('此医院没有可用体验券');
                      }*/
                    if(result.code == 1){
                        $.each(result.list,function(index,value){
                            $('#doctor_id').append('<option value="'+value.id+'" >'+value.name+'</option>');
                        });
                    }else{
                        showAlert(result.res);
                    }
                }
            });
        }
    }


    function UploadImg(){
        var content = $.trim($("*[name='content']").val());
        if(!content){
            showAlert("请输入帖子内容");
            return false;
        }
        var img = "";
        var file = $("#uploadImage").val();
        $('#js_btn').attr('disabled',true);
        if(file==""){
            SubmitData("");
        }
        else{
            //判断上传的文件的格式是否正确
            var fileType = file.substring(file.lastIndexOf(".")+1);
            if(fileType!="mp4"&&fileType!="MP4" ){
                showAlert("上传文件格式错误");
                $('#js_btn').attr('disabled',false);
                return false;
            }
            else{
                var url = "<?php echo U('home/Upload/article_video');?>";
                $.ajaxFileUpload({
                    url:url,
                    fileElementId:"uploadImage",        //file的id
                    dataType:"json",                  //返回数据类型为文本
                    success:function(res){
                        if(res){
                            img = res;
                            SubmitData(img);
                        }else{
                            showAlert("视频上传失败");
                            $('#js_btn').attr('disabled',false);
                        }
                    }
                })
            }
        }
    }





    function SubmitData(img1){

        var content = $.trim($("*[name='content']").val());
        var user_id = $.trim($("*[name='user_id']").val());
        var zan = $.trim($("*[name='zan']").val());
        var browse = $.trim($("*[name='browse']").val());
        var classify = $.trim($("*[name='classify']").val());
        var lng = $.trim($("*[name='lng']").val());
        var lat = $.trim($("*[name='lat']").val());
        var hospital_id = $.trim($("*[name='hospital_id']").val());
        //var doctor_id = $.trim($("*[name='doctor_id']").val());
        var time = $.trim($("*[name='time']").val());
        if(!content){
            showAlert("请输入帖子内容");
            $('#js_btn').attr('disabled',false);
            return false;
        }
        if(!classify){
            showAlert("请选择分类");
            return false;
        }


        if (!lng){showAlert("请输入经度");return false;}
        if (!lat){showAlert("请输入纬度");return false;}
        // if (!hospital_id){showAlert("请选择医院");return false;}
        // if (!doctor_id){showAlert("请选择医生");return false;}
        // if (!time){showAlert("请选择手术时间");return false;}



        $('#js_btn').attr('disabled',true);
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "<?php echo U('home/'.$at.'/add'); ?>",
            data:{content:content,
                lng:lng,
                lat:lat,
                hospital_id:hospital_id,
                time:time,
                user_id:user_id,zan:zan,browse:browse,type:'2',img_arr:img1,classify:classify,is_edit:is_Edit},
            success: function (result) {
                if(result.code == 1){
                    showAlert(result.res);
                    window.location.href= parent_url;
                }else if(result.code==0){
                    showAlert(result.res);
                    $('#js_btn').attr('disabled',false);
                }else{
                    showAlert("提交失败，请检查您的输入是否合法");
                    $('#js_btn').attr('disabled',false);
                }
            }
        });

    }

</script>