<!--引用文件head-->
<include file="common/header"/>


<!-- 上传图片 -->

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-fileupload.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/jquery.gritter.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/chosen.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/select2_metro.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/jquery.tagsinput.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/clockface.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-wysihtml5.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/datepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/timepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/colorpicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-toggle-buttons.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/daterangepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/datetimepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/multi-select-metro.css" />

<link href="__PUBLIC__/css/bootstrap-modal.css" rel="stylesheet" type="text/css"/>

<!-- 上传图片-->

<!-- END HEAD -->

<!-- BEGIN BODY -->

<body class="page-header-fixed">

<!-- BEGIN HEADER -->

<!--头部导航栏-->
<include file="common/top"/>



<div class="page-container">


    <!--导航栏-->
    <include file="common/nav"/>



    <div class="page-content">


        <!-- BEGIN PAGE CONTAINER-->

        <div class="container-fluid">

            <!-- BEGIN PAGE HEADER-->

            <div class="row-fluid">

                <div class="span12">



                    <!--颜色选择-->
                    <include file="common/color"/>



                    <!-- BEGIN PAGE TITLE & BREADCRUMB-->

                    <h3 class="page-title">

                        订单 <small>详细</small>

                    </h3>

                    <ul class="breadcrumb">

                        <li>

                            <i class="icon-home"></i>

                            <a href="<?php echo U('home/home/index');?>">主页</a>

                            <i class="icon-angle-right"></i>

                        </li>

                        <li>

                            <i class="icon-long-arrow-right"></i>

                            <a href="<?php echo U('home/'.$at.'/index');?>">{$title}</a>

                            <i class="icon-angle-right"></i>

                        </li>

                        <li><a href="#">订单编号：{$list.order_number}</a></li>



                    </ul>

                    <!-- END PAGE TITLE & BREADCRUMB-->

                </div>

            </div>

            <!-- END PAGE HEADER-->

            <div id="dashboard">

                <div class="row-fluid invoice">

                    <div class="row-fluid invoice-logo">


                        <div class="span6">

                            <p>订单编号：{$list.order_number}

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <span class="muted">订单时间：{$list.create_time|date="Y-m-d H:i:s",###}</span></p>

                        </div>

                    </div>

                    <hr>

                    <div class="row-fluid">

                        <div class="span3">

                            <h4>收货人信息:</h4>

                           <table style="width: 100%;line-height: 30px;">
                               <tr>
                                   <td style="width: 100px;">购买用户：</td>
                                   <td><a href="{:U('home/user/check/edit/'.$list['user_id'])}" target="_blank">{$list.user_name}</a></td>
                               </tr>
                               <tr>
                                   <td>收货人：</td>
                                   <td>{$list.addressee}</td>
                               </tr>

                               <tr>
                                   <td>手机号码：</td>
                                   <td>{$list.mobile}</td>
                               </tr>

                               <tr>
                                   <td>收货地址：</td>
                                   <td>{$list.location}{$list.particular}</td>
                               </tr>
                           </table>

                        </div>

                        <div class="span4">

                            <h4>订单信息:</h4>

                            <table style="width: 100%;line-height: 30px;">
                                <tr>
                                    <td>订单状态：</td>
                                    <td>
                                        <if condition="$list.status eq 1">
                                            <span class="label label-success">支付预约金额</span>
                                        </if>
                                        <if condition="$list.status eq 2">
                                            <span class="label label-info">支付全款,待发货</span>
                                        </if>
                                        <if condition="$list.status eq 3">
                                                            <span class="label label-important">
                                                                退款
                                                                <if condition="$list.refund_status eq 1">
                                                                    -买家申请中，待卖家同意
                                                                </if>
                                                                <if condition="$list.refund_status eq 2">
                                                                    -卖家拒绝退款
                                                                </if>
                                                                <if condition="$list.refund_status eq 3">
                                                                    -买家申请客服介入
                                                                </if>
                                                                  <if condition="$list.refund_status eq 4">
                                                                    -退款成功
                                                                </if>

                                                                <if condition="$list.refund_status eq 5">
                                                                    -退款中
                                                                </if>
                                                            </span>
                                            <br>
                                            申请退款前状态：
                                            <if condition="$list.front_status eq 1">
                                                <span class="label label-success">支付预约金额</span>
                                            </if>
                                            <if condition="$list.front_status eq 2">
                                                <span class="label label-info">支付全款,待发货</span>
                                            </if>
                                            <if condition="$list.front_status eq 4">
                                                <span class="label label-warning">已发货，待收货</span>
                                            </if>
                                            <if condition="$list.front_status eq 5">
                                                <span class="label">交易完成(未评价)</span>
                                            </if>
                                            <if condition="$list.front_status eq 6">
                                                <span class="label label-inverse">交易完成(已评价)</span>
                                            </if>
                                        </if>
                                        <if condition="$list.status eq 4">
                                            <span class="label label-warning">已发货，待收货</span>
                                        </if>
                                        <if condition="$list.status eq 5">
                                            <span class="label label-info">交易完成(未评价)</span>
                                        </if>
                                        <if condition="$list.status eq 6">
                                            <span class="label label-inverse">交易完成(已评价)</span>
                                        </if>
                                    </td>
                                </tr>
                                <if condition="$list.status eq 6">
                                    <tr>
                                        <td>评分：</td>
                                        <td>

                                            <!--<img src="__PUBLIC__/image/evaluate_banx@2x.png" alt="">-->

                                            <if condition="$com_info.grade neq 0">
                                                <for start="0" end="$com_info.grade">
                                                    <img src="__PUBLIC__/image/evaluate_sel_xing@2x.png" alt="">
                                                </for>
                                                    <for start="0" end="$com_info.no_xing">
                                                        <img src="__PUBLIC__/image/evaluate_xing@2x.png" alt="">
                                                    </for>

                                                <else/>
                                                <for start="0" end="5">
                                                    <img src="__PUBLIC__/image/evaluate_xing@2x.png" alt="">
                                                </for>
                                            </if>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>评价内容：</td>
                                        <td>
                                            {$com_info.content}
                                            <br>
                                            <if condition="$com_info.img_list neq null">
                                                <foreach name="com_info.img_list" item="v">
                                                    <a class="fancybox-button" data-rel="fancybox-button" title="" href="{$v}">
                                                        <img src="{$v}" style="width: 60px;height: 60px;" alt="">
                                                    </a>
                                                </foreach>
                                            </if>
                                        </td>
                                    </tr>
                                </if>

                                <tr>
                                    <td>支付类型：</td>
                                    <td>
                                        <if condition="$list.money_type eq 1">
                                            <span class="label label-success">支付预约金</span>
                                            <else/>
                                            <span class="label label-info">支付全额</span>
                                        </if>
                                    </td>
                                </tr>

                                <tr>
                                    <td>支付方式：</td>
                                    <td>
                                        <if condition="$list.pay_type eq 1">
                                            <span class="label label-success">微信</span>
                                        </if>
                                        <if condition="$list.pay_type eq 2">
                                            <span class="label label-info">支付宝</span>
                                        </if>
                                        <if condition="$list.pay_type eq 3">
                                            <span class="label label-warning">银联</span>
                                        </if>
                                        <if condition="$list.pay_type eq 4">
                                            <span class="label label-warning">余额支付</span>
                                        </if>
                                    </td>
                                </tr>

                                <tr>
                                    <td>支付时间：</td>
                                    <td>
                                        {$list.pay_time|date="Y-m-d H:i:s",###}
                                    </td>
                                </tr>
                            </table>

                        </div>

                        <div class="span4 invoice-payment">

                            <h4>操作:</h4>
                            <if condition="$list.express_type eq 1">
                                <a href="javascript:wuliu('{$list.id}');" class="btn green"><i class="icon-truck"></i> 查看物流信息</a>
                            </if>

                                <?php if($list['status']=='3'){?>
                                <?php if($list['refund_status']=='3'){?>
                                    <table style="width: 100%;line-height: 30px;">
                                        <tr>
                                            <td>申请退款前订单状态：</td>
                                            <td>
                                                <if condition="$list.front_status eq 1">
                                                    <span class="label label-success">支付预约金额</span>
                                                </if>
                                                <if condition="$list.front_status eq 2">
                                                    <span class="label label-info">支付全款,待收货</span>
                                                </if>

                                                <if condition="$list.front_status eq 4">
                                                    <span class="label label-info">已发货，待收货</span>
                                                </if>
                                                <if condition="$list.front_status eq 5">
                                                    <span class="label label-info">交易完成</span>
                                                </if>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <a href="javascript:fahuo('{$list.id}','{$list.money}');" class="btn blue"><i class="icon-edit"></i> 退款给买家</a>
                                            </td>
                                            <td>
                                                <a href="javascript:EditAll('{$list.id}','2','拒绝买家的退款申请','shop_order','refund_status');" class="btn red"><i class="icon-edit"></i> 拒绝退款</a>

                                            </td>
                                        </tr>
                                    </table>
                            <?php }?>
                            <?php }?>



                        </div>

                    </div>

                    <div class="row-fluid">
                        <br>
                        <p>
                            购买店铺：<a href="{:U('home/shop/check/edit/'.$list['shop_id'])}" target="_blank">{$list.shop_name}</a>
                            &nbsp; &nbsp; &nbsp; &nbsp;
                            店铺电话：{$list.shop_phone}
                        </p>
                        <table class="table table-striped table-hover">

                            <thead>

                            <tr>
                                <th>商品封面</th>
                                <th>商品名称</th>
                                <th>购买规格</th>
                                <th>商品价格</th>
                                <th>购买数量</th>
                            </tr>

                            </thead>

                            <tbody>

                            <tr>
                                <td>
                                    <a class="fancybox-button" data-rel="fancybox-button" title="" href="{$list.goods_info.cover}">
                                        <img src="{$list.goods_info.cover}" style="width: 60px;height: 60px;" alt="">
                                    </a>
                                </td>
                                <td>{$list.goods_info.name}</td>
                                <td>{$list.select_info.select_val}</td>
                                <td>￥{$list.select_info.money}</td>
                                <td>x {$list.select_info.num}</td>
                            </tr>

                            </tbody>

                        </table>

                    </div>

                    <div class="row-fluid">

                        <div class="span4">

                            <div class="well">

                                <address>

                                    <strong>买家备注：</strong>
                                    <br>
                                    <br>

                                    <if condition="$list.remark neq null">
                                        {$list.remark}
                                        <else/>
                                        无
                                    </if>


                                </address>

                            </div>

                        </div>

                        <div class="span8 invoice-block" style="text-align: right;" >

                            <ul class="unstyled amounts">

                                <li><strong>订单总金额:</strong> ￥<span style="font-weight: bolder;color: green;font-size: 18px;"> {$list.total_money}</span></li>
                                <li><strong>运费:</strong> ￥<span style="font-weight: bolder;color: green;font-size: 18px;"> {$list.postage_money}</span></li>
                                <li><strong>当前支付金额:</strong> ￥<span style="font-weight: bolder;color: #f00;font-size: 18px;"> {$list.money}</span></li>

                            </ul>

                            <br>


                            <a href="<?php echo U('home/'.$at.'/index');?>" class="btn green big hidden-print">返回列表<i class="m-icon-big-swapright m-icon-white"></i></a>

                        </div>

                    </div>

                </div>
                <div class="clearfix"></div>







        </div>

        <!-- END PAGE CONTAINER-->

    </div>

    <!-- END PAGE -->

</div>

    <!-- modal -->
    <div class="modal fade" id = 'modal_fahuo' style="display: none;">
        <div class="modal-dialog" >
            <div class="modal-content" >
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close">
                    </button>
                    <i class="fa fa-question" style='margin-top:5px; width:30px; float:left;'></i>
                    <h4 class="modal-title" id='modal_fahuo_title'>退款给买家</h4>
                </div>
                <div class="modal-body">


                    <form action="#" class="form-horizontal">
                        <div class="control-group">
                            <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前支付金额</font></font></label>
                            <div class="controls">
                                <p style="padding-top: 7px;" id="tui_money"></p>
                            </div>
                        </div>


                        <div class="control-group">

                            <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font></font></label>

                            <div class="controls">
                                <!-- 类型：0不跳转，1跳转外部链接，2跳转医院详情,3优惠券详情，4商品详情，5邀请好友-->

                                <label class="radio">
                                    <div class="radio"><span><input type="radio" name="optionsRadios1"  checked=""  value="1"></span></div>
                                    全部退款
                                </label>
                                <label class="radio">
                                    <div class="radio"><span ><input type="radio" name="optionsRadios1"  value="2"></span></div>
                                    手动输入退款金额
                                </label>



                            </div>

                        </div>

                        <div class="control-group show_all show_2" style="display: none;">
                            <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">退款金额</font></font></label>
                            <div class="controls">
                                <input type="number" placeholder="请输入要退款金额" name="money_tui"  value="" class="m-wrap medium">
                            </div>
                        </div>

                    </form>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal" >取 消</button>
                    <button type="button" class="btn green" id='modal_fahuo_yes'  style='margin-left:9px'>确 定</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- ./modal -->

    <!-- modal -->
    <div class="modal fade" id = 'modal_wuliu' style="display: none;">
        <div class="modal-dialog" >
            <div class="modal-content" >
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close">
                    </button>
                    <i class="fa fa-question" style='margin-top:5px; width:30px; float:left;'></i>
                    <h4 class="modal-title" id='modal_wuliu_title'>物流信息</h4>
                </div>
                <div class="modal-body">



                        <p>快递公司：<span id="express_name"></span></p>
                        <p>快递单号：<span id="express_number"></span></p>

                    <hr>
                        <div>
                            <p id="no_wuliu" style="text-align: center;margin: 10px 0;display: none;">未查询到物流信息！</p>

                            <table style="line-height: 60px;" id="express_con">

                            </table>
                        </div>




                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal" >关 闭</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- ./modal -->

    <!-- END CONTAINER -->
<include file="common/footer"/>
    <include file="common/tz"/>
<!-- END JAVASCRIPTS -->

</body>


<!-- END BODY -->

</html>
<script src="__PUBLIC__/js/ajaxfileupload.js"></script>
<script>
    var is_Edit = '<?php echo $is_edit;?>';
    $("#uploadImage").on("change", function(){
        // Get a reference to the fileList
        var files = !!this.files ? this.files : [];

        // If no files were selected, or no FileReader support, return
        if (!files.length || !window.FileReader) return;

        // Only proceed if the selected file is an image
        if (/^image/.test( files[0].type)){

            // Create a new instance of the FileReader
            var reader = new FileReader();

            // Read the local file as a DataURL
            reader.readAsDataURL(files[0]);

            // When loaded, set image data as background of div
            reader.onloadend = function(){

                $("#uploadPreview").html("<img style='max-height: 150px;border:1px solid #ddd;' src='"+this.result+"'/>");
                $('.on_img_btn').hide();
                $('.change_img_btn').show().css('display','inline-block');
                $('.del_img_btn').show().css('display','inline-block');
                $("#upload_kuang").removeClass("dan_upload_img_div1");
            }
        }
    });

    $('input:radio[name="optionsRadios1"]').change( function(){
        $('.show_all').hide();
        if($(this).val()==2){
            $('.show_'+$(this).val()).show();
        }
    })

    function fahuo(id,money){
        $('#tui_money').html(money);
        $('#modal_fahuo').modal('show');
        $('#modal_fahuo_yes')[0].onclick=function(){
            //$('#modal_confirm').modal('hide');
            Edittui(id)
        };


    }



    function wuliu(id){
        $('#modal_wuliu').modal('show');
        $('#no_wuliu').hide();
        $('#express_con').html('');
        $('#express_name').html('');
        $('#express_number').html('');
        $.ajax({
            type: 'POST',
            url: "<?php echo U('home/'.$at.'/wuliu'); ?>",
            data:{order_id:id},
            success: function (result) {
                if(result.code == 1){
                    $('#express_name').html(result.head_info.express_name);
                    $('#express_number').html(result.head_info.express_number);
                    $.each(result.list, function(index, value) {
                        $('#express_con').append('<tr>' +
                            '<td style="width: 150px;vertical-align: top;">'+value.time+'</td>' +
                            '<td style="line-height: 25px;">'+value.context+'</td>' +
                            '</tr>');
                    });
                }else{
                    $('#no_wuliu').show().html(result.res);
                }
            }
        });
    }


    var parent_url = "<?php echo U('home/user/index');?>";

    function to_gen(){
        window.location.href = parent_url;
    }

    function EditCheckbox(id){
        var str ;
        if($('.tuijian'+id).is(':checked')) {
            str =1;
        }else{
            str=0;
        }
        $.ajax({
            type: 'POST',
            url: "<?php echo U('home/'.$at.'/edittuijian'); ?>",
            data:{id:id,str:str},
            success: function (result) {
                if(result.code == 1){
                    showAlert(result.res);
                    window.location.reload();
                }else{
                    showAlert(result.res);
                }
            }
        });
    }

    function EditStatus(id,str,title,db){
        var name;
        if(str=='1'){
            name = '显示';
        }else{
            name = '隐藏';
        }
        showConfirm('<i class="icon-exclamation-sign"></i> '+name+title,'确定要'+name+title+' 吗?',function(){
            $.ajax({
                type: 'POST',
                url: "<?php echo U('home/public/editshow'); ?>",
                data:{id:id,str:str,db:db},
                success: function (result) {
                    if(result.code == 1){
                        showAlert(result.res);
                        window.location.reload();
                    }else{
                        showAlert(result.res);
                    }
                }
            });
        });
    }

    function _deleteUser(id,name,db){
        showConfirm('<i class="icon-exclamation-sign"></i> 删除'+name,'确定要删除'+name+' 吗?',function(){
            $.ajax({
                type: 'POST',
                url: "<?php echo U('home/public/delete'); ?>",
                data:{id:id,db:db},
                success: function (result) {
                    if(result.code == 1){
                        showAlert(result.res);
                        window.location.reload();
                    }else{
                        showAlert(result.res);
                    }
                }
            });
        });
    }

    function ClearImg(){
        $("#upload_kuang").addClass("dan_upload_img_div1");
        $("#uploadImage").val('');
        $('.on_img_btn').show();
        $('.change_img_btn').hide();
        $('.del_img_btn').hide();
        $('#uploadPreview').html('');
    }


    function UploadImg(){
        var img = "";
        var file = $("#uploadImage").val();
        if(file==""){
            SubmitData("");
        }


        else{
            //判断上传的文件的格式是否正确
            var fileType = file.substring(file.lastIndexOf(".")+1);
            if(fileType!="png"&&fileType!="jpg" &&fileType!="jpeg"){
                showAlert("上传文件格式错误");
                return false;
            }
            else{
                var url = "<?php echo U('home/Upload/thumb');?>";
                $.ajaxFileUpload({
                    url:url,
                    fileElementId:"uploadImage",        //file的id
                    dataType:"json",                  //返回数据类型为文本
                    success:function(res){
                        if(res){
                            img = res;

                            SubmitData(img);
                        }else{
                            showAlert("图片上传失败");
                        }
                    }
                })
            }
        }
    }

    function Edittui(id,money){
        var type = $("input[name='optionsRadios1']:checked").val();
        var money = 0;
        if(type==2){
            money = $.trim($("*[name='money_tui']").val());
        }
        showConfirm('<i class="icon-exclamation-sign"></i> 退款','确定要退款给买家吗?',function(){
            $.ajax({
                type: 'POST',
                url: "<?php echo U('home/'.$at.'/edittui'); ?>",
                data:{id:id,type:type,money:money},
                success: function (result) {
                    if(result.code == 1){
                        showAlert(result.res);
                        window.location.reload();
                    }else{
                        showAlert(result.res);
                    }
                }
            });
        });
    }

    function EditAll(id,str,title,db,value){
        showConfirm('<i class="icon-exclamation-sign"></i> '+title,'确定要 '+title+' 吗?',function(){
            $.ajax({
                type: 'POST',
                url: "<?php echo U('home/public/editall'); ?>",
                data:{id:id,str:str,db:db,value:value},
                success: function (result) {
                    if(result.code == 1){
                        showAlert(result.res);
                        window.location.reload();
                    }else{
                        showAlert(result.res);
                    }
                }
            });
        });
    }


    function SubmitData(){

        var name = $.trim($("*[name='name']").val());
        var phone = $.trim($("*[name='phone']").val());
        var location = $.trim($("*[name='location']").val());
        var parent = $.trim($("*[name='parent']").val());
        var price = $.trim($("*[name='price']").val());
        var ku_num = $.trim($("*[name='ku_num']").val());

        if(!name){
            showAlert("请输入明细账单名称");
            return false;
        }

        if(!phone){
            showAlert("请输入手机号");
            return false;
        }
        if(!location){
            showAlert("请输入地址");
            return false;
        }



        $('#js_btn').attr('disabled',true);
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "<?php echo U('home/user/add'); ?>",
            data:{name:name,phone:phone,location:location,parent:parent,price:price,ku_num:ku_num,is_edit:is_Edit},
            success: function (result) {
                if(result.code == 1){
                    showAlert(result.res);
                    window.location.href= parent_url;
                }else if(result.code==0){
                    showAlert(result.res);
                    $('#js_btn').attr('disabled',false);
                }else{
                    showAlert("提交失败，请检查您的输入是否合法");
                    $('#js_btn').attr('disabled',false);
                }
            }
        });

    }

</script>