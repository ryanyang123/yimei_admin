<!--引用文件head-->
<include file="common/header"/>


<!-- 上传图片 -->

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-fileupload.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/jquery.gritter.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/chosen.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/select2_metro.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/jquery.tagsinput.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/clockface.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-wysihtml5.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/datepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/timepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/colorpicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/bootstrap-toggle-buttons.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/daterangepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/datetimepicker.css" />

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/multi-select-metro.css" />

<link href="__PUBLIC__/css/bootstrap-modal.css" rel="stylesheet" type="text/css"/>

<!-- 上传图片-->

<!-- END HEAD -->

<!-- BEGIN BODY -->

<body class="page-header-fixed">

<!-- BEGIN HEADER -->

<!--头部导航栏-->
<include file="common/top"/>



<div class="page-container">


    <!--导航栏-->
    <include file="common/nav"/>



    <div class="page-content">


        <!-- BEGIN PAGE CONTAINER-->

        <div class="container-fluid">

            <!-- BEGIN PAGE HEADER-->

            <div class="row-fluid">

                <div class="span12">



                    <!--颜色选择-->
                    <include file="common/color"/>



                    <!-- BEGIN PAGE TITLE & BREADCRUMB-->

                    <h3 class="page-title">

                        {$title} <small>列表</small>

                    </h3>

                    <ul class="breadcrumb">

                        <li>

                            <i class="icon-home"></i>

                            <a href="<?php echo U('home/home/index');?>">主页</a>

                            <i class="icon-angle-right"></i>

                        </li>

                        <li>

                            <i class="icon-long-arrow-right"></i>

                            <a href="<?php echo U('home/'.$at.'/index');?>">弹出视频</a>

                            <i class="icon-angle-right"></i>

                        </li>

                        <li><a href="#"><?php echo $is_edit?'修改'.$title:'新增'.$title;?></a></li>



                    </ul>

                    <!-- END PAGE TITLE & BREADCRUMB-->

                </div>

            </div>

            <!-- END PAGE HEADER-->

            <div id="dashboard">



                <div class="row-fluid">

                    <div class="span12">

                        <!-- BEGIN PORTLET-->

                        <div class="portlet box">



                            <div class="portlet-body form">

                                <!-- BEGIN FORM-->

                                <form action="<?php echo U('home/GameAdd/upload_thumb');?>" class="form-horizontal">


                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font></font></label>

                                        <div class="controls">
                                            <!-- 类型：0不跳转，1跳转外部链接，2跳转医院详情,3优惠券详情，4商品详情，5邀请好友-->

                                            <label class="radio">
                                                <div class="radio"><span><input type="radio" name="optionsRadios2" <if condition="$list['ad_type'] eq 1"> checked="" </if>   value="1"></span></div>
                                                图片
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios2" <if condition="$list['ad_type'] eq 2"> checked="" </if> value="2"></span></div>
                                                视频
                                            </label>



                                        </div>

                                    </div>

                                    <if condition="$list.ad_type eq 2">
                                        <div class="control-group " >

                                            <label class="control-label">
                                                <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原有视频</font></font></label>

                                            <div class="controls">

                                                <a href="<?php echo $list['img_url'];?>" target="_blank">查看</a>
                                            </div>

                                        </div>
                                    </if>

                                    <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视频/图片</font></font></label>



                                        <div class="controls">
                                            <div id="upload_kuang"  <if condition="!$is_edit and !$list['img_url']">class="dan_upload_img_div1"</if>>
                                            <div id="uploadPreview">
                                                <if condition="$is_edit and $list['img_url']">
                                                    <img src="{$list.img_url}" style="max-height: 150px;border:1px solid #ddd;" alt=""/>
                                                </if>
                                            </div>

                                        </div>

                                        <label class="on_img_btn" for="uploadImage" style="display: inline;"> <span  class="btn btn-default" style="">
                                                <if condition="!$is_edit and !$list['img_url']">
                                                    选择图片/视频
                                                    <else/>
                                                    更改图片/视频
                                                </if>

                                            </span></label>
                                        <label class="change_img_btn" for="uploadImage" style="display: none;"> <span  class="btn btn-default" style="">更改</span></label>
                                        <label class="del_img_btn" style="display: none;" onclick="ClearImg()"> <span  class="btn btn-default" style="">删除</span></label>
                                        <input id="uploadImage" <if condition="$list.ad_type eq 2">style="position: relative;opacity: 1;" </if> type="file"  name="photoimage" class="fimg1"  />
                                    </div>
                            </div>


                              <!--      <div class="control-group">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">排序</font></font></label>

                                        <div class="controls">
                                            <input type="text" placeholder="请输入序号" name="sort"  value="{$list.sort}" class="m-wrap medium">
                                        </div>

                                    </div>-->

                                    <div class="control-group show_type">

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font></font></label>

                                        <div class="controls">
                                            <!-- 类型：0不跳转，1跳转外部链接，2跳转医院详情,3优惠券详情，4商品详情，5邀请好友-->

                                            <label class="radio">
                                                <div class="radio"><span><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 0"> checked="" </if>   value="0"></span></div>
                                                不跳转
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 1"> checked="" </if> value="1"></span></div>
                                                跳转外部URL链接
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 2"> checked="" </if> value="2"></span></div>
                                                跳转机构
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 3"> checked="" </if> value="3"></span></div>
                                                跳转优惠券详情
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 4"> checked="" </if> value="4"></span></div>
                                                跳转商品详情
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 5"> checked="" </if> value="5"></span></div>
                                                跳转邀请好友页面
                                            </label>
                                            <label class="radio">
                                                <div class="radio"><span class="checked"><input type="radio" name="optionsRadios1" <if condition="$list['type'] eq 6"> checked="" </if> value="6"></span></div>
                                                跳转积分商品列表
                                            </label>

                                        </div>

                                    </div>





                                    <div class="control-group show_all show_1" <if condition="$list['type'] neq 1"> style="display: none;" </if>>

                                        <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">跳转URL地址</font></font></label>

                                        <div class="controls">
                                            <input type="text" placeholder="请输入跳转URL地址" name="url_link"  <if condition="$list['type'] eq 1"> value="{$list.to_url}" </if> class="m-wrap medium">
                                        </div>

                                    </div>


                            <div class="control-group show_all show_2" <if condition="$list['type'] neq 2"> style="display: none;" </if>>

                            <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">机构</font></font></label>

                            <div class="controls">
                                <select name="game_id" data-placeholder="Your Favorite Type of Bear" class="chosen-with-diselect span3" tabindex="-1" id="game_id">
                                    <foreach name="game_list" item="v" >
                                        <option <if condition="$list['to_url'] eq $v['id']"> selected </if> value="{$v.id}" >{$v.name}</option>
                                    </foreach>
                                </select>
                            </div>

                         </div>



                    <div class="control-group show_all show_3" <if condition="$list['type'] neq 3"> style="display: none;" </if>>

                    <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优惠券</font></font></label>

                    <div class="controls">
                        <select name="ticket_id" data-placeholder="Your Favorite Type of Bear" class="chosen-with-diselect span3" tabindex="-1" id="">
                            <foreach name="ticket_list" item="v" >
                                <option <if condition="$list['to_url'] eq $v['id']"> selected </if> value="{$v.id}" >{$v.title}</option>
                            </foreach>
                        </select>
                    </div>

                 </div>


                <div class="control-group show_all show_4" <if condition="$list['type'] neq 4"> style="display: none;" </if>>

                    <label class="control-label"><font style="vertical-align: inherit;"><font
                            style="vertical-align: inherit;">选择商品</font></font></label>

                    <div class="controls">
                        <span id="show_xz_span"></span>
                        <a href="JavaScript:binduser('','')" class="btn blue"><i
                                class="icon-plus"></i> <span id="xz_a_span">选择</span></a>
                    </div>
                </div>


            <div class="control-group">

                <label class="control-label"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示时间（秒）</font></font></label>

                <div class="controls">
                    <input type="number" placeholder="显示时间，单位秒，最低显示1秒" name="show_time"  value="{$list.show_time}" class="m-wrap medium">
                </div>

            </div>
                                    <div class="form-actions">

                                        <button type="button" id="js_btn" onclick="UploadImg()" class="btn blue"><i class="icon-ok"></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 保存</font></font></button>

                                        <button type="button" onclick="to_gen()" class="btn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取消</font></font></button>



                                    </div>

                                </form>

                                <!-- END FORM-->

                            </div>

                        </div>

                        <!-- END PORTLET-->

                    </div>

                </div>


                <div class="clearfix"></div>





            </div>

        </div>

        <!-- END PAGE CONTAINER-->

    </div>

    <!-- END PAGE -->

</div>


<!-- modal -->
<div class="modal fade" id='modal_bind' style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                </button>
                <i class="fa fa-question" style='margin-top:5px; width:30px; float:left;'></i>
                <h4 class="modal-title" id='modal_bind_title'>搜索商品</h4>
            </div>
            <div class="modal-body">


                <form action="#" class="form-horizontal">
                    <div class="control-group">
                        <label class="control-label" style="width: 80px;"><font style="vertical-align: inherit;"><font
                                style="vertical-align: inherit;">当前选择</font></font></label>
                        <div class="controls" style="margin-left: 100px;">
                            <p style="padding-top: 7px;color: #f00;" id="xz_p">暂无选择</p>
                            <table style="width: 100%;line-height: 25px;display: none;" id="xz_table" border="1">
                                <tr>
                                    <th style="width: 30px;" id="xz_id"></th>
                                    <th id="xz_name"></th>
                                    <th style="width: 120px;" id="xz_shop"></th>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label"><font style="vertical-align: inherit;"><font
                                style="vertical-align: inherit;">搜索商品</font></font></label>
                        <div class="controls">
                            <input type="text" placeholder="搜索商品名称" name="search_val" value="" class="m-wrap medium">
                            <button type="button" class="btn green" onclick="SearchGoods()" style='margin-left:9px'>搜
                                索
                            </button>
                        </div>
                    </div>

                    <style>
                        .zdy_a {
                            display: block;
                            width: 12px;
                            height: 12px;
                            border: 2px solid #ccc;
                            border-radius: 50%;
                            text-decoration: none;
                            margin: 0 auto;
                        }

                        a.zdy_a:link, a.zdy_a:visited, a.zdy_a:hover, a.zdy_a:active {
                            text-decoration: none;
                        }

                        .zdy_a_active {
                            background: #333;
                        }
                    </style>
                    <div class="control-group">

                        <div style="height: 270px;overflow-y: auto;">
                            <table style="width: 100%;text-align: center;line-height: 40px;" border="1">
                                <tr>
                                    <th style="width: 70px;">商品ID</th>
                                    <th>商品名称</th>
                                    <th style="width: 120px;">所属店铺</th>
                                    <th style="width: 50px;">选择</th>
                                </tr>

                                <tbody id="search_tbody">

                                </tbody>


                            </table>
                        </div>

                    </div>

                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn green"
                        data-dismiss="modal">确 定
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- ./modal -->


<!-- END CONTAINER -->
<include file="common/footer"/>
<!-- END JAVASCRIPTS -->

</body>


<!-- END BODY -->

</html>
<script src="__PUBLIC__/js/ajaxfileupload.js"></script>
<script>
    var is_Edit = '<?php echo $is_edit;?>';
    $("#uploadImage").on("change", function(){
        // Get a reference to the fileList
        var files = !!this.files ? this.files : [];

        // If no files were selected, or no FileReader support, return
        if (!files.length || !window.FileReader) return;

        // Only proceed if the selected file is an image
        if (/^image/.test( files[0].type)){

            // Create a new instance of the FileReader
            var reader = new FileReader();

            // Read the local file as a DataURL
            reader.readAsDataURL(files[0]);

            // When loaded, set image data as background of div
            reader.onloadend = function(){

                $("#uploadPreview").html("<img style='max-height: 150px;border:1px solid #ddd;' src='"+this.result+"'/>");
                $('.on_img_btn').hide();
                $('.change_img_btn').show().css('display','inline-block');
                $('.del_img_btn').show().css('display','inline-block');
                $("#upload_kuang").removeClass("dan_upload_img_div1");
            }
        }
    });

    $(function(){
        var now_type = "{$list.ad_type}";
        if(now_type=='2'){
            $('.show_all').hide();
            $('.show_type').hide();

        }
    });

    function binduser(doc_id, user_id) {
        if (user_id) {
            $('#bd_div').show();
            $('#bd_user_id').html(user_id);
        }
        $('#modal_bind').modal('show');
        $('#modal_bind_yes')[0].onclick = function () {
            //$('#modal_confirm').modal('hide');
            Submitbduser(doc_id);
        };
    }


    function SearchGoods() {
        var search_val = $.trim($("*[name='search_val']").val());
        if (search_val == '') {
            showAlert("请输入要搜索的商品名");
            return false;
        }

        $.ajax({
            type: 'POST',
            url: "<?php echo U('home/'.$at.'/SearchGoods'); ?>",
            data: {search_val: search_val},
            success: function (result) {
                if (result.code == 1) {
                    $('#search_tbody').html('');
                    $.each(result.list, function (index, value) {
                        $('#search_tbody').append(' <tr>' +
                            '                        <td>' + value.id + '</td>' +
                            '                        <td>' + value.name + '</td>' +
                            '                        <td>' + value.shop_name + '</td>' +
                            '                        <td><a href="javascript:xzgoods(\'' + value.id + '\',\''+value.name+'\',\''+value.shop_name+'\')" class="zdy_a zdy_a_' + value.id + '">&nbsp;</a> </td>' +
                            '                        </tr>');
                    });


                } else {
                    $('#search_tbody').html('<tr>' +
                        '                    <td colspan="10">未找到相关商品</td>' +
                        '                        </tr>');

                }
            }
        });
    }



    var xz_id = "{$goods_info.id}";
    var xz_name = "{$goods_info.name}";
    var xz_shop = "{$goods_info.shop_name}";


    $(function(){
        if(xz_id!='0'){
            $('#xz_p').hide();
            $('#xz_table').show();
            $('#xz_id').html(xz_id);
            $('#xz_name').html(xz_name);
            $('#xz_shop').html(xz_shop);
            $('#show_xz_span').html("当前选择：《 "+xz_name+" 》    ");
            $('#xz_a_span').html('更改');
        }
    })


    function xzgoods(id,name,shop_name) {
        $('.zdy_a').removeClass('zdy_a_active');
        $('.zdy_a_' + id).addClass('zdy_a_active');
        $('#xz_p').hide();
        $('#xz_table').show();
        $('#xz_id').html(id);
        $('#xz_name').html(name);
        $('#xz_shop').html(shop_name);
        $('#show_xz_span').html("当前选择：《 "+name+" 》    ");
        $('#xz_a_span').html('更改');
        xz_id = id;
        xz_name = name;
        xz_shop = shop_name;
    }




    $('input:radio[name="optionsRadios1"]').change( function changetype(){
        $('.show_all').hide();
        if($(this).val()==1 || $(this).val()==2 || $(this).val()==3 || $(this).val()==4){
            $('.show_'+$(this).val()).show();
        }
    })


    $('input:radio[name="optionsRadios2"]').change( function(){
        $('.show_all').hide();

        if($(this).val()==2){
            $('#uploadImage').css({'position':'relative','opacity':"1"});
            $('.show_type').hide();
        }else{
            $('#uploadImage').css({'position':'absolute','opacity':"0"});
            var banner_type = $("input[name='optionsRadios1']:checked").val();
            if(banner_type==1 || banner_type==2 || banner_type==3 || banner_type==4){
                $('.show_'+banner_type).show();
            }
            $('.show_type').show();
        }
       /* if($(this).val()==1 || $(this).val()==2 || $(this).val()==3 || $(this).val()==4){
            $('.show_'+$(this).val()).show();
        }*/
    })


    function ClearImg(){
        $("#upload_kuang").addClass("dan_upload_img_div1");
        $("#uploadImage").val('');
        $('.on_img_btn').show();
        $('.change_img_btn').hide();
        $('.del_img_btn').hide();
        $('#uploadPreview').html('');
    }

    function UploadImg(){
        var img = "";
        var ad_type = $("input[name='optionsRadios2']:checked").val();
        var file = $("#uploadImage").val();
        if(file==""){
            SubmitData("");
        }


        else{
            //判断上传的文件的格式是否正确
            var fileType = file.substring(file.lastIndexOf(".")+1);
            if(ad_type=='1'){
                if(fileType!="png"&&fileType!="jpg" &&fileType!="jpeg"){
                    showAlert("上传图片格式错误");
                    return false;
                }
                var url = "<?php echo U('home/Upload/thumb');?>";
            }else{
                if(fileType!="mp4"&&fileType!="MP4" ){
                    showAlert("上传格式错误，请上传MP4格式文件");
                    $('#js_btn').attr('disabled',false);
                    return false;
                }
                var url = "<?php echo U('home/Upload/video');?>";
            }



                $.ajaxFileUpload({
                    url:url,
                    fileElementId:"uploadImage",        //file的id
                    dataType:"json",                  //返回数据类型为文本
                    success:function(res){
                        if(res){
                            img = res;
                            SubmitData(img);
                        }else{
                            showAlert("图片上传失败");
                        }
                    }
                })

        }
    }


    var parent_url = "<?php echo U('home/'.$at.'/index');?>";

    function to_gen(){
        window.location.href = parent_url;
    }

    function SubmitData(img){
        var sort = $.trim($("*[name='sort']").val());
        var banner_type = $("input[name='optionsRadios1']:checked").val();
        var ad_type = $("input[name='optionsRadios2']:checked").val();
        var url_link = $.trim($("*[name='url_link']").val());
        var show_time = $.trim($("*[name='show_time']").val());
        var game_id = '';


        if(ad_type=='1'){
            if(!img && !is_Edit){
                showAlert("请上传图片");
                return false;
            }
        }else{
            if(!img && !is_Edit){
                showAlert("请上传视频");
                return false;
            }
        }


        if(banner_type==1){
            if(!url_link){showAlert("请输入跳转的外部链接URL");return false;}
        }

        if(banner_type==2){
            game_id = $.trim($("*[name='game_id']").val());
            if(!game_id){showAlert("请选择机构");return false;}
        }


        if(banner_type==3){
            game_id = $.trim($("*[name='ticket_id']").val());
            if(!game_id){showAlert("请选择优惠券");return false;}
        }
        if(banner_type==4){
            if (xz_id=='0') {showAlert("请选择商品");return false;}
            game_id = xz_id;
        }

        $('#js_btn').attr('disabled',true);
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "<?php echo U('home/'.$at.'/add'); ?>",
            data:{img:img,show_time:show_time,ad_type:ad_type,banner_type:banner_type,url_link:url_link,game_id:game_id,sort:sort,is_edit:is_Edit},
            success: function (result) {
                if(result.code == 1){
                    showAlert(result.res);
                    window.location.href= parent_url;
                }else if(result.code==0){
                    showAlert(result.res);
                    $('#js_btn').attr('disabled',false);
                }else{
                    showAlert("提交失败，请检查您的输入是否合法");
                    $('#js_btn').attr('disabled',false);
                }
            }
        });

    }

</script>